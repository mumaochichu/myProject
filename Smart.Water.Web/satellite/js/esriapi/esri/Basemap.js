// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ./geometry ./core/Collection ./core/collectionUtils ./core/JSONSupport ./core/lang ./core/Loadable ./core/loadAll ./core/Logger ./core/maybe ./core/promiseUtils ./core/urlUtils ./core/accessorSupport/decorators ./portal/Portal ./portal/PortalItem ./support/basemapDefinitions ./webdoc/support/writeUtils @dojo/framework/shim/Promise".split(" "),function(z,I,d,A,h,t,B,C,D,E,F,u,p,r,e,v,G,w,x){var H=0,y=F.getLogger("esri.Basemap");return function(k){function b(a){var c=k.call(this,
a)||this;c.id=null;c.portalItem=null;c.spatialReference=null;c.thumbnailUrl=null;c.title="Basemap";c.id=Date.now().toString(16)+"-basemap-"+H++;c.baseLayers=new h;c.referenceLayers=new h;var f=function(a){a.parent&&a.parent!==c&&"remove"in a.parent&&a.parent.remove(a);a.parent=c;"elevation"===a.type&&y.error("Layer '"+a.title+", id:"+a.id+"' of type '"+a.type+"' is not supported as a basemap layer and will therefore be ignored.")};c.baseLayers.on("after-add",function(a){return f(a.item)});c.referenceLayers.on("after-add",
function(a){return f(a.item)});c.baseLayers.on("after-remove",function(a){a.item.parent=null});c.referenceLayers.on("after-remove",function(a){a.item.parent=null});return c}d.__extends(b,k);l=b;b.prototype.initialize=function(){var a=this;this.when().catch(function(c){y.error("#load()","Failed to load basemap (title: '"+a.title+"', id: '"+a.id+"')",c)});this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)};b.prototype.normalizeCtorArgs=function(a){a&&"resourceInfo"in a&&
(this._set("resourceInfo",a.resourceInfo),a=d.__assign({},a),delete a.resourceInfo);return a};Object.defineProperty(b.prototype,"baseLayers",{set:function(a){this._set("baseLayers",t.referenceSetter(a,this._get("baseLayers")))},enumerable:!0,configurable:!0});b.prototype._writeBaseLayers=function(a,c,f){var b=[];a&&(f=d.__assign(d.__assign({},f),{layerContainerType:"basemap"}),this.baseLayers.forEach(function(a){a=x.getLayerJSON(a,f.webmap?f.webmap.getLayerJSONFromResourceInfo(a):null,f);u.isSome(a)&&
b.push(a)}),this.referenceLayers.forEach(function(a){a=x.getLayerJSON(a,f.webmap?f.webmap.getLayerJSONFromResourceInfo(a):null,f);u.isSome(a)&&(a.isReference=!0,b.push(a))}));c.baseMapLayers=b};Object.defineProperty(b.prototype,"referenceLayers",{set:function(a){this._set("referenceLayers",t.referenceSetter(a,this._get("referenceLayers")))},enumerable:!0,configurable:!0});b.prototype.writeTitle=function(a,c){c.title=a||"Basemap"};b.prototype.load=function(a){this.addResolvingPromise(this._loadFromSource(a));
return p.resolve(this)};b.prototype.loadAll=function(){var a=this;return E.loadAll(this,function(c){c(a.baseLayers,a.referenceLayers)})};b.prototype.clone=function(){var a={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.slice(),referenceLayers:this.referenceLayers.slice()};this.loaded&&(a.loadStatus="loaded");return(new l({resourceInfo:this.resourceInfo})).set(a)};b.prototype.read=function(a,c){this.resourceInfo||this._set("resourceInfo",{data:a,context:c});k.prototype.read.call(this,
a,c)};b.prototype.write=function(a,c){a=a||{};c&&c.origin||(c=d.__assign({origin:"web-map"},c));k.prototype.write.call(this,a,c);!this.loaded&&this.resourceInfo&&this.resourceInfo.data.baseMapLayers&&(a.baseMapLayers=this.resourceInfo.data.baseMapLayers.map(function(a){a=C.clone(a);a.url&&r.isProtocolRelative(a.url)&&(a.url="https:"+a.url);a.templateUrl&&r.isProtocolRelative(a.templateUrl)&&(a.templateUrl="https:"+a.templateUrl);return a}));return a};b.prototype._loadFromSource=function(a){return d.__awaiter(this,
void 0,void 0,function(){var c,b,g,q,e,m,n=this;return d.__generator(this,function(d){switch(d.label){case 0:return c=this,b=c.resourceInfo,g=c.portalItem,p.throwIfAborted(a),q=[],b?(e=b.context?b.context.url:null,q.push(this._loadLayersFromJSON(b.data,e,a)),b.data.id&&!b.data.title&&(m=b.data.id,q.push(w.getBasemapTitle(m).then(function(a){a&&n.read({title:a},b.context)})))):g&&q.push(this._loadFromItem(g,a)),[4,p.all(q)];case 1:return d.sent(),[2]}})})};b.prototype._loadLayersFromJSON=function(a,
c,b){return d.__awaiter(this,void 0,void 0,function(){var g,f,e,m,n,h,k,l;return d.__generator(this,function(d){switch(d.label){case 0:return g=this.resourceInfo&&this.resourceInfo.context,f=this.portalItem&&this.portalItem.portal||g&&g.portal||null,e=g&&"web-scene"===g.origin?"web-scene":"web-map",[4,new Promise(function(a,c){z(["./portal/support/layersCreator"],a,c)})];case 1:return m=d.sent(),n=[],p.throwIfAborted(b),a.baseMapLayers&&Array.isArray(a.baseMapLayers)&&(h={context:{origin:e,url:c,
portal:f,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},k=m.populateOperationalLayers(this.baseLayers,a.baseMapLayers.filter(function(a){return!a.isReference}),h),n.push(k),l=m.populateOperationalLayers(this.referenceLayers,a.baseMapLayers.filter(function(a){return a.isReference}),h),n.push(l)),[4,p.eachAlways(n)];case 2:return d.sent(),[2]}})})};b.prototype._loadFromItem=function(a,c){return d.__awaiter(this,void 0,void 0,function(){var b,g,e;return d.__generator(this,function(d){switch(d.label){case 0:return[4,
a.load(c)];case 1:return b=d.sent(),[4,b.fetchData("json",c)];case 2:return g=d.sent(),e=r.urlToObject(a.itemUrl),this._set("resourceInfo",{data:g.baseMap,context:{origin:"web-map",portal:a.portal||v.getDefault(),url:e}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:g.spatialReference},this.resourceInfo.context),this.read({title:a.title,thumbnailUrl:a.thumbnailUrl},{origin:"portal-item",portal:a.portal||v.getDefault(),url:e}),[2,this._loadLayersFromJSON(this.resourceInfo.data,
e,c)]}})})};b.fromId=function(a){return(a=w.esriBasemapDefinitions[a])?l.fromJSON(a):null};var l;d.__decorate([e.property({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer:function(a,c,b,d){this._writeBaseLayers(a,c,d)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:h},elevationLayers:{type:h}},writer:function(a,b,d,e){this._writeBaseLayers(a,b,e)}}}}}})],b.prototype,"baseLayers",null);d.__decorate([e.property({type:String,json:{origins:{"web-scene":{write:!0}}}})],
b.prototype,"id",void 0);d.__decorate([e.property({type:G})],b.prototype,"portalItem",void 0);d.__decorate([e.property()],b.prototype,"referenceLayers",null);d.__decorate([e.property({readOnly:!0})],b.prototype,"resourceInfo",void 0);d.__decorate([e.property({type:A.SpatialReference})],b.prototype,"spatialReference",void 0);d.__decorate([e.property()],b.prototype,"thumbnailUrl",void 0);d.__decorate([e.property({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],b.prototype,"title",
void 0);d.__decorate([e.writer("title")],b.prototype,"writeTitle",null);return b=l=d.__decorate([e.subclass("esri.Basemap")],b)}(B.JSONSupportMixin(D))});