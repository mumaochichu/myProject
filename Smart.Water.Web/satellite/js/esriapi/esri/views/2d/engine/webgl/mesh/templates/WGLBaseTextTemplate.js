// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/maybe ../../../../../../core/screenUtils ../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper ../../../../engine ../../definitions ../../enums ../../number ../../WGLDisplayRecord ../../materialKey/MaterialKey ./util".split(" "),function(F,n,v,w,x,m,y,z,A,B,C,q,t,u,r){Object.defineProperty(n,"__esModule",{value:!0});var D=x.getLogger("esri.views.2d.engine.webgl.WGLTextTemplate"),
E=function(m,l){void 0===l&&(l="mapview-processing");return D.error(w(l,m))};n.default=function(n){return function(l){function e(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];a=l.apply(this,a)||this;a._isCIM=!1;a.geometryType=C.WGLGeometryType.TEXT;a._aux=q.i8888to32(0,0,a._referenceSize,a._bitset);return a}v.__extends(e,l);e.prototype.bindTextInfo=function(a,b){var d=this;this._shapingInfo=a&&a.length?m.andThen(a,function(a){return A.shapeGlyphs(a,b,{scale:d._scale,angle:d._angle,xOffset:d._xOffset,
yOffset:d._yOffset,hAlign:d._xAlignD,vAlign:d._yAlignD,maxLineWidth:Math.max(32,Math.min(d._lineWidth,512)),lineHeight:B.MAGIC_LABEL_LINE_HEIGHT*Math.max(.25,Math.min(d._lineHeight,4)),decoration:d._decoration,isCIM:d._isCIM})}):null};e.prototype.writeMeshWithGeometry=function(a,b,d,c,h,f){var g=this;if(m.isSome(this._textPlacement))this._writePlacedText(a,b,c,h,f);else if(r.isPoint(f))this._writeGlyphs(a,b,c,f);else if(r.isPolygon(f))m.andThen(h.centroid,function(d){return g._writeGlyphs(a,b,c,d)});
else if(r.isMultipoint(f)){var e=h=d=0;for(f=f.points;e<f.length;e++){var k=f[e],l=k[1];d+=k[0];h+=l;this._writeGlyphs(a,b,c,{x:d,y:h})}}else E("Unable to handle geometryType: "+d)};e.prototype._writePlacedText=function(a,b,d,c,h){c=this._shapingInfo;if(!m.isNone(c)){var f=u.MaterialKeyBase.load(this._materialKey);if(h=z.CIMMarkerPlacementHelper.getPlacement(h,m.unwrap(this._textPlacement),y.pt2px(1))){var g,e;for(g=h.next();null!=g;){e=q.i1616to32(Math.round(8*g.tx),Math.round(8*g.ty));g=g.getAngle();
c.setRotation(g);for(var k=0,l=c.glyphs;k<l.length;k++){var n=l[k],p=new t(d,this.geometryType,f.data,0,0);f.textureBinding=n.textureBinding;p.materialKey=f.data;p.indexFrom=b.indexVector.length;p.indexCount=this._writeIndices(b);p.vertexFrom=b.getVector("geometry").vertexCount;p.vertexCount=this._writeVertex(b,d,e,n);a.push(p)}c.setRotation(-g);g=h.next()}}}};e.prototype._writeGlyphs=function(a,b,d,c){var h=this._shapingInfo;if(!m.isNone(h)){var f=u.MaterialKeyBase.load(this._materialKey);c=q.i1616to32(Math.round(8*
c.x),Math.round(8*c.y));for(var g=0,h=h.glyphs;g<h.length;g++){var e=h[g],k=new t(d,this.geometryType,f.data,0,0);f.textureBinding=e.textureBinding;k.materialKey=f.data;k.indexFrom=b.indexVector.length;k.indexCount=this._writeIndices(b);k.vertexFrom=b.getVector("geometry").vertexCount;k.vertexCount=this._writeVertex(b,d,c,e);a.push(k)}}};e.prototype._writeVertexCommon=function(a,b,d,c){c=this._color;var e=this._haloColor,f=q.i8888to32(0,0,this._referenceSize,this._bitset),g=q.i8888to32(0,0,this._size,
this._haloSize);a.push(d);a.push(b);a.push(c);a.push(e);a.push(g);a.push(f)};e.prototype._writeVertex=function(a,b,d,c){a=a.get("geometry");this._writeVertexCommon(a,b,d,c);a.push(c.offsets.upperLeft);a.push(c.texcoords.upperLeft);this._writeVertexCommon(a,b,d,c);a.push(c.offsets.upperRight);a.push(c.texcoords.upperRight);this._writeVertexCommon(a,b,d,c);a.push(c.offsets.lowerLeft);a.push(c.texcoords.lowerLeft);this._writeVertexCommon(a,b,d,c);a.push(c.offsets.lowerRight);a.push(c.texcoords.lowerRight);
return 4};e.prototype._writeIndices=function(a){var b=a.getVector("geometry").vertexCount;a=a.indexVector;a.push(b+0);a.push(b+1);a.push(b+2);a.push(b+1);a.push(b+3);a.push(b+2);return 6};return e}(n)}});