// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../request ../../../../core/has ../../../../core/ItemCache ../../../../core/maybe ../../../../core/MemCache ../../../../core/promiseUtils ../../../../core/workers ../../../../geometry/support/aaBoundingRect ../vectorTiles/VectorTile ./GeometryUtils ./GlyphMosaic ./GlyphSource ./SpriteMosaic ./TileIndex ../../tiling/TileKey".split(" "),function(u,v,f,w,B,C,n,D,l,E,F,G,x,H,I,J,y,t){Object.defineProperty(v,"__esModule",{value:!0});var z=new C(10),r=new Map;u=function(){function d(a,
e,h,c,b,k){this._vectorTileLayer=a;this.devicePixelRatio=e;this.allowUpdates=h;this._container=c;this._memCache=b;this._enableCachingWorkerTiles=k;this._connection=this._glyphMosaic=this._spriteMosaic=null;this._updateToAbortController=new Map;this._ongoingTileRequests=new Map;this._ongoingRequestToController=new Map}d.prototype.destroy=function(){this._updateToAbortController&&this._updateToAbortController.forEach(function(a){return a.abort()});this._ongoingTileRequests&&this.abortAll();this._connection&&
(this._connection.close(),this._connection=null);this._vectorTileLayer=null;this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null);this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)};Object.defineProperty(d.prototype,"spriteMosaic",{get:function(){var a=this;return this._spriteSourcePromise.then(function(){return a._spriteMosaic})},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,
configurable:!0});d.prototype.start=function(a){return f.__awaiter(this,void 0,void 0,function(){var e,h,c,b,k,g=this;return f.__generator(this,function(d){e=this._vectorTileLayer.sourceNameToSource;h=[];for(c in e)h.push(this._fetchTileMap(e[c],a));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,a);this._spriteSourcePromise.then(function(a){g._spriteMosaic=new J(1024,1024,250);g._spriteMosaic.setSpriteSource(a)});b=this._vectorTileLayer.styleRepository;k=new I(b.glyphs);
this._glyphMosaic=new H(1024,1024,k);this._broadcastPromise=E.open("WorkerTileHandler",{client:this,scheduler:a.scheduler,signal:a.signal}).then(function(c){g._connection=c;return l.all(g._connection.broadcast("setLayers",{style:b.styleJSON,enableCachingTiles:g._enableCachingWorkerTiles},f.__assign({},a)))});return[2,l.all(h)]})})};d.prototype.updateStyle=function(){return f.__awaiter(this,void 0,void 0,function(){var a,e=this;return f.__generator(this,function(h){switch(h.label){case 0:return[4,
this._broadcastPromise];case 1:return h.sent(),this._updateToAbortController.forEach(function(a){return a.abort()}),this._updateToAbortController.clear(),a=this._vectorTileLayer.styleRepository,this._broadcastPromise=l.create(function(c,b){l.all(e._connection.broadcast("updateStyle",a.styleJSON)).then(c,b)}),[2,this._broadcastPromise]}})})};d.prototype.abortTileUpdate=function(a){this._updateToAbortController.has(a)&&(this._updateToAbortController.get(a).abort(),this._updateToAbortController.delete(a))};
d.prototype.updateTile=function(a,e){return f.__awaiter(this,void 0,void 0,function(){var h,c,b,k,g=this;return f.__generator(this,function(f){switch(f.label){case 0:return this.allowUpdates&&a.isReady?[4,this._broadcastPromise]:[2];case 1:f.sent();h=Math.round(x.degToByte(e.state.rotation));if(a.rotation===h)return[2,null];b=a.key;this._updateToAbortController.has(b.id)&&(c=this._updateToAbortController.get(b.id),c.abort(),this._updateToAbortController.delete(b.id));c=l.createAbortController();a.rotation=
h;k=a.client.invoke("updateSymbols",{key:a.id,rotation:h},{signal:c.signal}).then(function(c){g._updateToAbortController.delete(b.id);a.isReady&&a.updateSymbolData(c)}).catch(function(a){l.isAbortError(a)||g._updateToAbortController.delete(b.id)});this._updateToAbortController.set(a.id,c);return[2,k]}})})};d.prototype.updateTileData=function(a){for(var e=a.tileId,h=this._container.children,c,b=0;b<h.length;b++)if(c=h[b],c.id===e){c.updateTileData(a.tileData);break}};d.prototype.getVectorTile=function(a,
e,h,c){return f.__awaiter(this,void 0,void 0,function(){var b,k,g,d,p,A,m;return f.__generator(this,function(f){switch(f.label){case 0:return b=new t(a,e,h,0),n.isSome(this._memCache)&&(k=this._memCache.get(b.id),n.isSome(k))?(k.reference(),[2,k]):[4,this._getVectorTileData(b)];case 1:g=f.sent();l.throwIfAborted(c);if(n.isSome(this._memCache)&&(d=this._memCache.get(b.id),n.isSome(d)))return d.reference(),[2,d];if(!this._vectorTileLayer)return[2,null];p=this._vectorTileLayer.tileInfo;A=p.getTileBounds(F.create(),
b);m=new G.VectorTile(b,this._vectorTileLayer.styleRepository,A,[512,512],0,!1);g&&g.tileData?(m.setData(g.tileData,g.client),n.isSome(this._memCache)&&(m.reference(),this._memCache.put(m.key.id,m,m.getMemoryUsage()*m.referenced,D.MIN_PRIORITY))):m.setData(null,null);return[2,m]}})})};d.prototype.releaseVectorTile=function(a){n.isNone(this._memCache)||a.release()||this._memCache.updateSize(a.key.id,a,a.getMemoryUsage()*a.referenced)};d.prototype.fetchTileData=function(a,e){return f.__awaiter(this,
void 0,void 0,function(){var h,c,b,k;return f.__generator(this,function(g){switch(g.label){case 0:return[4,this._getRefKeys(a,e)];case 1:h=g.sent();c=this._vectorTileLayer.sourceNameToSource;b=[];for(k in c)b.push(k);return[2,this._getSourcesData(b,h,e)]}})})};d.prototype.parseTileData=function(a,e,h){return f.__awaiter(this,void 0,void 0,function(){var c,b,k,g,d,p,l,m,n=this;return f.__generator(this,function(q){switch(q.label){case 0:c=a&&a.data;if(!c)return[2,null];b=c.sourceName2DataAndRefKey;
k=c.transferList;return 0===Object.keys(b).length?[2,null]:[4,this._broadcastPromise];case 1:return q.sent(),g=Math.round(x.degToByte(e)),[4,this._connection.getAvailableClient()];case 2:return d=q.sent(),[4,d.invoke("createTileAndParse",{key:a.key.id,rotation:g,cacheTile:this.allowUpdates,sourceName2DataAndRefKey:b},f.__assign(f.__assign({},h),{transferList:k})).catch(function(){n._enableCachingWorkerTiles&&d.invoke("destructTileData",a.key.id).catch(function(){});return null})];case 3:p=q.sent();
if(B("esri-vector-tiles-debug")){l={};for(m in b)l[m]=b[m].refKey;return[2,{tileData:p,client:d,refKeys:l}]}return[2,{tileData:p,client:d}]}})})};Object.defineProperty(d.prototype,"updating",{get:function(){return 0<this._ongoingTileRequests.size},enumerable:!0,configurable:!0});d.prototype.abortAll=function(){this._ongoingRequestToController.forEach(function(a){return a.abort()});this._ongoingRequestToController.clear();this._ongoingTileRequests.clear()};d.prototype.getSprites=function(a){return f.__awaiter(this,
void 0,void 0,function(){return f.__generator(this,function(e){switch(e.label){case 0:return[4,this._spriteSourcePromise];case 1:return e.sent(),[2,this._spriteMosaic.getSpriteItems(a)]}})})};d.prototype.getGlyphs=function(a){return this._glyphMosaic.getGlyphItems(a.font,a.codePoints)};d.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository};d.prototype._getTilePayload=function(a,e,h){return f.__awaiter(this,void 0,void 0,function(){var c,b,d,g,l;return f.__generator(this,
function(k){switch(k.label){case 0:return c=t.pool.acquire(a.id),b=this._vectorTileLayer.sourceNameToSource,d=b[e],g=d.getSourceTileUrl(c.level,c.row,c.col),t.pool.release(c),[4,w(g,f.__assign({responseType:"array-buffer"},h))];case 1:return l=k.sent(),[2,{protobuff:l.data,sourceName:e}]}})})};d.prototype._fetchTileMap=function(a,e){if(a.capabilities.operations.supportsTileMap&&a.tileIndex||!a.tileMapURL)return l.resolve();var h=z.get(a.tileMapURL);if(h)return a.tileIndex=h,l.resolve();if(r.has(a.tileMapURL))return r.get(a.tileMapURL).then(function(c){a.tileIndex=
new y(c.data)});e=w(a.tileMapURL,e);e.then(function(c){a.tileIndex=new y(c.data);r["delete"](a.tileMapURL);z.put(a.tileMapURL,a.tileIndex)});r.set(a.tileMapURL,e);return e};d.prototype._getRefKeys=function(a,e){return f.__awaiter(this,void 0,void 0,function(){var h,c,b,d,g;return f.__generator(this,function(f){h=this._vectorTileLayer.sourceNameToSource;c=[];for(b in h)d=h[b],g=d.getRefKey(a,e),c.push(g);return[2,l.eachAlways(c)]})})};d.prototype._getSourcesData=function(a,e,d){return f.__awaiter(this,
void 0,void 0,function(){var c,b,h,g,q,p,n;return f.__generator(this,function(f){switch(f.label){case 0:c=[];for(b=0;b<e.length;b++)null==e[b].value||null==a[b]?c.push(null):(h=this._getTilePayload(e[b].value,a[b],d),c.push(h));return[4,l.eachAlways(c)];case 1:g=f.sent();q={};p=[];for(b=0;b<g.length;b++)g[b].value&&g[b].value&&g[b].value.protobuff&&0<g[b].value.protobuff.byteLength&&(n=e[b].value.id,q[g[b].value.sourceName]={refKey:n,protobuff:g[b].value.protobuff},p.push(g[b].value.protobuff));return[2,
{sourceName2DataAndRefKey:q,transferList:p}]}})})};d.prototype._getVectorTileData=function(a){return f.__awaiter(this,void 0,void 0,function(){var e,d,c,b,k=this;return f.__generator(this,function(f){e=a.id;if(this._ongoingTileRequests.has(e))return[2,this._ongoingTileRequests.get(e)];d=new AbortController;c={signal:d.signal};b=this._getParsedVectorTileData(a,c).then(function(a){k._ongoingTileRequests.delete(e);k._ongoingRequestToController.delete(e);return a}).catch(function(){k._ongoingTileRequests.delete(e);
k._ongoingRequestToController.delete(e);return null});this._ongoingTileRequests.set(e,b);this._ongoingRequestToController.set(e,d);return[2,b]})})};d.prototype._getParsedVectorTileData=function(a,e){return f.__awaiter(this,void 0,void 0,function(){var d;return f.__generator(this,function(c){switch(c.label){case 0:return[4,this.fetchTileData(a,e)];case 1:return d=c.sent(),[2,this.parseTileData({key:a,data:d},0,e)]}})})};return d}();v.TileHandler=u});