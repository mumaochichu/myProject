// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/libs/gl-matrix-2/mat3f32 ../../../../../core/libs/gl-matrix-2/vec4f32 ../../../../webgl ../definitions ../enums ../number ./WGLBrush".split(" "),function(y,z,D,E,A,q,v,w,F,G){Object.defineProperty(z,"__esModule",{value:!0});var B=1/65536,C=[1,1,1,1];y=function(t){function l(){var a=null!==t&&t.apply(this,arguments)||this;a._fillVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}]};a._fillVertexAttributesDD=
{geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:4,stride:8,normalized:!0,divisor:0}]};a._outlineVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:8,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:8,normalized:!1,divisor:0}]};a._outlineVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,
offset:0,stride:12,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:12,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:12,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:8,stride:12,normalized:!0,divisor:0}]};a._color=A.vec4f32.create();a._outlineColor=A.vec4f32.create();a._fillProgramOptions={id:!1,dd:!1,pattern:!1};a._outlineProgramOptions={id:!1,dd:!1};a._patternMatrix=E.mat3f32.create();return a}D.__extends(l,t);l.prototype.dispose=
function(){};l.prototype.drawMany=function(a,e){var b=a.displayLevel,h=a.drawPhase,c=a.renderPass,m=a.styleLayerId,f=a.styleLayer,p=f.getPaintValue("fill-pattern",b),g=f.hasDataDrivenColor?C:f.getPaintValue("fill-color",b),k=f.hasDataDrivenOpacity?1:f.getPaintValue("fill-opacity",b),n=k*g[3],d=void 0!==p||1>n||f.hasDataDrivenFill;if(!d||"opaque"!==c){this._color[0]=n*g[0];this._color[1]=n*g[1];this._color[2]=n*g[2];this._color[3]=n;var u;h===w.WGLDrawPhase.HITTEST&&(u=F.u32to4Xu8(m+1));h=f.getPaintValue("fill-translate",
b);b=f.getPaintValue("fill-translate-anchor",b);this._drawFill(a,m,f,e,h,b,p,d,u);this._drawOutline(a,m,f,e,h,b,p,u,k)}};l.prototype._drawFill=function(a,e,b,h,c,m,f,p,g){var k=a.context,n=a.displayLevel,d=a.drawPhase,u=a.renderPass,l=a.spriteMosaic,q=a.state;if(p||"translucent"!==u){p=void 0!==f;var u=a.pixelRatio>v.VTL_HIGH_RES_CUTOFF?2:1,t=b.hasDataDrivenFill;a=a.painter.getVectorTileProgramCach();var r,x=d===w.WGLDrawPhase.HITTEST,d=this._fillProgramOptions;d.id=x;d.dd=t;d.pattern=p;d=a.getProgram(1,
(x?1:0)<<2|(t?1:0)<<1|(p?1:0),d);k.bindProgram(d);if(p){r=l.getMosaicItemPosition(f,!0);if(!r){k.bindProgram();return}d.setUniform2f("u_pattern_tl",r.tl[0],r.tl[1]);d.setUniform2f("u_pattern_br",r.br[0],r.br[1]);d.setUniform1i("u_texture",v.VTL_TEXTURE_BINDING_UNIT_SPRITES);l.bind(k,9729,r.page,v.VTL_TEXTURE_BINDING_UNIT_SPRITES)}d.setUniformMatrix3fv("u_displayMat3",1===m?q.displayMat3:q.displayViewMat3);d.setUniform2fv("u_fillTranslation",c);d.setUniform1f("u_depth",b.z+B);d.setUniform4fv("u_color",
this._color);x&&d.setUniform4fv("u_id",g);for(b=0;b<h.length;b++)if(c=h[b],c.layerData[e]&&(f=this._getFillVAO(k,c,t,a)))m=c.layerData[e],k.bindVAO(f),d.setUniformMatrix3fv("u_dvsMat3",c.transforms.dvs),p&&(f=c.coordRange[0]/(u*c.size[0]*Math.max(Math.pow(2,Math.round(n)-c.key.level),1)),g=1/(r.size[1]*f),this._patternMatrix[0]=1/(r.size[0]*f),this._patternMatrix[4]=g,d.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)),k.setStencilFunction(514,c.stencilRef,255),k.drawElements(4,m.triangleElementCount,
5125,12*m.triangleElementStart),c.triangleCount+=m.triangleElementCount/3}};l.prototype._drawOutline=function(a,e,b,h,c,m,f,p,g){var k=a.context,n=a.displayLevel,d=a.drawPhase,l=a.pixelRatio,q=a.state;if("opaque"!==a.renderPass&&(f=void 0!==f,b.getPaintValue("fill-antialias",n)&&!f||b.hasDataDrivenOutlineColor)){a=a.painter.getVectorTileProgramCach();f=b.hasDataDrivenOutline;if(b.outlineUsesFillColor){if(1!==this._color[3])return;this._outlineColor[0]=this._color[0];this._outlineColor[1]=this._color[1];
this._outlineColor[2]=this._color[2];this._outlineColor[3]=this._color[3]}else n=b.hasDataDrivenOutlineColor?C:b.getPaintValue("fill-outline-color",n),g*=n[3],this._outlineColor[0]=g*n[0],this._outlineColor[1]=g*n[1],this._outlineColor[2]=g*n[2],this._outlineColor[3]=g;l=.75/l;g=d===w.WGLDrawPhase.HITTEST;d=this._outlineProgramOptions;d.id=g;d.dd=f;d=a.getProgram(2,(g?1:0)<<1|(f?1:0),d);k.bindProgram(d);d.setUniformMatrix3fv("u_displayMat3",1===m?q.displayMat3:q.displayViewMat3);d.setUniform2fv("u_fillTranslation",
c);d.setUniform1f("u_depth",b.z+B);d.setUniform1f("u_outline_width",l);d.setUniform4fv("u_color",this._outlineColor);g&&d.setUniform4fv("u_id",p);for(b=0;b<h.length;b++)if(c=h[b],c.layerData[e]&&(m=c.layerData[e],p=this._getOutlineVAO(k,c,f,a)))k.bindVAO(p),d.setUniformMatrix3fv("u_dvsMat3",c.transforms.dvs),k.setStencilFunction(514,c.stencilRef,255),k.drawElements(4,m.outlineElementCount,5125,12*m.outlineElementStart),c.triangleCount+=m.outlineElementCount/3}};l.prototype._getFillVAO=function(a,
e,b,h){if(b){if(e.fillDDVertexArrayObject)return e.fillDDVertexArrayObject;b=e.fillDDVertexBuffer;var c=e.fillIndexBuffer;if(!b||!c)return null;e.fillDDVertexArrayObject=new q.VertexArrayObject(a,h.getProgramAttributes(1),this._fillVertexAttributesDD,{geometry:b},c);return e.fillDDVertexArrayObject}if(e.fillVertexArrayObject)return e.fillVertexArrayObject;b=e.fillVertexBuffer;c=e.fillIndexBuffer;if(!b||!c)return null;e.fillVertexArrayObject=new q.VertexArrayObject(a,h.getProgramAttributes(1),this._fillVertexAttributes,
{geometry:b},c);return e.fillVertexArrayObject};l.prototype._getOutlineVAO=function(a,e,b,h){if(b){if(e.outlineDDVertexArrayObject)return e.outlineDDVertexArrayObject;b=e.outlineDDVertexBuffer;var c=e.outlineIndexBuffer;if(!b||!c)return null;e.outlineDDVertexArrayObject=new q.VertexArrayObject(a,h.getProgramAttributes(2),this._outlineVertexAttributesDD,{geometry:b},c);return e.outlineDDVertexArrayObject}if(e.outlineVertexArrayObject)return e.outlineVertexArrayObject;b=e.outlineVertexBuffer;c=e.outlineIndexBuffer;
if(!b||!c)return null;e.outlineVertexArrayObject=new q.VertexArrayObject(a,h.getProgramAttributes(2),this._outlineVertexAttributes,{geometry:b},c);return e.outlineVertexArrayObject};return l}(G.default);z.WGLBrushVTLFill=y});