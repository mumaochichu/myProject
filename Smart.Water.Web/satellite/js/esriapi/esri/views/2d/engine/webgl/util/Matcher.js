// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/Error ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../support/arcadeOnDemand ../../../../../symbols/cim/cimSymbolUtils ../../../../../symbols/cim/utils ../../../arcade/utils".split(" "),function(k,y,g,F,t,G,A,B,x,H,C){function I(h,e){return g.__awaiter(this,void 0,void 0,function(){var a,b;return g.__generator(this,function(c){switch(c.label){case 0:return a=h||1,"number"===typeof a?[2,function(c,
b,e){return a}]:[4,B.createRendererExpression(a,e.spatialReference,e.fields)];case 1:return b=c.sent(),[2,function(a,c,g){return C.callWithFeature(b,a,{$view:g},e.geometryType,c)||1}]}})})}Object.defineProperty(y,"__esModule",{value:!0});var D=t.getLogger("esri/views/2d/engine/webgl/util/Matcher");k=function(){function h(){this._defaultResult=null}h.fromBasicRenderer=function(e,a,b){return g.__awaiter(this,void 0,void 0,function(){var c,d,f;return g.__generator(this,function(g){switch(g.label){case 0:return[4,
x.expandSymbols(e.getSymbols(),b)];case 1:return c=g.sent(),d=new h,c.length?[4,a.createTemplateGroup(c[0],null,e)]:[3,3];case 2:f=g.sent(),d.setDefault(f),g.label=3;case 3:return[2,d]}})})};h.prototype.size=function(){return 1};h.prototype.getDefault=function(){return this._defaultResult};h.prototype.setDefault=function(e){this._defaultResult=e};h.prototype.match=function(e,a,b,c,d){return this.getDefault()};h.prototype.analyze=function(e,a,b,c,d){return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,
function(a){return[2]})})};return h}();y.FeatureMatcher=k;t=function(h){function e(a,b,c,d){var f=h.call(this)||this;f._intervals=[];f._isMaxInclusive=b;d?f._getValue=C.callWithFeature.bind(null,d):a&&a.length?"function"===typeof a?(f._field=null,f._getValue=a):(f._field=a,f._normalizationInfo=c,f._getValue=f._getValueFromField.bind(f)):f._field=null;return f}g.__extends(e,h);e.fromCBRenderer=function(a,b,c){return g.__awaiter(this,void 0,void 0,function(){var d,f,h,z,q,E,v,r,w,n,u,l,p,k=this;return g.__generator(this,
function(m){switch(m.label){case 0:return d=a.isMaxInclusive,f=a.normalizationField,h=a.normalizationTotal,z=a.normalizationType,q=a.field,E={normalizationField:f,normalizationTotal:h,normalizationType:z},(w=v=a.valueExpression)?[4,B.createRendererExpression(v,c.spatialReference,c.fields)]:[3,2];case 1:w=m.sent(),m.label=2;case 2:return r=w,n=new e(q,d,E,r),[4,x.expandSymbol(a.backgroundFillSymbol,c)];case 3:return u=m.sent(),[4,A.all(a.classBreakInfos.map(function(d){return g.__awaiter(k,void 0,
void 0,function(){var f,e,h;return g.__generator(this,function(g){switch(g.label){case 0:return[4,x.expandSymbol(d.symbol,c)];case 1:return f=g.sent(),[4,b.createTemplateGroup(f,u,a)];case 2:return e=g.sent(),h={min:d.minValue,max:d.maxValue},n.add(h,e),[2]}})})}))];case 4:return m.sent(),[4,x.expandSymbol(a.defaultSymbol,c)];case 5:return(l=m.sent())?[4,b.createTemplateGroup(l,u,a)]:[3,7];case 6:p=m.sent(),n.setDefault(p),m.label=7;case 7:return[2,n]}})})};e.prototype.add=function(a,b){this._intervals.push({interval:a,
result:b});this._intervals.sort(function(a,b){return a.interval.min-b.interval.min})};e.prototype.size=function(){return h.prototype.size.call(this)+this._intervals.length};e.prototype.match=function(a,b,c,d,f){if(!this._getValue)return this.getDefault();a=this._getValue(b,{$view:f},c,d);if(!a&&(null===a||void 0===a||isNaN(a)))return this.getDefault();for(b=0;b<this._intervals.length;b++)if(d=this._intervals[b],c=d.interval,d=d.result,f=this._isMaxInclusive?a<=c.max:a<c.max,a>=c.min&&f)return d;return this.getDefault()};
e.prototype._needsNormalization=function(){var a=this._normalizationInfo;return a&&(a.normalizationField||a.normalizationTotal||a.normalizationType)};e.prototype._getValueFromField=function(a){var b=a.attributes[this._field];if(!this._needsNormalization())return b;var c=this._normalizationInfo,d=c.normalizationField,f=c.normalizationTotal,c=c.normalizationType;a=!!d&&a.attributes[d];if(c)switch(c){case "field":return(a||void 0)&&b/a;case "log":return Math.log(b)*Math.LOG10E;case "percent-of-total":return b/
f*100;default:D.error("Found unknown normalization type: "+c)}else D.error("Normalization is required, but no type was set!")};return e}(k);y.IntervalMatcher=t;t=function(h){function e(a,b,c){var d=h.call(this)||this;d._nullResult=null;d._resultsMap=new Map;c?d._getValue=C.callWithFeature.bind(null,c):a&&a.length?"function"===typeof a[0]?(d._fields=null,d._getValue=a[0]):(d._fields=a,d._seperator=b||"",d._getValue=d._getValueFromFields.bind(d)):d._fields=null;return d}g.__extends(e,h);e.fromUVRenderer=
function(a,b,c){return g.__awaiter(this,void 0,void 0,function(){var d,f,h,z,q,k,v,r,w,n,u=this;return g.__generator(this,function(l){switch(l.label){case 0:return d=a.uniqueValueInfos,f=a.fieldDelimiter,h=[a.field],z=a.valueExpression,a.field2&&h.push(a.field2),a.field3&&h.push(a.field3),[4,x.expandSymbol(a.backgroundFillSymbol,c)];case 1:return q=l.sent(),(v=z)?[4,B.createRendererExpression(z,c.spatialReference,c.fields)]:[3,3];case 2:v=l.sent(),l.label=3;case 3:return k=v,r=new e(h,f,k),[4,A.all(d.map(function(d){return g.__awaiter(u,
void 0,void 0,function(){var f,e;return g.__generator(this,function(g){switch(g.label){case 0:return[4,x.expandSymbol(d.symbol,c)];case 1:return f=g.sent(),[4,b.createTemplateGroup(f,q,a)];case 2:return e=g.sent(),"\x3cNull\x3e"===d.value?r.setNullResult(e):r.add(d.value,e),[2]}})})}))];case 4:return l.sent(),[4,x.expandSymbol(a.defaultSymbol,c)];case 5:return(w=l.sent())?[4,b.createTemplateGroup(w,q,a)]:[3,7];case 6:n=l.sent(),r.setDefault(n),l.label=7;case 7:return[2,r]}})})};e.prototype.setNullResult=
function(a){this._nullResult=a};e.prototype.add=function(a,b){this._resultsMap.set(a.toString(),b)};e.prototype.size=function(){return h.prototype.size.call(this)+this._resultsMap.size};e.prototype.match=function(a,b,c,d,f){if(!this._getValue)return this.getDefault();a=this._getValue(b,{$view:f},c,d);if(null!==this._nullResult&&(null==a||""===a||"\x3cNull\x3e"===a))return this._nullResult;if(!a&&null==a)return this.getDefault();a=a.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):
this.getDefault()};e.prototype._getValueFromFields=function(a){for(var b=[],c=0,d=this._fields;c<d.length;c++)b.push(a.attributes[d[c]]);return b.join(this._seperator)};return e}(k);y.MapMatcher=t;t=function(h){function e(a,b,c,d){var f=h.call(this)||this;f._fidToAttributeHash=new Map;f._attributeHashToGroup=new Map;f._renderer=a;f._fieldMap=a.fieldMap;f._templates=b;f._info=c;f._scaleFn=d;return f}g.__extends(e,h);e.fromDictionaryRenderer=function(a,b,c){return g.__awaiter(this,void 0,void 0,function(){var d;
return g.__generator(this,function(f){switch(f.label){case 0:return a.fetchResources({spatialReference:c.spatialReference,fields:c.fields}),[4,I(a.scaleExpression,c)];case 1:return d=f.sent(),[2,new e(a,b,c,d)]}})})};e.prototype._analyzeFeature=function(a,b,c,d,f){return g.__awaiter(this,void 0,void 0,function(){var e,h,q,k,v,r,w,n,u,l,p,t;return g.__generator(this,function(m){switch(m.label){case 0:e=a.attributes[b];h=this._fidToAttributeHash.get(e);q=this._hashAttributes(a);if(h===q)return[2];if(k=
this._attributeHashToGroup.has(q))return[3,4];v=g.__assign(g.__assign({},d),{spatialReference:this._info.spatialReference,abortOptions:f,fields:this._info.fields});r=this._scaleFn(a,c,d);return[4,this._renderer.getSymbolAsync(a,v)];case 1:return w=m.sent(),[4,x.expandSymbol(w,this._info,f)];case 2:n=m.sent();if("expanded-cim"!==n.type)return D.error(new F("mapview-bad-type","Found unexpected type "+n.type+" in dictionary response")),[2];u=0;for(l=n.layers;u<l.length;u++)p=l[u],p.scaleFactor=r,p.templateHash+=
"-"+r,"text"===p.type&&"string"===typeof p.text&&-1<p.text.indexOf("[")&&(p.text=H.createLabelOverrideFunction(this._fieldMap,p.text,p.cim.textCase));return[4,this._templates.createTemplateGroup(n,null,this._renderer)];case 3:t=m.sent(),this._attributeHashToGroup.set(q,t),m.label=4;case 4:return this._fidToAttributeHash.set(e,q),[2]}})})};e.prototype.analyze=function(a,b,c,d,e){return g.__awaiter(this,void 0,void 0,function(){var f,h=this;return g.__generator(this,function(g){switch(g.label){case 0:return f=
b.map(function(b){return h._analyzeFeature(b,a,c,d,e)}),[4,A.all(f)];case 1:return g.sent(),[2]}})})};e.prototype.match=function(a,b){a=this._fidToAttributeHash.get(b.attributes[a]);return this._attributeHashToGroup.get(a)};e.prototype._hashAttributes=function(a){var b="",c;for(c in this._fieldMap)b+=". "+a.attributes[this._fieldMap[c]];return b};return e}(k);y.DictionaryMatcher=t;k=function(h){function e(a){var b=h.call(this)||this;b._templates=a;return b}g.__extends(e,h);e.prototype.match=function(a,
b){return G.isNone(b.symbol)?0:b.groupId?b.groupId:this._templates.createTemplateGroup(b.symbol,null,null)};return e}(k);y.GraphicMatcher=k});