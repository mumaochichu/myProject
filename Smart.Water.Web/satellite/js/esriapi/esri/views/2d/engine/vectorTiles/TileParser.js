// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/pbf ../../../../core/promiseUtils ./BackgroundBucket ./CircleBucket ./Feature ./FillBucket ./LineBucket ./SourceLayerData ./SymbolBucket ../webgl/TileClipper ../../tiling/enums".split(" "),function(wa,xa,I,na,J,oa,pa,qa,ra,sa,ta,ua,n,va){return function(){function e(b,a,l){this._pbfTiles={};this._tileClippers={};this._client=l;this._tile=a;this._layers=a.getLayers();var g=a.tileKey.split("/").map(parseFloat);a=g[0];l=g[1];g=g[2];this._level=a;for(var e=
Math.max(8,Math.round(1*this._level)-8),c=0,h=Object.keys(b);c<h.length;c++){var k=h[c],d=b[k];this._pbfTiles[k]=new na(new Uint8Array(d.protobuff),new DataView(d.protobuff));if(d.refKey&&(d=d.refKey.split("/").map(parseFloat)[0],d=a-d,0<d)){var p=(1<<d)-1;this._tileClippers[k]=new n.TileClipper(d,l&p,g&p,8,e)}this._tileClippers[k]||(this._tileClippers[k]=new n.SimpleBuilder)}}e.prototype.parse=function(b){return I.__awaiter(this,void 0,void 0,function(){var a,l,g,e,c,h,k,d,p,t,x,n,q,u,K,f,r,L,fa,
ga,y,M,N,O,z,A,B,P,ha,C,Q,m,v,R,w,S,T,U,V,ia,ja,D,W,ka,E,X,Y,F,Z,G,aa,ba,H,ca,la,ma,da,ea;return I.__generator(this,function(I){a=b&&b.signal;l=this._parseTileData(this._pbfTiles);g=this._layers;e=this._level;h=[];k=this._tileClippers;d={};p={};for(t=g.length-1;0<=t;t--)if(c=g[t],!(c.minzoom&&e<Math.floor(c.minzoom)||c.maxzoom&&e>=c.maxzoom||c.layout&&c.layout.visibility&&"none"===c.layout.visibility||0===c.type)&&l[c.source]&&k[c.source]&&(x=l[c.source],n=k[c.source],q=c.sourceLayer,u=x[q]))if((K=
p[c.source])||(K=p[c.source]=new Set),K.add(c.sourceLayer),f=this._createBucket(c))f.layerIndex=t,f.layerExtent=u.extent,f.tileClipper=n,(r=d[c.source])||(r=d[c.source]={}),(L=r[q])||(L=r[q]=[]),L.push(f);fa=10*this._level;ga=10*(this._level+1);y=[];M=[];N=[];O=[];z=new Set;A={};B=[];P=[];ha=function(a){p[a].forEach(function(b){B.push(b);P.push(a)})};C=0;for(Q=Object.keys(p);C<Q.length;C++)m=Q[C],ha(m);for(v=0;v<B.length;v++)if(m=P[v],R=B[v],l[m]&&d[m]&&(x=l[m],u=x[R],r=d[m],(w=r[R])&&0!==w.length)){if(J.isAborted(a))return[2,
void 0];for(S=u.getData();S.next(2);){T=S.getMessage();U=new qa(T,u);T.release();if(V=U.values){if((ia=V._minzoom)&&ia>=ga)continue;if((ja=V._maxzoom)&&ja<=fa)continue}D=0;for(W=w;D<W.length;D++)f=W[D],f.pushFeature(U)}}ka=this._tile;E=0;for(X=Object.keys(d);E<X.length;E++)for(q in m=X[E],Y=d[m],Y)for(w=Y[q],F=0,Z=w;F<Z.length;F++)f=Z[F],f.hasFeatures()&&(3===f.layer.type?(y.push(f),ka.addBucket(f)):f.layer.refLayerId?N.push(f):(M.push(f),O[f.layer.id]=f));G=0;for(aa=y;G<aa.length;G++)ba=f=aa[G],
ba.getResources(ba.tileClipper,z,A);if(this._tile.status===va.TileStatus.INVALID)return[2,J.resolve([])];H=[];ca=this._tile.getWorkerTileHandler();0<z.size&&(la=ca.fetchSprites(z,this._client,b),H.push(la));for(da in A)ea=A[da],0<ea.size&&(ma=ca.fetchGlyphs(this._tile.tileKey,da,ea,this._client,b),H.push(ma));return[2,J.all(H).then(function(){for(var a=0,b=M;a<b.length;a++){var c=b[a];c.processFeatures(c.tileClipper);h.push(c)}a=0;for(b=N;a<b.length;a++){var c=b[a],d=O[c.layer.refLayerId];d&&(d.assignBufferInfo(c),
h.push(c))}a=0;for(b=y;a<b.length;a++)c=b[a],c.processFeatures(c.tileClipper),h.push(c);h.sort(function(a,b){return a.layerIndex-b.layerIndex});return h})]})})};e.prototype._parseTileData=function(b){for(var a={},e=0,g=Object.keys(b);e<g.length;e++){for(var n=g[e],c=b[n],h={};c.next();)switch(c.tag()){case 3:var k=c.getMessage(),d=new ta(k);k.release();h[d.name]=d;break;default:c.skip()}a[n]=h}return a};e.prototype._createBucket=function(b){switch(b.type){case 0:return this._createBackgroundBucket(b);
case 1:return this._createFillBucket(b);case 2:return this._createLineBucket(b);case 4:return this._createCircleBucket(b);case 3:return this._createSymbolBucket(b)}};e.prototype._createBackgroundBucket=function(b){return new oa(b,this._level)};e.prototype._createFillBucket=function(b){var a=this._tile;return new ra(b,this._level,b.hasDataDrivenFill?a.fillDDVertexBuffer:a.fillVertexBuffer,a.fillIndexBuffer,b.hasDataDrivenOutline?a.outlineDDVertexBuffer:a.outlineVertexBuffer,a.outlineIndexBuffer)};
e.prototype._createLineBucket=function(b){var a=this._tile;return new sa(b,this._level,b.hasDataDrivenLine?a.lineDDVertexBuffer:a.lineVertexBuffer,a.lineIndexBuffer)};e.prototype._createCircleBucket=function(b){var a=this._tile;return new pa(b,this._level,a.circleVertexBuffer,a.circleIndexBuffer)};e.prototype._createSymbolBucket=function(b){var a=this._tile;return new ua(b,this._level,b.hasDataDrivenIcon?a.iconDDVertexBuffer:a.iconVertexBuffer,a.iconIndexBuffer,b.hasDataDrivenText?a.textDDVertexBuffer:
a.textVertexBuffer,a.textIndexBuffer,a.placementEngine,a.getWorkerTileHandler())};return e}()});