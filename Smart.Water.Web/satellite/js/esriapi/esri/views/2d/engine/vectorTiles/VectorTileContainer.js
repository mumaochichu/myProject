// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../geometry/support/aaBoundingRect ../../engine ./FadeRecorder ../webgl/definitions ../webgl/enums ../webgl/TiledDisplayObject ../../tiling/TileCoverage ../../tiling/TileKey".split(" "),function(v,w,h,D,E,F,A,G,H,p,q,I,J,K){function B(f,e){if(f){var a=f.getLayoutProperty("visibility");if(!a||"none"!==a.getValue()&&(void 0===f.minzoom||f.minzoom<e+1E-6)&&(void 0===f.maxzoom||f.maxzoom>=
e-1E-6))return!0}return!1}Object.defineProperty(w,"__esModule",{value:!0});v=function(f){function e(){var a=null!==f&&f.apply(this,arguments)||this;a._backgroundTiles=[];a._fadeRecorder=new H.FadeRecorder(400);a._pointToCallbacks=new Map;a._parsedDataQueue=new Map;return a}h.__extends(e,f);e.prototype.destroy=function(){this.removeAllChildren();this.children.forEach(function(a){return a.destroy()});this._spriteMosaic&&this._spriteMosaic.dispose();this._glyphMosaic&&this._glyphMosaic.dispose()};Object.defineProperty(e.prototype,
"updating",{get:function(){return 0<this._parsedDataQueue.size},enumerable:!0,configurable:!0});e.prototype.setStyleResources=function(a,b,d){this._spriteMosaic=a;this._glyphMosaic=b;this._styleRepository=d};e.prototype.hitTest=function(a,b){return h.__awaiter(this,void 0,void 0,function(){var d,k;return h.__generator(this,function(e){d=[a,b];k=F.createResolver();this._pointToCallbacks.set(d,k);this.requestRender();return[2,k.promise]})})};e.prototype.setTileData=function(a,b){var d=this.stage;d.dataUploadCounter<
p.MAX_GPU_UPLOADS_PER_FRAME&&b?(a.setData(b.tileData,b.client,b.refKeys),d.dataUploadCounter++):b?(this._parsedDataQueue.set(a,b),this.emit("updating-change")):a.setData(null,null)};e.prototype.createRenderParams=function(a){return h.__assign(h.__assign({},f.prototype.createRenderParams.call(this,a)),{renderPass:null,styleLayer:null,styleLayerId:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,fadeRecorder:this._fadeRecorder,hasClipping:!!this._clippingInfos})};e.prototype.doRender=
function(a){!this.visible||a.drawPhase!==q.WGLDrawPhase.MAP&&a.drawPhase!==q.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||f.prototype.doRender.call(this,a)};e.prototype.removeChild=function(a){this._parsedDataQueue.has(a)&&(this._parsedDataQueue.delete(a),this.emit("updating-change"));return f.prototype.removeChild.call(this,a)};e.prototype.renderChildren=function(a){if(a.drawPhase===q.WGLDrawPhase.DEBUG)f.prototype.renderChildren.call(this,a);else{var b=this.stage;if(0<this._parsedDataQueue.size&&
b.dataUploadCounter<p.MAX_GPU_UPLOADS_PER_FRAME){for(var d=D.pairsOfMap(this._parsedDataQueue),k=0;k<d.length&&b.dataUploadCounter<p.MAX_GPU_UPLOADS_PER_FRAME;k++){var e=d[k][0],c=d[k][1];e.setData(c.tileData,c.client,c.refKeys);this._parsedDataQueue.delete(e);b.dataUploadCounter++}this.emit("updating-change")}this._fadeRecorder.recordLevel(a.displayLevel);this._doRender(a);(0<this._parsedDataQueue.size||this._fadeRecorder.needsRedraw())&&this.requestRender();0<this._pointToCallbacks.size&&(b=a.context,
d=b.getBoundFramebufferObject(),a.drawPhase=q.WGLDrawPhase.HITTEST,k=a.painter.effects.hittest,k.bind(a),this._doRender(a),k.draw(a,this._pointToCallbacks,6),b.bindFramebuffer(d))}};e.prototype.removeAllChildren=function(){this._parsedDataQueue.clear();for(var a=0;a<this.children.length;a++)this.children[a].dispose();f.prototype.removeAllChildren.call(this)};e.prototype._doRender=function(a){var b=a.context,d=this._styleRepository,e=d.layers,C=!0;a.drawPhase===q.WGLDrawPhase.HITTEST&&(C=!1);0<d.backgroundBucketIds.length&&
(a.renderPass="background",this._renderBackgroundLayers(a,d.backgroundBucketIds));f.prototype.renderChildren.call(this,a);for(var d=this.children.filter(function(a){return a.visible}),c=0;c<d.length;c++){var l=d[c];l.triangleCount=0;l.commitChanges()}b.setStencilWriteMask(0);b.setColorMask(!0,!0,!0,!0);b.setStencilOp(7680,7680,7681);b.setStencilTestEnabled(!0);b.setBlendingEnabled(!1);b.setDepthTestEnabled(!0);b.setDepthWriteEnabled(!0);b.setDepthFunction(515);b.setClearDepth(1);b.clear(b.gl.DEPTH_BUFFER_BIT);
a.renderPass="opaque";for(c=e.length-1;0<=c;c--)this._renderStyleLayer(c,a,d);b.setDepthWriteEnabled(!1);b.setBlendingEnabled(C);b.setBlendFunctionSeparate(1,771,1,771);a.renderPass="translucent";for(c=0;c<e.length;c++)this._renderStyleLayer(c,a,d);b.setDepthTestEnabled(!1);a.renderPass="symbol";for(c=0;c<e.length;c++)this._renderStyleLayer(c,a,d);b.bindVAO();b.setStencilTestEnabled(!0);b.setBlendingEnabled(!0)};e.prototype._renderStyleLayer=function(a,b,d){var e=b.painter,f=b.renderPass,c=this._styleRepository.layers[a];
if(void 0!==c){var l;switch(c.type){case 0:return;case 1:if("opaque"!==f&&"translucent"!==b.renderPass)return;l="vtlFill";break;case 2:if("translucent"!==f)return;l="vtlLine";break;case 4:if("symbol"!==f)return;l="vtlCircle";break;case 3:if("symbol"!==f)return;l="vtlSymbol"}f=b.displayLevel;if(!(0===d.length||void 0!==c.minzoom&&c.minzoom>=f+1E-6||void 0!==c.maxzoom&&c.maxzoom<f-1E-6))for(b.styleLayerId=a,b.styleLayer=c,c=0;c<d.length;c++)if(d[c].layerData[a]){e.renderObjects(b,d,l);break}}};e.prototype._renderBackgroundLayers=
function(a,b){for(var d=a.context,e=a.displayLevel,f=a.painter,c=a.state,l=this._styleRepository,r=!1,t=0;t<b.length;t++){var n=b[t];if(B(l.layers[n],e)){r=!0;break}}if(r){var r=this._tileInfoView.getTileCoverage(a.state,0,"smallest"),n=r.spans,h=r.lodInfo,p=h.level,x=A.create(),t=[];if(this._renderPasses){var u=this._renderPasses[0];E.isSome(this._clippingInfos)&&(u.brushes[0].prepareState(a,this._clippingInfos[0]),u.brushes[0].drawMany(a,this._clippingInfos))}for(var u=this._backgroundTiles,y=0,
g,z=0;z<n.length;z++)for(var m=n[z],v=m.row,w=m.colTo,m=m.colFrom;m<=w;m++)y<u.length?(g=u[y],g.key.set(p,v,h.normalizeCol(m),h.getWorldForColumn(m)),this._tileInfoView.getTileBounds(x,g.key,!1),g.bounds=x,g.coords[0]=x[0],g.coords[1]=x[3]):(g=new K(p,v,h.normalizeCol(m),h.getWorldForColumn(m)),g=new I.TiledDisplayObject(g,this._tileInfoView.getTileBounds(A.create(),g),[512,512],[4096,4096]),u.push(g)),g.setTransform(c,this._tileInfoView.getTileResolution(g.key)),t.push(g),y++;d.setStencilWriteMask(0);
d.setColorMask(!0,!0,!0,!0);d.setStencilOp(7680,7680,7681);d.setStencilFunction(514,0,255);c=!0;a.drawPhase===q.WGLDrawPhase.HITTEST&&(c=!1);d.setStencilTestEnabled(c);for(d=0;d<b.length;d++)n=b[d],c=l.layers[n],B(c,e)&&(a.styleLayerId=n,a.styleLayer=c,f.renderObjects(a,t,"vtlBackground"));J.pool.release(r)}};return e}(G.TileContainer);w.VectorTileContainer=v});