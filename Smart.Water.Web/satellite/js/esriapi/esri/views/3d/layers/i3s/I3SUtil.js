// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../request ../../../../core/arrayUtils ../../../../core/Error ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/typedArrayUtil ../../../../core/wgs84Constants ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/quat ../../../../core/libs/gl-matrix-2/quatf32 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/SpatialReference ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/webMercatorUtils ../../../../tasks/support/Query ./I3SBinaryReader ./I3SProjectionUtil ../support/edgeUtils ../support/symbolColorUtils ../../support/orientedBoundingBox ../../support/projectionUtils".split(" "),
function(sa,g,Y,Z,p,x,q,H,I,aa,J,y,ba,k,ca,K,da,v,ea,fa,ga,ha,L,ia,z,r){function E(a){return a&&parseInt(a.substring(a.lastIndexOf("/")+1,a.length),10)}function M(a,b){var c=b[0],d=b[1];b=b[3];var f=a[0]-c,c=c-a[2],h=a[1]-d;a=d-a[3];var d=Math.max(f,c,0),e=Math.max(h,a,0),d=d*d+e*e;return d>b*b?0:0<d?1:-Math.max(f,c,h,a)>b?3:2}function N(a,b,c){var d=[],f=c&&c.missingFields;c=c&&c.originalFields;for(var h=0;h<a.length;h++){for(var e=a[h],l=e.toLowerCase(),w=!1,g=0,k=b;g<k.length;g++){var O=k[g];if(l===
O.name.toLowerCase()){d.push(O.name);w=!0;c&&c.push(e);break}}!w&&f&&f.push(e)}return d}function ja(a,b){return a.filter(function(a){return a!==b}).concat([b])}function ka(a,b,c,d){b.sort(function(a,b){return a.attributes[c]-b.attributes[c]});var f=b.map(function(a){return a.attributes[c]}),h=[],e=N(d,a.fields,{originalFields:h});return P(a,f,e).then(function(a){for(var c=0;c<b.length;c++){var d=b[c],f=a[c],g={};if(d.attributes)for(var l in d.attributes)g[l]=d.attributes[l];for(var t=0;t<h.length;t++)g[h[t]]=
f[e[t]];d.attributes=g}return b})}function P(a,b,c){var d=a.capabilities.query.maxRecordCount;if(null!=d&&b.length>d)return d=la(b,d),q.all(d.map(function(b){return P(a,b,c)})).then(ma);d=new fa({objectIds:b,outFields:c,orderByFields:[a.objectIdField]});return a.queryFeatures(d).then(function(a){if(a&&a.features&&a.features.length===b.length)return a.features.map(function(a){return a.attributes});throw new p("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer");
})}function na(a,b,c,d,f){for(var e=[],g=0;g<b.length;g++){var l=b[g];l&&-1!==f.indexOf(l.name)&&e.push({url:a+"/nodes/"+c.resources.attributes+"/attributes/"+l.key+"/0",storageInfo:l})}return q.eachAlways(e.map(function(a){return Y(a.url,{responseType:"array-buffer"}).then(function(b){return ga.readBinaryAttribute(a.storageInfo,b.data)})})).then(function(a){for(var b=[],c=0;c<d.length;c++){for(var f=d[c],h={},t=0;t<a.length;t++)null!=a[t].value&&(h[e[t].storageInfo.name]=Q(a[t].value,f));b.push(h)}return b})}
function Q(a,b){if(!a)return null;b=a[b];return H.isInt16Array(a)?b===oa?null:b:H.isInt32Array(a)?b===pa?null:b:b!==b?null:b}function la(a,b){var c=a.length;b=Math.ceil(c/b);for(var d=[],f=0;f<b;f++)d.push(a.slice(Math.floor(c*f/b),Math.floor(c*(f+1)/b)));return d}function ma(a){for(var b=[],c=0;c<a.length;c++)b=b.concat(a[c]);return b}function R(a){var b=new K(E(a.store.indexCRS||a.store.geographicCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function S(a){var b=new K(E(a.store.vertexCRS||
a.store.projectedCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function A(a,b,c){if(!ea.canProject(a,b))throw new p("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===c&&a.isGeographic)throw new p("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{});}function T(a,b,c){var d=R(a);a=S(a);A(d,b,c);A(a,b,c)}function U(a,b,c,d,
f,h){void 0===f&&(f=0);void 0===h&&(h=!1);if(d!==B||h)a===c?(c.center[2]+=f,r.bufferToBuffer(c.center,b,0,c.center,d,0,1)):(k.vec3.set(c.center,a.center[0],a.center[1],a.center[2]+f),r.bufferToBuffer(c.center,b,0,c.center,d,0,1),y.quat.copy(c.quaternion,a.quaternion),k.vec3.copy(c.halfSize,a.halfSize));else if(b.isGeographic)d=1+Math.max(0,f)/(I.wgs84Radius+a.center[2]),k.vec3.set(c.center,a.center[0],a.center[1],a.center[2]+f),r.bufferToBuffer(c.center,b,0,c.center,B,0,1),y.quat.copy(c.quaternion,
a.quaternion),y.quat.conjugate(n,a.quaternion),k.vec3.set(e,0,0,1),k.vec3.transformQuat(e,e,n),k.vec3.set(e,a.halfSize[0]*Math.abs(e[0]),a.halfSize[1]*Math.abs(e[1]),a.halfSize[2]*Math.abs(e[2])),k.vec3.scale(e,e,qa),k.vec3.add(c.halfSize,a.halfSize,e),k.vec3.scale(c.halfSize,c.halfSize,d);else{z.corners(a,F);k.vec3.set(c.center,a.center[0],a.center[1],a.center[2]+f);r.computeLinearTransformation(b,c.center,m,B);k.vec3.set(c.center,m[12],m[13],m[14]);d=2*Math.sqrt(1+m[0]+m[5]+m[10]);n[0]=(m[6]-m[9])/
d;n[1]=(m[8]-m[2])/d;n[2]=(m[1]-m[4])/d;n[3]=.25*d;y.quat.multiply(c.quaternion,n,a.quaternion);y.quat.conjugate(n,c.quaternion);for(var g=h=d=a=0,l=F;g<l.length;g++){var w=l[g];w[2]+=f;r.bufferToBuffer(w,b,0,w,B,0,1);k.vec3.sub(e,w,c.center);k.vec3.transformQuat(e,e,n);a=Math.max(a,Math.abs(e[0]));d=Math.max(d,Math.abs(e[1]));h=Math.max(h,Math.abs(e[2]))}k.vec3.set(c.halfSize,a,d,h)}}Object.defineProperty(g,"__esModule",{value:!0});g.DDS_ENCODING_STRING="image/vnd-ms.dds";g.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=
["image/jpeg","image/png"];g.extractWkid=E;g.selectEncoding=function(a,b){if(b)for(b=0;b<a.length;b++)if(a[b].encoding===g.DDS_ENCODING_STRING)return a[b];for(b=0;b<a.length;b++)if(-1<g.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(a[b].encoding))return a[b];return null};g.findIntersectingNodes=function(a,b,c,d,f,e){f.traverse(c,function(c){var f=c.mbs;b!==d&&(f=ra,r.mbsToMbs(c.mbs,d,f,b));f=M(a,f);if(0===f)return!1;e(c,f);return!0})};g.filterInPlace=function(a,b,c){for(var d=0,f=0,e=0;e<b.length&&
d<a.length;e++)a[d]===b[e]&&(c(e)&&(a[f]=a[d],f++),d++);a.length=f};var u=da.create();g.getClipAABB=function(a,b){if(0===b.rotationScale[1]&&0===b.rotationScale[2]&&0===b.rotationScale[3]&&0===b.rotationScale[5]&&0===b.rotationScale[6]&&0===b.rotationScale[7])return u[0]=(a[0]-b.position[0])/b.rotationScale[0],u[1]=(a[1]-b.position[1])/b.rotationScale[4],u[2]=(a[2]-b.position[2])/b.rotationScale[8],u[3]=(a[3]-b.position[0])/b.rotationScale[0],u[4]=(a[4]-b.position[1])/b.rotationScale[4],u[5]=(a[5]-
b.position[2])/b.rotationScale[8],u};var ra=ca.vec4f64.create();g.intersectBoundingRectWithMbs=M;g.intersectBoundingBoxWithMbs=function(a,b){var c=b[0],d=b[1],f=b[2];b=b[3];var e=a[0]-c,c=c-a[3],g=a[1]-d,d=d-a[4],l=a[2]-f;a=f-a[5];var f=Math.max(e,c,0),k=Math.max(g,d,0),m=Math.max(l,a,0),f=f*f+k*k+m*m;return f>b*b?0:0<f?1:-Math.max(e,c,g,d,l,a)>b?3:2};g.findFieldsCaseInsensitive=N;g.whenGraphicAttributes=function(a,b,c,d,e,g){!0===(g&&g.populateObjectId)&&(d=ja(d,c));if(0===b.length)return q.resolve(b);
g=a.associatedLayer;var f=a.attributeStorageInfo;if(g)return ka(g,b,c,d);if(f){b=e(b);if(!b)return q.reject(new p("scenelayer:features-not-loaded","Tried to query attributes for unloaded features"));var h=a.parsedUrl.path;return q.all(b.map(function(a){return na(h,f,a.node,a.indices,d).then(function(b){for(var c=0;c<a.graphics.length;c++){var d=a.graphics[c],e=b[c];if(d.attributes)for(var f in d.attributes)f in e||(e[f]=d.attributes[f]);d.attributes=e}return a.graphics})})).then(Z.flatten)}return q.reject(new p("scenelayer:no-attribute-source",
"This scene layer does not have a source for attributes available"))};var oa=-Math.pow(2,15),pa=-Math.pow(2,31);g.getCachedAttributeValue=Q;g.getIndexCrs=R;g.getVertexCrs=S;g.getCacheKeySuffix=function(a,b){return b===r.SphericalECEFSpatialReference?"@ECEF":a.equals(b)?"":null!=b.wkid?"@"+b.wkid:null};g.checkSpatialReference=A;g.checkSpatialReferences=T;g.checkSceneLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(b=a.store.defaultGeometrySchema,b=!!(null!=b.geometryType&&
"triangles"!==b.geometryType||null!=b.topology&&"PerAttributeArray"!==b.topology||null==b.vertexAttributes||null==b.vertexAttributes.position));if(b)throw new p("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:a.parsedUrl.path});};g.checkSceneLayerCompatibleWithView=function(a,b){T(a,b.spatialReference,b.viewingMode)};g.checkPointCloudLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(a=a.store.defaultGeometrySchema,
b=!!(null==a.geometryType||"points"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||null!=a.encoding&&""!==a.encoding&&"lepcc-xyz"!==a.encoding||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new p("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});};g.checkPointCloudLayerCompatibleWithView=function(a,b){A(a.spatialReference,b.spatialReference,b.viewingMode)};g.rendererNeedsTextures=function(a){if(null==
a||"simple"!==a.type&&"class-breaks"!==a.type&&"unique-value"!==a.type||("unique-value"===a.type||"class-breaks"===a.type)&&null==a.defaultSymbol)return!0;a=a.getSymbols();if(0===a.length)return!0;for(var b=0;b<a.length;b++){var c=a[b];if("mesh-3d"!==c.type||0===c.symbolLayers.length)return!0;for(var d=0,c=c.symbolLayers.items;d<c.length;d++){var e=c[d];if("fill"!==e.type||x.isNone(e.material)||x.isNone(e.material.color)||"replace"!==e.material.colorMixMode)return!0}}return!1};g.transparentEdgeMaterial=
L.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0});var V=function(){return function(){this.material=this.edgeMaterial=null;this.castShadows=!0}}();g.SymbolInfo=V;g.getSymbolInfo=function(a){var b=new V,c=!1,d=!1,e=0;for(a=a.symbolLayers.items;e<a.length;e++){var g=a[e];if("fill"===g.type&&g.enabled){var k=g.material,l=g.edges;x.isSome(k)&&!c&&(c=k.color,k=ia.parseColorMixMode(k.colorMixMode),x.isSome(c)?b.material={color:[c.r/255,c.g/255,c.b/255],alpha:c.a,colorMixMode:k}:b.material={color:[1,
1,1],alpha:1,colorMixMode:1},b.castShadows=g.castShadows,c=!0);x.isSome(l)&&!d&&(b.edgeMaterial=L.createMaterialFromEdges(l,{}),d=!0)}}b.material||(b.material={color:[1,1,1],alpha:1,colorMixMode:1});return b};g.addWraparound=function(a,b){return(a|0)+(b|0)|0};g.transformObb=U;g.computeAuthorativeOBB=function(a,b,c,d,g,h){var f=ha.computeGlobalTransformation(a.mbs,g,c,b);aa.mat4.invert(C,f);var l,m=function(){if(!l)if(l=F,v.empty(D),x.isSome(a.obb)&&!a.isComputedObb){U(a.obb,c,W,b,g,a.isComputedObb);
z.corners(W,l);for(var d=0,f=l;d<f.length;d++){var h=f[d];k.vec3.transformMat4(h,h,C);v.expandPointInPlace(D,h)}}else for(h=a.mbs,d=h[3],r.vectorToVector(h,c,e,b),k.vec3.transformMat4(e,e,C),e[2]+=g,f=0;8>f;++f){var m=f&1?d:-d,n=f&2?d:-d,p=f&4?d:-d,h=l[f];k.vec3.copy(h,[e[0]+m,e[1]+n,e[2]+p]);v.expandPointInPlace(D,h)}},n=Infinity,p=-Infinity,u=function(a){if("replace"===a.type&&(a=a.geometry,a.hasZ)){v.empty(G);var c=a.spatialReference||d;a=a.rings.reduce(function(a,d){return d.reduce(function(a,
d){r.vectorToVector(d,c,e,b);k.vec3.transformMat4(e,e,C);v.expandPointInPlace(G,e);return Math.min(e[2],a)},a)},Infinity);m();v.intersects(D,G)&&(n=Math.min(n,a),p=Math.max(p,a))}};h.forEach(function(a){return u(a)});if(Infinity===n)return null;h=function(a,b,c){k.vec3.transformMat4(e,c,f);a[b+0]=e[0];a[b+1]=e[1];a[b+2]=e[2];b+=24;c[2]=n;k.vec3.transformMat4(e,c,f);a[b+0]=e[0];a[b+1]=e[1];a[b+2]=e[2];b+=24;c[2]=p;k.vec3.transformMat4(e,c,f);a[b+0]=e[0];a[b+1]=e[1];a[b+2]=e[2]};for(var q=0;8>q;++q)h(X.data,
3*q,l[q]);return z.compute(X)};var B=r.SphericalECEFSpatialReference,qa=1/(1-I.wgs84Flattening)-1,m=J.mat4f64.create(),n=ba.quatf32.create(),F=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],G=v.create(),D=v.create(),W=z.create(),e=[0,0,0],X={data:Array(72),size:3,offsetIdx:0,strideIdx:3},C=J.mat4f64.create()});