// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4 ../../../../layers/graphics/dehydratedFeatures ../graphics/elevationAlignmentUtils ../graphics/ElevationContext ../graphics/featureExpressionInfoUtils ./I3SUtil ../../support/geometryUtils ../../support/orientedBoundingBox ../../support/projectionUtils".split(" "),function(v,w,f,c,h,r,t,m,u,n,p,k,l,q){return function(){function d(a,
b,e,c,d,g,f){void 0===f&&(f={});this.indexSR=a;this._renderCoordsHelper=b;this.extent=c;this.elevationProvider=d;this.options=f;this.fp=k.frustum.create();this._poi=h.vec3f64.create();this.minDistance=Infinity;this.maxDistance=0;this.maxLodLevel=2;this._tmp1=h.vec3f64.create();this._tmp2=h.vec3f64.create();this._tmp3=h.vec3f64.create();this._tmp0=h.vec3f64.create();this.screenspaceErrorBias=f.screenspaceErrorBias||1;this.progressiveLoadFactor=f.progressiveLoadFactor||1;this.updateCamera(e);this.engineSR=
this._renderCoordsHelper.spatialReference;this.updateElevationInfo(g);this.tmpPoint=t.makeDehydratedPoint(0,0,0,a)}d.prototype.updateElevationInfo=function(a){null==a?this._elevationContext=null:(this._elevationContext=u.ElevationContext.fromElevationInfo(a),this._elevationContext.updateFeatureExpressionInfoContext(n.createContextWithoutExpressionSupport(n.extractExpressionInfo(a,!1))))};d.prototype.updateCamera=function(a){k.frustum.fromMatrix(a.viewMatrix,a.projectionMatrix,this.fp);this._screenSizeFactor=
1/(a.perScreenPixelRatio/2);this._camPos=a.eye;this.minDistance=Infinity;this.maxDistance=0};d.prototype.setPointOfInterest=function(a){c.vec3.copy(this._poi,a)};d.prototype.updateScreenSpaceErrorBias=function(a){var b=this.screenspaceErrorBias;this.screenspaceErrorBias=a;return b};d.prototype.updateExtent=function(a){this.extent=a};d.prototype.getRenderMbs=function(a){var b=a.renderMbs;0>b[3]&&(r.vec4.copy(b,a.mbs),this._elevationContext&&1E5>b[3]&&(this.tmpPoint.x=b[0],this.tmpPoint.y=b[1],this.tmpPoint.z=
b[2],b[2]=m.evaluateElevationAlignmentAtPoint(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),q.mbsToMbs(b,this.indexSR,b,this.engineSR));return b};d.prototype.getRenderObb=function(a){var b=a.authorativeObb||a.obb;if(!(f.isNone(b)||0>b.halfSize[0])){f.isNone(a.renderObb)&&(a.renderObb=l.create());var e=a.renderObb;if(0>e.halfSize[0]){if(f.isSome(a.authorativeObb))return l.set(a.authorativeObb,e),a.authorativeObb;var c=0;this._elevationContext&&1E5>a.mbs[3]&&
(this.tmpPoint.x=b.center[0],this.tmpPoint.y=b.center[1],this.tmpPoint.z=b.center[2],c=m.evaluateElevationAlignmentAtPoint(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-b.center[2]);p.transformObb(b,this.indexSR,e,this.engineSR,c,a.isComputedObb)}return e}};d.prototype.isNodeVisible=function(a){var b=this.getRenderMbs(a);if(!this.isMBSinExtent(b))return!1;a=this.getRenderObb(a);return f.isSome(a)?l.isVisible(a,this.fp):this.isMBSVisible(b)};d.prototype.isGeometryVisible=
function(a){a=this.getRenderObb(a);return f.isSome(a)?l.isVisible(a,this.fp):!0};d.prototype.isMBSinExtent=function(a){return this.extent?0!==p.intersectBoundingBoxWithMbs(this.extent,a):!0};d.prototype.isMBSVisible=function(a){return k.frustum.intersectsSphere(this.fp.planes,k.sphere.wrap(a[3],a))};d.prototype.screenSpaceDiameterMbs=function(a,b){var e=this.getRenderMbs(a);a=Math.sqrt(c.vec3.squaredDistance(e,this._camPos));e=a-e[3];this._updateMinMaxDistance(a);return 0>e?.5*Number.MAX_VALUE:b/
e*this._screenSizeFactor};d.prototype.calcCameraDistance=function(a){return this.calcCameraDistanceToCenter(a)-this.getRenderMbs(a)[3]};d.prototype.calcCameraDistanceToCenter=function(a){a=this.getRenderMbs(a);a=c.vec3.distance(a,this._camPos);this._updateMinMaxDistance(a);return a};d.prototype.calcAngleDependentLoD=function(a){a=this.getRenderMbs(a);var b=a[3];a=(Math.abs(a[0]*(a[0]-this._camPos[0])+a[1]*(a[1]-this._camPos[1])+a[2]*(a[2]-this._camPos[2]))/c.vec3.length(a)+b)/c.vec3.distance(a,this._camPos);
return Math.min(1,a)};d.prototype.hasLOD=function(a){return 0!==a.lodMetric};d.prototype.getDistancePlanarMode=function(a,b){var e=a[0]-b[0],c=a[1]-b[1];a=a[2]-b[2];e=e*e+c*c;b=b[3];if(e<=b*b)return Math.abs(a);b=Math.sqrt(e)-b;return Math.sqrt(a*a+b*b)};d.prototype.getDistanceGlobeMode=function(a,b){var e=c.vec3.length(b),d=c.vec3.length(a)-e;c.vec3.scale(this._tmp0,a,c.vec3.dot(a,b)/c.vec3.squaredLength(a));var f=c.vec3.squaredDistance(b,this._tmp0),g=b[3];if(f<=g*g)return Math.abs(d);b=c.vec3.scale(this._tmp0,
b,1/e);e=c.vec3.scale(this._tmp1,b,e-g*g/2/e);f=c.vec3.subtract(this._tmp2,a,e);f=c.vec3.subtract(this._tmp2,f,c.vec3.scale(this._tmp3,b,c.vec3.dot(b,f)));e=c.vec3.add(this._tmp2,e,c.vec3.scale(this._tmp2,f,g/c.vec3.length(f)));g=c.vec3.distance(a,e);2E5<=d&&(a=c.vec3.subtract(this._tmp1,a,e),a=c.vec3.dot(a,b)/c.vec3.length(a),.08>a&&(a=1E-4),g/=a);return g};d.prototype.getDistance=function(a,b){return this.engineSR===q.SphericalECEFSpatialReference?this.getDistanceGlobeMode(a,b):this.getDistancePlanarMode(a,
b)};d.prototype._updateMinMaxDistance=function(a){0<a?(this.minDistance=Math.min(this.minDistance,a),this.maxDistance=Math.max(this.maxDistance,a)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-a))};d.prototype.getLodLevel=function(a){if(0===a.lodMetric||!a.resources.hasFeatureData)return 0;if(0===a.childCount)return this.maxLodLevel;if(1>this.progressiveLoadFactor){var b=this.screenspaceErrorBias;return this.evaluateLODmetric(a,this.progressiveLoadFactor*this.screenspaceErrorBias)?
this.evaluateLODmetric(a,b)?2:1:0}return this.evaluateLODmetric(a,this.screenspaceErrorBias)?this.maxLodLevel:0};d.prototype.evaluateLODmetric=function(a,b){switch(a.lodMetric){case 2:var c=this.getRenderMbs(a),d=this.getDistance(this._camPos,c),f=2*d/this._screenSizeFactor;this._updateMinMaxDistance(d+c[3]);return a.maxError*b<=f;case 1:return b=this.screenSpaceDiameterMbs(a,a.mbs[3]*b),this.options.angleDependentLoD&&(b*=this.calcAngleDependentLoD(a)),b<a.maxError;case 3:return 10>this.screenSpaceDiameterMbs(a,
a.maxError)*b;case 4:return this.calcCameraDistance(a)>a.maxError*b}return!1};d.prototype.distToPOI=function(a){a=this.getRenderMbs(a);return c.vec3.distance(a,this._poi)-a[3]};d.prototype.distCameraToPOI=function(){return c.vec3.distance(this._camPos,this._poi)};return d}()});