// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define(["require","exports","../PixelBlock"],function(J,B,I){function H(d){var l=d.altitude,a=d.azimuth,q=d.hillshadeType,f=d.pixelSizePower,y=d.pixelSizeFactor,r=d.scalingType,p=d.isGCS,v=d.resolution,m="multi-directional"===q?2*d.zFactor:d.zFactor,w=v.x,e=v.y;d=m/(8*w);var t=m/(8*e);p&&.001<m&&(d/=111E3,t/=111E3);"adjusted"===r&&(p?(d=111E3*w,t=111E3*e,d=(m+Math.pow(d,f)*y)/(8*d),t=(m+Math.pow(t,f)*y)/(8*t)):(d=(m+Math.pow(w,f)*y)/(8*w),t=(m+Math.pow(e,f)*y)/(8*e)));var k=(90-l)*Math.PI/180,l=Math.cos(k),
h=(360-a+90)*Math.PI/180,a=Math.sin(k)*Math.cos(h),k=Math.sin(k)*Math.sin(h),f=[315,270,225,360,180,0],y=[60,60,60,60,60,90],m=new Float32Array([3,5,3,2,1,4]),g=m.reduce(function(a,d){return a+d}),m=m.map(function(a){return a/g}),r="multi-directional"===q?f.length:1,p=new Float32Array(6),e=new Float32Array(6),w=new Float32Array(6);if("multi-directional"===q)for(var n=0;n<r;n++)l=y[n],a=f[n],k=(90-l)*Math.PI/180,l=Math.cos(k),h=(360-a+90)*Math.PI/180,a=Math.sin(k)*Math.cos(h),k=Math.sin(k)*Math.sin(h),
p[n]=l,e[n]=a,w[n]=k;else p.fill(l),e.fill(a),w.fill(k);return{resolution:v,factor:[d,t],sinZcosA:a,sinZsinA:k,cosZ:l,sinZcosAs:e,sinZsinAs:w,cosZs:p,weights:m,hillshadeType:["traditional","multi-directional"].indexOf(q)}}Object.defineProperty(B,"__esModule",{value:!0});var G=function(d){return d&&"esri.layers.support.PixelBlock"===d.declaredClass&&d.pixels&&0<d.pixels.length};B.calculateHillshadeParams=H;B.hillshade=function(d,l){if(!G(d))return d;var a=d.width,q=d.height,f=d.mask,y=new Uint8Array(a*
q);f&&y.set(f);var r=H(l),p=r.factor,v=r.sinZcosA,m=r.sinZsinA,w=r.cosZ,e=r.sinZcosAs,t=r.sinZsinAs,k=r.cosZs,r=r.weights,h=p[0],p=p[1];l=l.hillshadeType;for(var g=d.pixels[0],n=new Uint8Array(a*q),C,E,D,x,B,z,F,A,u=1;u<q-1;u++)for(var c=u*a,b=1;b<a-1;b++)if(f&&!f[c+b])n[c+b]=0;else{x=8;if(f&&(x=f[c-a+b-1]+f[c-a+b]+f[c-a+b+1]+f[c+b-1]+f[c+b+1]+f[c+a+b-1]+f[c+a+b]+f[c+a+b+1],7>x)){n[c+b]=0;y[c+b]=0;continue}7===x?(C=f[c-a+b-1]?g[c-a+b-1]:g[c+b],E=f[c-a+b]?g[c-a+b]:g[c+b],D=f[c-a+b+1]?g[c-a+b+1]:g[c+
b],x=f[c+b-1]?g[c+b-1]:g[c+b],B=f[c+b+1]?g[c+b+1]:g[c+b],z=f[c+a+b-1]?g[c+a+b-1]:g[c+b],F=f[c+a+b]?g[c+a+b]:g[c+b],A=f[c+a+b+1]?g[c+a+b+1]:g[c+b]):(C=g[c-a+b-1],E=g[c-a+b],D=g[c-a+b+1],x=g[c+b-1],B=g[c+b+1],z=g[c+a+b-1],F=g[c+a+b],A=g[c+a+b+1]);x=(D+B+B+A-(C+x+x+z))*h;C=(z+F+F+A-(C+E+E+D))*p;E=Math.sqrt(1+x*x+C*C);D=0;if("traditional"===l)z=255*(w+m*C-v*x)/E,0>z&&(z=0),D=z;else for(F=t.length,A=0;A<F;A++)z=255*(k[A]+t[A]*C-e[A]*x)/E,0>z&&(z=0),D+=z*r[A];n[c+b]=D&255}for(u=0;u<q;u++)n[u*a]=n[u*a+1],
n[(u+1)*a-1]=n[(u+1)*a-2];for(u=1;u<a-1;u++)n[u]=n[u+a],n[u+(q-1)*a]=n[u+(q-2)*a];return new I({width:a,height:q,pixels:[n],mask:f?y:null,pixelType:"u8",validPixelCount:d.validPixelCount,statistics:[{minValue:0,maxValue:255}]})};B.tintHillshade=function(d,l,a,q){if(G(d)&&G(l)){var f=q.min,y=d.pixels[0],r=l.mask;l=l.pixels[0];q=255.00001/(q.max-f);for(var p=new Uint8ClampedArray(l.length),v=new Uint8ClampedArray(l.length),m=new Uint8ClampedArray(l.length),w=a.length-1,e=0;e<l.length;e++)if(!r||0!==
r[e]){var t=Math.floor((l[e]-f)*q),k=a[0>t?0:t>w?w:t],t=k[0],h=y[e],k=h*k[1],g=k*(1-Math.abs(t%2-1)),h=h-k;switch(Math.floor(t)){case 0:p[e]=k+h;v[e]=g+h;m[e]=h;break;case 1:p[e]=g+h;v[e]=k+h;m[e]=h;break;case 2:p[e]=h;v[e]=k+h;m[e]=g+h;break;case 3:p[e]=h;v[e]=g+h;m[e]=k+h;break;case 4:p[e]=g+h;v[e]=h;m[e]=k+h;break;case 5:case 6:p[e]=k+h,v[e]=h,m[e]=g+h}}d.pixels=[p,v,m];d.updateStatistics()}}});