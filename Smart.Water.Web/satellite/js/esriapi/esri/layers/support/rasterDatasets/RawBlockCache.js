// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../geometry","./EphemeralBlockCache","../rasterFunctions/rasterProjectionHelper"],function(v,k,r,t,n){function u(b,a){if(!f.has(b))return null;b=f.get(b);return null==b[a]?null:b[a]}Object.defineProperty(k,"__esModule",{value:!0});var f=new Map,g=new t;k.register=function(b,a){a={extent:null,rasterInfo:a,cache:new Map};if(f.has(b))return b=f.get(b),b.push(a),b.length-1;f.set(b,[a]);return 0};k.unregister=function(b,a){f.has(b)&&(f.get(b)[a]=null)};k.deleteRaster=
function(b){f.delete(b)};k.decreaseRefCount=function(b,a,c){if(!f.has(b))return null==a?g.decreaseRefCount(b,c):0;var d=f.get(b);if(null==d[a])return g.decreaseRefCount(b,c);a=d[a].cache;if(a.has(c)){b=a.get(c);b.refCount--;if(0===b.refCount){a.delete(c);for(a=0;a<d.length;a++)d[a]&&d[a].cache.has(c)&&d[a].cache.delete(c);b.controller&&b.controller.abort()}return b.refCount}return 0};k.getBlock=function(b,a,c){if(!f.has(b))return null==a?g.getBlock(b,c):null;var d=f.get(b);if(null==d[a]){for(var e=
0;e<d.length;e++)if(d[e]&&d[e].cache.has(c))return c=d[e].cache.get(c),c.refCount++,c.block;return g.getBlock(b,c)}b=d[a].cache;if(b.has(c))return c=b.get(c),c.refCount++,c.block;for(e=0;e<d.length;e++)if(e!==a&&d[e]&&d[e]&&d[e].cache.has(c))return a=d[e].cache.get(c),a.refCount++,b.set(c,a),a.block;return null};k.putBlock=function(b,a,c,d,e){void 0===e&&(e=null);if(f.has(b)){var m=f.get(b);null==m[a]?g.putBlock(b,c,d,e):m[a].cache.set(c,{refCount:1,block:d,controller:e})}else null==a&&g.putBlock(b,
c,d,e)};k.deleteBlock=function(b,a,c){if(f.has(b)){var d=f.get(b);null==d[a]?g.deleteBlock(b,c):d[a].cache.delete(c)}else null==a&&g.deleteBlock(b,c)};k.update=function(b,a,c,d,e,f,h){void 0===h&&(h=null);b=u(b,a);a=b.extent;var k=b.cache,l=b.rasterInfo;c=c.clone().normalize()[0];if(!a||a.xmin!==c.xmin||a.xmax!==c.xmax||a.ymin!==c.ymin||a.ymax!==c.ymax){var g=l.spatialReference;a=n.projectExtent(c,g,h);d=new r.Point({x:d,y:d,spatialReference:c.spatialReference});if(null===e&&(e=n.projectResolution(d,
g,c,h),!e))return;h=n.snapPyramid(e,l,f||"closest");e=h.pyramidLevel;f=h.pyramidResolution;if(!h.excessiveReading){g=Math.floor((a.xmin-l.storageInfo.origin.x)/f.x);h=Math.floor((l.storageInfo.origin.y-a.ymax)/f.y);var m=0<e?l.storageInfo.pyramidBlockWidth:l.storageInfo.blockWidth,p=0<e?l.storageInfo.pyramidBlockHeight:l.storageInfo.blockHeight,l=Math.floor(g/m);d=Math.floor(h/p);g=Math.floor((g+Math.ceil((a.xmax-a.xmin)/f.x-.1)-1)/m);a=Math.floor((h+Math.ceil((a.ymax-a.ymin)/f.y-.1)-1)/p);var q=
new Set;for(f=d-1;f<=a+1;f++)for(h=l-1;h<=g+1;h++)q.add(e+"/"+f+"/"+h);k.forEach(function(a,b){q.has(b)||k.delete(b)});b.extent={xmin:c.xmin,ymin:c.ymin,xmax:c.xmax,ymax:c.ymax}}}}});