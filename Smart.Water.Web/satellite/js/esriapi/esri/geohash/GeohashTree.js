// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define(["require","exports","../core/CircularArray","../core/maybe","./geohashUtils"],function(D,E,G,H,I){Object.defineProperty(E,"__esModule",{value:!0});D=function(){function h(d){this._pool=new G.default(8024);this._nodes=0;this._root=new F(0,0,0);this._fields=d}h.prototype._acquire=function(d,c,e){var f=this._pool.dequeue();this._nodes++;return H.isSome(f)?f.realloc(d,c,e):new F(d,c,e)};h.prototype._release=function(d){this._nodes--;this._pool.enqueue(d)};Object.defineProperty(h.prototype,"count",
{get:function(){return this._root.count},enumerable:!0,configurable:!0});Object.defineProperty(h.prototype,"size",{get:function(){return this._nodes},enumerable:!0,configurable:!0});Object.defineProperty(h.prototype,"poolSize",{get:function(){return this._pool.size},enumerable:!0,configurable:!0});Object.defineProperty(h.prototype,"depth",{get:function(){var d=0;this._forEachNode(function(c){return d=Math.max(d,c.depth)});return d},enumerable:!0,configurable:!0});h.prototype.dropLevels=function(d){var c=
this;this._forEachNode(function(e){if(e.depth>=d)for(var f=0;f<e.children.length;f++){var n=e.children[f];e.children[f]=null;n&&c._release(n)}})};h.prototype.insert=function(d,c,e){void 0===e&&(e=0);for(var f=this._root,n=0,a=0,b=0;null!==f;){f.depth>=e&&(f.count+=1,f.xTotal+=d.geometry.coords[0],f.yTotal+=d.geometry.coords[1],f.xGeohashTotal+=d.geohashX,f.yGeohashTotal+=d.geohashY,this._updateStatistics(d,f,1));if(n>=c)break;var g=Math.ceil((n+1)/2),m=Math.floor((n+1)/2),l=1-n%2,k=30-(3*g+2*m),g=
30-(2*g+3*m),k=(d.geohashX&7*l+3*(1-l)<<k)>>k,g=(d.geohashY&3*l+7*(1-l)<<g)>>g,m=k+g*(8*l+4*(1-l)),h=2*l+3*(1-l),a=a<<3*l+2*(1-l)|k,b=b<<h|g;null==f.children[m]&&(f.children[m]=this._acquire(a,b,n+1));n+=1;f=f.children[m]}};h.prototype.remove=function(d,c){for(var e=this._root,f=0;null!==e;){--e.count;e.xTotal-=d.geometry.coords[0];e.yTotal-=d.geometry.coords[1];e.xGeohashTotal-=d.geohashX;e.yGeohashTotal-=d.geohashY;this._updateStatistics(d,e,-1);if(f>=c)break;var n=Math.ceil((f+1)/2),a=Math.floor((f+
1)/2),b=1-f%2,g=30-(3*n+2*a),n=30-(2*n+3*a),b=((d.geohashX&7*b+3*(1-b)<<g)>>g)+((d.geohashY&3*b+7*(1-b)<<n)>>n)*(8*b+4*(1-b)),g=e.children[b];1===g.count&&(this._release(g),e.children[b]=null);f+=1;e=g}};h.prototype.find=function(d,c,e){return this._root.find(d,c,e,0,0,0)};h.prototype.findSingleOccupancyNode=function(d,c,e,f,n){for(var a=this._root;null!==a;){var b=a.depth,g=a.xNode,m=a.yNode,l=1-b%2,k=a.xGeohashTotal/a.count,h=a.yGeohashTotal/a.count;if(1===a.count&&d<k&&k<=e&&c<h&&h<=f)return a;
if(b>=n)a=a.next;else{for(var k=Math.ceil((b+1)/2),b=Math.floor((b+1)/2),t=30-(3*k+2*b),k=30-(2*k+3*b),p=~((1<<t)-1),h=~((1<<k)-1),g=g<<3*l+2*(1-l),m=m<<2*l+3*(1-l),b=Math.max(g,(d&p)>>t),t=Math.min(g+8*l+4*(1-l),(e&p)>>t),p=Math.min(m+4*l+8*(1-l),(f&h)>>k),q=null,v=null,k=Math.max(m,(c&h)>>k);k<=p;k++)for(h=b;h<=t;h++){var u=a.children[h-g+(k-m)*(8*l+4*(1-l))];u&&(q||(q=u,q.next=a.next),v&&(v.next=u),v=u,u.next=a.next)}a=q||a.next}}return null};h.prototype.getRegionStatistics=function(d,c,e,f,n){for(var a=
this._root,b=0,g=0,h=0,l={};null!==a;){var k=a.depth,x=a.xNode,t=a.yNode;if(k>=n){var p=a.xGeohashTotal/a.count,q=a.yGeohashTotal/a.count;d<p&&p<=e&&c<q&&q<=f&&(b+=a.count,g+=a.xTotal,h+=a.yTotal,this._aggregateStatistics(l,a.statistics));a=a.next}else{for(var v=Math.ceil((k+1)/2),u=Math.floor((k+1)/2),k=1-k%2,w=30-(3*v+2*u),p=30-(2*v+3*u),y=~((1<<w)-1),q=~((1<<p)-1),x=x<<3*k+2*(1-k),t=t<<2*k+3*(1-k),v=Math.max(x,(d&y)>>w),u=Math.max(t,(c&q)>>p),w=Math.min(x+8*k+4*(1-k),(e&y)>>w),y=Math.min(t+4*k+
8*(1-k),(f&q)>>p),B=null,C=null,z=u;z<=y;z++)for(var A=v;A<=w;A++){var r=a.children[A-x+(z-t)*(8*k+4*(1-k))];r&&(z!==u&&z!==y&&A!==v&&A!==w?(p=r.xGeohashTotal/r.count,q=r.yGeohashTotal/r.count,d<p&&p<=e&&c<q&&q<=f&&(b+=r.count,g+=r.xTotal,h+=r.yTotal,this._aggregateStatistics(l,r.statistics))):(B||(B=r,B.next=a.next),C&&(C.next=r),C=r,r.next=a.next))}a=B||a.next}}d=this._normalizeStatistics(l,b);return{count:b,attributes:d,xTotal:g,yTotal:h}};h.prototype._forEachNode=function(d){for(var c=this._root;null!==
c;){var e=this._linkChildren(c)||c.next;d(c);c=e}};h.prototype._linkChildren=function(d){for(var c=null,e=null,f=0;f<=d.children.length;f++){var h=d.children[f];h&&(c||(c=h,c.next=d.next),e&&(e.next=h),e=h,h.next=d.next)}return c};h.prototype._updateStatistics=function(d,c,e){for(var f=0,h=this._fields;f<h.length;f++){var a=h[f],b=a.name,g=d.attributes[a.outStatistic.onStatisticField];switch(a.outStatistic.statisticType){case "norm":c.statistics[b]||(c.statistics[b]={});var a=d.attributes[a.outStatistic.onStatisticNormalizationField],
m=c.statistics[b].onStatisticField||0,l=c.statistics[b].onStatisticNormalizationField||0;null==g||isNaN(g)||null==a||0===a||isNaN(a)||(c.statistics[b].onStatisticField=m+e*g,c.statistics[b].onStatisticNormalizationField=l+e*a);break;case "sum":case "avg":c.statistics[b]||(c.statistics[b]={value:0,nanCount:0});m=c.statistics[b].value;a=c.statistics[b].nanCount;null==g||isNaN(g)?c.statistics[b].nanCount=a+e:c.statistics[b].value=m+e*g;break;case "avg_angle":c.statistics[b]||(c.statistics[b]={x:0,y:0,
nanCount:0});var m=c.statistics[b].x,l=c.statistics[b].y,a=c.statistics[b].nanCount,k=Math.PI/180;null==g||isNaN(g)?c.statistics[b].nanCount=a+e:(c.statistics[b].x=m+e*Math.cos(g*k),c.statistics[b].y=l+e*Math.sin(g*k));break;case "mode":c.statistics[b]||(c.statistics[b]={}),m=c.statistics[b][g]||0,c.statistics[b][g]=m+e}}};h.prototype._aggregateStatistics=function(d,c){for(var e=0,f=this._fields;e<f.length;e++){var h=f[e],a=h.name;switch(h.outStatistic.statisticType){case "sum":case "avg":case "avg_angle":case "mode":case "norm":d[a]||
(d[a]={});for(var b in c[a])d[a][b]=(d[a][b]||0)+c[a][b]}}};h.prototype._normalizeStatistics=function(d,c){for(var e={},f=0,h=this._fields;f<h.length;f++){var a=h[f],b=a.name;switch(a.outStatistic.statisticType){case "norm":a=d[b];if(c&&null==a.onStatisticNormalizationField)break;if(c&&a.onStatisticNormalizationField){e[b]=a.onStatisticField/a.onStatisticNormalizationField;break}e[b]=0;break;case "sum":if(!c)break;var g=d[b],a=g.value,g=g.nanCount;if(!(c-g))break;e[b]=a;break;case "avg":if(!c)break;
g=d[b];a=g.value;g=g.nanCount;if(!(c-g))break;e[b]=a/(c-g);break;case "avg_angle":if(!c)break;var g=d[b],a=g.x,m=g.y,g=g.nanCount;if(!(c-g))break;e[b]=180/Math.PI*Math.atan2(m/(c-g),a/(c-g));break;case "mode":var a=d[b],g=0,m=null,l;for(l in a){var k=a[l];k>g&&(g=k,m=l)}e[b]="null"===m?null:m}}return e};return h}();E.GeohashTree=D;var F=function(){function h(d,c,e){this.yTotal=this.xTotal=this.count=0;this.statistics={};this.next=null;this.yGeohashTotal=this.xGeohashTotal=this.yNode=this.xNode=this.depth=
0;this.children=Array(32);for(var f=0;f<this.children.length;f++)this.children[f]=null;this.xNode=d;this.yNode=c;this.depth=e}h.prototype.realloc=function(d,c,e){for(var f=0;f<this.children.length;f++)this.children[f]=null;this.xNode=d;this.yNode=c;this.depth=e;this.next=null;this.count=this.yTotal=this.xTotal=this.yGeohashTotal=this.xGeohashTotal=0;this.statistics={};return this};h.prototype.getLngLatBounds=function(){var d=this.depth,c=Math.ceil(d/2),d=Math.floor(d/2);return I.decodeGeohashXY({geohashX:this.xNode<<
30-(3*c+2*d),geohashY:this.yNode<<30-(2*c+3*d)},this.depth)};h.prototype.find=function(d,c,e,f,h,a){if(f>=e)return this;var b=1-f%2,g=3*b+2*(1-b),m=2*b+3*(1-b),l=30-h-g,k=30-a-m,b=this.children[((d&7*b+3*(1-b)<<l)>>l)+((c&3*b+7*(1-b)<<k)>>k)*(8*b+4*(1-b))];return null==b?null:b.find(d,c,e,f+1,h+g,a+m)};return h}()});