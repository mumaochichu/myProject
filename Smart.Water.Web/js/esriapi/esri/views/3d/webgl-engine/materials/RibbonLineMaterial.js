// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/geometryUtils ../../support/buffer/InterleavedLayout ../lib/geometryDataUtils ../lib/GLMaterial ../lib/Material ../lib/Util ./VisualVariableMaterialParameters ./internal/MaterialUtil ./renderers/MergedRenderer ./renderers/utils ../shaders/RibbonLineTechnique ../shaders/RibbonLineTechnique".split(" "),
function(R,ra,I,V,J,K,C,W,e,n,d,X,Y,Z,aa,ba,ca,da,ea,fa,ga,h){function L(h,b,a,c,q){for(var e=0;e<q;e++)a[c++]=h[b++];return c}var H=V.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");R=function(n){function b(a,c){c=n.call(this,c)||this;c.techniqueConfig=new h.RibbonLineTechniqueConfiguration;c.params=da.copyParameters(a,ha);c.validateParams();c.params.transparent=1>c.params.color[3]||c.params.transparent;c.layout=c.createLayout();return c}I.__extends(b,n);b.prototype.dispose=
function(){};b.prototype.setParameterValues=function(a){for(var c in a)"cap"===c?H.error("cap cannot be changed after creation"):"join"===c&&"round"===this.params[c]!==("round"===a[c])?H.error("join cannot be changed after creation"):"stipplePattern"===c&&!!this.params[c]!==!!a[c]?H.error("stippledness cannot be changed after creation"):this.params[c]=a[c];this.validateParams();this.parametersChanged()};b.prototype.getParameters=function(){return this.params};b.prototype.getPassParameters=function(){return this.params};
b.prototype.getTechniqueConfig=function(a){this.techniqueConfig.output=a;a=K.isSome(this.params.stipplePattern);this.techniqueConfig.stippleEnabled=a;this.techniqueConfig.stippleIntegerRepeatsEnabled=a&&this.params.stippleIntegerRepeats;this.techniqueConfig.stippleOffColorEnabled=a&&K.isSome(this.params.stippleOffColor);this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees;this.techniqueConfig.roundJoins="round"===this.params.join;
this.techniqueConfig.roundCaps="round"===this.params.cap;this.techniqueConfig.transparent=this.params.transparent;this.techniqueConfig.polygonOffset=this.params.polygonOffset;this.techniqueConfig.writeDepth=this.params.writeDepth;this.techniqueConfig.vvColor=this.params.vvColorEnabled;this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled;this.techniqueConfig.vvSize=this.params.vvSizeEnabled;this.techniqueConfig.innerColorEnabled=0<this.params.innerWidth&&K.isSome(this.params.innerColor);this.techniqueConfig.falloffEnabled=
0<this.params.falloff;this.techniqueConfig.occluder=8===this.renderOccluded;return this.techniqueConfig};b.prototype.intersect=function(a,c,b,h,g,e,f,k,E){E?this.intersectDrapedLineGeometry(a,h,e,f):this.intersectLineGeometry(a,c,b,h,this.params.width,f)};b.prototype.intersectDrapedLineGeometry=function(a,c,b,e){if(c.options.selectionMode){c=a.getAttribute(h.RibbonVertexAttributeConstants.POSITION).data;var g=a.getAttribute(h.RibbonVertexAttributeConstants.SIZE),q=this.params.width;this.params.vvSizeEnabled?
(g=a.getAttribute(h.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE).data[0],q*=J.clamp(this.params.vvSizeOffset[0]+g*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])):g&&(q*=g.data[0]);g=b[0];b=b[1];a=(q/2+4)*a.pixelRatio;for(var q=Number.MAX_VALUE,f=0;f<c.length-5;f+=3){var k=c[f],E=c[f+1],d=g-k,l=b-E,k=c[f+3]-k,E=c[f+4]-E,B=J.clamp((k*d+E*l)/(k*k+E*E),0,1),d=k*B-d,l=E*B-l,l=d*d+l*l;l<q&&(q=l)}q<a*a&&e()}};b.prototype.intersectLineGeometry=function(a,c,
b,B,g,r){if(B.options.selectionMode&&!fa.isInstanceHidden(c))if(ba.isTranslationMatrix(b)){c=a.data.getVertexAttr();a=c[h.RibbonVertexAttributeConstants.POSITION].data;this.params.vvSizeEnabled?g*=J.clamp(this.params.vvSizeOffset[0]+c[h.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0]*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0]):c[h.RibbonVertexAttributeConstants.SIZE]&&(g*=c[h.RibbonVertexAttributeConstants.SIZE].data[0]);var f=B.camera,k=ia;
W.vec2.copy(k,B.point);g=g*f.pixelRatio/2+4*f.pixelRatio;e.vec3.set(G[0],k[0]-g,k[1]+g,0);e.vec3.set(G[1],k[0]+g,k[1]+g,0);e.vec3.set(G[2],k[0]+g,k[1]-g,0);e.vec3.set(G[3],k[0]-g,k[1]-g,0);for(var q=0;4>q;q++)f.unprojectPoint(G[q],y[q]);d.plane.fromPoints(f.eye,y[0],y[1],N);d.plane.fromPoints(f.eye,y[1],y[2],O);d.plane.fromPoints(f.eye,y[2],y[3],P);d.plane.fromPoints(f.eye,y[3],y[0],Q);c=Number.MAX_VALUE;for(var n=this.params.isClosed?a.length-2:a.length-5,q=0;q<n;q+=3){u[0]=a[q]+b[12];u[1]=a[q+1]+
b[13];u[2]=a[q+2]+b[14];var l=(q+3)%a.length;t[0]=a[l]+b[12];t[1]=a[l+1]+b[13];t[2]=a[l+2]+b[14];if(!(0>d.plane.signedDistance(N,u)&&0>d.plane.signedDistance(N,t)||0>d.plane.signedDistance(O,u)&&0>d.plane.signedDistance(O,t)||0>d.plane.signedDistance(P,u)&&0>d.plane.signedDistance(P,t)||0>d.plane.signedDistance(Q,u)&&0>d.plane.signedDistance(Q,t))){f.projectPoint(u,z);f.projectPoint(t,F);if(0>z[2]&&0<F[2]){e.vec3.subtract(x,u,t);var l=f.frustum,M=-d.plane.signedDistance(l.planes[4],u),l=M/e.vec3.dot(x,
d.plane.normal(l.planes[4]));e.vec3.scale(x,x,l);e.vec3.add(u,u,x);f.projectPoint(u,z)}else if(0<z[2]&&0>F[2])e.vec3.subtract(x,t,u),l=f.frustum,M=-d.plane.signedDistance(l.planes[4],t),l=M/e.vec3.dot(x,d.plane.normal(l.planes[4])),e.vec3.scale(x,x,l),e.vec3.add(t,t,x),f.projectPoint(t,F);else if(0>z[2]&&0>F[2])continue;z[2]=0;F[2]=0;l=d.lineSegment.distance2(d.lineSegment.fromPoints(z,F,S),k);l<c&&(c=l,e.vec3.copy(T,u),e.vec3.copy(U,t))}}b=B.rayBeginPoint;B=B.rayEndPoint;c<g*g&&(a=Number.MAX_VALUE,
d.lineSegment.closestLineSegmentPoint(d.lineSegment.fromPoints(T,U,S),d.lineSegment.fromPoints(b,B,ja),D)&&(e.vec3.subtract(D,D,b),a=e.vec3.length(D),e.vec3.scale(D,D,1/a),a/=e.vec3.distance(b,B)),r(a,D))}else H.error("intersection assumes a translation-only matrix")};b.prototype.computeAttachmentOrigin=function(a,c){var b=a.data;a="getVertexAttr"in b?b.getVertexAttr():"vertexAttr"in b?b.vertexAttr:null;if(!a)return null;var e=h.RibbonVertexAttributeConstants.POSITION,b="getVertexAttr"in b?b.getIndices(e):
null;return Y.computeAttachmentOriginLines(a[e],b,b&&this.params.isClosed,c)};b.prototype.createLayout=function(){var a=X.newLayout().vec3f(h.RibbonVertexAttributeConstants.POSITION).f32(h.RibbonVertexAttributeConstants.SUBDIVISIONFACTOR).vec2f(h.RibbonVertexAttributeConstants.UV0).vec3f(h.RibbonVertexAttributeConstants.AUXPOS1).vec3f(h.RibbonVertexAttributeConstants.AUXPOS2);this.params.vvSizeEnabled?a.f32(h.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE):a.f32(h.RibbonVertexAttributeConstants.SIZE);
this.params.vvColorEnabled?a.f32(h.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE):a.vec4f(h.RibbonVertexAttributeConstants.COLOR);this.params.vvOpacityEnabled&&a.f32(h.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE);return a};b.prototype.createBufferWriter=function(){return new ka(this.layout,this.params)};b.prototype.createRenderer=function(a,b){return new ea(a,b,this,h.ribbonVertexAttributeLocations)};b.prototype.getGLMaterial=function(a){return 0===a.output||4===a.output?new la(a):
void 0};b.prototype.validateParams=function(){"miter"!==this.params.join&&(this.params.miterLimit=0)};return b}(aa.Material);var la=function(e){function b(a){a=e.call(this,a)||this;a.updateParameters();return a}I.__extends(b,e);b.prototype.updateParameters=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(ga.RibbonLineTechnique,this.material.getTechniqueConfig(this.output),this.technique)};b.prototype.beginSlot=function(a){return this.technique.configuration.occluder?3===a||10===
a||11===a:0===this.output?(this.targetSlot=this.technique.configuration.writeDepth?5:8,a===this.targetSlot):3===a};b.prototype._updateOccludeeState=function(a){a.hasOccludees!==this.material.getParameters().sceneHasOcludees&&(this.material.setParameterValues({sceneHasOcludees:a.hasOccludees}),this.updateParameters())};b.prototype.ensureParameters=function(a){0===this.output&&this._updateOccludeeState(a)};b.prototype.bind=function(a,b){a.bindProgram(this.technique.program);this.technique.bindPass(a,
this.material.getPassParameters(),b)};b.prototype.getPipelineState=function(a,b){return b?this.technique.occludeePipeline:this.technique.configuration.occluder?11===a?this.technique.occluderPipelineTransparent:10===a?this.technique.occluderPipelineOpaque:this.technique.occluderPipelineMaskWrite:this.technique.pipeline};return b}(Z.GLMaterial),ha=I.__assign({width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,
slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1},ca.Default),ka=function(){function d(b,a){this.params=a;this.numJoinSubdivisions=this.numCapSubdivisions=0;this.vertexBufferLayout=b;if(!a.isClosed)switch(this.params.cap){case "butt":this.numCapSubdivisions=0;break;case "square":this.numCapSubdivisions=1;break;case "round":this.numCapSubdivisions=ma}switch(this.params.join){case "miter":case "bevel":this.numJoinSubdivisions=
a.stipplePattern?1:0;break;case "round":this.numJoinSubdivisions=na}}d.prototype.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};d.prototype.elementCount=function(b){var a=2*this.numCapSubdivisions+2,c=b.indices[h.RibbonVertexAttributeConstants.POSITION].length/2+1,e=this.params.isClosed,a=e?2:2*a,d=e?0:1,c=e?c:c-1;if(b.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS])for(b=b.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS].data;d<c;++d)a+=4+2*b[d];else a+=(c-
d)*(2*this.numJoinSubdivisions+4);return a+2};d.prototype.write=function(b,a,c,d){var q=this,g=oa,r=pa,f=qa,k=a.vertexAttr[h.RibbonVertexAttributeConstants.POSITION].data,n=a.indices&&a.indices[h.RibbonVertexAttributeConstants.POSITION];n&&n.length!==2*(k.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");n=null;a.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS]&&(n=a.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS].data);var u=1,l=0;this.params.vvSizeEnabled?
l=a.vertexAttr[h.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0]:a.vertexAttr[h.RibbonVertexAttributeConstants.SIZE]&&(u=a.vertexAttr[h.RibbonVertexAttributeConstants.SIZE].data[0]);var t=[1,1,1,1],x=0;this.params.vvColorEnabled?x=a.vertexAttr[h.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE].data[0]:a.vertexAttr[h.RibbonVertexAttributeConstants.COLOR]&&(t=a.vertexAttr[h.RibbonVertexAttributeConstants.COLOR].data);var y=0;this.params.vvOpacityEnabled&&(y=a.vertexAttr[h.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE].data[0]);
a=k.length/3;b=b.transformation;var p=new Float32Array(c.buffer);c=this.vertexBufferLayout.stride/4;var m=d*c;d=m;var w=function(a,b,c,d,e,f){p[m++]=b[0];p[m++]=b[1];p[m++]=b[2];p[m++]=d;p[m++]=e;p[m++]=f;p[m++]=a[0];p[m++]=a[1];p[m++]=a[2];p[m++]=c[0];p[m++]=c[1];p[m++]=c[2];q.params.vvSizeEnabled?p[m++]=l:p[m++]=u;q.params.vvColorEnabled?p[m++]=x:(p[m++]=t[0],p[m++]=t[1],p[m++]=t[2],p[m++]=t[3]);q.params.vvOpacityEnabled&&(p[m++]=y)},m=m+c;e.vec3.set(r,k[0],k[1],k[2]);b&&e.vec3.transformMat4(r,
r,b);var z=this.params.isClosed;if(z){var v=k.length-3;e.vec3.set(g,k[v],k[v+1],k[v+2]);b&&e.vec3.transformMat4(g,g,b)}else{e.vec3.copy(g,r);e.vec3.set(f,k[3],k[4],k[5]);b&&e.vec3.transformMat4(f,f,b);for(v=0;v<this.numCapSubdivisions;++v){var A=1-v/this.numCapSubdivisions;w(g,r,f,A,1,-4);w(g,r,f,A,1,4)}w(g,r,f,0,0,-4);w(g,r,f,0,0,4);e.vec3.copy(g,r);e.vec3.copy(r,f)}for(var F=z?a:a-1,v=z?0:1;v<F;v++){A=(v+1)%a*3;e.vec3.set(f,k[A+0],k[A+1],k[A+2]);b&&e.vec3.transformMat4(f,f,b);w(g,r,f,0,1,-1);w(g,
r,f,0,1,1);for(var D=n?n[v]:this.numJoinSubdivisions,C=0;C<D;++C)A=(C+1)/(D+1),w(g,r,f,A,1,-2),w(g,r,f,A,1,2);w(g,r,f,1,0,-2);w(g,r,f,1,0,2);e.vec3.copy(g,r);e.vec3.copy(r,f)}if(z)m=L(p,d+c,p,m,2*c);else for(w(g,r,f,0,1,-5),w(g,r,f,0,1,5),v=0;v<this.numCapSubdivisions;++v)A=(v+1)/this.numCapSubdivisions,w(g,r,f,A,1,-5),w(g,r,f,A,1,5);L(p,d+c,p,d,c);m=L(p,m-c,p,m,c)};return d}(),ma=3,na=1,u=n.vec3f64.create(),t=n.vec3f64.create(),x=n.vec3f64.create(),D=n.vec3f64.create(),ia=n.vec3f64.create(),z=C.createRenderScreenPointArray3(),
F=C.createRenderScreenPointArray3(),T=n.vec3f64.create(),U=n.vec3f64.create(),S=d.lineSegment.create(),ja=d.lineSegment.create(),oa=n.vec3f64.create(),pa=n.vec3f64.create(),qa=n.vec3f64.create(),G=[C.createRenderScreenPointArray3(),C.createRenderScreenPointArray3(),C.createRenderScreenPointArray3(),C.createRenderScreenPointArray3()],y=[n.vec3f64.create(),n.vec3f64.create(),n.vec3f64.create(),n.vec3f64.create()],N=d.plane.create(),O=d.plane.create(),P=d.plane.create(),Q=d.plane.create();return R});