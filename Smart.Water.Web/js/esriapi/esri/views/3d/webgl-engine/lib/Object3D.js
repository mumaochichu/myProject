// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/mathUtils ./GeometryRecord ./IdGen ./Object3DStateSet ./Util ../materials/renderers/utils".split(" "),function(t,C,y,z,r,l,g,m,u,n,A,v,p,q){t=function(){function b(a){void 0===a&&(a={});this._objectTransformation=l.mat4f64.create();this._bvObjectSpace=new w;this._bvWorldSpace=
new w;this._bvDirty=!0;this._hasVolatileTransformation=!1;this._visible=!0;this.id=b._idGen.gen(a.idHint);this.castShadow=null!=a.castShadow?a.castShadow:!0;(this.metadata=a.metadata)&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new x);this.objectTransformation=l.mat4f64.create();this._initializeGeometryRecords(a.geometries,a.materials,a.transformations,a.origins)}Object.defineProperty(b.prototype,"geometryRecords",{get:function(){return this._geometryRecords},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"geometries",{get:function(){return this._geometries},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"objectTransformation",{get:function(){return this._objectTransformation},set:function(a){r.mat4.copy(this._objectTransformation,a);this._invalidateBoundingVolume();this._notifyDirty("objTransformation")},enumerable:!0,configurable:!0});b.prototype.dispose=function(){for(var a=0,c=this._geometryRecords;a<c.length;a++)n.pool.release(c[a]);
this._geometries=this._geometryRecords=null};b.prototype._initializeGeometryRecords=function(a,c,e,b){if(Array.isArray(a)){p.assert(c.length===a.length,"Object3D: materials don't match geometries");p.assert(e.length===a.length,"Object3D: transformations don't match geometries");this._geometryRecords=Array(a.length);this._geometries=a.slice();for(var d=0;d<a.length;d++)this._geometryRecords[d]=n.pool.acquire(a[d],c[d],l.mat4f64.clone(e[d]),{highlights:null,occludees:null,visible:!0},b&&b[d]);this._hasVolatileTransformation=
!1}else this._geometryRecords=[],this._geometries=[]};Object.defineProperty(b.prototype,"parentLayer",{get:function(){return this._parentLayer},set:function(a){p.assert(null==this._parentLayer||null==a,"Object3D can only be added to a single Layer");this._parentLayer=a},enumerable:!0,configurable:!0});b.prototype.getNumGeometryRecords=function(){return this._geometryRecords.length};b.prototype.findGeometryRecords=function(a){for(var c=[],e=0;e<this._geometries.length;e++)this._geometries[e]===a&&
c.push(this._geometryRecords[e]);return c};b.prototype.getGeometryRecord=function(a){p.assert(0<=a&&a<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range");return this._geometryRecords[a]};b.prototype.addGeometry=function(a,c,e,b,g,h){e=e?e:l.mat4f64.IDENTITY;this._geometries.push(a);a=n.pool.acquire(a,c,e,b||{highlights:null,occludees:null,visible:!0},g,h);this._geometryRecords.push(a);this._hasVolatileTransformation=this._geometryRecords.some(function(a){return!!a.shaderTransformation});
this._notifyDirty("objGeometryAdded",a);this._invalidateBoundingVolume();return a};b.prototype.removeGeometry=function(a){var c=this._geometryRecords.splice(a,1)[0];n.pool.release(c);this._hasVolatileTransformation=this._geometryRecords.some(function(a){return!!a.shaderTransformation});this._geometries.splice(a,1);this._notifyDirty("objGeometryRemoved",c);this._invalidateBoundingVolume();return c};b.prototype.removeAllGeometries=function(){for(;0<this.getNumGeometryRecords();)this.removeGeometry(0)};
b.prototype.geometryVertexAttrsUpdated=function(a){this._notifyDirty("vertexAttrsUpdated",this._geometryRecords[a]);this._invalidateBoundingVolume()};Object.defineProperty(b.prototype,"isVisible",{get:function(){return this._visible},enumerable:!0,configurable:!0});b.prototype.setVisible=function(a){this._visible=a;a=0;for(var c=this._geometryRecords;a<c.length;a++)c[a].instanceParameters.visible=this._visible;this._notifyDirty("visibilityChanged")};b.prototype.occlude=function(){for(var a=v.generateObject3DStateId(1),
c=0,b=this._geometryRecords;c<b.length;c++){var d=b[c];d.instanceParameters.occludees=q.addObject3DStateID(d.instanceParameters.occludees,a)}this._notifyDirty("occlusionChanged");return a};b.prototype.removeOcclude=function(a){for(var c=0,b=this._geometryRecords;c<b.length;c++){var d=b[c];d.instanceParameters.occludees=q.removeObject3DStateID(d.instanceParameters.occludees,a)}this._notifyDirty("occlusionChanged")};b.prototype.highlight=function(){for(var a=v.generateObject3DStateId(0),c=0,b=this._geometryRecords;c<
b.length;c++){var d=b[c];d.instanceParameters.highlights=q.addObject3DStateID(d.instanceParameters.highlights,a)}this._notifyDirty("highlightChanged");return a};b.prototype.removeHighlight=function(a){for(var c=0,b=this._geometryRecords;c<b.length;c++){var d=b[c];d.instanceParameters.highlights=q.removeObject3DStateID(d.instanceParameters.highlights,a)}this._notifyDirty("highlightChanged")};b.prototype.setGeometryTransformation=function(a,c){p.assert(0<=a&&a<this._geometryRecords.length,"Object3d.setGeometryTransformation: index out of range");
var b=this._geometryRecords[a];n.pool.release(b);c=n.pool.acquire(b.geometry,b.material,l.mat4f64.clone(c),b.instanceParameters);this._geometryRecords[a]=c;this._notifyDirty("objGeometryReplaced",[b,c]);this._invalidateBoundingVolume()};b.prototype.getCombinedStaticTransformation=function(a,c){return r.mat4.multiply(z.unwrapOr(c,l.mat4f64.create()),this.objectTransformation,a.getStaticTransformation())};b.prototype.getCombinedShaderTransformation=function(a,c){c=c||l.mat4f64.create();r.mat4.multiply(c,
this.objectTransformation,a.getShaderTransformation());return c};b.prototype.hasVolativeTransformation=function(){return this._hasVolatileTransformation};b.prototype.getBBMin=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin};b.prototype.getBBMax=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax};b.prototype.getCenter=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.center:
this._bvWorldSpace.center};b.prototype.getBSRadius=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bsRadius:this._bvWorldSpace.bsRadius};b.prototype._validateBoundingVolume=function(){if(this._bvDirty||this._hasVolatileTransformation){this._bvObjectSpace.init();this._bvWorldSpace.init();for(var a=0;a<this._geometryRecords.length;++a){var c=this._geometries[a],b=this._geometryRecords[a],c=c.boundingInfo;this._calculateTransformedBoundingVolume(c,this._bvObjectSpace,b.getShaderTransformation());
this._calculateTransformedBoundingVolume(c,this._bvWorldSpace,this.getCombinedShaderTransformation(b))}g.vec3.lerp(this._bvObjectSpace.center,this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5);g.vec3.lerp(this._bvWorldSpace.center,this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5);for(var b=m.vec3f64.create(),d=m.vec3f64.create(),B=u.maxScale(this.objectTransformation),a=0;a<this._geometryRecords.length;++a){var c=this._geometries[a],h=this._geometryRecords[a].getShaderTransformation(),f=
u.maxScale(h),c=c.boundingInfo;g.vec3.transformMat4(b,c.getCenter(),h);h=g.vec3.distance(b,this._bvObjectSpace.center);c=c.getBSRadius()*f;this._bvObjectSpace.bsRadius=Math.max(this._bvObjectSpace.bsRadius,h+c);g.vec3.transformMat4(d,b,this.objectTransformation);f=g.vec3.distance(d,this._bvWorldSpace.center);this._bvWorldSpace.bsRadius=Math.max(this._bvWorldSpace.bsRadius,f+c*B)}this._bvDirty=!1}};b.prototype._calculateTransformedBoundingVolume=function(a,c,b){var d=a.getBBMin();a=a.getBBMax();var e=
m.vec3f64.clone(d),h=m.vec3f64.clone(a);g.vec3.transformMat4(e,e,b);g.vec3.transformMat4(h,h,b);for(var f=0;3>f;++f)c.bbMin[f]=Math.min(c.bbMin[f],e[f],h[f]),c.bbMax[f]=Math.max(c.bbMax[f],e[f],h[f]);for(f=0;3>f;++f){g.vec3.copy(e,d);g.vec3.copy(h,a);e[f]=a[f];h[f]=d[f];g.vec3.transformMat4(e,e,b);g.vec3.transformMat4(h,h,b);for(var k=0;3>k;++k)c.bbMin[k]=Math.min(c.bbMin[k],e[k],h[k]),c.bbMax[k]=Math.max(c.bbMax[k],e[k],h[k])}};b.prototype._invalidateBoundingVolume=function(){this._bvDirty=!0;this._parentLayer&&
this._parentLayer.notifyObjectBBChanged(this,{center:this._bvWorldSpace.center,radius:this._bvWorldSpace.bsRadius})};b.prototype._notifyDirty=function(a,c,b,d){this._parentLayer&&this._parentLayer.notifyDirty(a,c,b||1,d||this)};Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{hasGeometry:function(b){return-1<a._geometries.indexOf(b)},getGeometryIndex:function(b){return a._geometries.indexOf(b)}}},enumerable:!0,configurable:!0});b._idGen=new A.IdGen;return b}();var x=function(){function b(){this.bbMin=
m.vec3f64.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this.bbMax=m.vec3f64.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}b.prototype.isEmpty=function(){return this.bbMax[0]<this.bbMin[0]&&this.bbMax[1]<this.bbMin[1]&&this.bbMax[2]<this.bbMin[2]};return b}(),w=function(b){function a(){var a=b.call(this)||this;a.center=m.vec3f64.create();a.bsRadius=0;return a}y.__extends(a,b);a.prototype.init=function(){g.vec3.set(this.bbMin,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);
g.vec3.set(this.bbMax,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);g.vec3.set(this.center,0,0,0);this.bsRadius=0};a.prototype.getCenter=function(){return this.center};a.prototype.getBSRadius=function(){return this.bsRadius};return a}(x);return t});