// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/compilerUtils ../../../../core/Handles ../../../../core/MapUtils ../../../../core/maybe ../../../../core/TimeProfiler ../../../../core/watchUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2f64 ../../support/debugFlags ../core/shaderLibrary/hud/HUD.glsl ./BoundingInfo ./Camera ./depthRange ./depthRangeUtils ./FxaaRenderPass ./glUtil3D ./HighlightHelper ./Material ./OffscreenRenderingHelper ./RenderContext ./rendererUtils ./RenderPluginManager ./renderStats ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./edgeRendering/EdgeView ../lighting/SceneLighting ../materials/HUDMaterial ../../../webgl/Profiling".split(" "),
function(z,da,H,I,t,u,A,J,l,q,B,v,w,K,C,L,M,N,O,P,D,Q,R,S,T,U,V,W,X,Y,Z,aa,ba,ca){z=function(){function b(a,c,e,d,b,f,h){var g=this;this._materialRep=a;this._rctx=d;this._compositingHelper=b;this.requestRender=f;this._stage=h;this._materialRenderers=new Map;this._hasWater=this._hasOccludees=this._hasHighlights=!1;this._lighting=new aa.SceneLighting;this._content=new Map;this._isRendering=!1;this._fallbackDepthStencilTexture=null;this._stats=new U.RenderStatsAggregator;this._antialiasing=1;this._edgeView=
null;this._handles=new I;this._cameraPrevious=new C.default;this._cameraCurrent=new C.default;this.renderHiddenTransparentEdges=function(){};this._shaderTechniqueRepository=e;this._fxaaPass=new N(this._rctx);this._smaaPass=new X(this._rctx);this._bindParameters={slot:null,view:null,proj:null,viewInvTransp:null,fovY:0,nearFar:null,viewport:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,slicePlane:null,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,
lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrViewMat:null,rpProjectionMat:null,ssrEnabled:!1};this._offscreenRendering=new Q(this._rctx,this._compositingHelper);this._sliceHelper=new W;this._shadowMap=new V(this._rctx,e.viewingMode);this._ssaoHelper=new Y(e,this._rctx,function(){return g.requestRender()});this._highlightHelper=new P(e,this._rctx);this._renderPlugins=new T.RenderPluginManager({rctx:this._rctx,shaderTechniqueRep:e,textureRep:c,materialRep:this._materialRep,
requestRender:this.requestRender});this._renderContext=new R(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper);this._renderContext.ssrParams={nearFar:null,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrViewMat:null,rpProjectionMat:null,ssrEnabled:!1};this._handles.add(J.init(v,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",function(a){g.renderHiddenTransparentEdges=a?function(){return g.renderEdges(1)}:
function(){};g.requestRender()}))}b.prototype.dispose=function(){this._handles.destroy();this._fxaaPass.disable();this._smaaPass.disable();this._materialRenderers.forEach(function(a){return a.dispose()});this._materialRenderers=null;this._edgeView&&(this._edgeView.destroy(),this._edgeView=null);this._offscreenRendering.enabled=!1;this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null);this._shadowMap&&(this._shadowMap.enabled=!1,this._shadowMap.dispose());
this._ssaoHelper&&(this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose());this._highlightHelper&&(this._highlightHelper.enabled=!1);K.tmpIndices.prune();this._content.clear();this._content=null};Object.defineProperty(b.prototype,"updating",{get:function(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources},enumerable:!0,configurable:!0});b.prototype.ensureEdgeView=function(){var a=this;null==this._edgeView&&(this._edgeView=new Z.EdgeView(this._rctx,this._shaderTechniqueRepository,{setNeedsRender:function(){return a.requestRender()}}),
this._edgeView.initialize());return this._edgeView};Object.defineProperty(b.prototype,"edgeView",{get:function(){return this._edgeView},enumerable:!0,configurable:!0});b.prototype.setLighting=function(a){this._lighting.set(a)};b.prototype.setRenderParams=function(a){void 0!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap);void 0!==a.shadowMapMaxCascades&&(this._shadowMap.maxCascades=a.shadowMapMaxCascades);this._highlightHelper.enabled=!0;void 0!==a.ssao&&(this._ssaoHelper.enabled=a.ssao);void 0!==
a.ssaoAttenuation&&(this._ssaoHelper.attenuation=a.ssaoAttenuation);void 0!==a.ssaoRadius&&(this._ssaoHelper.radius=a.ssaoRadius);void 0!==a.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter.");void 0!==a.ssaoSamples&&(this._ssaoHelper.samples=a.ssaoSamples);a.background&&(this._offscreenRendering.background=a.background);void 0!==a.antialiasingEnabled&&(this._antialiasing=a.antialiasingEnabled?1:0);void 0!==a.defaultHighlightOptions&&this._highlightHelper.setDefaultOptions(a.defaultHighlightOptions);
void 0!==a.slicePlane&&(this._sliceHelper.plane=u.unwrap(a.slicePlane));void 0!==a.waterReflectionEnabled&&(this._waterReflectionEnabled=10<=this._rctx.parameters.maxTextureImageUnits&&a.waterReflectionEnabled);this.requestRender()};Object.defineProperty(b.prototype,"hasSlicePlane",{get:function(){return!!this._sliceHelper.plane},enumerable:!0,configurable:!0});b.prototype.getRenderParams=function(){var a={};this._shadowMap&&(a.shadowMap=this._shadowMap.enabled,a.shadowMapMaxCascades=this._shadowMap.maxCascades);
this._ssaoHelper&&this._ssaoHelper.isSupported&&(a.ssao=this._ssaoHelper.enabled,a.ssaoAttenuation=this._ssaoHelper.attenuation,a.ssaoRadius=this._ssaoHelper.radius,a.ssaoFilterRadius=this._ssaoHelper.filterRadius,a.ssaoSamples=this._ssaoHelper.samples);this._waterReflectionEnabled&&(a.waterReflectionEnabled=this._waterReflectionEnabled);return a};Object.defineProperty(b.prototype,"renderPlugins",{get:function(){return this._renderPlugins},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"canRender",{get:function(){return!0},enumerable:!0,configurable:!0});b.prototype.getStats=function(){return this._stats.getAggregatedStats()};b.prototype.getFramebufferTexture=function(a){switch(a){case "color":return this._offscreenRendering.colorTexture;case "hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case "shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case "linearDepth":return this._offscreenRendering.linearDepthTexture;case "normals":return this._offscreenRendering.normalTexture;
case "highlight":return this._offscreenRendering.highlightTexture;default:return H.neverReached(a),null}};b.prototype.isEmpty=function(){return 0===this._materialRenderers.size};b.prototype.modify=function(a,c,e,d,b,f){var g=this;void 0===c&&(c=a?a.length:0);void 0===d&&(d=e?e.length:0);void 0===f&&(f=b?b.length:0);this._isRendering&&console.warn("Renderer.modify called while rendering");for(var k=0;k<d;++k)this._content.delete(e[k].uniqueName);for(k=0;k<c;++k)this._content.set(a[k].uniqueName,a[k]);
if(c||d||f){var E=!1;S.splitRenderGeometryChangeSetByMaterial({toAdd:a,numToAdd:c,toRemove:e,numToRemove:d,toUpdate:b,numToUpdate:f}).forEach(function(a,c){var d=g._materialRenderers.get(c);!d&&0<a.toAdd.length&&(d=c.createRenderer(g._rctx,g._materialRep),g._materialRenderers.set(c,d));d&&(d.modify(a),d.isEmpty&&(E=!0))});E&&this._materialRenderers.forEach(function(a,c){a.isEmpty&&(g._materialRenderers.delete(c),a.dispose())});this._hasHighlights=t.someMap(this._materialRenderers,function(a){return a.hasHighlights});
this._hasOccludees=t.someMap(this._materialRenderers,function(a){return a.hasOccludees});this._hasWater=t.someMap(this._materialRenderers,function(a){return a.hasWater});this.requestRender()}};b.prototype.updateLogic=function(a){var c=!1;this._materialRenderers.forEach(function(e){e.updateLogic&&(c=e.updateLogic(a)||c)});return c};b.prototype.render=function(a){this.renderScene(a);if(this.onPostRender)this.onPostRender()};b.prototype.renderScene=function(a){var c=this;this._isRendering=!0;var e=this._rctx,
d=this._offscreenRendering,b=a.camera,f=a.fbo;d.needLastFrameColorTexture=this._waterReflectionEnabled;d.advanceCurrentRenderTarget();this._waterReflectionEnabled?this.setBindParametersSSR(b):this.removeBindParametersSSR();var h=this._sliceHelper.plane;a.disableSlice&&(this._sliceHelper.plane=null);this._renderPlugins.prepareRender(b);this.renderShadowMap(a);d.enabled=!0;d.initializeFrame(b);this.renderLinearDepth(b);this.renderNormal(b);this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(b,d.linearDepthTexture,
d.normalTexture);this._ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository);this._stats.reset();this.updateGlobalUniforms(b.projectionMatrix);this._renderContext.pass=0;this._renderContext.camera=b;this._renderContext.hasOccludees=this._hasOccludees;d.bindFramebuffer();this._renderPlugins.render(0,this._renderContext);this.renderOpaqueGeometry(this._renderContext);this.renderEdges(2);this.renderHiddenTransparentEdges();this.renderTransparentGeometry(this._renderContext);this.renderEdges(1);
var k=a=!1;a=this.renderHUDVisibility(this._renderContext);this.renderInternalSlot(20,this._renderContext);(k=this.renderTransparentTerrain(this._renderContext))&&a&&(d.compositeTransparentTerrainOntoHUDVisibility(),d.renderToTargets(function(){return c.renderHUD(w.HUD.TransparentRenderStyle.OCCLUDED)},d.currentColorTarget,d.tmpDepth,void 0,!0,!0));k&&d.compositeTransparentTerrainOntoMain();d.renderToTargets(function(){c.renderInternalSlot(8,c._renderContext);c._renderPlugins.render(15,c._renderContext);
c._renderPlugins.render(16,c._renderContext)},d.currentColorTarget,d.mainDepth);this._renderPlugins.needsLaserlineWithContrastControl&&d.renderAndComposite(function(){c._renderPlugins.render(17,c._renderContext)},2);this.renderOccluded();this.renderAntiAliasing(f,this._antialiasing);e.bindFramebuffer(f);e.clearSafe(256);this.renderHUD(w.HUD.TransparentRenderStyle.NOTOCCLUDED);this.renderHighlights(b,f);this._sliceHelper.plane=h;this._isRendering=!1};b.prototype.renderEdges=function(a){var c=this,
b=this._edgeView;b&&b.shouldRender()&&this._offscreenRendering.renderAndComposite(function(){return b.render(c._bindParameters,a)},1)};b.prototype.renderShadowMap=function(a){var c=this._shadowMap;if(c.enabled){v.ENABLE_PROFILE_DEPTH_RANGE&&A.begin("depthRange");var b=a.camera,d=a.fbo,g=a.lightDirection,f=this.computeDepthRange(b);v.ENABLE_PROFILE_DEPTH_RANGE&&A.end("depthRange");c.prepare(b,g,f);g=c.getCascades();for(f=0;f<g.length;++f){var h=g[f];h.camera.setGLViewport(this._rctx);this.renderGeometryPass(3,
h.camera)}a.camera=b;c.finish(d);b.setGLViewport(this._rctx)}c.bindToAllPrograms(this._shaderTechniqueRepository)};b.prototype.renderLinearDepth=function(a){var c=this;this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled?this._offscreenRendering.renderToTargets(function(){return c.renderGeometryPass(1,a)},this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)};
b.prototype.renderNormal=function(a){var c=this;this._ssaoHelper.enabled?this._offscreenRendering.renderToTargets(function(){c.renderGeometryPass(2,a)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)};b.prototype.computeDepthRange=function(a){var c=M.depthRangeFromScene(a,this._content,this._stage.getLayers());L.union(c,this.renderPlugins.queryDepthRange(a));c.near=Math.max(a.near,c.near);c.far=
Math.min(a.far,c.far);return c};b.prototype.renderGeometryPass=function(a,c){this.updateGlobalUniforms(c.projectionMatrix);this._renderContext.pass=a;this._renderContext.camera=c;this.renderOpaqueGeometry(this._renderContext);this.renderTransparentGeometry(this._renderContext);this.renderTransparentTerrain(this._renderContext)};b.prototype.renderOpaqueGeometry=function(a){this._renderPlugins.render(1,a);this._renderPlugins.render(2,a);this.renderInternalSlot(3,a);this._renderPlugins.render(4,a);a.ssaoHelper&&
a.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository);this._renderPlugins.render(14,this._renderContext)};b.prototype.renderTransparentGeometry=function(a){this.renderInternalSlot(5,a);this._renderPlugins.render(6,a);a.ssaoHelper&&a.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository)};b.prototype.renderTransparentTerrain=function(a){return this._renderPlugins.render(7,a)};b.prototype.renderHUDVisibility=function(a){var c=this,b=ba.default.shouldRenderVisibilityDuringRenderPass(a.pass),
d=a.offscreenRenderingHelper&&a.offscreenRenderingHelper.enabled,g=!1;b&&d&&a.offscreenRenderingHelper.renderHUDVisibility(function(){g=c.renderInternalSlot(12,a)});return g};b.prototype.renderHUD=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this.renderInternalSlot(21,this._renderContext);this.renderInternalSlot(18,this._renderContext);this.renderInternalSlot(19,this._renderContext)};b.prototype.renderHighlights=function(a,c){var b=this,d=this._highlightHelper;if(d&&d.enabled&&
(this._hasHighlights||this._renderPlugins.needsHighlight)){var g=null;d.profilingCallback&&(g=ca.startMeasurement(this._renderContext.rctx));var f=this._offscreenRendering;this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;f=f.renderToTargets(function(){b.renderGeometryPass(4,a);b._rctx.clearSafe(256);b.renderHUD(w.HUD.TransparentRenderStyle.BOTH)},f.highlight,f.tmpDepth,[0,0,0,0],!0,!0);d.render(a,f,c);null!==g&&d.profilingCallback&&g.stop(function(a){d.profilingCallback&&
d.profilingCallback(a)})}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)};b.prototype.renderOccluded=function(){var a=this,c=0;this._materialRenderers.forEach(function(a,b){b&&b.isVisible()&&8===b.renderOccluded&&(c|=b.renderOccluded,n.push(b))});var b=this._offscreenRendering,d=this._renderContext,g=function(a,d,e,f,g){void 0===e&&(e=function(){return h(d)});void 0===f&&(f=!0);void 0===g&&(g=!0);0!==(c&d)&&(b.renderToTargets(e,b.tmpColor,b.mainDepth,[0,0,0,0],f,g),
b.compositeOccludedOntoMain(a))};0!==n.length&&(this.renderInternalSlot(10,d,n),g(.2,8,function(){return a.renderInternalSlot(11,d,n)},!1,!1),n.length=0);this._materialRenderers.forEach(function(a,b){b&&b.isVisible()&&(4===b.renderOccluded||2===b.renderOccluded||32===b.renderOccluded||16===b.renderOccluded)&&(c|=b.renderOccluded,p.push(b))});var f=this._renderPlugins.renderOccludedFlags;if(c|=f){var h=function(b){d.renderOccludedMask=b;1<f&&a._renderPlugins.render(9,d);a.renderInternalSlot(3,d,p);
a.renderInternalSlot(5,d,p);a.renderInternalSlot(8,d,p);d.resetRenderOccludedMask()};d.pass=0;g(.5,4,function(){return h(4)},!0,2);g(.5,2,function(){return h(2)},!0,2);g(1,48,function(){h(16);h(32)},!0,2);p.length=0}};b.prototype.renderAntiAliasing=function(a,b){var c=this;switch(b){case 1:this._smaaPass.loadResources(function(){return c.requestRender()});this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:this._offscreenRendering.colorTexture},a)):(this._rctx.bindFramebuffer(a),
this._offscreenRendering.composite());break;case 2:this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:this._offscreenRendering.colorTexture},a)):(this._rctx.bindFramebuffer(a),this._offscreenRendering.composite());break;default:this._rctx.bindFramebuffer(a),this._offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable()}};b.prototype.renderInternalSlot=function(a,b,e){this._bindParameters.slot=a;this._bindParameters.view=b.camera.viewMatrix;
this._bindParameters.proj=b.camera.projectionMatrix;this._bindParameters.viewInvTransp=b.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=b.camera.aboveGround;this._bindParameters.fovY=b.camera.fovY;x[0]=b.camera.near;x[1]=b.camera.far;var c=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=x;this._bindParameters.viewport=b.camera.fullViewport;this._bindParameters.shadowMap=b.shadowMap;this._bindParameters.shadowMappingEnabled=!!b.shadowMap&&b.shadowMap.enabled;
this._bindParameters.ssaoEnabled=!!b.ssaoHelper&&b.ssaoHelper.enabled;this._bindParameters.pixelRatio=b.camera.pixelRatio;this._bindParameters.slicePlane=b.sliceHelper&&b.sliceHelper.plane;this._bindParameters.hasOccludees=b.hasOccludees;this._bindParameters.linearDepthTextureID=3;this._bindParameters.lastFrameColorTextureID=4;this._bindParameters.hudVisibilityTexture=c?c.hudVisibilityTexture:null;this._bindParameters.highlightDepthTexture=c&&c.depthTexture||this.getFallbackDepthTexture();return this.renderInternalSlotMaterials(a,
b,e)};b.prototype.renderInternalSlotMaterials=function(a,b,e){var c=this,g=0===b.pass?this._stats:null,f=!1;u.isSome(e)?e.forEach(function(d){D.materialPredicate(d,b)&&(d=c._materialRenderers.get(d),u.isSome(d)&&(f=d.render(a,b,c._bindParameters)||f))}):this._materialRenderers.forEach(function(d,e){D.materialPredicate(e,b)&&(e=g?g.getMaterialRenderStatsObject(d.type):null,f=d.render(a,b,c._bindParameters,e)||f)});return f};b.prototype.updateGlobalUniforms=function(a){for(var b=this._shaderTechniqueRepository.getProgramsUsingUniform("proj"),
e=0;e<b.length;e++)b[e].setUniformMatrix4fv("proj",a);if(this._lighting)for(b=this._shaderTechniqueRepository.getProgramsUsingUniform("lightingMainDirection"),e=0;e<b.length;e++)this._lighting.setUniforms(b[e])};b.prototype.getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=O.createEmptyDepthTexture(this._rctx));return this._fallbackDepthStencilTexture};b.prototype.getGpuMemoryUsage=function(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():
0,highlights:this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0,shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}};Object.defineProperty(b.prototype,"test",{get:function(){return{antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,materialRenderers:this._materialRenderers}},enumerable:!0,configurable:!0});b.prototype.setBindParametersSSR=
function(a){this._cameraCurrent.copyFrom(a);this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture;this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture;l.mat4.translate(F,this._cameraPrevious.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]);l.mat4.translate(r,this._cameraCurrent.viewMatrix,this._bindParameters.origin?
this._bindParameters.origin:[0,0,0]);l.mat4.invert(r,r);l.mat4.invert(G,this._cameraCurrent.projectionMatrix);l.mat4.multiply(m,r,G);l.mat4.multiply(m,F,m);l.mat4.multiply(m,this._cameraPrevious.projectionMatrix,m);this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=m;this._renderContext.ssrParams.ssrViewMat=this._bindParameters.ssrViewMat=a.viewMatrix;this._renderContext.ssrParams.rpProjectionMat=this._bindParameters.rpProjectionMat=a.projectionMatrix;y[0]=a.near;y[1]=
a.far;this._renderContext.ssrParams.nearFar=y;this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=!0;this._cameraPrevious.copyFrom(this._cameraCurrent)};b.prototype.removeBindParametersSSR=function(){this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null;this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=!1};return b}();var x=B.vec2f64.create(),y=B.vec2f64.create(),p=[],n=[],F=q.mat4f64.create(),G=q.mat4f64.create(),
r=q.mat4f64.create(),m=q.mat4f64.create();return z});