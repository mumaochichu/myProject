// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../request ../../../../core/asyncUtils ../../../../core/Error ../../../../core/lang ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/Version ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../support/imageUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial".split(" "),function(X,
t,h,J,x,K,L,M,y,v,E,F,w,N,O,P,Q,R){function S(e,f){return h.__awaiter(this,void 0,void 0,function(){var b,a;return h.__generator(this,function(g){switch(g.label){case 0:return(b=y.isSome(f)&&f.streamDataRequester)?[2,T(e,b,f)]:[4,x.result(J(e,y.unwrap(f)))];case 1:a=g.sent();if(!0===a.ok)return[2,a.value.data];v.throwIfAbortError(a.error);G(a.error);return[2,void 0]}})})}function T(e,f,b){return h.__awaiter(this,void 0,void 0,function(){var a;return h.__generator(this,function(g){switch(g.label){case 0:return[4,
x.result(f.request(e,"json",b))];case 1:a=g.sent();if(!0===a.ok)return[2,a.value];v.throwIfAbortError(a.error);G(a.error.details.url);return[2,void 0]}})})}function G(e){throw new K("","Request for object resource failed: "+e);}function U(e){var f=w.empty();e.forEach(function(b){b=b.boundingInfo;w.expand(f,b.getBBMin());w.expand(f,b.getBBMax())});return f}function H(e,f){return h.__awaiter(this,void 0,void 0,function(){var b,a,g,I,p,u,q,n;return h.__generator(this,function(h){switch(h.label){case 0:b=
[];a=function(a){var g=e[a],h=g.images[0].data;if(!h)return r.warn("Externally referenced texture data is not yet supported"),"continue";var h=g.encoding+";base64,"+h,n="/textureDefinitions/"+a,c={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:!0};a=y.isSome(f)&&f.disableTextures?v.resolve(null):N.requestImage(h,f);b.push(a.then(function(a){return{refId:n,image:a,params:c,alphaChannelUsage:"rgba"===g.channels?g.alphaChannelUsage||"transparency":"none"}}))};for(g in e)a(g);return[4,v.all(b)];
case 1:I=h.sent();p={};u=0;for(q=I;u<q.length;u++)n=q[u],p[n.refId]=n;return[2,p]}})})}function V(e){switch(e){case "mask":return 2;case "maskAndTransparency":return 3;case "none":return 1;case "transparency":return 0;default:return 0}}Object.defineProperty(t,"__esModule",{value:!0});var r=M.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");t.load=function(e,f){return h.__awaiter(this,void 0,void 0,function(){var b,a;return h.__generator(this,function(g){switch(g.label){case 0:return[4,
S(e,f)];case 1:return b=g.sent(),[4,H(b.textureDefinitions,f)];case 2:return a=g.sent(),[2,{resource:b,textures:a}]}})})};t.processLoadResult=function(e,f){var b,a,g=[],h=[],p=[],u=[],q=e.resource,n=E.Version.parse(q.version||"1.0","wosr");W.validate(n);var n=q.model.name,t=q.model.geometries,v=q.materialDefinitions;e=e.textures;for(var w=0,A=new Map,B=0;B<t.length;B++){var c=t[B];a=c;var d=a.params,m=d.topology;b=!0;d.vertexAttributes||(r.warn("Geometry must specify vertex attributes"),b=!1);switch(d.topology){case "PerAttributeArray":break;
case "Indexed":case null:case void 0:m=d.faces;if(!m)r.warn("Indexed geometries must specify faces"),b=!1;else if(d.vertexAttributes){var l=void 0;for(l in d.vertexAttributes)(d=m[l])&&d.values?(null!=d.valueType&&"UInt32"!==d.valueType&&(r.warn("Unsupported indexed geometry indices type '"+d.valueType+"', only UInt32 is currently supported"),b=!1),null!=d.valuesPerElement&&1!==d.valuesPerElement&&(r.warn("Unsupported indexed geometry values per element '"+d.valuesPerElement+"', only 1 is currently supported"),
b=!1)):(r.warn("Indexed geometry does not specify face indices for '"+l+"' attribute"),b=!1)}break;default:r.warn("Unsupported topology '"+m+"'"),b=!1}a.params.material||(r.warn("Geometry requires material"),b=!1);a=a.params.vertexAttributes;d=void 0;for(d in a)a[d].values||(r.warn("Geometries with externally defined attributes are not yet supported"),b=!1);if(b){a=c.params;b=a.material;a=a.texture;var m=c.params.vertexAttributes,d={},C;for(C in m)l=m[C],d[C]={data:l.values,size:l.valuesPerElement};
m={};if("PerAttributeArray"===c.params.topology){for(var c=d.position.data.length/d.position.size,l=new Uint32Array(c),k=0;k<c;k++)l[k]=k;var c=l,x;for(x in d)m[x]=c}else{var c=c.params.faces,D;for(D in c)m[D]=new Uint32Array(c[D].values)}(c=e&&e[a])&&!A.has(a)&&(l=new Q(c.image,n,c.params),u.push(l),A.set(a,l));l=(l=A.get(a))?l.id:void 0;k=p[b]?p[b][a]:null;if(!k){k=b.substring(b.lastIndexOf("/")+1);k=v[k].params;1===k.transparency&&(k.transparency=0);var z=c&&c.alphaChannelUsage,z=0<k.transparency||
"transparency"===z||"maskAndTransparency"===z,c={ambient:F.vec3f64.fromArray(k.diffuse),diffuse:F.vec3f64.fromArray(k.diffuse),opacity:1-(k.transparency||0),transparent:z,textureAlphaMode:c?V(c.alphaChannelUsage):void 0,textureAlphaCutoff:.33,textureId:l,initTextureTransparent:!0,doubleSided:!0,cullFace:0,colorMixMode:k.externalColorMixMode||"tint",textureAlphaPremultiplied:!0};y.isSome(f)&&f.materialParamsMixin&&L.mixin(c,f.materialParamsMixin);k=new R(c,n);p[b]||(p[b]={});p[b][a]=k}h.push(k);b=
new O(new P.GeometryData(d,m),n);w+=m.position?m.position.length:0;g.push(b)}}return{name:n,stageResources:{textures:u,materials:h,geometries:g},pivotOffset:q.model.pivotOffset,boundingBox:U(g),numberOfVertices:w,lodThreshold:null}};t.createTextureResources=H;var W=new E.Version(1,2,"wosr")});