// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Color ../../../Graphic ../../../core/Collection ../../../core/has ../../../core/Logger ../../../core/MapUtils ../../../core/mathUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/scheduling ../../../core/typedArrayUtil ../../../core/unitUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat3 ../../../core/libs/gl-matrix-2/mat3f32 ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../geometry/support/aaBoundingBox ../../../layers/graphics/controllers/I3SOnDemandController ../../../layers/support/fieldUtils ../../../layers/support/layerUtils ../../../layers/support/SceneModification ../../../renderers/visualVariables/support/visualVariableUtils ../../../support/arcadeOnDemand ../../../symbols/Symbol3D ../../../symbols/support/unitConversionUtils ./I3SMeshViewLabeler ./I3SMeshWorkerHandle ./graphics/graphicUtils ./i3s/Highlights ./i3s/I3SElevationProvider ./i3s/I3SGeometryUtil ./i3s/I3SIntersectionHandler ./i3s/I3SProjectionUtil ./i3s/I3SUtil ./i3s/IDBCache ./support/attributeUtils ./support/layerViewUpdatingProperties ../support/debugFlags ../support/orientedBoundingBox ../support/projectionUtils ../support/buffer/glUtil ../webgl-engine/collections/Component/SourceGeometry ../webgl-engine/core/material/RenderTexture ../webgl-engine/core/shaderLibrary/util/AlphaDiscard.glsl ../webgl-engine/lib/Texture ../webgl-engine/lib/TextureBackedBuffer/BufferManager @dojo/framework/shim/Promise".split(" "),
function(ea,x,h,fa,I,ga,ha,ia,N,K,g,v,ja,O,ka,P,p,la,ma,Q,R,na,S,oa,E,pa,T,qa,ra,U,sa,ta,ua,va,wa,V,xa,ya,za,Aa,L,k,Ba,M,Ca,F,W,C,Da,Ea,G,Fa,X,Ga){function Y(g){var h=g.metallicRoughness;return h&&0<=h.baseColorTextureId||h&&0<=h.metallicRoughnessTextureId||0<=g.normalTextureId||0<=g.emissiveTextureId||0<=g.occlusionTextureId}function Z(h){return g.isSome(h)&&O.isArrayBuffer(h.data)}function aa(h,k){h=1024+h.interleavedVertexData.byteLength+(h.indices?h.indices.byteLength:0)+h.positionData.data.byteLength+
h.positionData.indices.byteLength;if(g.isSome(k))for(var b=0;b<k.length;b++){var a=k[b];g.isSome(a)&&O.isArrayBuffer(a.data)&&(h+=a.data.byteLength)}return h}function ba(g,h){return 104857600<h.byteSize?(D.warn("Node is too big to store in IndexedDB cache: "+g.id+" ("+h.byteSize+" bytes)"),!1):0<h.byteSize}Object.defineProperty(x,"__esModule",{value:!0});var D=ia.getLogger("esri.views.3d.layers.SceneLayerView3D"),ca=[1,1,1,1],Ha=function(){return function(g,h,b,a,c,d,e){this.node=g;this.featureIds=
h;this.objectHandle=b;this.cachedRendererVersion=a;this.attributeInfo=c;this.material=d;this.textures=e;this.cachedEdgeMaterials=[];this.cachedSymbology=null}}();x.I3SMeshView3D=function(x){return function(x){function b(){var a=null!==x&&x.apply(this,arguments)||this;a._elevationProvider=null;a._intersectionHandler=null;a._nodeId2Meta=new Map;a._addTasks=new Map;a._rendererVersion=0;a._colorVariable=null;a._opacityVariable=null;a._rendererFields=null;a._symbologyFields=null;a._symbologyOverride=null;
a._symbologyOverrideFields=null;a._symbolInfos=new Map;a._idbCache=new Ba.IDBCache("esri-scenelayer-cache","geometries");a._labeler=null;a.holeFilling="auto";a._hasColors=!1;a._hasTextures=!1;a._hasData=!1;a.slicePlaneEnabled=!1;a._modifications=[];a._layerUrl="";a._cacheKeySuffix=null;a._arcade=null;a._tmpAttributeOnlyGraphic=new I(null,null,{});return a}h.__extends(b,x);Object.defineProperty(b.prototype,"layerUid",{get:function(){return this.layer&&this.layer.uid},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"sublayerUid",{get:function(){return null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updatingMeshView3D",{get:function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||g.isSome(this._labeler)&&this._labeler.updating},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":
"probably-not":"unknown"},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"rendererTextureUsage",{get:function(){return k.rendererNeedsTextures(this._currentRenderer)?63:44},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"elevationOffset",{get:function(){var a=null!=this.layer?this.layer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){var c=ka.getMetersPerVerticalUnitForSR(this.layer.spatialReference),d=ua.getMetersPerUnit(a.unit);return g.unwrapOr(a.offset,
0)*d/c}return 0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view&&this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"useCompressedTextures",{get:function(){var a=this.layer.version,a=!ha("trident")||1<a.major||1===a.major&&3<a.minor;return this.view._stage.renderView.has("s3tc")&&a},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0});b.prototype.initialize=function(){var a=this;this._worker=new wa.I3SMeshWorkerHandle(this.view.resourceController.scheduler);this.addResolvingPromise(this._worker.promise);this._worker.setLegacySchema(this.layerUid,this.layer.store.defaultGeometrySchema);k.checkSceneLayerValid(this.layer);k.checkSceneLayerCompatibleWithView(this.layer,
this.view);this._layerUrl=this.layer.parsedUrl.path;this._controller=new pa({layerView:this});this.geoMemoryEstimate=this.texMemoryEstimate=this.gpuMemoryEstimate=0;this._stage=this.view._stage;this._collection=this._stage.renderView.componentObjectCollection;this._highlights=new xa({collection:this._collection,forAllFeatures:function(c){return a._forAllFeatures(c,null,1)},forAllFeaturesOfNode:function(c,e){return a._forAllFeaturesOfNode(c,e)}});if(this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=
!1;else{var c=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(c&&c.faceRange&&c.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color);this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView());this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,function(c){return a._deleteComponentObject(c)});
this._intersectionHandler=new Aa.I3SIntersectionHandler({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,forEach:function(c){return a._nodeId2Meta.forEach(function(a){return g.isSome(a)&&c(a.node,a.objectHandle)})}});this._elevationProvider=new ya({layerView:this,intersectionHandler:this._intersectionHandler});this.updatingHandles.add(this,"view.clippingArea",function(){return a._clippingAreaChanged()},
2);this.updatingHandles.add(this,"fullOpacity",function(c){return a._opacityChange(c)});this.updatingHandles.add(this,"slicePlaneEnabled",function(c){return a._slicePlaneEnabledChange(c)});this.updatingHandles.add(this,"elevationOffset",function(c,e){a._reloadAll(e);a._controller.recomputeAuthorativeOBBs()});this.updatingHandles.add(this,"filter",function(){return a._filterChange()},2);this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",function(){return a._updatePBR()});
c=function(){a._reloadAll();a._memCache.clear()};this.updatingHandles.add(this,"rendererTextureUsage",c);this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",c);this.updatingHandles.add(this,"suspended",function(c){return a._suspendedChange(c)},2);this.updatingHandles.add(this.layer,"labelsVisible",function(){return a._labelingChanged()},2);this.updatingHandles.add(this.layer,"labelingInfo",function(){return a._labelingChanged()},2);this.updatingHandles.add(this,"_modifications",
function(){return a._modificationsChanged()},2);this.handles.add([P.init(F,"I3S_TREE_SHOW_TILES",function(c){if(c&&!a._treeDebugger){var d=a._controller.crsIndex;(new Promise(function(a,c){ea(["./support/I3STreeDebugger"],a,c)})).then(function(c){c=c.I3STreeDebugger;!a._treeDebugger&&F.I3S_TREE_SHOW_TILES&&(a._treeDebugger=new c({lv:a,view:a.view,nodeSR:d}))})}else c||!a._treeDebugger||F.I3S_TREE_SHOW_TILES||(a._treeDebugger.destroy(),a._treeDebugger=null)}),P.init(F,"I3S_SHOW_MODIFICATIONS",function(){return a._showModifications()})]);
this._cacheKeySuffix=k.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference);this._idbCache.init().catch(function(a){return D.warn("Failed to initialize IndexedDB cache: "+a)});this._componentColorManager=this._hasSymbolColors?new Ga.BufferManager(this._stage.renderView.renderingContext):null};b.prototype.destroy=function(){this._clearAddTasks();this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),
this._elevationProvider=null);this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);var a=this._worker;a&&(a.destroyContext(this.layer.uid).then(function(){return a.destroy()}),this._worker=null);this._removeAllNodeDataFromStage();this._memCache.destroy();this._stage=this._collection=this._memCache=null;g.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null);this._treeDebugger&&(this._treeDebugger.destroy(),
this._treeDebugger=null);this._controller&&(this._controller.destroy(),this._controller=null);this._highlights.destroy();this._nodeId2Meta=null;this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)};b.prototype.memEstimateTextureAdded=function(a){a=a.estimatedTexMemRequired;this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a;return a};b.prototype.memEstimateTextureRemoved=
function(a){a=a.estimatedTexMemRequired;this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a};b.prototype.memEstimateGeometryAdded=function(a){a=this._collection.getObjectMemoryUsageGPU(a);this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a;return a};b.prototype.memEstimateGeometryRemoved=function(a){a=this._collection.getObjectMemoryUsageGPU(a);this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a};b.prototype.isNodeLoaded=function(a){return this._nodeId2Meta.has(a)};b.prototype.getUsedMemory=function(){var a=
g.isSome(this._labeler)?this._labeler.usedMemory:0;this._nodeId2Meta.forEach(function(c){return a+=g.isSome(c)?c.node.memory:0});return a};b.prototype.getUnloadedMemory=function(){return(this._controller?this._controller.unloadedMemoryEstimate:0)+(g.isSome(this._labeler)?this._labeler.unloadedMemoryEstimate:0)};b.prototype.ignoresMemoryFactor=function(){return!1};b.prototype._labelingChanged=function(){var a=this;if(!qa.areLabelsVisible(this.layer)||!this._supportsLabeling)g.isSome(this._labeler)&&
(this._labeler.destroy(),this._labeler=null);else if(!g.isSome(this._labeler)){var c=new va.default({view:this.view,layer:this.layer,collection:this._collection});this._nodeId2Meta.forEach(function(d){return g.isSome(d)&&a._addMetaToLabeler(c,d)});this._labeler=c}};b.prototype._modificationsChanged=function(){this._worker.setModifications(this.layer.uid,this._modifications,this.layer.spatialReference);this._reloadAll();this._memCache.clear();this._controller.recomputeAuthorativeOBBs();this._showModifications()};
b.prototype._showModifications=function(){g.isSome(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null);if(F.I3S_SHOW_MODIFICATIONS&&0!==this._modifications.length){var a={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},c={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=[];for(var d=0,e=this._modifications;d<e.length;d++){var f=e[d];f.geometry.spatialReference=this.layer.spatialReference;
var b=h.__assign(h.__assign({},c),{color:a[f.type]});this._modificationGraphics.push(new I({geometry:f.geometry,symbol:b}))}this.view.graphics.addMany(this._modificationGraphics)}};b.prototype._addMetaToLabeler=function(a,c){var d=this;a.addNodeMeta(c,function(a,c){return d._createAttributes(a,c)})};b.prototype._suspendedChange=function(a){a?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):
(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))};b.prototype.getLoadedAttributes=function(a){a=this._nodeId2Meta.get(a);if(g.isSome(a)&&g.isSome(a.attributeInfo))return a.attributeInfo.loadedAttributes};b.prototype.getAttributeData=function(a){a=this._nodeId2Meta.get(a);if(g.isSome(a)&&g.isSome(a.attributeInfo))return a.attributeInfo.attributeData};b.prototype.setAttributeData=
function(a,c){var d=this;a=this._nodeId2Meta.get(a);g.isSome(a)&&(a.attributeInfo=c,a.cachedRendererVersion=this._getInvalidRendererVersion(),a.filteredIds=null,g.isSome(this._labeler)&&this._labeler.setNodeMetaAttributes(a,function(a,c){return d._createAttributes(a,c)}),this._updateEngineObject(a))};b.prototype.getVisibleNodes=function(){var a=[];this._nodeId2Meta.forEach(function(c){return g.isSome(c)&&a.push(c.node)});return a};b.prototype.getLoadedNodeIndices=function(a){this._nodeId2Meta.forEach(function(c,
d){return a.push(d)})};b.prototype._createTexture=function(a,c,d,e){if(g.isNone(d)||null==d.data)return null;var b=d.data,r=c.wrapTextures;c=d.usage&1?"opaque"===c.alphaMode?3:4:3;var u=!0,m;d.encoding===k.DDS_ENCODING_STRING?m=X.DDS_ENCODING:u=K.isPowerOfTwo(b.width)&&K.isPowerOfTwo(b.height);u=(e?this._enableAtlasMipMaps:this._enableMipMaps)&&u;d=new X(b,a.id+"/"+d.id,{mipmap:u,wrap:e||!r?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:e&&u&&this._disableAtlasAnisotropy,encoding:m,noUnpackFlip:!0,
components:c});this._stage.add(4,d);a.memory+=this.memEstimateTextureAdded(d);return d};b.prototype._getVertexBufferLayout=function(a,c){a={hasTexture:Y(a.params.material),hasNormals:c.normal,hasRegions:c.uvRegion};return Da.glLayout(Ea.createVertexBufferLayout(this._getGeometryParameters(a)))};b.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};b.prototype._findGraphicNodeAndIndex=function(a){var c=M.attributeLookup(a.attributes,this._getObjectIdField()),d=null;
N.someMap(this._nodeId2Meta,function(a){if(g.isNone(a))return!1;var e=a.featureIds.indexOf(c);if(-1===e)return!1;d={node:a.node,index:e};return!0});return d};b.prototype._getGraphicIndices=function(a,c){a=this._nodeId2Meta.get(a.index);if(g.isNone(a))return[];for(var d=[],e=this._getObjectIdField(),b=0;b<c.length;b++){var r=M.attributeLookup(c[b].attributes,e),r=a.featureIds.indexOf(r);-1!==r&&d.push(r)}return d};b.prototype.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);if(!a)return v.reject();
var c=this._nodeId2Meta.get(a.node.index);if(g.isNone(c))return v.reject();a=za.boundingBoxCornerPoints(a.index,this._collection,c.objectHandle,new Float64Array(24));if(C.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8))return c=E.empty(),E.expandWithBuffer(c,a,0,8),v.resolve({boundingBox:c,screenSpaceObjects:[]})};b.prototype.whenGraphicAttributes=function(a,c){var d=this;return k.whenGraphicAttributes(this.layer,a,this._getObjectIdField(),c,function(a){for(var c=
new Map,e=[],b=0;b<a.length;b++){var g=a[b],h=d._findGraphicNodeAndIndex(g),l=c.get(h.node);l||(l={node:h.node,indices:[],graphics:[]},e.push(l));l.indices.push(h.index);l.graphics.push(g)}return e},{populateObjectId:!0})};b.prototype.getGraphicFromIntersectorMetadata=function(a){if(null==a.nodeIndex||null==a.componentIndex)return null;var c=this._nodeId2Meta.get(a.nodeIndex);return g.isNone(c)||null==c.featureIds||a.componentIndex>=c.featureIds.length?null:this._createGraphic(a.componentIndex,c)};
b.prototype._getCacheKey=function(a){return this._layerUrl+"/v15/"+a.id+this._cacheKeySuffix};b.prototype._getMemCacheKey=function(a,c){void 0===c&&(c=this.elevationOffset);return a+"#"+c};Object.defineProperty(b.prototype,"_idbCacheEnabled",{get:function(){return!this._controller.disableIDBCache&&0===this._modifications.length&&0===this.elevationOffset&&null!=this._cacheKeySuffix},enumerable:!0,configurable:!0});b.prototype.loadCachedGPUData=function(a){return this._memCache.pop(this._getMemCacheKey(a.index))};
b.prototype._cacheGPUData=function(a,c){void 0===c&&(c=this.elevationOffset);var d=this._controller.indexDepth-a.node.level+1;this._memCache.put(this._getMemCacheKey(a.node.index,c),a,a.node.memory,d)};b.prototype.loadMissingTextures=function(a,c,d,e){var b=this,r=a.filter(function(a,d){if(0===(a.usage&b.rendererTextureUsage))return!1;if(g.isNone(c))return!0;a=k.selectEncoding(a.encodings,b.useCompressedTextures);d=c[d];return g.isNone(d)||null==d.data||a&&d.encoding!==a.encoding?!0:!1});return 0===
r.length?v.resolve(!1):d(r,e).then(function(d){for(var e=0,b=0;b<a.length;b++)e<d.length&&d[e].id===a[b].id&&(c[b]=d[e],e++);return!0})};b.prototype.loadCachedNodeData=function(a,c,d){var e=this;return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(a),c).then(function(b){if(null==b)return null;if(b.nodeVersion!==a.version)return e._idbCache.remove(e._getCacheKey(a)),null;a.obb||e._setComputedObb(a,b.nodeObb);return e.loadMissingTextures(b.requiredTextures,b.textureData,d,c).then(function(d){d&&
e._idbCache.initialized&&g.isSome(b.textureData)&&(b.byteSize=aa(b.transformedGeometry,b.textureData),b.textureData.every(Z)&&ba(a,b)&&e._idbCache.put(e._getCacheKey(a),b).catch(function(c){return D.warn("Failed to update node with textures in IndexedDB cache: "+a.id+": "+c)}));v.throwIfAborted(c);return b})}):v.resolve(null)};b.prototype.addNodeData=function(a,c,d){var b=this;return"geometryData"in c?this._addData(a,c.attributeDataInfo,function(){return b._transformNode(a,c,d).then(function(e){return b._controller.reschedule(d,
function(){if(g.isNone(e))return b._addCachedNodeData(a,null,d);var f=e.obb,u=e.componentOffsets,m=e.featureIds,q=e.transformedGeometry,f=W.create([f.center.x,f.center.y,f.center.z],[f.extents.x,f.extents.y,f.extents.z],[f.orientation.x,f.orientation.y,f.orientation.z,f.orientation.w]),l=b._controller.crsIndex,t=b.view.renderSpatialReference,k=L.computeGlobalTransformation(a.mbs,b.elevationOffset,l,t);na.vec3.transformMat4(f.center,f.center,k);C.bufferToBuffer(f.center,t,0,f.center,l,0,1);f.center[2]-=
b.elevationOffset;l=a.obb;g.isNone(l)&&(l=b._setComputedObb(a,f));c.geometryData.componentOffsets=u;m&&(c.geometryData.featureIds=Array.prototype.slice.call(m));u={nodeVersion:a.version,geometryData:c.geometryData,requiredTextures:c.requiredTextures,textureData:c.textureData,transformedGeometry:q,globalTrafo:k,nodeObb:l,byteSize:aa(q,c.textureData)};b._idbCacheEnabled&&b._idbCache.initialized&&ba(a,u)&&(m=g.isSome(u.textureData)?u.textureData.map(function(a){return Z(a)?a:null}):null,b._idbCache.put(b._getCacheKey(a),
h.__assign(h.__assign({},u),{textureData:m})).catch(function(c){return D.warn("Failed to store node in IndexedDB cache: "+a.id+": "+c)}));return b._addCachedNodeData(a,u,d)})})}):v.reject()};b.prototype.computeAuthorativeOBB=function(a){return k.computeAuthorativeOBB(a,this.view.renderSpatialReference,this._controller.crsIndex,this.layer.spatialReference,this.elevationOffset,this._modifications)};b.prototype._setComputedObb=function(a,c){a.obb=W.clone(c);a.isComputedObb=!0;this._controller.updateBoundingVolume(a.index);
return a.obb};b.prototype._transformNode=function(a,c,d){for(var b=c.geometryData.geometries,f=Array(b.length),r=0;r<b.length;++r)f[r]=this._getVertexBufferLayout(b[r],c.geometryDescriptor);var b=a.mbs,h=this.elevationOffset,m=this._controller.crsIndex,q=this._controller.crsVertex,l=this.view.renderSpatialReference,r=L.getLocalOrigin(b,h,m),h=L.computeGlobalTransformation(b,h,m,l),m=C.getProjectorName(m,q),q=C.getProjectorName(q,l);return g.isNone(m)||g.isNone(q)?null:this._worker.invoke({context:this.layer.uid,
geometryBuffer:c.geometryBuffer,geometryData:c.geometryData,geometryDescriptor:c.geometryDescriptor,layouts:f,localOrigin:r,globalTrafo:h,mbs:b,obb:a.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexToVertexProjector:m,vertexToRenderProjector:q},d)};b.prototype.addCachedGPUData=function(a,c,d){this._controller.isGeometryVisible(a)?(g.isSome(this._labeler)&&this._addMetaToLabeler(this._labeler,
c),this._addNodeMeta(a.index,c),this.updateNodeState(a.index,d),this._collection.setObjectVisibility(c.objectHandle,!0),this._updateMaterial(c),this._updateEngineObject(c),this._highlights.objectCreated(c),this._treeDebugger&&this._treeDebugger.update()):this._cacheGPUData(c)};b.prototype.addCachedNodeData=function(a,c,d,b){var e=this;return this._addData(a,d,function(){return e._addCachedNodeData(a,c,b)})};b.prototype._addCachedNodeData=function(a,c,d){var b=this;if(this.suspended||!this._controller.isGeometryVisible(a))return v.resolve();
if(g.isNone(c))return this._addNodeMeta(a.index,null),v.resolve();var f=c.geometryData,r=c.transformedGeometry,h=c.globalTrafo,m=g.isSome(c.textureData)?c.textureData.filter(function(a){return g.isSome(a)&&0!==(a.usage&b.rendererTextureUsage)}):null;a.memory=0;var q=f.componentOffsets,l=f.geometries,f=f.featureIds,t=null,k=null;if(this._hasSymbolColors)for(var t=this._componentColorManager.getBuffer(f.length),k=new Uint16Array(f.length),y=0;y<f.length;y++)k[y]=t.acquireIndex();var p=this._collection,
l=l[0],t=r.layout,k=r.indices,y=r.interleavedVertexData,B=r.positionData,r=r.hasColors,n=this._materialParameters(l,t),q=q||new Uint32Array([0,k?k.length:y.byteLength/t[0].stride]),q={vertices:{data:y,count:y.byteLength/t[0].stride,layoutParameters:n.geometryParams},positionData:{positions:B.data,indices:B.indices},indices:k,primitiveType:4,componentOffsets:q},t=l.transformation?R.mat4f64.clone(l.transformation):R.mat4f64.create();Q.mat4.multiply(t,h,t);var h=Q.mat4.getTranslation(S.vec3f64.create(),
t),t=la.mat3.fromMat4(ma.mat3f32.create(),t),k=this.view.renderSpatialReference,y=this.view.basemapTerrain.spatialReference,B=S.vec3f64.create(),w=[1,1,1];C.localLinearScaleFactors(h,k,w,y);C.vectorToVector(h,k,B,y);var J=p.createObject({toMapSpace:[B[0],B[1],w[0],w[1]],geometry:q,obb:g.unwrap(a.renderObb),transform:{position:h,rotationScale:t},visible:!1}),h={isSchematic:l.params.material.isSchematic,isOpaque:"blend"!==l.params.material.alphaMode&&1<=l.params.material.metallicRoughness.baseColorFactor[3]},
q=g.isSome(m)?m.map(function(c){return b._createTexture(a,n.material,c,2===n.geometryParams.textureCoordinates)}):[];this._configureMaterial(J,l.params.material,q,m);a.memory+=this.memEstimateGeometryAdded(J);var z=this._addTasks.get(a.index),A=new Ha(a,f,J,this._getInvalidRendererVersion(),z.attributeInfo,h,q);z.meta=A;!this._hasTextures&&c.requiredTextures.some(function(a){return 0!==(a.usage&19)})&&(this._hasTextures=!0);this._hasData=!0;this._hasColors=this._hasColors||r;this._hasTextures=this._hasTextures||
!!a.resources.texture;this.notifyChange("hasTexturesOrVertexColors");var x=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(A).then(function(c){c&&b._edgeView.updateObjectVisibility(A.objectHandle,!1);return b._controller.reschedule(d,function(){var d=b._addTasks.get(a.index);if(d)if(g.isSome(b._labeler)&&b._addMetaToLabeler(b._labeler,A),b._addNodeMeta(a.index,A),b.suspended)b._removeNodeStageData(a.index,b.elevationOffset);else{p.setObjectVisibility(J,!0);c&&b._edgeView.updateObjectVisibility(A.objectHandle,
!0);A.attributeInfo=d.attributeInfo;var d=A.cachedRendererVersion!==b._rendererVersion,e=x!==b.slicePlaneEnabled;b._setObjectSymbolColors(A);var f=b._applyFiltersToNode(A);(d||c&&(e||f))&&b._addOrUpdateEdgeRendering(A);b.visibleGeometryChanged(A);b._highlights.objectCreated(A);b._updateMaterial(A);b._treeDebugger&&b._treeDebugger.update()}})}).catch(function(a){g.isSome(z.meta)&&b._deleteComponentObject(z.meta);throw a;})};b.prototype._addNodeMeta=function(a,c){if(this._nodeId2Meta.has(a)){D.error("Removing duplicated node");
var b=this._nodeId2Meta.get(a);g.isSome(b)&&this._deleteComponentObject(b)}this._nodeId2Meta.set(a,c)};b.prototype._materialParameters=function(a,c){a=a.params.material;var b=c.some(function(a){return"uvRegion"===a.name});c=c.some(function(a){return"normalCompressed"===a.name});var e=Y(a);return{geometryParams:this._getGeometryParameters({hasTexture:e,hasNormals:c,hasRegions:b}),material:a}};b.prototype._configureMaterial=function(a,c,b,e){var d=this,h=this.rendererTextureUsage,k=function(a){a:{a&=
h;if(!g.isNone(e)&&0!==a)for(var c=0;c<e.length;c++){var d=e[c];if(g.isSome(d)&&0!==(d.usage&a)){a=b[c].id;break a}}a=null}return a};this._collection.updateMaterial(a,function(a){var b=c.metallicRoughness.baseColorFactor,e=K.clamp(c.metallicRoughness.baseColorFactor[3],0,1);a.baseColor=[b[0],b[1],b[2],e];a.objectOpacity=d.fullOpacity;a.mrrFactors=[c.metallicRoughness.metallicFactor,c.metallicRoughness.roughnessFactor,c.isSchematic?.2:.5];a.emissiveFactor=c.emissiveFactor;a.usePBR=d._usePBR(c.isSchematic);
a.isIntegratedMesh=d._isIntegratedMesh;a.alphaCutoff="mask"===c.alphaMode?c.alphaCutoff:Fa.defaultMaskAlphaCutoff;a.alphaDiscardMode="opaque"===c.alphaMode?1:"mask"===c.alphaMode?2:3;b=d._stage.renderView.textureRepository;if(e=k(33))a.baseColorTexture=new G.RenderTexture(b,e);if(e=k(2))a.metallicRoughnessTexture=new G.RenderTexture(b,e);if(e=k(16))a.emissionTexture=new G.RenderTexture(b,e);if(e=k(8))a.occlusionTexture=new G.RenderTexture(b,e);if(e=k(4))a.normalTexture=new G.RenderTexture(b,e);a.commonMaterialParameters.slicePlaneEnabled=
d.slicePlaneEnabled;a.commonMaterialParameters.doubleSided=c.doubleSided;a.commonMaterialParameters.cullFace=c.cullFace;d._updateMaterialOverlay(a)})};b.prototype._getGeometryParameters=function(a){return{textureCoordinates:a.hasTexture?a.hasRegions?2:1:0,colors:this._hasVertexColors,normals:a.hasNormals&&!this._isIntegratedMesh}};b.prototype._addData=function(a,c,b){var d=this,f=this._addTasks.get(a.index);f?f.attributeInfo=c:(f=h.__assign(h.__assign({},v.createResolver()),{attributeInfo:c,meta:null}),
this._addTasks.set(a.index,f),b().then(f.resolve,f.reject).then(function(){return d._addTasks.delete(a.index)}).catch(function(c){d._addTasks.delete(a.index);throw c;}));return f.promise};b.prototype._clearAddTasks=function(){var a=this;this._addTasks.forEach(function(c){g.isSome(c.meta)&&a._deleteComponentObject(c.meta)});this._addTasks.clear()};b.prototype._clippingAreaChanged=function(){var a=E.create();C.extentToBoundingBox(this.view.clippingArea,a,this.view.renderSpatialReference)?this._clippingArea=
a:this._clippingArea=null;this._filterChange();this._controller&&this._controller.updateClippingArea(this.view.clippingArea)};b.prototype._filterChange=function(){this._applyFilters(!1)};b.prototype._applyFilters=function(a){var c=this;this._filters=this.getFilters();a?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(a){g.isSome(a)&&c._applyFiltersToNode(a)&&(c._addOrUpdateEdgeRendering(a),c.visibleGeometryChanged(a))})};b.prototype.getFilters=function(){var a=
this,c=[];this._clippingArea&&c.push(function(c,b){return a._boundingboxFilter(c,b,a._clippingArea)});return c};b.prototype.addSqlFilter=function(a,c,b,e){var d=this;c&&b&&a.push(function(a,f){return d._sqlFilter(a,f,c,b,e)})};b.prototype._sqlFilter=function(a,c,b,e,f){var d={},h=this._createLayerGraphic(d),m=this.layer.objectIdField,q=c.featureIds,l=g.isSome(c.attributeInfo)&&c.attributeInfo.attributeData;e.every(function(a){return null!=l[a]||a===m})&&k.filterInPlace(a,q,function(a){d[m]=q[a];for(var c=
0;c<e.length;c++){var g=e[c];g!==m&&(d[g]=k.getCachedAttributeValue(l[g],a))}try{if(Array.isArray(b)){for(a=0;a<b.length;a++)if(b[a].testFeature(h))return!0;return!1}return b.testFeature(h)}catch(Ia){return f(Ia),!1}})};b.prototype._boundingboxNodeTest=function(a,c){C.mbsToMbs(a.node.mbs,this._controller.crsIndex,da,this.view.renderSpatialReference);return k.intersectBoundingBoxWithMbs(c,da)};b.prototype._boundingboxFeatureTest=function(a,c,b){return E.intersects(b,this._collection.getComponentAABB(a.objectHandle,
c,Ja))};b.prototype._boundingboxFilter=function(a,c,b){var d=this,f=this._collection,g=this._boundingboxNodeTest(c,b);if(3!==g)if(0===g)a.length=0;else if(f=f.getComponentCount(c.objectHandle),f.invisible+f.visible===c.featureIds.length){var h=this._transformAABB(Ka,b,c.objectHandle);k.filterInPlace(a,c.featureIds,function(a){return d._boundingboxFeatureTest(c,a,h)})}};b.prototype._transformAABB=function(a,c,b){var d=this._collection.getObjectTransform(b);b=d.position;d=d.rotationScale;a[0]=(c[0]-
b[0])/d[0];a[1]=(c[1]-b[1])/d[4];a[2]=(c[2]-b[2])/d[8];a[3]=(c[3]-b[0])/d[0];a[4]=(c[4]-b[1])/d[4];a[5]=(c[5]-b[2])/d[8];return a};b.prototype._addOrUpdateEdgeRendering=function(a,c){void 0===c&&(c=!0);if(!this._edgeView)return v.resolve(!1);var b=a.objectHandle,e=this._edgeView.hasObject(b);a=this._getFilteredEdgeMaterials(a);var f=a.perFeatureEdgeMaterials,g={slicePlaneEnabled:this.slicePlaneEnabled};if(a.hasEdges)return e?(this._edgeView.updateAllComponentMaterials(b,f,g,c),this._edgeView.updateObjectVisibility(b,
!0),v.resolve(!0)):this._collection.addEdges(b,this._edgeView,f,g).then(function(){return!0});e&&this._edgeView.removeObject(b);return v.resolve(!1)};b.prototype._removeEdgeRendering=function(a){this._edgeView&&this._edgeView.hasObject(a.objectHandle)&&this._edgeView.removeObject(a.objectHandle)};b.prototype._applyFiltersToNode=function(a){return this._applyFiltersToNodeComponents(a)?(g.isSome(this._labeler)&&this._labeler.applyFilterChange(a),!0):!1};b.prototype._applyFiltersToNodeComponents=function(a){var c=
this._collection,b=0===c.getComponentCount(a.objectHandle).invisible;c.setAllComponentVisibilities(a.objectHandle,"all");if(0===this._filters.length)return a.filteredIds=null,!b;this._updateCachedFilteredIds(a);if(a.filteredIds===a.featureIds)return!b;b=this._computeFilteredComponentIndices(a);c.setAllComponentVisibilities(a.objectHandle,b);return!0};b.prototype._updateCachedFilteredIds=function(a){if(null==a.filteredIds||a.appliedFilters!==this._filters)a.filteredIds=this._computeFilteredIds(a),
a.appliedFilters=this._filters};b.prototype._computeFilteredIds=function(a){for(var c=a.featureIds.slice(),b=0,e=this._filters;b<e.length&&((0,e[b])(c,a),0!==c.length);b++);return c.length===a.featureIds.length?a.featureIds:c};b.prototype._computeFilteredComponentIndices=function(a){var c=[];a.featureIds.forEach(function(b,e){a.filteredIds[c.length]===b&&c.push(e)});return c};b.prototype._removeAllNodeDataFromStage=function(a){var c=this;void 0===a&&(a=this.elevationOffset);this._nodeId2Meta.forEach(function(b,
e){return c._removeNodeStageData(e,a)})};b.prototype.removeNodeData=function(a,c){for(var b=this.elevationOffset;0<a.length&&!c.done;){var e=a.pop();this._removeNodeStageData(e,b);c.madeProgress()}};b.prototype._removeNodeStageData=function(a,c){var b=this._nodeId2Meta.get(a);g.isNone(b)?this._nodeId2Meta.delete(a):(this._collection.setObjectVisibility(b.objectHandle,!1),this.visibleGeometryChanged(b),this._removeEdgeRendering(b),g.isSome(this._labeler)&&this._labeler.removeNodeMeta(b),this._nodeId2Meta.delete(a),
this._highlights.objectDeleted(b),this._cacheGPUData(b,c),this._treeDebugger&&this._treeDebugger.update())};b.prototype._deleteComponentObject=function(a){this._edgeView&&this._edgeView.removeObject(a.objectHandle);this.memEstimateGeometryRemoved(a.objectHandle);this._collection.destroyObject(a.objectHandle);if(a.textures){var c=0;for(a=a.textures;c<a.length;c++){var b=a[c];this.memEstimateTextureRemoved(b);this._stage.remove(4,b.id)}}};b.prototype.updateNodeState=function(a,c){a=this._nodeId2Meta.get(a);
g.isSome(a)&&this._collection.updateMaterial(a.objectHandle,function(a){return a.polygonOffsetEnabled=0===c})};b.prototype._invalidateAllSymbols=function(){this._rendererVersion=k.addWraparound(this._rendererVersion,1);this._controller&&this._controller.requestUpdate()};b.prototype._getInvalidRendererVersion=function(){return k.addWraparound(this._rendererVersion,-1)};b.prototype._rendererChange=function(a){return h.__awaiter(this,void 0,void 0,function(){var c,b,e,f,g,u,m,q,l,t;return h.__generator(this,
function(d){switch(d.label){case 0:this._currentRenderer=a;this.notifyChange("rendererTextureUsage");this._rendererVersion=k.addWraparound(this._rendererVersion,1);this._opacityVariable=this._colorVariable=this._rendererFields=null;this._invalidateAllSymbols();if(!a)return[3,2];c=this;b=T.fixFields;e=[this.layer.fields];return[4,a.getRequiredFields(this.layer.fields)];case 1:c._rendererFields=b.apply(void 0,e.concat([d.sent()])),d.label=2;case 2:this._updateSymbologyFields();if(!(!this._arcade&&a&&
"arcadeRequired"in a&&a.arcadeRequired))return[3,4];f=this;return[4,sa.loadArcade()];case 3:f._arcade=d.sent(),d.label=4;case 4:if(a&&"visualVariables"in a&&a.visualVariables)for(g=0,u=a.visualVariables;g<u.length;g++)m=u[g],"color"===m.type?this._colorVariable=m:"opacity"===m.type?this._opacityVariable=m:D.warn("Unsupported visual variable type for 3D Object Scene Services: "+m.type);if(a)for(q=0,l=a.getSymbols();q<l.length;q++)t=l[q],"mesh-3d"!==t.type&&D.error("Symbols of type '"+t.type+"' are not supported for 3D Object Scene Services.");
this._controller&&this._controller.requestUpdate();return[2]}})})};b.prototype._getCachedEdgeMaterials=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);return a.cachedEdgeMaterials};b.prototype._getSymbolColors=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);var c=a.cachedSymbology;return function(a,b){a*=5;oa.vec4.set(b.externalColor,c[a+0]/255,c[a+1]/255,c[a+
2]/255,c[a+3]/255);b.externalColorMixMode=c[a+4]&15;b.castShadows=0!==(c[a+4]&16);b.pickable=0!==(c[a+4]&32)}};b.prototype._getSymbolInfo=function(a,c){c=a&&a.getSymbol(c,{arcade:this._arcade});if(!(c instanceof ta))return null;a=c.id;if(this._symbolInfos.has(a))return this._symbolInfos.get(a);c=k.getSymbolInfo(c);this._symbolInfos.set(a,c);return c};b.prototype._setSymbologyOverride=function(a,c){this._symbologyOverride!==a&&(this._symbologyOverride=a,this._symbologyOverrideFields=c,this._invalidateAllSymbols(),
this._updateSymbologyFields())};b.prototype._updateSymbologyFields=function(){this._symbologyFields=g.isSome(this._symbologyOverrideFields)&&0<this._symbologyOverrideFields.length?g.isSome(this._rendererFields)&&0<this._rendererFields.length?T.fixFields(this.layer.fields,h.__spreadArrays(this._rendererFields,this._symbologyOverrideFields)):this._symbologyOverrideFields:this._rendererFields};b.prototype._updateCachedRendererData=function(a){a.cachedRendererVersion=this._rendererVersion;if(this._hasSymbolColors){var c=
this._tmpAttributeOnlyGraphic,b={};c.attributes=b;var e=this._currentRenderer,f=g.isSome(a.attributeInfo)&&a.attributeInfo.attributeData,r=null!=a.featureIds?this.layer.objectIdField:null,u=null!=f&&g.isSome(this._symbologyFields)&&0<this._symbologyFields.length,m=u?[]:null,q=u?[]:null;if(u&&g.isSome(this._symbologyFields))for(var l=0,t=this._symbologyFields;l<t.length;l++){var p=t[l],y=f[p];y&&(m.push(p),q.push(y))}a.cachedSymbology||(a.cachedSymbology=new Uint8Array(5*a.featureIds.length));for(var f=
{color:H,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null},l=this.fullOpacity,t=null,p=2,y=k.transparentEdgeMaterial,v=0,B=0;B<a.featureIds.length;B++){null!=r&&(b[r]=a.featureIds[B]);if(u)for(var n=0;n<m.length;n++)b[m[n]]=k.getCachedAttributeValue(q[n],B);var w=this._getSymbolInfo(e,c),x=n=null;if(e&&"visualVariables"in e){if(this._colorVariable){var z=U.getColor(this._colorVariable,c,{color:La,arcade:this._arcade});z&&(n=H,n[0]=z.r/255,n[1]=z.g/255,n[2]=z.b/255,this._opacityVariable||
null===z.a||(x=z.a))}this._opacityVariable&&(x=U.getOpacity(this._opacityVariable,c,{arcade:this._arcade}))}w&&w.material&&(z=w.material,n=g.isNone(n)||g.isNone(x)?V.overrideColor(n,x,z.color,z.alpha,ca,H):V.overrideColor(n,x,null,null,ca,H));g.isNone(n)&&(n=H,n[0]=1,n[1]=1,n[2]=1,n[3]=1);f.pickable=!0;f.castShadows=w?w.castShadows:!0;f.colorMixMode=w&&w.material?w.material.colorMixMode:1;f.edgeMaterial=w?w.edgeMaterial:null;g.isSome(this._symbologyOverride)&&(f.color=n,this._symbologyOverride(c,
f),n=f.color);if(g.isSome(f.edgeMaterial)){w=0>=n[3]?0:1<=n[3]&&(a.material.isOpaque||3===f.colorMixMode)?2:1;if(f.edgeMaterial!==t||w!==p)y=h.__assign(h.__assign({},f.edgeMaterial),{opacity:l,objectTransparency:w}),t=f.edgeMaterial,p=w;a.cachedEdgeMaterials[B]=y}else a.cachedEdgeMaterials[B]=k.transparentEdgeMaterial;a.cachedSymbology[v+0]=Math.round(255*n[0]);a.cachedSymbology[v+1]=Math.round(255*n[1]);a.cachedSymbology[v+2]=Math.round(255*n[2]);a.cachedSymbology[v+3]=Math.round(255*n[3]);a.cachedSymbology[v+
4]=f.colorMixMode|+f.castShadows<<4|+f.pickable<<5;v+=5}}};b.prototype._getFilteredEdgeMaterials=function(a){var c=this,b=this._getCachedEdgeMaterials(a);b.forEach(function(a){return a.opacity=c.fullOpacity});if(g.isNone(a.filteredIds))return{hasEdges:b.some(function(a){return a!==k.transparentEdgeMaterial}),perFeatureEdgeMaterials:b};var e=0,f=!1,b=b.map(function(c,b){if(a.featureIds[b]!==a.filteredIds[e])return k.transparentEdgeMaterial;f=f||c!==k.transparentEdgeMaterial;e++;return c});return{hasEdges:f,
perFeatureEdgeMaterials:b}};b.prototype._setObjectSymbolColors=function(a){if(this._hasSymbolColors){var c=a.objectHandle;a=this._getSymbolColors(a);this._collection.setComponentData(c,a);this._stage.renderView.setNeedsRender()}};b.prototype._reloadAll=function(a){void 0===a&&(a=this.elevationOffset);this._removeAllNodeDataFromStage(a);null!=this._controller&&this._controller.restartNodeLoading()};b.prototype._opacityChange=function(a){var c=this;this._nodeId2Meta.forEach(function(b){g.isNone(b)||
(c._collection.updateMaterial(b.objectHandle,function(c){return c.objectOpacity=a}),c._updateEdgeRendering(b))})};b.prototype._updateMaterial=function(a){var c=this;this._collection.updateMaterial(a.objectHandle,function(b){b.commonMaterialParameters.slicePlaneEnabled=c.slicePlaneEnabled;b.usePBR=c._usePBR(a.material.isSchematic);b.objectOpacity=c.fullOpacity;c._updateMaterialOverlay(b)})};b.prototype._updateMaterialOverlay=function(a){};b.prototype._updateEngineObject=function(a){this._setObjectSymbolColors(a);
this._applyFiltersToNode(a);this._addOrUpdateEdgeRendering(a);this.visibleGeometryChanged(a)};b.prototype._slicePlaneEnabledChange=function(a){var c=this;this._intersectionHandler&&(this._intersectionHandler.slicePlane=a);g.isSome(this._labeler)&&(this._labeler.slicePlaneEnabled=a);this._nodeId2Meta.forEach(function(b){g.isNone(b)||(c._collection.updateMaterial(b.objectHandle,function(b){b.commonMaterialParameters.slicePlaneEnabled=a}),c._updateEdgeRendering(b,!1))})};b.prototype._updatePBR=function(){var a=
this;this._nodeId2Meta.forEach(function(b){g.isNone(b)||a._collection.updateMaterial(b.objectHandle,function(c){c.usePBR=a._usePBR(b.material.isSchematic)})})};b.prototype._usePBR=function(a){return!this._isIntegratedMesh&&(a?this.view.qualitySettings.physicallyBasedRenderingEnabled:!0)};b.prototype._updateEdgeRendering=function(a,b){void 0===b&&(b=!0);this._edgeView&&this._edgeView.hasObject(a.objectHandle)&&this._addOrUpdateEdgeRendering(a,b)};b.prototype._forAllNodes=function(a){this._nodeId2Meta.forEach(a)};
b.prototype._forAllFeatures=function(a,b,d){var c=this;void 0===d&&(d=0);N.someMap(this._nodeId2Meta,function(e){if(g.isNone(e))return!1;if(g.isSome(b))switch(b(e)){case 0:return!0;case 2:return!1}var f=1;switch(d){case 1:f=c._forAllFeaturesOfNode(e,a);break;case 0:f=c._forVisibleFeaturesOfNode(e,a);break;case 2:f=c._forAllFeaturesOfNodeInClippingArea(e,a)}return 0===f})};b.prototype._forAllFeaturesOfNode=function(a,b){for(var c=1,e=a.featureIds,f=0;f<e.length&&(c=b(e[f],f,a),0!==c);f++);return c};
b.prototype._forVisibleFeaturesOfNode=function(a,b){var c=1,e=a.featureIds;this._collection.forEachVisibleComponent(a.objectHandle,function(d){c=b(e[d],d,a);return 1===c});return c};b.prototype._forAllFeaturesOfNodeInClippingArea=function(a,b){if(null==this._clippingArea)return this._forAllFeaturesOfNode(a,b);var c=this._boundingboxNodeTest(a,this._clippingArea);if(0===c)return 1;if(3===c)return this._forAllFeaturesOfNode(a,b);for(var c=a.featureIds,e=k.getClipAABB(this._clippingArea,this._collection.getObjectTransform(a.objectHandle)),
f=0;f<c.length;f++)if(this._boundingboxFeatureTest(a,f,e)){var g=b(c[f],f,a);if(0===g)return g}return 1};b.prototype._createAttributes=function(a,b){var c={};null!=b.featureIds&&(c[this._getObjectIdField()]=b.featureIds[a]);b=g.isSome(b.attributeInfo)&&b.attributeInfo.attributeData;if(g.isSome(b))for(var e=0,f=Object.keys(b);e<f.length;e++){var h=f[e];c[h]=k.getCachedAttributeValue(b[h],a)}return c};b.prototype._createGraphic=function(a,b){return this._createLayerGraphic(this._createAttributes(a,
b))};b.prototype.highlight=function(a){var b=this,d=this._highlights;"number"===typeof a?a=[a]:a instanceof I?a=[a]:a instanceof ga&&(a=a.toArray());if(Array.isArray(a)&&0<a.length){if(a[0]instanceof I){a=a.map(function(a){return M.attributeLookup(a.attributes,b._getObjectIdField())});var e=d.acquireSet(),f=e.set,e=e.handle;d.setFeatureIds(f,a);return e}if("number"===typeof a[0])return e=d.acquireSet(),f=e.set,e=e.handle,d.setFeatureIds(f,a),e}return Ma};b.prototype.visibleGeometryChanged=function(a){var b=
this;this._elevationProvider&&(this._elevationProvider.objectChanged(a.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=ja.schedule(function(){b.emit("visible-geometry-changed");b._visibleGeometryChangedSchedulerHandle=null})))};Object.defineProperty(b.prototype,"performanceInfo",{get:function(){var a={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/
1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};this._controller&&(this._idbCacheEnabled&&(a.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(a));return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){var b=
[];a._forAllFeatures(function(a){b.push(a);return 1},null,0);b.sort(function(a,b){return a-b});return b},get numNodes(){return a._nodeId2Meta.size}}},enumerable:!0,configurable:!0});h.__decorate([p.property()],b.prototype,"_visibleGeometryChangedSchedulerHandle",void 0);h.__decorate([p.property()],b.prototype,"view",void 0);h.__decorate([p.property()],b.prototype,"layer",void 0);h.__decorate([p.property()],b.prototype,"_controller",void 0);h.__decorate([p.property()],b.prototype,"_labeler",void 0);
h.__decorate([p.property({dependsOn:["updatingMeshView3D"]})],b.prototype,"updating",void 0);h.__decorate([p.property({dependsOn:["_controller.updating","_visibleGeometryChangedSchedulerHandle","_labeler.updating"]})],b.prototype,"updatingMeshView3D",null);h.__decorate([p.property({dependsOn:["_controller.rootNodeVisible"]})],b.prototype,"suspended",void 0);h.__decorate([p.property()],b.prototype,"holeFilling",void 0);h.__decorate([p.property(Ca.updatingProgress)],b.prototype,"updatingProgress",void 0);
h.__decorate([p.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],b.prototype,"updatingProgressValue",void 0);h.__decorate([p.property({readOnly:!0})],b.prototype,"hasTexturesOrVertexColors",null);h.__decorate([p.property({readOnly:!0})],b.prototype,"rendererTextureUsage",null);h.__decorate([p.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],b.prototype,"elevationOffset",null);h.__decorate([p.property({type:Boolean})],b.prototype,"slicePlaneEnabled",void 0);h.__decorate([p.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled",
"useCompressedTextures"]})],b.prototype,"uncompressedTextureDownsamplingEnabled",null);h.__decorate([p.property({dependsOn:["layer.version"]})],b.prototype,"useCompressedTextures",null);h.__decorate([p.property({type:[ra]})],b.prototype,"_modifications",void 0);return b=h.__decorate([p.subclass("esri.views.3d.layers.I3SMeshView3D")],b)}(x)};var Ja=E.create(),Ka=E.create(),H=[0,0,0,0],La=new fa([0,0,0,0]),da=[0,0,0,0],Ma={remove:function(){},pause:function(){},resume:function(){}}});