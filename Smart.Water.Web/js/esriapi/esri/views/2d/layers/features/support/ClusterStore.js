// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../geometry ../../../../../core/has ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/screenUtils ../../../../../geohash/GeohashTree ../../../../../geohash/geohashUtils ../../../../../geometry/support/spatialReferenceUtils ../../../../../geometry/support/webMercatorUtils ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/data/FeatureStore ../../../../../layers/graphics/data/projectionSupport ../../../../../layers/graphics/data/QueryEngine ../../../../../layers/graphics/data/utils ../../../../../support/arcadeOnDemand ../../../arcade/utils ../../../engine/webgl/definitions".split(" "),
function(F,G,q,A,W,h,L,M,H,z,N,D,O,P,Q,B,I,J,R,S,l){function T(h,d,a){return q.__awaiter(this,void 0,void 0,function(){var b,c,g,e;return q.__generator(this,function(n){b=[];c=0;for(g=h;c<g.length;c++)e=g[c],b.push(U(e,d,a));return[2,L.all(b)]})})}function U(h,d,a){return q.__awaiter(this,void 0,void 0,function(){var b,c,g;return q.__generator(this,function(e){switch(e.label){case 0:if(!("onStatisticValueExpression"in h.outStatistic))return[3,2];b=h;c=b.outStatistic.onStatisticValueExpression;g=b;
return[4,R.createRendererExpression(c,d,a)];case 1:return g.expression=e.sent(),[2,b];case 2:return[2,h]}})})}Object.defineProperty(G,"__esModule",{value:!0});var K=function(l){return h.andThen(l,function(d){return"cluster"!==d.type?null:q.__assign(q.__assign({},d),{clusterRadius:M.pt2px(d.clusterRadius/2)})})},V=function(h){function d(a,b,c,g,e){var n=this;b=new P.default([],[b,c]);n=h.call(this,b,g,null,a)||this;n.invalid=!1;n.canDelete=!1;n.geohashBoundsInfo=e;return n}q.__extends(d,h);Object.defineProperty(d.prototype,
"count",{get:function(){return this.attributes.cluster_count},enumerable:!0,configurable:!0});d.create=function(a,b,c,g,e,n,f){b=new d(b,c,g,n,f);b.localId=a.createLocalId(b.objectId,!0);b.tileLevel=e;return b};d.prototype.update=function(a,b,c,g,e){this.geometry.coords[0]=a;this.geometry.coords[1]=b;this.tileLevel=c;this.attributes=g;this.geohashBoundsInfo=e;this.referenceId=null;this.invalid=!1;return this};d.prototype.toJSON=function(){return{objectId:this.objectId,referenceId:this.referenceId,
attributes:q.__assign(q.__assign({},this.attributes),{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}};return d}(O.default);F=function(x){function d(a,b,c,g){a=x.call(this,a)||this;a._deferredDeletionQueue=[];a._invalidated=!1;a._aggregateFieldsHash=null;a._geohashLevel=0;a._aggregateValueRanges={};a._aggregateValueRangesChanged=!1;a._aggregateFields=[];a._hasAggregateValueExpression=!1;a._hasViewExpression=!1;a._$view={scale:0,viewingMode:"none"};a._clusters=
new Map;a._tiles=new Map;a._spatialReference=b;a._attributeStore=c;a._featureReduction=K(g);a._projectionSupportCheck=B.checkProjectionSupport(b,A.SpatialReference.WGS84);return a}q.__extends(d,x);d.prototype.setScale=function(a){var b=a!==this._$view.scale&&this._hasViewExpression,c=this._featureReduction;this._$view.scale=a;h.isSome(c)&&b&&(this._tree=new H.GeohashTree(this._aggregateFields),this._unindexFeatures(),this._reindexFeatures(!0))};d.prototype.update=function(a,b,c){return q.__awaiter(this,
void 0,void 0,function(){var g,e,n,d,l,r,u,p,k,m,t,y=this;return q.__generator(this,function(f){switch(f.label){case 0:g=this._featureReduction;e=h.andThen(b.featureReduction,K);n=b.aggregateFields.reduce(function(a,b){return a+JSON.stringify(b)},"");d=null===g&&b.featureReduction;l=n!==this._aggregateFieldsHash;r=d||l;if(!l)return[3,2];u=this;return[4,T(b.aggregateFields,this._spatialReference,c)];case 1:u._aggregateFields=f.sent();this._hasViewExpression=!1;p=0;for(k=this._aggregateFields;p<k.length;p++)m=
k[p],"onStatisticValueExpression"in m.outStatistic&&(t=m,this._hasAggregateValueExpression=!0,this._hasViewExpression=this._hasViewExpression||t.expression.referencesScale());f.label=2;case 2:return[4,this._projectionSupportCheck];case 3:f.sent();this._featureReduction=e;this._aggregateFieldsHash=n;this._aggregateValueRanges={};this._invalidated=!0;if(h.isNone(e))return this._tree=null,[2];h.isSome(g)&&g.clusterRadius!==e.clusterRadius&&this._clusters.forEach(function(a){return a.canDelete=!0});r&&
(this._tree=new H.GeohashTree(b.aggregateFields),this._unindexFeatures());(r||a)&&this._reindexFeatures(l);this._handleClusterUpdates();this._tiles.forEach(function(a){return y._getClustersForTile(a,0,e.clusterRadius,null,!1)});return[2]}})})};d.prototype._ensureAggregateFields=function(a){if(this._hasAggregateValueExpression)for(var b=this._$view,c=0,g=this._aggregateFields;c<g.length;c++){var e=g[c];"onStatisticValueExpression"in e.outStatistic&&(a.attributes[e.outStatistic.onStatisticField]=S.callWithOptimizedFeature(e.expression,
a,{$view:b},this.geometryInfo))}};d.prototype._unindexFeatures=function(){this._featuresById.forEach(function(a){a.geohashIndexed=!1})};d.prototype._reindexFeatures=function(a){var b=this;this._featuresById.forEach(function(c){c.geohashX||c.geohashY||b._setGeohash(c);a&&b._ensureAggregateFields(c);b._attributeStore.isVisible(c)?b._insertIntoIndex(c):b._removeFromIndex(c)})};d.prototype.onTileUpdate=function(a){var b=this,c=a.added;a=a.removed;if(c.length){var g=Math.max.apply(Math,c.map(function(a){return a.level}));
this._setGeohashLevel(g);c.forEach(function(a){return b._tiles.set(a.key.id,a)})}if(!h.isNone(this._featureReduction)){var e=this._featureReduction.clusterRadius;a.forEach(function(a){b._tiles.delete(a.key.id);b._markTileClustersForDeletion(a,e)})}};d.prototype.sweepClusters=function(){var a=this;this._clusters.forEach(function(b,c){b.canDelete&&(a._attributeStore.freeLocalId(b.objectId),a._clusters.delete(c))});for(var b=0,c=this._deferredDeletionQueue;b<c.length;b++)this._attributeStore.addLocalId(c[b]);
this._deferredDeletionQueue=[]};d.prototype.executeTileQuery=function(a,b,c){return q.__awaiter(this,void 0,void 0,function(){var g,e,d;return q.__generator(this,function(f){switch(f.label){case 0:return h.isNone(this._featureReduction)?[2,x.prototype.executeTileQuery.call(this,a,b,c)]:[4,this._projectionSupportCheck];case 1:return f.sent(),this._handleClusterUpdates(),g=this._featureReduction.clusterRadius,e=this._getTransforms(a,b),d=this._getClustersForTile(a,c.pixelBuffer,g,e),this._aggregateValueRangesChanged&&
(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),[2,d]}})})};d.prototype.getAggregate=function(a){var b=null;this._clusters.forEach(function(c){c.localId===a&&(b=c.toJSON())});return b};d.prototype.getAggregateValueRanges=function(){return this._aggregateValueRanges};d.prototype._getClustersForTile=function(a,b,c,g,e){var d=this;void 0===e&&(e=!0);b=Math.max(b,50);var f=2*c,E=new Set,r=this._getGeohashLevel(a.key.level),u=Math.pow(2,
a.key.level)*Math.ceil(l.TILE_SIZE/f),p=Math.ceil(b/f)+2;c=Math.ceil(l.TILE_SIZE/f)+2*p;var k=a.key;b=Math.floor(k.col*l.TILE_SIZE/f)-p;f=Math.floor(k.row*l.TILE_SIZE/f)-p;p=b+c;c=f+c;for(var m=[],t=a.tileInfoView.getLODInfoAt(a.key.level),y=b;y<=p;y++){b=function(b){var c,f,n=y;t.wrap&&(n=0>y?y+u:y%u);var p=t.wrap&&0>y,l=t.wrap&&y%u!==y;b=w._lookupCluster(t,a.key.level,n,b,r);if(h.isSome(b)){n=h.andThen(g,function(a){return p?a.left:l?a.right:a.tile});if(e&&h.isNone(n)||!b.count)return"continue";
if(e&&1===b.count){var k=b.geohashBoundsInfo,v=k.xLL;f=k.yLL;c=k.xTR;var x=k.yTR,k=k.level,v=h.unwrap(w._tree).findSingleOccupancyNode(v,f,c,x,k),v=h.unwrap(v).getLngLatBounds(),k={x:v[0],y:v[1]};f={x:v[2],y:v[3]};var z=x=c=v=0;if(w._spatialReference.isWebMercator)c=D.lngLatToXY(k.x,k.y),v=c[0],c=c[1],f=D.lngLatToXY(f.x,f.y),x=f[0],z=f[1];else{c=B.project(k,A.SpatialReference.WGS84,w._spatialReference);f=B.project(f,A.SpatialReference.WGS84,w._spatialReference);if(!c||!f)return"continue";v=c.x;c=
c.y;x=f.x;z=f.y}var C=null;w.forEachInBounds([v,c,x,z],function(a){d._attributeStore.isVisible(a)&&(C=a)});if(!C)return"continue";n=J.getGeometry(w.geometryInfo.geometryType,w.geometryInfo.hasZ,w.geometryInfo.hasM,C.geometry,0,h.unwrap(n));v=q.__assign(q.__assign({},C.attributes),b.attributes);b.referenceId=C.localId;E.add(b.objectId);m.push(new I.Feature(v,b.localId,n))}else e&&(E.add(b.objectId),n=J.getGeometry(w.geometryInfo.geometryType,w.geometryInfo.hasZ,w.geometryInfo.hasM,b.geometry,0,h.unwrap(n)),
m.push(new I.Feature(b.attributes,b.localId,n)))}};for(var w=this,k=f;k<=c;k++)b(k)}return{features:m,objectIds:E}};d.prototype._getGeohashLevel=function(a){return Math.min(Math.ceil(a/2+2),12)};d.prototype._setGeohashLevel=function(a){var b=this,c=this._geohashLevel;a=this._getGeohashLevel(a);a=2*(Math.floor(a/2)+1)-1;var g=this._tree;this._geohashLevel=a;h.isNone(g)||(a>c?(g.dropLevels(0),this._featuresById.forEach(function(a){a.geohashIndexed&&(b._setGeohash(a),g.insert(a,b._geohashLevel),a.geohashIndexed=
!0)})):a<c&&g.dropLevels(this._geohashLevel))};d.prototype._insertIntoIndex=function(a){a.geohashIndexed||(this._invalidated=!0,a.geohashIndexed=!0,h.unwrap(this._tree).insert(a,this._geohashLevel))};d.prototype._removeFromIndex=function(a){a.geohashIndexed&&(this._invalidated=!0,h.unwrap(this._tree).remove(a,this._geohashLevel),a.geohashIndexed=!1)};d.prototype._handleClusterUpdates=function(){var a=this;this._invalidated&&this._clusters.size&&this._clusters.forEach(function(b){h.isSome(b)&&(b.invalid=
b.invalid||a._invalidated)});this._invalidated=!1};d.prototype._getTransforms=function(a,b){var c={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]};b=N.getInfo(b);if(!b)return{tile:c,left:null,right:null};var g=b.valid;b=g[0];var e=g[1],g=q.__assign(q.__assign({},c),{translate:[e,a.bounds[3]]});a=q.__assign(q.__assign({},c),{translate:[b-e+a.bounds[0],a.bounds[3]]});return{tile:c,left:g,right:a}};d.prototype._getClusterId=function(a,b,c){return(a&15)<<
28|(b&16383)<<14|c&16383};d.prototype._markForDeletion=function(a,b,c){a=this._getClusterId(a,b,c);this._clusters.has(a)&&(b=this._clusters.get(a),h.isSome(b)?b.canDelete=!0:this._clusters.delete(a))};d.prototype._getClusterBounds=function(a,b,c){if(h.isNone(this._featureReduction))return null;var g=this._featureReduction.clusterRadius,e=2*g;b=c%2?b*e:b*e+g;var d=c*e,g=d/l.TILE_SIZE;c=(b+e)/l.TILE_SIZE;e=(d-e)/l.TILE_SIZE;b=a.getXForColumn(b/l.TILE_SIZE);g=a.getYForRow(g);c=a.getXForColumn(c);a=a.getYForRow(e);
return[b,g,c,a]};d.prototype._lookupCluster=function(a,b,c,g,e){var d,f;if(h.isNone(this._featureReduction)||h.isNone(this._tree))return null;var l=this._getClusterId(b,c,g),r=this._clusters.get(l);if(r&&h.isSome(r)&&!r.invalid&&!r.canDelete)return r;var u=this._getClusterBounds(a,c,g);a=u[0];c=u[1];g=u[2];var u=u[3],p={x:a,y:c};f={x:g,y:u};var k=0,m=d=0,t=0;if(this._spatialReference.isWebMercator)d=D.xyToLngLat(p.x,p.y),k=d[0],d=d[1],f=D.xyToLngLat(f.x,f.y),m=f[0],t=f[1];else{d=B.project(p,this._spatialReference,
A.SpatialReference.WGS84);f=B.project(f,this._spatialReference,A.SpatialReference.WGS84);if(!d||!f)return null;k=d.x;d=d.y;m=f.x;t=f.y}k>m&&(m=180);p={geohashX:0,geohashY:0};f={geohashX:0,geohashY:0};z.setGeohashXY(p,d,k,e);z.setGeohashXY(f,t,m,e);d=p.geohashX;m=p.geohashY;t=f.geohashX;f=f.geohashY;k={xLL:d,yLL:m,xTR:t,yTR:f,level:e};m=this._tree.getRegionStatistics(d,m,t,f,e);e=m.count;d=m.xTotal;f=m.yTotal;d=e?d/e:0;f=e?f/e:0;h.isSome(r)&&r.canDelete&&(t=this._attributeStore.removeLocalId(r.objectId),
this._deferredDeletionQueue.push(t));t=h.isSome(r)&&!r.canDelete&&r.invalid;m=q.__assign({cluster_count:e},m.attributes);p=this._attributeStore;b=t?r.update(d,f,b,m,k):V.create(p,l,d,f,b,m,k);0===e&&(b.geometry.coords[0]=(a+g)/2,b.geometry.coords[1]=(c+u)/2);this._attributeStore.setAttributeData(b.localId,b,this.geometryInfo,null);this._clusters.set(l,b);this._updateAggregateValueRangeForCluster(b,b.tileLevel);return b};d.prototype._updateAggregateValueRangeForCluster=function(a,b){var c=this._aggregateValueRanges[b]||
{minValue:Infinity,maxValue:0},d=c.minValue,e=c.maxValue;c.minValue=Math.min(d,a.count);c.maxValue=Math.max(e,a.count);this._aggregateValueRanges[b]=c;if(d!==c.minValue||e!==c.maxValue)this._aggregateValueRangesChanged=!0};d.prototype._markTileClustersForDeletion=function(a,b){var c=2*b;b=Math.ceil(l.TILE_SIZE/c);for(var d=a.key,e=Math.floor(d.col*l.TILE_SIZE/c),c=Math.floor(d.row*l.TILE_SIZE/c),d=e;d<e+b;d++)for(var h=c;h<c+b;h++)this._markForDeletion(a.key.level,d,h)};d.prototype._setGeohash=function(a){var b=
a.geometry;b&&b.coords.length&&(b=B.project({x:b.coords[0],y:b.coords[1]},this._spatialReference,A.SpatialReference.WGS84))&&z.setGeohashXY(a,b.y,b.x,12)};d.prototype._add=function(a){var b=this._featuresById.get(a.objectId);x.prototype._add.call(this,a);this._ensureAggregateFields(a);h.isSome(this._featureReduction)&&h.isSome(this._tree)&&(b?(a.geohashIndexed=b.geohashIndexed,a.geohashX=b.geohashX,a.geohashY=b.geohashY):this._setGeohash(a),!a.geohashIndexed&&this._attributeStore.isVisible(a)&&this._insertIntoIndex(a))};
d.prototype._remove=function(a){h.isSome(this._featureReduction)&&h.isSome(this._tree)&&this._removeFromIndex(a);return x.prototype._remove.call(this,a)};return d}(Q.default);G.ClusterStore=F});