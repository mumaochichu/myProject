// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators ../../../../../geometry/SpatialReference ../../../../../layers/support/LabelClass ../../../../../layers/support/labelFormatUtils ../../../../../renderers/support/jsonUtils ../../../engine ../../../arcade/utils ../../../engine/webgl/util/vvFlagUtils ../batchUtils ../textUtils ./BaseProcessor ../support/AttributeStore".split(" "),
function(v,w,c,C,N,D,l,m,f,x,y,E,F,t,G,H,I,J,K,L){function M(c,b){c=Array(c);for(var d=0;d<c.length;d++)c[d]=b;return c}Object.defineProperty(w,"__esModule",{value:!0});var z=D.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");v=function(h){function b(){var d=null!==h&&h.apply(this,arguments)||this;d._symbolToMosaicItemMap=new Map;d._visualSetPromises=new Map;d.type="symbol";return d}c.__extends(b,h);b.prototype.initialize=function(){this._factory=this._createFactory()};b.prototype.destroy=
function(){this._visualSetPromises.clear();this._symbolToMosaicItemMap.clear();this.notifyChange("updating")};Object.defineProperty(b.prototype,"supportsTileUpdates",{get:function(){return!0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"labelingInfo",{get:function(){return!this.config||l.isNone(this.config.labelingInfo)?null:this.config.labelingInfo.map(function(d){return y.fromJSON(d)})},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"labelingInfoFeatureReduction",
{get:function(){var d,a;if(!this.config||l.isNone(this.config.featureReduction))return null;var e=this.config.featureReduction;return"cluster"===e.type&&l.isSome(null===(d=e.drawingInfo)||void 0===d?void 0:d.labelingInfo)?null===(a=e.drawingInfo)||void 0===a?void 0:a.labelingInfo.map(function(a){return y.fromJSON(a)}):null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hasLabels",{get:function(){return!(!this.labelingInfo&&!this.labelingInfoFeatureReduction)},enumerable:!0,configurable:!0});
b.prototype._updateLabelClassInfos=function(){return c.__awaiter(this,void 0,void 0,function(){var d,a,e,b,q,g=this;return c.__generator(this,function(k){switch(k.label){case 0:if(l.isNone(this.labelingInfo)&&l.isNone(this.labelingInfoFeatureReduction))return[2,m.resolve()];d=function(a){return c.__awaiter(g,void 0,void 0,function(){var d,e,b;return c.__generator(this,function(c){switch(c.label){case 0:d=null,c.label=1;case 1:return c.trys.push([1,3,,4]),[4,E.createLabelFunction(a,this.service.fields,
this.spatialReference)];case 2:return d=c.sent(),[3,4];case 3:return e=c.sent(),b=a.where?"where":"arcade",z.error(new C("mapview-labeling","Failed to evaluate "+b+" expression",{labelClass:a,error:e})),[3,4];case 4:return[2,d]}})})};a=[];l.isSome(this.labelingInfo)&&a.push.apply(a,this.labelingInfo.map(function(a,e){return c.__awaiter(g,void 0,void 0,function(){var b;return c.__generator(this,function(c){switch(c.label){case 0:return b=l.andThen,[4,d(a)];case 1:return[2,b.apply(void 0,[c.sent(),
function(d){return{type:"feature",labelClass:a,index:e,minScale:a.minScale,maxScale:a.maxScale,builder:d,symbol:a.symbol,symbolJSON:a.symbol.toJSON()}}])]}})})}));l.isSome(this.labelingInfoFeatureReduction)&&(e=a.length,a.push.apply(a,this.labelingInfoFeatureReduction.map(function(a,b){return c.__awaiter(g,void 0,void 0,function(){var k;return c.__generator(this,function(c){switch(c.label){case 0:return k=l.andThen,[4,d(a)];case 1:return[2,k.apply(void 0,[c.sent(),function(d){return{type:"aggregate",
labelClass:a,index:e+b,minScale:a.minScale,maxScale:a.maxScale,builder:d,symbol:a.symbol,symbolJSON:a.symbol.toJSON()}}])]}})})})));return[4,m.all(a)];case 1:return b=k.sent(),this._labelClassInfos=q=b.filter(function(a){return a}),[2]}})})};Object.defineProperty(b.prototype,"hydrate",{get:function(){return G.createHydrateFactory(this.service.geometryType)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"renderer",{get:function(){return this.config?F.fromJSON(this.config.renderer):
null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return 0<this._visualSetPromises.size},enumerable:!0,configurable:!0});b.prototype.update=function(d){return c.__awaiter(this,void 0,void 0,function(){var a,e;return c.__generator(this,function(c){switch(c.label){case 0:return a=this._getMeshHash(),this._set("config",d),[4,this._updateLabelClassInfos()];case 1:return c.sent(),a!==this._getMeshHash()&&(this._factory=this._createFactory()),e=this._labelClassInfos,
this._factory.update(e,this.renderer,this.tileStore.tileScheme.tileInfo),[2]}})})};b.prototype.onTileData=function(d,a,e){var c=this;a=this._onTileData(d,a,e);this._visualSetPromises.set(d,a);m.always(a,function(){return c._cleanPromise(d)});this.notifyChange("updating");return a};b.prototype.onTileError=function(d,a,e){var c=this;a=this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:d.id,error:a},{signal:e.signal});this._visualSetPromises.set(d,a);m.always(a,function(){return c._cleanPromise(d)});
this.notifyChange("updating");return a};b.prototype._getMeshHash=function(){var d=H.getVVFlags("visualVariables"in this.renderer&&this.renderer.visualVariables||[]);return this.renderer.getMeshHash()+"."+d};b.prototype._createFactory=function(){var d=this,a=this.service,e=a.geometryType,c=a.objectIdField,a=a.fields,b=x.fromJSON(this.spatialReference),a={geometryType:e,fields:a,spatialReference:b};this._store=b=new t.WGLTemplateStore(function(a,e){return d.remoteClient.invoke("tileRenderer.getMaterialItems",
a,e)},!1);this._matcher=t.createMatcher(b,a,this.renderer);return new t.WGLMeshFactory(e,c,this.renderer,b)};b.prototype._cleanPromise=function(d){this._visualSetPromises.delete(d);this.notifyChange("updating")};b.prototype._onTileData=function(d,a,e){return c.__awaiter(this,void 0,void 0,function(){var b,q,g,A,p,n,r,u,f,m,B;return c.__generator(this,function(c){switch(c.label){case 0:b=a.addOrUpdate,q=a.remove,g=a.clear,A=this._processFeatures(d,b,a.transformParams,e),p=e.signal,c.label=1;case 1:return c.trys.push([1,
3,,4]),[4,A];case 2:return n=c.sent(),r=l.andThen(n,function(a){return a.message}),u=l.andThen(n,function(a){return a.transferList})||[],f={addOrUpdate:r,remove:q,clear:g},m={transferList:l.unwrap(u)||[],signal:p},[2,this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:d.id,data:f},m)];case 3:return B=c.sent(),this._handleError(d,B,e),[3,4];case 4:return[2]}})})};b.prototype._processFeatures=function(d,a,e,b){return c.__awaiter(this,void 0,void 0,function(){var k,g,l,p,n,f;return c.__generator(this,
function(c){switch(c.label){case 0:k=a&&a.length;if(!k)return[2,null];g=this._factory;l={viewingMode:"",scale:d.scale};return[4,this._matcher];case 1:return p=c.sent(),[4,this._getLabelInfos(d,a,e)];case 2:return n=c.sent(),[4,g.analyze(a,p,e,l)];case 3:return f=c.sent(),m.throwIfAborted(b),[2,this._writeFeatures(d,f,e,n,g,b)]}})})};b.prototype._writeFeatures=function(d,a,e,b,q,g){return c.__awaiter(this,void 0,void 0,function(){var k,f,n;return c.__generator(this,function(p){switch(p.label){case 0:return k=
q.createMeshData(a.length),f={viewingMode:"",scale:d.scale},n=c.__assign(c.__assign({},g),{batchSize:200}),[4,I.executeForEachAsync(a,function(a){try{var c=l.isSome(b)?b.get(a.localId):null;q.write(k,a,e,f,d.level,c)}catch(O){}},n)];case 1:return p.sent(),[2,this._encodeDisplayData(k)]}})})};b.prototype._encodeDisplayData=function(c){var a={},d=[];c.encode(a,d);return{message:a,transferList:d}};b.prototype._handleError=function(c,a,b){if(!m.isAbortError(a))return this.remoteClient.invoke("tileRenderer.onTileError",
{tileKey:c.id,error:a.message},{signal:b.signal})};b.prototype._getLabelClassInfosForScale=function(d){return c.__awaiter(this,void 0,void 0,function(){var a;return c.__generator(this,function(c){a=this._labelClassInfos;return[2,a.filter(function(a){var c=a.minScale;a=a.maxScale;return(!c||c>=d||0===c)&&(!a||a<=d||0===a)})]})})};b.prototype._shouldDiscard=function(c,a){switch(this.service.geometryType){case "esriGeometryPoint":var b=a.geometry;a=b.x;b=b.y;return c.checkOverlap(a,b);case "esriGeometryPolygon":return b=
a.centroid,a=b.x,b=b.y,c.checkOverlap(a,b);default:return!1}};b.prototype._markUsed=function(c,a){switch(this.service.geometryType){case "esriGeometryPoint":var b=a.geometry;a=b.x;b=b.y;return c.markUsed(a,b);case "esriGeometryPolygon":return b=a.centroid,a=b.x,b=b.y,c.markUsed(a,b)}};b.prototype._getLabelInfos=function(b,a,e){return c.__awaiter(this,void 0,void 0,function(){var d,f,g,m,p,n,r,u,h;return c.__generator(this,function(k){switch(k.label){case 0:return this.hasLabels&&a&&0!==a.length?[4,
this._getLabelClassInfosForScale(b.scale)]:[2,null];case 1:d=k.sent();if(0===d.length)return[2,null];f=new Map;g=new t.CollisionGrid(t.definitions.COLLISION_EARLY_REJECT_BUCKET_SIZE);m=function(a){var b=a.localId;if(p._shouldDiscard(g,a))return f.has(b)||f.set(b,null),"continue";for(var k=M(d.length,null),n=!1,m=function(f){f=d[f];var g=f.type,m=f.index,h=f.builder;f=f.symbolJSON;if((L.isAggregateId(b)&&1<a.attributes.cluster_count?"aggregate":"feature")!==g)return"continue";if(!e)return z.error("mapview-labeling",
"Tried to evaluate geometry expression but no transformation found"),{value:void 0};var g=p.hydrate(a.geometry,e.transform,e.hasZ,e.hasM),q=c.__assign(c.__assign({},a),{geometry:g});g.spatialReference=x.fromJSON(p.spatialReference);h=h.evaluate(q);if(l.isNone(h)||""===h)return"continue";var h=t.bidiText(h),g=h[0],r=h[1];n=!0;p._store.getMosaicItem(f,!1,J.codepoints(g)).then(function(a){k[m]={glyphs:a.glyphMosaicItems,rtl:r,classIndex:m}})},h=0;h<d.length;h++){var q=m(h);if("object"===typeof q)return q}f.set(b,
k);n&&p._markUsed(g,a)};p=this;n=0;for(r=a;n<r.length;n++)if(u=r[n],h=m(u),"object"===typeof h)return[2,h.value];return[2,f]}})})};c.__decorate([f.property({readOnly:!0})],b.prototype,"supportsTileUpdates",null);c.__decorate([f.property()],b.prototype,"config",void 0);c.__decorate([f.property({dependsOn:["config"]})],b.prototype,"labelingInfo",null);c.__decorate([f.property({dependsOn:["config"]})],b.prototype,"labelingInfoFeatureReduction",null);c.__decorate([f.property({dependsOn:["labelingInfo",
"labelingInfoFeatureReduction"]})],b.prototype,"hasLabels",null);c.__decorate([f.property({dependsOn:["service"]})],b.prototype,"hydrate",null);c.__decorate([f.property({dependsOn:["config"],readOnly:!0})],b.prototype,"renderer",null);c.__decorate([f.property({readOnly:!0})],b.prototype,"updating",null);return b=c.__decorate([f.subclass("esri.views.2d.layers.features.processors.SymbolProcessor")],b)}(K.default);w.default=v});