// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../layers/support/FieldsIndex ../../../../../support/arcadeOnDemand ../../../engine ../../../arcade/utils ../../../engine/webgl/definitions ../tileRenderers/support/visualVariablesUtils @dojo/framework/shim/Promise".split(" "),function(C,u,g,t,r,D,E,m,p,F,G,k,H,x,I){Object.defineProperty(u,"__esModule",
{value:!0});var q=D.getLogger("esri.views.layers.2d.features.support.AttributeStore"),v=k.debug.createDebugLogger(k.debug.DEBUG_ATTR_UPDATES,q);u.LOCAL_ID_TYPE_AGGREGATE=1;u.isAggregateId=function(c){return(c&2147483648)>>>31===u.LOCAL_ID_TYPE_AGGREGATE};var y=function(c,a){return function(b,d,e){var f;try{f=a(b,d,e)}catch(h){f=NaN}return(null===f||isNaN(f)||Infinity===f)&&c||f}},z=r("esri-shared-array-buffer"),A=r("esri-webgl-texture-float"),J=r("esri-webgl-max-texture-size"),B=r("esri-atomics"),
K=function(){function c(a,b,d,e){this.texelSize=4;var c=e.pixelType,h=e.layout;this.textureOnly=(e=e.textureOnly)||!1;this.pixelType=c;this._ctype=b;this.layout=h;this._resetRange();this._shared=a;e||(this.data=this._initData(c,d,a,b))}Object.defineProperty(c.prototype,"buffer",{get:function(){return m.andThen(this.data,function(a){return a.buffer})},enumerable:!0,configurable:!0});c.prototype.getData=function(a,b){a&=2147483647;return m.unwrap(this.data)[a*this.texelSize+b]};c.prototype.setData=
function(a,b,d){a&=2147483647;0===(this.layout&1<<b)?q.error("mapview-attributes-store","Tried to set a value for a texel's readonly component"):(this.data[a*this.texelSize+b]=d,this.dirtyStart=Math.min(this.dirtyStart,a),this.dirtyEnd=Math.max(this.dirtyEnd,a))};c.prototype.lock=function(){5121===this.pixelType&&this._shared&&B&&"local"!==this._ctype&&Atomics.store(this.data,0,1)};c.prototype.unlock=function(){5121===this.pixelType&&this._shared&&B&&"local"!==this._ctype&&Atomics.store(this.data,
0,0)};c.prototype.expand=function(a){if(!this.textureOnly){a=this._initData(this.pixelType,a,this._shared,this._ctype);var b=m.unwrap(this.data);a.set(b);this.data=a}};c.prototype.toMessage=function(){var a=this.dirtyStart,b=this.dirtyEnd,d=this.texelSize;if(a>b)return null;this._resetRange();var e=!this._shared&&"local"!==this._ctype,c=this.pixelType,h=this.layout,n=m.unwrap(this.data);if(!n.slice){if(!e)return{start:a,end:b,data:null,pixelType:c,layout:h};d=new (k.Utils.getPixelArrayCtor(this.pixelType))(Array.prototype.slice.call(this.data,
a*d,(b+1)*d));return{start:a,end:b,data:d,pixelType:c,layout:h}}d=e&&n.slice(a*d,(b+1)*d)||null;return{start:a,end:b,data:d,pixelType:c,layout:h}};c.prototype._initData=function(a,b,d,e){d=d&&"local"!==e?SharedArrayBuffer:ArrayBuffer;a=k.Utils.getPixelArrayCtor(a);b=new a(new d(b*b*4*a.BYTES_PER_ELEMENT));for(a=0;a<b.length;a+=4)b[a+1]=255;return b};c.prototype._resetRange=function(){this.dirtyStart=2147483647;this.dirtyEnd=0};return c}();r=function(){function c(a){this._attributeComputeMap=new Map;
this._blocks=[];this._idMap=new Map;this._localToObjectId=new Map;this._filters=Array(k.definitions.MAX_FILTERS);this._freeTexelsList=[];this._abortController=p.createAbortController();this._hasScaleExpr=!1;this._size=32;this._idCounter=1;this._idsToHighlight=new Set;var b=A?5126:5121;v("Creating AttributeStore "+(z?"with":"without")+" shared memory");this._client=a;this._blockDescriptors=[{pixelType:5121,layout:1},{pixelType:5121,layout:15,textureOnly:!0},{pixelType:b,layout:15},{pixelType:b,layout:15}];
this._blocks=this._blockDescriptors.map(function(){return null})}c.prototype.destroy=function(){this._abortController.abort()};Object.defineProperty(c.prototype,"hasScaleExpr",{get:function(){return this._hasScaleExpr},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_signal",{get:function(){return this._abortController.signal},enumerable:!0,configurable:!0});c.prototype.invalidateResources=function(){this._createResourcesPromise=null;this._abortController.abort();this._abortController=
p.createAbortController()};c.prototype.createLocalId=function(a,b){void 0===b&&(b=!1);if(!this._idMap.has(a)){var d=this._getFreeTexel();b=((b?2147483648:0)|d)>>>0;this._idMap.set(a,-1===b?0:b);this._localToObjectId.set(b,a)}return this._idMap.get(a)};c.prototype.addLocalId=function(a){this._getBlock(0).setData(a,0,0);this._freeTexelsList.push(a&2147483647)};c.prototype.removeLocalId=function(a){var b=this._idMap.get(a);this._idMap.delete(a);this._localToObjectId.delete(b);return b};c.prototype.freeLocalId=
function(a){var b=this._idMap.get(a);this._getBlock(0).setData(b,0,0);this._idMap.delete(a);this._localToObjectId.delete(b);this._freeTexelsList.push(b&2147483647)};c.prototype.getFeatureId=function(a){return this._localToObjectId.get(a)};c.prototype.getLocalId=function(a){return this._idMap.has(a)?this._idMap.get(a):null};c.prototype.setHighlight=function(a){return g.__awaiter(this,void 0,void 0,function(){var b,d,e,c,h,n,l=this;return g.__generator(this,function(f){switch(f.label){case 0:this._getBlock(0).lock();
this._idsToHighlight.forEach(function(a){if(a=l.getLocalId(a)){var b=l._getBlock(0).getData(a,0);l._getBlock(0).setData(a,0,b&-2)}});this._idsToHighlight.clear();b=0;for(d=a;b<d.length;b++)e=d[b],this._idsToHighlight.add(e);for(c=0;c<a.length;c++)h=this.getLocalId(a[c]),null!=h&&(n=this._getBlock(0).getData(h,0),this._getBlock(0).setData(h,0,n|1));this._getBlock(0).unlock();return[4,this.sendUpdates()];case 1:return f.sent(),[2]}})})};c.prototype.addHighlight=function(){return g.__awaiter(this,void 0,
void 0,function(){return g.__generator(this,function(a){return[2]})})};c.prototype.removeHighlight=function(){return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,function(a){return[2]})})};c.prototype.updateFilters=function(a){return g.__awaiter(this,void 0,void 0,function(){var b,d,c,f,h,n=this;return g.__generator(this,function(e){switch(e.label){case 0:return b=a.config,d=a.service,c=a.spatialReference,f=b.filters,h=f.map(function(b,e){return n._updateFilter(a,b,e,d,c)}),
[4,p.all(h)];case 1:return e.sent(),[2]}})})};c.prototype.setAttributeBindings=function(a,b){return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,function(d){this._hasScaleExpr=!1;switch(a.type){case "simple":case "class-breaks":case "unique-value":case "dictionary":return[2,this._bindVVEvaluators(a.visualVariables,b)];case "dot-density":return[2,this._bindDDEvaluators(a.attributes,b)];case "heatmap":break;default:q.error(t("attribute-store","Found invalid renderer type: "+a))}return[2]})})};
c.prototype.setData=function(a,b,d,c){this._getBlock(b).setData(a,d,c)};c.prototype.getData=function(a,b,d){return this._getBlock(b).getData(a,d)};c.prototype.getHighlightFlag=function(a){return this._idsToHighlight.has(a)?x.HIGHLIGHT_FLAG:0};c.prototype.setAttributeData=function(a,b,d,c){var e=this;this._getBlock(0).setData(a,0,this.getFilterFlags(b));var h=A?1:2;this._attributeComputeMap.forEach(function(f,l){var g=l*h%4;l=e._getBlock(Math.floor(l*h/4)+x.ATTRIBUTE_DATA_VV);f=f(b,{$view:c},d);if(A)l.setData(a,
g,f);else if(f===k.definitions.NAN_MAGIC_NUMBER)l.setData(a,g,255),l.setData(a,g+1,255);else{f=E.clamp(Math.round(f),-32767,32766)+32768;var n=(f&65280)>>8;l.setData(a,g,f&255);l.setData(a,g+1,n)}})};c.prototype.sendUpdates=function(){var a=this;if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=p.createResolver(),this._nextUpdate.promise;var b={blocks:this._blocks.map(function(a){return m.isSome(a)?a.toMessage():null})};return this._currUpdate=this._createResources().then(function(){var d=
function(){a._currUpdate=null;if(a._nextUpdate){var b=a._nextUpdate;a._nextUpdate=null;a.sendUpdates().then(function(){return b.resolve()})}},d=a._client.update(b,a._signal).then(d).catch(d);a._client.render();return d}).catch(function(b){if(p.isAbortError(b))return a._createResourcesPromise=null,a._createResources();q.error(t("mapview-attribute-store","Encountered an error during client update",b));return p.resolve()})};c.prototype._createResources=function(){var a=this;if(m.isSome(this._createResourcesPromise))return this._createResourcesPromise;
this._getBlock(x.ATTRIBUTE_DATA_ANIMATION);v("Initializing AttributeStore");var b={shared:z&&"local"!==this._client.type,size:this._size,blocks:m.mapMany(this._blocks,function(a){return{textureOnly:a.textureOnly,buffer:a.buffer,pixelType:a.pixelType}})};this._createResourcesPromise=b=this._client.initialize(b,this._signal).catch(function(b){p.isAbortError(b)?a._createResourcesPromise=null:q.error(t("mapview-attribute-store","Encountered an error during client initialization",b))});b.then(function(){return m.isNone(a._createResourcesPromise)?
a._createResources():void 0});return b};c.prototype._getBlock=function(a){var b=this._blocks[a];if(m.isSome(b))return b;v("Initializing AttributeBlock at index "+a);b=new K(z,this._client.type,this._size,this._blockDescriptors[a]);this._blocks[a]=b;this._createResourcesPromise=null;return b};c.prototype._expand=function(){if(this._size<J){var a=this._size<<=1;v("Expanding block size to",a,this._blocks);m.forEachSome(this._blocks,function(b){return b.expand(a)});this._createResourcesPromise=null;this._size=
a;return 0}q.error(t("mapview-limitations","Maximum number of onscreen features exceeded."));return-1};c.prototype._getFreeTexel=function(){return this._freeTexelsList.length?this._freeTexelsList.pop():this._idCounter>=this._size*this._size&&this._expand()?-1:this._idCounter++};c.prototype._updateFilter=function(a,b,c,e,f){return g.__awaiter(this,void 0,void 0,function(){var d,n,l,k,p,q,r,t,v,w=this;return g.__generator(this,function(h){switch(h.label){case 0:d=this._filters[c];n=m.isSome(d)&&d.hash;
if(n===JSON.stringify(b))return[2];l=1<<c+1;return m.isNone(b)?(this._filters[c]=null,this._idMap.forEach(function(a){var b=w._getBlock(0).getData(a,0);w._getBlock(0).setData(a,0,b|l)}),[2]):[4,a.queryObjectIds(b)];case 1:return k=h.sent(),b.hiddenIds&&b.hiddenIds.length&&(k=k.filter(function(a){return-1===b.hiddenIds.indexOf(a)})),p=k.map(function(a){return w._idMap.get(a)}),[4,this._getFilter(c,e)];case 2:q=h.sent();q.update(b,f);this._getBlock(0).lock();this._idMap.forEach(function(a){if((a&2147483648)>>>
31!==u.LOCAL_ID_TYPE_AGGREGATE){var b=w._getBlock(0).getData(a,0);w._getBlock(0).setData(a,0,b&~l)}});for(r=0;r<p.length;r++)t=p[r],null!=t&&(v=this._getBlock(0).getData(t,0),this._getBlock(0).setData(t,0,v|l));this._getBlock(0).unlock();return[2]}})})};c.prototype._getFilter=function(a,b){return g.__awaiter(this,void 0,void 0,function(){var c,e,f;return g.__generator(this,function(d){switch(d.label){case 0:return c=this._filters[a],m.isSome(c)?[2,c]:[4,new Promise(function(a,b){C(["../../../../../layers/graphics/data/FeatureFilter"],
a,b)})];case 1:return e=d.sent().default,f=new e({geometryType:b.geometryType,hasM:!1,hasZ:!1,timeInfo:b.timeInfo,fieldsIndex:new F(b.fields)}),this._filters[a]=f,[2,f]}})})};c.prototype.isVisible=function(a){return!!(this._getBlock(0).getData(a.localId,0)&2)};c.prototype.getFilterFlags=function(a){for(var b=0,c=(a.localId&2147483648)>>>31===u.LOCAL_ID_TYPE_AGGREGATE?254:255,e=0;e<this._filters.length;e++)var f=this._filters[e],f=!(c&1<<e)||m.isNone(f)||f.check(a),b=b|(f?1:0)<<e;a=this.getFeatureId(a.localId);
return b<<1|this.getHighlightFlag(a)};c.prototype._bindVVEvaluators=function(a,b){return g.__awaiter(this,void 0,void 0,function(){var c,e=this;return g.__generator(this,function(d){switch(d.label){case 0:this._attributeComputeMap.clear();if(!m.isSome(a))return[3,2];c=p.all(a.map(function(a){return g.__awaiter(e,void 0,void 0,function(){var c,d;return g.__generator(this,function(e){switch(e.label){case 0:return c=k.Utils.getVVType(a.type),[4,this._createGetValueFunction(a,b)];case 1:return d=e.sent(),
m.isSome(d)&&this._attributeComputeMap.set(c,d),[2]}})})}));return[4,c];case 1:d.sent(),d.label=2;case 2:return[2]}})})};c.prototype._bindDDEvaluators=function(a,b){return g.__awaiter(this,void 0,void 0,function(){var c,e,f,h=this;return g.__generator(this,function(d){switch(d.label){case 0:return this._attributeComputeMap.clear(),a.length>k.definitions.DOT_DENSITY_MAX_FIELDS&&q.warn("mapview-invalid-value","DotDensityRenderer supports a maximum of "+k.definitions.DOT_DENSITY_MAX_FIELDS+" attribtues, but found "+
a.length),[4,p.all(a.map(function(a){return h._createNormalizedFunction(a,b)}))];case 1:c=d.sent().map(function(a){return y(0,a)});for(e=0;e<k.definitions.DOT_DENSITY_MAX_FIELDS;e++)(f=e<a.length&&c[e])?this._attributeComputeMap.set(e,f):this._attributeComputeMap.has(e)&&this._attributeComputeMap.delete(e);return[2]}})})};c.prototype._createGetValueFunction=function(a,b){return g.__awaiter(this,void 0,void 0,function(){var c,e,f,h,n,l,m;return g.__generator(this,function(d){switch(d.label){case 0:if("size"!==
a.type)return[3,2];c=k.getTypeOfSizeVisualVariable(a);if(c===k.enums.WGLVVFlag.SIZE_SCALE_STOPS)return[2,null];f=(e=c===k.enums.WGLVVFlag.SIZE_UNIT_VALUE)&&function(b){return I.getVisualVariableSizeValueRepresentationRatio(b,a.valueRepresentation)};h=y;n=[k.definitions.NAN_MAGIC_NUMBER];return[4,this._createNormalizedFunction(a,b,f)];case 1:return[2,h.apply(void 0,n.concat([d.sent()]))];case 2:return l=y,m=[k.definitions.NAN_MAGIC_NUMBER],[4,this._createNormalizedFunction(a,b)];case 3:return[2,l.apply(void 0,
m.concat([d.sent()]))]}})})};c.prototype._createNormalizedFunction=function(a,b,c){return g.__awaiter(this,void 0,void 0,function(){var d,f,h;return g.__generator(this,function(e){switch(e.label){case 0:if(d=a.field){if("string"===typeof d)return(f=a.normalizationField)?[2,function(a){if(a.attributes[d]&&a.attributes[f])return a=a.attributes[d]/a.attributes[f],c?c(a):a}]:[2,c?function(a){return c(a.attributes[d])}:function(a){return a.attributes[d]}];q.error(t("mapview-rendering:invalid-type","The field for a vv must be a string or a number, but got "+
typeof d));return[2,function(){}]}if(!a.valueExpression)return[3,2];this._hasScaleExpr=this._hasScaleExpr||-1!==a.valueExpression.indexOf("scale");return[4,G.createVVExpression(a.valueExpression,b.spatialReference,b.fields)];case 1:return h=e.sent(),[2,H.callWithOptimizedFeature.bind(null,h)];case 2:return q.error("Unable to create a normalized function for visual variable: "+a),[2,function(){}]}})})};return c}();u.default=r});