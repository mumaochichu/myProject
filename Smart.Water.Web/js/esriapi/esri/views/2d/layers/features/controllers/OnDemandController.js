// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/ArrayPool ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/promiseUtils ../../../../../core/watchUtils ../../../../../core/workers ../../../../../core/accessorSupport/decorators ../../../../../geometry/Extent ../../../../../geometry/support/jsonUtils ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/ogc/ogcFeatureUtils ../../../../../tasks/operations/query ../../../../../tasks/support/QuantizationParameters ../../../engine ./BaseController ./EditsQueue ../support/DataTile ../support/DataTileFeaturesIndex ../support/Tile ../support/TileUpdateQueue ../../../tiling/TileQueue".split(" "),
function(h,K,b,P,Q,A,R,y,C,S,t,T,L,B,U,M,V,W,D,X,E,Y,F,Z,N){Object.defineProperty(K,"__esModule",{value:!0});var G=R.getLogger("esri.views.2d.layers.features.controllers.OnDemandController");h=A("esri-featurelayer-webgl");A=A("esri-mobile");var H=h&&"object"===typeof h&&null!=h.maxDrillLevel?h.maxDrillLevel:A?1:4,O=h&&"object"===typeof h&&null!=h.maxRecordCountFactor?h.maxRecordCountFactor:A?1:3,aa=h&&"object"===typeof h&&null!=h.enablePBFQuery?h.enablePBFQuery:!0,I=new Set,v=[],ba=function(){function f(b,
a){var c=this;this.objectIdField=a;S.openWithPorts(b).then(function(a){return c.client=a})}f.prototype.destroy=function(){this.client.close();this.client=null};f.prototype.executeQuery=function(d,a){return b.__awaiter(this,void 0,void 0,function(){var c;return b.__generator(this,function(e){switch(e.label){case 0:return[4,this.client.invoke("queryFeatures",d.toJSON(),a)];case 1:return c=e.sent(),[2,B.convertFromFeatureSet(c,this.objectIdField)]}})})};return f}(),ca=function(){function f(b,a){this.source=
b;this.sourceSpatialReference=a}f.prototype.destroy=function(){};f.prototype.executeQuery=function(d,a){return b.__awaiter(this,void 0,void 0,function(){var c;return b.__generator(this,function(e){switch(e.label){case 0:return[4,M.executeQueryPBF(this.source,d,{type:"optimized",sourceSpatialReference:this.sourceSpatialReference},a)];case 1:return c=e.sent().data,[2,c]}})})};return f}(),da=function(){function f(b,a,c){this.source=b;this.objectIdField=a;this.sourceSpatialReference=c}f.prototype.destroy=
function(){};f.prototype.executeQuery=function(d,a){return b.__awaiter(this,void 0,void 0,function(){var c;return b.__generator(this,function(e){switch(e.label){case 0:return[4,M.executeQuery(this.source,d,this.sourceSpatialReference,a)];case 1:return c=e.sent().data,[2,B.convertFromFeatureSet(c,this.objectIdField)]}})})};return f}(),ea=function(){function f(b,a){this.source=b;this.objectIdField=a}f.prototype.destroy=function(){};f.prototype.executeQuery=function(d,a){return b.__awaiter(this,void 0,
void 0,function(){return b.__generator(this,function(c){return[2,U.queryOptimizedFeatureSet(this.source,d,a)]})})};return f}();D=function(f){function d(){var a=null!==f&&f.apply(this,arguments)||this;a.type="on-demand";a._queryInfoHash=null;a._dataTileIndex=new Y.default;a._editsQueue=new X.EditsQueue({processEdits:a._processEdits.bind(a)});a._featuresInFlight=new Map;a.service=null;return a}b.__extends(d,f);d.prototype.initialize=function(){var a=this,c=this._createFeatureStore();c.onFeatureAdd=
this.onFeatureAdd.bind(this);c.onFeatureRemove=this.onFeatureRemove.bind(this);this._set("featureStore",c);this._dataTileIndex.featureStore=this.featureStore;this._dataTileIndex.forEach(function(a){return a.done=!1});this._fetchQueue=new N({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(c,e){return b.__awaiter(a,void 0,void 0,function(){var a;return b.__generator(this,function(g){switch(g.label){case 0:return[4,this._fetchTile(c,this.queryInfo,e)];case 1:return a=
g.sent(),[2,{dataTile:c,featureSet:a}]}})})}});this._patchQueue=new N({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(c,e){return a._fetchTile(c.dataTile,c.queryInfo,e)}});this._updateQueue=new Z.default({tileInfoView:this.tileStore.tileScheme,process:function(c,e,g){return a._updateTile(c,e,g)}});var e=this.service,c=e.capabilities,g=e.source,d=e.objectIdField,e=e.spatialReference;g&&g.capabilities&&g.collectionId&&g.layerDefinition&&g.url?this.sourceAdapter=
new ea(g,d):Array.isArray(g)?this.sourceAdapter=new ba(g,d):this.sourceAdapter=aa&&c.query.supportsFormatPBF?new ca(g,e):new da(g,d,e);this.handles.add([this.watch("updating",function(c){return!c&&a.onIdle()})]);this.featureStore.events.on("valueRangesChanged",function(c){a.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:c.valueRanges}})})};d.prototype.destroy=function(){this._fetchQueue.clear();this._patchQueue.clear();this._updateQueue.clear();this._editsQueue.destroy();
this.queryEngine.destroy();this.sourceAdapter.destroy()};Object.defineProperty(d.prototype,"queryEngine",{get:function(){return this._createQueryEngine(this.featureStore)},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"updating",{get:function(){return!this.viewState||this._fetchQueue.updating||this._patchQueue.updating||this._updateQueue.updating||this._editsQueue.updating},enumerable:!0,configurable:!0});d.prototype.update=function(a,c){return b.__awaiter(this,void 0,void 0,function(){var e,
g,d,k,u,J,q=this;return b.__generator(this,function(b){switch(b.label){case 0:return this.validateConfig(a),e=JSON.stringify(this.config.filters),g=this.renderer.getAttributeHash(),d=a.availableFields.filter(function(a){return-1===q.availableFields.indexOf(a)}),k=this.config.definitionExpression,this._set("config",a),k!==this.config.definitionExpression&&this._set("queryEngine",this._createQueryEngine(this.featureStore)),[4,this.updatePixelBuffer()];case 1:return b.sent(),u=e!==JSON.stringify(a.filters),
J=g!==this.renderer.getAttributeHash(),c?J?[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,3]:[3,6];case 2:b.sent(),b.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return b.sent(),[4,this.featureStore.update(u,a,this.service.fields)];case 5:return b.sent(),this.refresh(),[2];case 6:return d.length?[4,this._handleAttributeChange(d)]:[3,8];case 7:b.sent(),b.label=8;case 8:return"heatmap"===this.renderer.type?[2]:J?[4,this.attributeStore.setAttributeBindings(this.renderer,
this.arcadeInfo)]:[3,10];case 9:b.sent(),this.featureStore.forEach(function(a){return q.attributeStore.setAttributeData(a.localId,a,q.geometryInfo,q.viewParams)}),b.label=10;case 10:return[4,this.attributeStore.updateFilters(this)];case 11:return b.sent(),[4,this.featureStore.update(u,a,this.service.fields)];case 12:return b.sent(),[4,this.attributeStore.sendUpdates()];case 13:return b.sent(),[2]}})})};d.prototype.invalidate=function(){return b.__awaiter(this,void 0,void 0,function(){var a,c,e;return b.__generator(this,
function(b){a=0;for(c=this.tileStore.tiles;a<c.length;a++)e=c[a],this._updateQueue.push(e.id,Date.now());return[2]})})};d.prototype.onIdle=function(){this.featureStore.sweepClusters()};d.prototype.onEdits=function(a){var c=this;this._fetchQueue.pause();this._fetchQueue.reset();return this._editsQueue.push(a).then(function(){c._editsQueue.updating||c._fetchQueue.resume()})};d.prototype.queryFeatures=function(a){return this.queryEngine.executeQuery(a)};d.prototype.queryFeatureCount=function(a){return this.queryEngine.executeQueryForCount(a)};
d.prototype.queryObjectIds=function(a){return this.queryEngine.executeQueryForIds(a)};d.prototype.queryExtent=function(a){return this.queryEngine.executeQueryForExtent(a)};d.prototype.queryStatistics=function(){return b.__awaiter(this,void 0,void 0,function(){var a,c,e,g=this;return b.__generator(this,function(d){switch(d.label){case 0:return e=c=a=0,[4,y.all(this.tileStore.tiles.map(function(d){return b.__awaiter(g,void 0,void 0,function(){var g,m,k,l,r,n,p,f,w,h,z;return b.__generator(this,function(b){switch(b.label){case 0:return g=
this.queryInfo,m=g.returnCentroid,k=g.returnGeometry,l=this._pixelBuffer,r={pixelBuffer:l,returnGeometry:k,returnCentroid:m,returnOutline:this.returnOutline},n=performance.now(),[4,this.featureStore.executeTileQuery(d,this.spatialReference,r)];case 1:p=b.sent().features;f=performance.now();e+=f-n;a+=p.length;w=0;for(h=p;w<h.length;w++)z=h[w],z.geometry&&(L.isPolygon(z.geometry)?c+=z.geometry.rings.reduce(function(a,c){return a+c.length},0):L.isPolyline(z.geometry)&&(c+=z.geometry.paths.reduce(function(a,
c){return a+c.length},0)));return[2]}})})}))];case 1:return d.sent(),[2,b.__assign(b.__assign({},this.featureStore.storeStatistics),{displayedFeatureCount:a,displayedVertexCount:c,displayPreProcessTime:e})]}})})};d.prototype.refresh=function(){return b.__awaiter(this,void 0,void 0,function(){var a=this;return b.__generator(this,function(c){switch(c.label){case 0:return this._queryInfoHash=Math.random().toString(),this._dataTileIndex.clear(),this._fetchQueue.pause(),this._updateQueue.pause(),this._editsQueue.clear(),
this._fetchQueue.clear(),[4,C.whenFalseOnce(this._fetchQueue,"updating")];case 1:return c.sent(),this._updateQueue.clear(),[4,C.whenFalseOnce(this._updateQueue,"updating")];case 2:return c.sent(),this.featureStore.startMarkingUsedFeatures(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),[4,C.whenFalseOnce(this._fetchQueue,"updating")];case 3:return c.sent(),this.featureStore.sweep(),this.featureStore.forEach(function(c){return a.attributeStore.setAttributeData(c.localId,c,a.geometryInfo,
a.viewParams)}),this.attributeStore.sendUpdates(),this._updateQueue.resume(),[2]}})})};d.prototype.setViewState=function(a){var c=this,b=this.viewState&&this.viewState.scale;f.prototype.setViewState.call(this,a);this._fetchQueue.state=a;this._updateQueue.state=a;b!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.featureStore.forEach(function(a){return c.attributeStore.setAttributeData(a.localId,a,c.geometryInfo,c.viewParams)}),this.attributeStore.sendUpdates());this.featureStore.setScale(this.viewState.scale)};
d.prototype.getAggregate=function(a){return this.featureStore.getAggregate(a)};d.prototype.getAggregateValueRanges=function(){return this.featureStore.getAggregateValueRanges()};d.prototype.onTileUpdate=function(a){this._manageTiles(a.added,a.removed);this.featureStore.onTileUpdate(a)};d.prototype.onFeatureAdd=function(a){if(this._featuresInFlight.has(a.objectId)){var c=this._featuresInFlight.get(a.objectId).attributes;a.attributes=b.__assign(b.__assign({},c),a.attributes);this._featuresInFlight.delete(a.objectId)}a.localId=
this.attributeStore.createLocalId(a.objectId);this.attributeStore.setAttributeData(a.localId,a,this.geometryInfo,this.viewParams)};d.prototype._handleAttributeChange=function(a){return b.__awaiter(this,void 0,void 0,function(){return b.__generator(this,function(c){switch(c.label){case 0:return[4,this._fetchChangedFields(a)];case 1:return c.sent(),[2]}})})};d.prototype._fetchChangedTileFields=function(a,c){return b.__awaiter(this,void 0,void 0,function(){var e;return b.__generator(this,function(b){return(e=
this._dataTileIndex.get(a.id))?[2,this._fetchChangedTileFieldsDrill(e,c)]:[2]})})};d.prototype._fetchChangedTileFieldsDrill=function(a,c,e){void 0===e&&(e=0);return b.__awaiter(this,void 0,void 0,function(){var g,d,k,u,f,q,l,r,n,p,h=this;return b.__generator(this,function(m){switch(m.label){case 0:return g=b.__assign(b.__assign({},this.queryInfo),{returnGeometry:!1,returnCentroid:!1,outFields:c.concat([this.service.objectIdField])}),a.returnExceeded=a.returnExceeded||e>=H,d=a.key,k={key:d,dataTile:a,
queryInfo:g},[4,this._patchQueue.push(k)];case 1:u=m.sent();if(!(u.exceededTransferLimit&&e<H))return[3,3];f=a.tile.createChildTiles();q=f.map(function(c){var b=new E.default;b.tile=c;b.displayTile=a.displayTile;return b});return[4,y.all(q.map(function(a){return h._fetchChangedTileFieldsDrill(a,c,e+1)}))];case 2:return m.sent(),[2];case 3:l=0;for(r=u.features;l<r.length;l++)n=r[l],this.featureStore.has(n.objectId)?(p=this.featureStore.getFeature(n.objectId),p.attributes=b.__assign(b.__assign({},p.attributes),
n.attributes)):this._featuresInFlight.set(n.objectId,n);return[2]}})})};d.prototype._fetchChangedTileFieldsPaged=function(a,c,e){void 0===e&&(e=0);return b.__awaiter(this,void 0,void 0,function(){var g,d,k,u,f,q,l,r,n,p,h;return b.__generator(this,function(m){switch(m.label){case 0:return g=this.service.capabilities.query.supportsMaxRecordCountFactor,d=this.service.tileMaxRecordCount,k=d*(g?1:O),u=b.__assign(b.__assign({},this.queryInfo),{returnGeometry:!1,returnCentroid:!1,outFields:c.concat([this.service.objectIdField]),
resultOffset:e*k,num:k}),a.returnExceeded=!0,f=a.key,q={key:f,dataTile:a,queryInfo:u},[4,this._patchQueue.push(q)];case 1:l=m.sent();r=0;for(n=l.features;r<n.length;r++)p=n[r],this.featureStore.has(p.objectId)?(h=this.featureStore.getFeature(p.objectId),h.attributes=b.__assign(b.__assign({},h.attributes),p.attributes)):this._featuresInFlight.set(p.objectId,p);return l.exceededTransferLimit?[2,this._fetchChangedTileFieldsPaged(a,c,e+1)]:[2]}})})};d.prototype._fetchChangedFields=function(a){return b.__awaiter(this,
void 0,void 0,function(){var c,e,g=this;return b.__generator(this,function(b){switch(b.label){case 0:return c=this.tileStore.tiles,e=c.map(function(c){return g._fetchChangedTileFields(c,a)}),[4,y.all(e)];case 1:return b.sent(),[2]}})})};d.prototype._manageTiles=function(a,c){void 0===c&&(c=null);for(var b=this._dataTileIndex,g=this._fetchQueue,d=this._updateQueue,k="esriGeometryPoint"===this.service.geometryType,u=function(a){var c=b.get(a.id);c?(c.displayTile=a,k?b.forEach(function(b){F.isChildOf(b,
c)&&(b.displayTile=a)}):c.done=!1):(c=new E.default,c.tile=a.clone(),c.displayTile=a,b.add(c));f._processDataTile(c)},f=this,h=0;h<a.length;h++){var l=a[h];u(l)}if(c)for(a=0;a<c.length;a++)l=c[a],I.add(l),d.abort(l.id);b.forEach(function(a){I.has(a.displayTile)&&v.push(a)});for(d=0;d<v.length;d++)l=v[d],g.abort(l.id),b.delete(l);v.length=0;I.clear()};d.prototype._processDataTile=function(a){var c=this,b=a.key,d=this._fetchQueue,m=b.id,k=this._queryInfoHash,b=b.level-a.displayTile.key.level>=H;this._dataTileIndex.add(a);
if(a.done||d.has(m)){if(a.queryInfoHash!==k||a.returnExceeded!==b)if(a.done)a.done=!1;else if(d.isOngoing(m))d.abort(m);else{a.queryInfoHash=k;a.returnExceeded=b;return}}else a.queryInfoHash=k,a.returnExceeded=b;a.done?this._invalidateTile(a.displayTile):d.has(m)||d.push(a).then(function(a){return c._handleResponse(a.dataTile,a.featureSet)}).catch(function(b){y.isAbortError(b)||(G.error(new Q("featurelayer-controller:tile-error","Encountered an error when handling tile response",b)),a.done=!0,c._invalidateTile(a.displayTile))})};
d.prototype._handleResponse=function(a,c){a.done=!0;B.hydrateOptimizedFeatureSet(c);if(c.exceededTransferLimit)if(a.returnExceeded)this._dataTileIndex.setTileFeatures(a,c.features),this._deleteChildrenDataTiles(a);else{c=a.tile.createChildTiles();for(var b=0;b<c.length;b++){var d=c[b],m=new E.default;m.tile=d;m.displayTile=a.displayTile;this._processDataTile(m)}P.release(c)}else this._dataTileIndex.setTileFeatures(a,c.features),this._deleteChildrenDataTiles(a);this._invalidateTile(a.tile)};d.prototype._deleteChildrenDataTiles=
function(a){this._dataTileIndex.forEach(function(c){F.isChildOf(c,a)&&v.push(c)});for(var c=0;c<v.length;c++){var b=v[c];this._fetchQueue.abort(b.id);this._dataTileIndex.delete(b)}v.length=0};d.prototype._createQuery=function(a,c,b,d,m,k){var e=this.service.geometryType;d=this._createDefaultQuery(d);d.maxRecordCountFactor=m;d.returnExceededLimitFeatures=k;d.resultType="tile";d.geometry=a;if(this.service.capabilities.query.supportsQuantization)d.quantizationParameters=new V.default({mode:"view",originPosition:"upper-left",
tolerance:b,extent:c}),"esriGeometryPolyline"===e&&(d.maxAllowableOffset=b);else if("esriGeometryPolyline"===e||"esriGeometryPolygon"===e)d.maxAllowableOffset=b;return d};d.prototype._fetchTile=function(a,c,d){return b.__awaiter(this,void 0,void 0,function(){var e,m,k,f,h,q,l,r,n,p,x;return b.__generator(this,function(b){switch(b.label){case 0:return e=new T({xmin:a.bounds[0],ymin:a.bounds[1],xmax:a.bounds[2],ymax:a.bounds[3],spatialReference:this.spatialReference}),m=this.service.geometryType,k=
"esriGeometryPoint"===m?a.tile:a.displayTile,f=k.extent,h=k.resolution,q=a.returnExceeded,l=this._createQuery(e,f,h,c,O,q),[4,this.sourceAdapter.executeQuery(l,d)];case 1:r=b.sent();if(r.transform&&"esriGeometryPolygon"===m)for(n=0,p=r.features;n<p.length;n++)x=p[n],x.geometry=B.removeCollinearVectices(x.geometry,x.geometry,m,!1,!1);return[2,r]}})})};d.prototype._invalidateTile=function(a){var b=this._updateQueue,d=0;for(a=this.tileStore.intersections(a,this._pixelBuffer);d<a.length;d++){var g=a[d].tile;
b.push(g.id,g.updateTimestamp)}};d.prototype._updateTile=function(a,c,d){return b.__awaiter(this,void 0,void 0,function(){var e,f,k,h,t,q,l,r,n,p,x,w,v=this;return b.__generator(this,function(b){switch(b.label){case 0:return e=this.tileStore.get(a),f=this.queryInfo,k=f.returnCentroid,h=f.returnGeometry,t=this._pixelBuffer,q={pixelBuffer:t,returnGeometry:h,returnCentroid:k,returnOutline:this.returnOutline},[4,this.featureStore.executeTileQuery(e,this.spatialReference,q)];case 1:return l=b.sent(),r=
l.features,n=l.objectIds,[4,this.attributeStore.sendUpdates()];case 2:return b.sent(),p={geometryType:this.service.geometryType,features:r,fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:e.transform},x=[],w=!0,this._dataTileIndex.forEach(function(a){e.id!==a.id&&F.isChildOf(a,e)&&w&&!a.done&&(w=!1)}),w&&e&&e.objectIds.forEach(function(a){n.has(a)||(a=v.attributeStore.getLocalId(a),x.push(a))}),n.forEach(function(a){e.objectIds.add(a)}),e.updateTimestamp=c,[2,this.processor.onTileData(e,
{clear:!0,addOrUpdate:p.features,remove:x,transformParams:W.Utils.getTransformParams(p)},d).catch(function(a){y.isAbortError(a)||G.error("update-tile",a)})]}})})};d.prototype._processEdits=function(a,c,d){return b.__awaiter(this,void 0,void 0,function(){var e,f,h,u,t,q=this;return b.__generator(this,function(g){switch(g.label){case 0:return e=this._createTempQueryEngine(),f=this._createObjectIdsQuery(a),a.length?[4,this.sourceAdapter.executeQuery(f)]:[3,2];case 1:h=g.sent(),B.hydrateOptimizedFeatureSet(h),
this._dataTileIndex.addOrUpdateFeatures(h.features),e.featureStore.addMany(h.features),g.label=2;case 2:return u=c.concat(a).map(function(a){return q.attributeStore.getLocalId(a)}),this._dataTileIndex.deleteFeaturesById(c),this.attributeStore.sendUpdates(),t=b.__assign(b.__assign({},this.queryInfo),{pixelBuffer:this._pixelBuffer,returnOutline:this.returnOutline}),this.tileStore.tiles.map(function(a){return b.__awaiter(q,void 0,void 0,function(){var c,f;return b.__generator(this,function(b){switch(b.label){case 0:return[4,
e.featureStore.executeTileQuery(a,this.spatialReference,t)];case 1:return c=b.sent().features,f={transform:a.transform,hasZ:!1,hasM:!1},[2,this.processor.onTileData(a,{addOrUpdate:c,remove:u,transformParams:f},d).catch(function(a){y.isAbortError(a)||G.error("update-tile",a)})]}})})}),e.destroy(),[2]}})})};d.prototype._createObjectIdsQuery=function(a){var b=this._createDefaultQuery(this.queryInfo);b.objectIds=a;return b};b.__decorate([t.property()],d.prototype,"_fetchQueue",void 0);b.__decorate([t.property()],
d.prototype,"_patchQueue",void 0);b.__decorate([t.property()],d.prototype,"_updateQueue",void 0);b.__decorate([t.property()],d.prototype,"_editsQueue",void 0);b.__decorate([t.property({readOnly:!0})],d.prototype,"featureStore",void 0);b.__decorate([t.property({constructOnly:!0})],d.prototype,"service",void 0);b.__decorate([t.property()],d.prototype,"sourceAdapter",void 0);b.__decorate([t.property({readOnly:!0,dependsOn:["featureStore","service"]})],d.prototype,"queryEngine",null);b.__decorate([t.property({dependsOn:["viewState",
"_fetchQueue.updating","_updateQueue.updating","_patchQueue.updating","_editsQueue.updating"]})],d.prototype,"updating",null);return d=b.__decorate([t.subclass("esri.views.2d.layers.features.controllers.OnDemandController")],d)}(D.default);K.default=D});