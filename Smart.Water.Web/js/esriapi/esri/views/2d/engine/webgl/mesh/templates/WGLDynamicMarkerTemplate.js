// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/maybe ../../../../../../core/screenUtils ../../../../../../core/libs/gl-matrix-2/mat2df32 ../../../../../../core/libs/gl-matrix-2/vec2f32 ../../color ../../number ../../materialKey/MaterialKey ./util ./WGLBaseMarkerTemplate ./WGLDynamicMeshTemplate ../../util/Result".split(" "),function(l,t,y,z,A,B,e,C,D,m,k,x,f,E,F,G){Object.defineProperty(t,"__esModule",{value:!0});var H=D.vec2f32.create(),
I=C.mat2df32.create(),J=A.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");l=function(l){function g(k,c){var b=l.call(this,c)||this;b._cimMarkerLayer=c;f.isFunction(c.color)?b._dynamicPropertyMap.set("_fillColor",function(b,a,d){return m.premultiplyAlphaRGBA(c.color(b,a,d))}):b._fillColor=m.premultiplyAlphaRGBA(c.color);f.isFunction(c.outlineColor)?b._dynamicPropertyMap.set("_outlineColor",function(b,a,d){return m.premultiplyAlphaRGBA(c.outlineColor(b,a,d))}):b._outlineColor=m.premultiplyAlphaRGBA(c.outlineColor);
f.isFunction(c.size)?b._dynamicPropertyMap.set("_size",function(b,a,d){return e.pt2px(c.size(b,a,d))}):b._size=e.pt2px(c.size);f.isFunction(c.scaleX)?b._dynamicPropertyMap.set("_scaleX",c.scaleX):b._scaleX=c.scaleX;f.isFunction(c.offsetX)?b._dynamicPropertyMap.set("xOffset",function(b,a,d){return e.pt2px(c.offsetX(b,a,d))}):b.xOffset=e.pt2px(c.offsetX);f.isFunction(c.offsetY)?b._dynamicPropertyMap.set("yOffset",function(b,a,d){return e.pt2px(c.offsetY(b,a,d))}):b.yOffset=e.pt2px(c.offsetY);f.isFunction(c.outlineWidth)?
b._dynamicPropertyMap.set("_outlineWidth",function(b,a,d){return e.pt2px(c.outlineWidth(b,a,d))}):b._outlineWidth=e.pt2px(c.outlineWidth);f.isFunction(c.rotation)?b._dynamicPropertyMap.set("_angle",c.rotation):b._angle=c.rotation;b._scaleFactor=B.unwrapOr(c.scaleFactor,1);b._markerPlacement=c.markerPlacement;b.effects=c.effects;b._bitSet=(1===c.alignment?1:0)|(c.colorLocked?1:0)<<1|(c.scaleSymbolsProportionally?1:0)<<3;b._materialKey=x.createMaterialKey(b.geometryType,k,!1);return b}y.__extends(g,
l);g.fromCIMMarker=function(e,c){return new g(e,c)};g.prototype.bindFeature=function(f,c,b){var l=this;this._dynamicPropertyMap.forEach(function(a,d){l[d]=a(f,c,b)});var a=this._cimMarkerLayer.materialHash,a="function"===typeof a?a(f,c,b):a;if((a=this._materialCache.get(a))&&G.ok(a.spriteMosaicItem)&&a.spriteMosaicItem){var a=a.spriteMosaicItem,d=this._cimMarkerLayer.sizeRatio,h=a.width/a.height*this._scaleX,g=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,n=this._size,p=n*h,m=this.xOffset,
t=this.yOffset;this.xOffset*=this._scaleFactor;this.yOffset*=this._scaleFactor;var q=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/e.pt2px(this._cimMarkerLayer.frameHeight):1,u=this._outlineWidth*q,v=e.pt2px(this._cimMarkerLayer.referenceSize),w=q=0,r=this._cimMarkerLayer.anchorPoint;r&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(q=-r.x/(this._size*h),w=r.y/this._size):(q=r.x,w=r.y));this._sizeOutlineWidth=k.i8888to32(Math.round(Math.min(Math.sqrt(128*
p),255)),Math.round(Math.min(Math.sqrt(128*n),255)),Math.round(Math.min(Math.sqrt(128*u),255)),Math.round(Math.min(Math.sqrt(128*v),255)));this.angle=g;this._bitestAndDistRatio=k.i8888to32(0,0,this._bitSet,Math.round(Math.min(64*d,255)));h=a.rect.x;g=a.rect.y;u=h+a.rect.width;v=g+a.rect.height;this._texUpperLeft=k.i1616to32(h,g);this._texUpperRight=k.i1616to32(u,g);this._texBottomLeft=k.i1616to32(h,v);this._texBottomRight=k.i1616to32(u,v);h=x.MarkerMaterialKey.load(this._materialKey);h.sdf=a.sdf;
h.pattern=!0;h.textureBinding=a.textureBinding;this._materialKey=h.data;this._anchorX=.5-((.5+q)*a.width+1)/a.rect.width;this._anchorY=.5-((.5+w)*a.height+1)/a.rect.height;p=p*d*this._scaleFactor;n=n*d*this._scaleFactor;p*=a.rect.width/a.width;n*=a.rect.height/a.height;this._computedWidth=p;this._computedHeight=n;this._applyTransformation(I,H);this.xOffset=m;this.yOffset=t}else J.error(z("mapview-cim","Encountered an error when binding feature"))};return g}(E.default(F.default));t.default=l});