// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../webgl ../../engine ../vectorTiles/shaders/ProgramCache ./BitBlitRenderer ./enums ./MaterialManager ./TextureManager ./effects/AnimationEffect ./effects/BlendEffect ./effects/HighlightEffect ./effects/HittestEffect ./painter/RenderPass".split(" "),function(g,l,m,h,f,p,q,k,r,t,u,v,w,x,y){function n(e,a){return 1!==a||m.isSome(e)&&"normal"!==e}Object.defineProperty(l,"__esModule",{value:!0});g=function(){return function(){}}();l.PainterOptions=
g;g=function(){function e(a,b){this.context=a;this._blitRenderer=new q.BitBlitRenderer;this._brushCache=new Map;this._vtlProgramCache=null;this._blendEffect=new v.BlendEffect;this.brushNameToCtor={marker:f.brushes.Marker,line:f.brushes.Line,fill:f.brushes.Fill,text:f.brushes.Text,label:f.brushes.Label,clip:f.brushes.Clip,stencil:f.brushes.Stencil,bitmap:f.brushes.Bitmap,tileInfo:f.brushes.TileInfo,vtlBackground:f.brushes.VTLBackground,vtlFill:f.brushes.VTLFill,vtlLine:f.brushes.VTLLine,vtlCircle:f.brushes.VTLCircle,
vtlSymbol:f.brushes.VTLSymbol};this.effects={highlight:new w.default,hittest:new x.HittestEffect,integrate:new u.AnimationEffect};this.materialManager=new r(a);this._vtlProgramCache=new p.default(a);this.textureManager=new t(b)}e.prototype.getRenderTarget=function(){return this._renderTarget};e.prototype.setRenderTarget=function(a){this._renderTarget=a};e.prototype.getFbos=function(a,b){if(a!==this._lastWidth||b!==this._lastHeight){this._lastWidth=a;this._lastHeight=b;if(this._fbos){for(var c in this._fbos)this._fbos[c].resize(a,
b);return this._fbos}c={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:a,height:b};var d={colorTarget:0,depthStencilTarget:3};this._stencilBuf=a=new h.Renderbuffer(this.context,{width:a,height:b,internalFormat:34041});this._fbos={output:new h.FramebufferObject(this.context,d,c,a),blend:new h.FramebufferObject(this.context,d,c,a),effect0:new h.FramebufferObject(this.context,d,c,a)}}return this._fbos};e.prototype.getSharedStencilBuffer=function(){return this._stencilBuf};
e.prototype.beforeRenderLayers=function(a,b){void 0===b&&(b=null);var c=a.getViewport(),d=c.width,c=c.height;this._prevFBO=a.getBoundFramebufferObject();d=this.getFbos(d,c);a.bindFramebuffer(d.output);a.setDepthWriteEnabled(!0);m.isSome(b)?(b=b.color,d=b.a,a.setClearColor(d*b.r/255,d*b.g/255,d*b.b/255,d)):a.setClearColor(0,0,0,0);a.setClearDepth(1);a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT);a.setDepthWriteEnabled(!1)};e.prototype.beforeRenderLayer=function(a,b,c){var d=a.context;n(a.blendMode,
c)?(d.bindFramebuffer(this._fbos.blend),d.setColorMask(!0,!0,!0,!0),d.setClearColor(0,0,0,0),d.clear(d.gl.COLOR_BUFFER_BIT)):(a=this._getOutputFBO(),d.bindFramebuffer(a));d.setDepthWriteEnabled(!1);d.setDepthTestEnabled(!1);d.setStencilTestEnabled(!0);d.setClearStencil(b);d.setStencilWriteMask(255);d.clear(d.gl.STENCIL_BUFFER_BIT)};e.prototype.compositeLayer=function(a,b){var c=a.context,d=a.blendMode;if(n(d,b)){var e=this._getOutputFBO();c.bindFramebuffer(e);c.setStencilTestEnabled(!1);c.setStencilWriteMask(0);
c.setBlendingEnabled(!0);c.setBlendFunctionSeparate(1,771,1,771);c.setColorMask(!0,!0,!0,!0);c=m.isSome(d)?d:"normal";this._blendEffect.draw(a,this._fbos.blend.colorTexture,9728,c,b)}};e.prototype.renderLayers=function(a){a.bindFramebuffer(this._prevFBO);if(this._fbos){var b=this._getOutputFBO();a.setStencilTestEnabled(!1);a.setStencilWriteMask(0);this.blitTexture(a,b.colorTexture,9728)}};e.prototype.dispose=function(){this.materialManager.dispose();this.textureManager.dispose();this._blitRenderer&&
(this._blitRenderer.dispose(),this._blitRenderer=null);this._vtlProgramCache&&(this._vtlProgramCache.dispose(),this._vtlProgramCache=null);this._brushCache&&(this._brushCache.forEach(function(a){return a.dispose()}),this._brushCache.clear(),this._brushCache=null);if(this._fbos)for(var a in this._fbos)this._fbos[a]&&this._fbos[a].dispose();if(this.effects)for(var b in this.effects)this.effects[b]&&this.effects[b].dispose();this._prevFBO=null};e.prototype.getGeometryBrush=function(a){var b;a=(b={},
b[k.WGLGeometryType.FILL]=f.brushes.Fill,b[k.WGLGeometryType.LINE]=f.brushes.Line,b[k.WGLGeometryType.MARKER]=f.brushes.Marker,b[k.WGLGeometryType.TEXT]=f.brushes.Text,b)[a];b=this._brushCache.get(a);void 0===b&&(b=new a,this._brushCache.set(a,b));return this._brushCache.get(a)};e.prototype.renderObject=function(a,b,c,d){c=this.brushNameToCtor[c];if(!c)return null;var e=this._brushCache.get(c);void 0===e&&(e=new c,this._brushCache.set(c,e));e.prepareState(a,b,d);e.draw(a,b,d)};e.prototype.renderObjects=
function(a,b,c,d){c=this.brushNameToCtor[c];if(!c)return null;var e=this._brushCache.get(c);void 0===e&&(e=new c,this._brushCache.set(c,e));e.drawMany(a,b,d)};e.prototype.getVectorTileProgramCach=function(){return this._vtlProgramCache};e.prototype.registerRenderPass=function(a){var b=this,c=a.brushes.map(function(a){b._brushCache.has(a)||b._brushCache.set(a,new a);return b._brushCache.get(a)});return new y.default(c,a)};e.prototype.setHighlightOptions=function(a){this.effects.highlight.setHighlightOptions(a)};
e.prototype.blitTexture=function(a,b,c,d){void 0===d&&(d=1);a.setBlendingEnabled(!0);a.setBlendFunctionSeparate(1,771,1,771);a.setColorMask(!0,!0,!0,!0);this._blitRenderer.render(a,b,c,d)};e.prototype._getOutputFBO=function(){return null!=this._renderTarget?this._renderTarget:this._fbos.output};return e}();l.default=g});