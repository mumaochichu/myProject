// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/BidiEngine ./Bucket ./GeometryUtils ./Placement ./TextShaping ./style/StyleLayer ../webgl/Geometry".split(" "),function(P,Q,L,M,N,w,F,E,I,B){function O(w,g){return w.iconMosaicItem&&g.iconMosaicItem?w.iconMosaicItem.page===g.iconMosaicItem.page?0:w.iconMosaicItem.page<g.iconMosaicItem.page?-1:1:w.iconMosaicItem&&!g.iconMosaicItem?1:!w.iconMosaicItem&&g.iconMosaicItem?-1:0}(function(){return function(){}})();return function(K){function g(a,b,e,f,h,c,d,
q){b=K.call(this,a,b)||this;b._markerMap=new Map;b._glyphMap=new Map;b._glyphBufferDataStorage=new Map;b._sdfMarkers=!1;if(a.hasDataDrivenIcon!==e.isDataDriven())throw Error("incompatible icon buffer");if(a.hasDataDrivenText!==h.isDataDriven())throw Error("incompatible text buffer");b._iconVertexBuffer=e;b._iconIndexBuffer=f;b._textVertexBuffer=h;b._textIndexBuffer=c;b._placementEngine=d;b._workerTileHandler=q;return b}L.__extends(g,K);Object.defineProperty(g.prototype,"markerPageMap",{get:function(){return this._markerMap},
enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"glyphsPageMap",{get:function(){return this._glyphMap},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"sdfMarker",{get:function(){return this._sdfMarkers},enumerable:!0,configurable:!0});g.prototype.copy=function(a,b,e,f,h){a=new g(this.layer,this.zoom,a,b,e,f,h,this._workerTileHandler);a.layerIndex=this.layerIndex;a.layerExtent=this.layerExtent;a._iconIndexStart=b.index;a._textIndexStart=f.index;a._iconIndexCount=
0;a._textIndexCount=0;a._symbolInstances=this._symbolInstances;a._workerTileHandler=this._workerTileHandler;a._fontArray=this._fontArray;a._textLayout=this._textLayout;a._iconLayout=this._iconLayout;a._isLinePlacement=this._isLinePlacement;a._avoidEdges=this._avoidEdges;return a};g.prototype.getResources=function(a,b,e){var f=this.layer,h=this.zoom,c=f.hasDataDrivenIcon,d=f.hasDataDrivenText;a&&a.setExtent(this.layerExtent);for(var q=f.getLayoutProperty("icon-image"),l=f.getLayoutProperty("text-field"),
t=f.getLayoutValue("text-font",h),v=f.getLayoutValue("text-transform",h),r=[],n=[1,1,1,1],y=1,p=1,k=[1,1,1,1],m=1,D=1,z=0,x=this._features;z<x.length;z++){var u=x[z],C=u.getGeometry(a);if(C&&0!==C.length){var w=void 0;q&&(w=f.getLayoutValue("icon-image",h,u),q.isDataDriven||(w=this._replaceKeys(w,u.values)),w&&b.add(w));var A=void 0,E=!1;if(l&&((A=f.getLayoutValue("text-field",h,u))&&!l.isDataDriven&&(A=this._replaceKeys(A,u.values)),A)){A=A.replace(/\\n/g,"\n");switch(v){case 2:A=A.toLowerCase();
break;case 1:A=A.toUpperCase()}g._bidiEngine.hasBidiChar(A)&&(E=void 0,E="rtl"===g._bidiEngine.checkContextual(A)?"IDNNN":"ICNNN",A=g._bidiEngine.bidiTransform(A,E,"VLYSN"),E=!0);var B=A.length;if(0<B)for(var G=0,F=t;G<F.length;G++){var H=F[G],J=e[H];J||(J=e[H]=new Set);for(H=0;H<B;H++){var I=A.charCodeAt(H);J.add(I)}}}if(w||A)B=f.getLayoutValue("icon-size",h,u),G=f.getLayoutValue("text-size",h,u),f.hasDataDrivenIconColor&&(n=f.getPaintValue("icon-color",h,u)),f.hasDataDrivenIconOpacity&&(y=f.getPaintValue("icon-opacity",
h,u)),f.hasDataDrivenIconSize&&(p=B),f.hasDataDrivenTextColor&&(k=f.getPaintValue("text-color",h,u)),f.hasDataDrivenTextOpacity&&(m=f.getPaintValue("text-opacity",h,u)),f.hasDataDrivenTextSize&&(D=G),u={sprite:w,label:A,rtl:E,type:u.type,geometry:C,iconSize:B,iconRotate:f.getLayoutValue("icon-rotate",h,u),ddIconValues:c?{color:n,opacity:y,size:p}:null,textSize:G,textRotate:f.getLayoutValue("text-rotate",h,u),ddTextValues:d?{color:k,opacity:m,size:D}:null},r.push(u)}}this._symbolFeatures=r};g.prototype.processFeatures=
function(a){a&&a.setExtent(this.layerExtent);var b=this.layer,e=this.zoom;a=this._isLinePlacement=1===b.getLayoutValue("symbol-placement",e);var f=8*b.getLayoutValue("symbol-spacing",e),h=b.getLayoutProperty("icon-image"),c=b.getLayoutProperty("text-field"),d=this._workerTileHandler,q,l;h&&(this._iconLayout=new I.IconLayout(b,e,a),q=d.getSpriteItems(),l=this._getTranslate(!0));var t,v;if(c){c=this._textLayout=new I.TextLayout(b,e,a);this._fontArray=c.fontArray;v=.5;switch(c.anchor){case 5:case 1:case 7:v=
0;break;case 6:case 2:case 8:v=1}t=.5;switch(c.anchor){case 5:case 3:case 6:t=0;break;case 7:case 4:case 8:t=1}b=.5;switch(c.justify){case 0:b=0;break;case 2:b=1}var e=c.letterSpacing*E.SDF_GLYPH_SIZE,h=a?0:c.maxWidth*E.SDF_GLYPH_SIZE,r=c.lineHeight*E.SDF_GLYPH_SIZE,c=this._fontArray.map(function(a){return d.getGlyphItems(a)});t=new E.TextShaping(c,h,r,e,v,t,b);v=this._getTranslate(!1)}this._iconIndexStart=this._iconIndexBuffer.index;this._textIndexStart=this._textIndexBuffer.index;this._textIndexCount=
this._iconIndexCount=0;this._markerMap.clear();this._glyphMap.clear();this._symbolInstances=b=[];e=this._textLayout;h=1;e&&e.size&&(h=e.size/E.SDF_GLYPH_SIZE);for(var c=e?e.maxAngle*w.C_DEG_TO_RAD:0,r=e?8*e.size:0,n=0,y=this._symbolFeatures;n<y.length;n++){var p=y[n],k=void 0;p.sprite&&(k=q[p.sprite])&&k.sdf&&(this._sdfMarkers=!0);var m=void 0,D=p.label,z=0;if(D&&(m=a?e.keepUpright:e.writingMode&&0<=e.writingMode.indexOf(1),(m=t.getShaping(D,p.rtl,m))&&0<m.length)){for(var z=1E30,D=-1E30,x=0,u=m;x<
u.length;x++)var C=u[x],z=Math.min(z,C.x),D=Math.max(D,C.x);z=(D-z+2*E.SDF_GLYPH_SIZE)*h*8}D=0;for(x=p.geometry;D<x.length;D++){var u=x[D],B=void 0;a?(m&&0<m.length&&e&&e.size&&g._smoothVertices(u,8*e.size*(2+Math.min(2,4*Math.abs(e.offset[1])))),B=g._findAnchors(u,f,z)):B=3===p.type?g._findCentroid(u):[new F.Anchor(u[0].x,u[0].y)];for(C=0;C<B.length;C++){var A=B[C];0>A.x||4096<A.x||0>A.y||4096<A.y||a&&0<z&&0===e.rotationAlignment&&!g._honorsTextMaxAngle(u,A,z,c,r)||b.push({shaping:m,line:u,iconMosaicItem:k,
anchor:A,iconSize:p.iconSize,iconRotate:p.iconRotate,ddIconValues:p.ddIconValues,textSize:p.textSize,textRotate:p.textRotate,ddTextValues:p.ddTextValues})}}}b.sort(O);for(q=0;q<b.length;q++)this._processFeature(b[q],l,v);this._addPlacedGlyphs()};g.prototype.updateSymbols=function(){this._iconIndexStart=this._iconIndexBuffer.index;this._textIndexStart=this._textIndexBuffer.index;this._textIndexCount=this._iconIndexCount=0;this._markerMap.clear();this._glyphMap.clear();var a=this.layer,b;a.getLayoutProperty("icon-image")&&
(b=this._getTranslate(!0));var e;a.getLayoutProperty("text-field")&&(e=this._getTranslate(!1));for(var a=0,f=this._symbolInstances;a<f.length;a++)this._processFeature(f[a],b,e);this._addPlacedGlyphs()};g.prototype.assignBufferInfo=function(){};g.prototype._getTranslate=function(a){var b=this.layer.getPaintValue(a?"icon-translate":"text-translate",this.zoom);if(0!==b[0]||0!==b[1]){var e=this._placementEngine.mapAngle;return 0!==e&&0===this.layer.getPaintValue(a?"icon-translate-anchor":"text-translate-anchor",
this.zoom)?(a=Math.sin(e),e=Math.cos(e),[8*(b[0]*e-b[1]*a),8*(b[0]*a+b[1]*e)]):[8*b[0],8*b[1]]}};g.prototype._replaceKeys=function(a,b){return a.replace(/{([^{}]+)}/g,function(a,f){return f in b?b[f]:""})};g.prototype._processFeature=function(a,b,e){var f=a.line,h=a.iconMosaicItem,c=a.shaping,d=a.anchor,q=this._iconLayout,l=q&&!!h,t=!0,v=1;l&&(q.size=a.iconSize,q.rotate=a.iconRotate,v=8*q.size,t=q.optional||!h);var r=this._textLayout,n=r&&c&&0<c.length,g;g=1;var p=!0;n&&(r.size=a.textSize,r.rotate=
a.textRotate,g=r.size/E.SDF_GLYPH_SIZE,g*=8,p=r.optional||!c||0===c.length);var k;l&&(k=this._placementEngine.getIconPlacement(d,b,h,v,q),d.minzoom>k.footprint.minzoom&&(k.footprint.minzoom=d.minzoom),k.footprint.minzoom===w.C_INFINITY&&(k=null));if(k||t){var m;n&&(m=this._placementEngine.getTextPlacement(d,e,c,g,f,r))&&(d.minzoom>m.footprint.minzoom&&(m.footprint.minzoom=d.minzoom),m.footprint.minzoom===w.C_INFINITY&&(m=null));if(m||p)k&&m||(p||t?p||m?t||k||(m=null):k=null:m=k=null),k&&m&&!p&&!t&&
(b=Math.max(k.footprint.minzoom,m.footprint.minzoom),k.footprint.minzoom=b,m.footprint.minzoom=b),m&&(r.ignorePlacement||this._placementEngine.add(m),this._storePlacedGlyphs(m.shapes,m.footprint.minzoom,this.zoom,a.ddTextValues)),k&&(q.ignorePlacement||this._placementEngine.add(k),this._addPlacedIcons(k.shapes,k.footprint.minzoom,this.zoom,h.page,a.ddIconValues))}};g.prototype._addPlacedIcons=function(a,b,e,f,h){b=Math.max(e+w.log2(b),0);for(var c=this._iconVertexBuffer,d=this._iconIndexBuffer,q=
0;q<a.length;q++){var l=a[q],t=Math.max(e+w.log2(l.minzoom),b),g=Math.min(e+w.log2(l.maxzoom),25);if(!(g<=t)){var r=l.tl,n=l.tr,y=l.bl,p=l.br,k=l.mosaicRect,m=l.labelAngle,D=l.minAngle,z=l.maxAngle,l=l.anchor,x=c.index,u=k.x,C=k.y,B=u+k.width,k=C+k.height;c.add(l.x,l.y,r.x,r.y,u,C,m,D,z,t,g,b,h);c.add(l.x,l.y,n.x,n.y,B,C,m,D,z,t,g,b,h);c.add(l.x,l.y,y.x,y.y,u,k,m,D,z,t,g,b,h);c.add(l.x,l.y,p.x,p.y,B,k,m,D,z,t,g,b,h);d.add(x+0,x+1,x+2);d.add(x+1,x+2,x+3);this._markerMap.has(f)?this._markerMap.get(f)[1]+=
6:this._markerMap.set(f,[this._iconIndexStart+this._iconIndexCount,6]);this._iconIndexCount+=2}}};g.prototype._addPlacedGlyphs=function(){var a=this,b=this._textVertexBuffer,e=this._textIndexBuffer;this._glyphBufferDataStorage.forEach(function(f,h){for(var c=0;c<f.length;c++){var d=f[c],q=b.index;b.add(d.glyphAnchor[0],d.glyphAnchor[1],d.tl[0],d.tl[1],d.xmin,d.ymin,d.labelAngle,d.minAngle,d.maxAngle,d.minLod,d.maxLod,d.placementLod,d.ddValues);b.add(d.glyphAnchor[0],d.glyphAnchor[1],d.tr[0],d.tr[1],
d.xmax,d.ymin,d.labelAngle,d.minAngle,d.maxAngle,d.minLod,d.maxLod,d.placementLod,d.ddValues);b.add(d.glyphAnchor[0],d.glyphAnchor[1],d.bl[0],d.bl[1],d.xmin,d.ymax,d.labelAngle,d.minAngle,d.maxAngle,d.minLod,d.maxLod,d.placementLod,d.ddValues);b.add(d.glyphAnchor[0],d.glyphAnchor[1],d.br[0],d.br[1],d.xmax,d.ymax,d.labelAngle,d.minAngle,d.maxAngle,d.minLod,d.maxLod,d.placementLod,d.ddValues);e.add(q+0,q+1,q+2);e.add(q+1,q+2,q+3);a._glyphMap.has(h)?a._glyphMap.get(h)[1]+=6:a._glyphMap.set(h,[a._textIndexStart+
a._textIndexCount,6]);a._textIndexCount+=2}});this._glyphBufferDataStorage.clear()};g.prototype._storePlacedGlyphs=function(a,b,e,f){b=Math.max(e+w.log2(b),0);for(var h=0;h<a.length;h++){var c=a[h],d=Math.max(e+w.log2(c.minzoom),b),q=Math.min(e+w.log2(c.maxzoom),25);if(!(q<=d)){var l=c.tl,g=c.tr,v=c.bl,r=c.br,n=c.labelAngle,y=c.minAngle,p=c.maxAngle,k=c.anchor,m=c.mosaicRect;this._glyphBufferDataStorage.has(c.page)||this._glyphBufferDataStorage.set(c.page,[]);this._glyphBufferDataStorage.get(c.page).push({glyphAnchor:[k.x,
k.y],tl:[l.x,l.y],tr:[g.x,g.y],bl:[v.x,v.y],br:[r.x,r.y],xmin:m.x,ymin:m.y,xmax:m.x+m.width,ymax:m.y+m.height,labelAngle:n,minAngle:y,maxAngle:p,minLod:d,maxLod:q,placementLod:b,ddValues:f})}}};g._findAnchors=function(a,b,e){b+=e;for(var f=0,h=a.length-1,c=0;c<h;c++)f+=B.Point.distance(a[c],a[c+1]);c=.5*(e||b);if(f<=c)return[];e=c/f;b=f/Math.max(Math.round(f/b),1);for(var f=0,h=-b/2,d=[],q=a.length-1,c=0;c<q;c++){for(var l=a[c],g=a[c+1],v=g.x-l.x,r=g.y-l.y,n=Math.sqrt(v*v+r*r),y=void 0;h+b<f+n;){var h=
h+b,p=(h-f)/n,k=w.interpolate(l.x,g.x,p),p=w.interpolate(l.y,g.y,p);void 0===y&&(y=Math.atan2(r,v));d.push(new F.Anchor(k,p,y,c,e))}f+=n}return d};g._deviation=function(a,b,e){return Math.atan2((b.x-a.x)*(e.y-b.y)-(b.y-a.y)*(e.x-b.x),(b.x-a.x)*(e.x-b.x)+(b.y-a.y)*(e.y-b.y))};g._honorsTextMaxAngle=function(a,b,e,f,h){var c=0;e/=2;for(var d=new B.Point(b.x,b.y),g=b.segment+1;c>-e;){--g;if(0>g)return!1;c-=B.Point.distance(a[g],d);d=a[g]}c+=B.Point.distance(a[g],a[g+1]);b=[];for(var d=0,l=a.length;c<
e;){var t=a[g],v=void 0;do{++g;if(g===l)return!1;v=a[g]}while(v.isEqual(t));var r=g,n=void 0;do{++r;if(r===l)return!1;n=a[r]}while(n.isEqual(v));t=this._deviation(t,v,n);b.push({deviation:t,distToAnchor:c});for(d+=t;c-b[0].distToAnchor>h;)d-=b.shift().deviation;if(Math.abs(d)>f)return!1;c+=B.Point.distance(v,n)}return!0};g._smoothVertices=function(a,b){if(!(0>=b)){var e=a.length;if(!(3>e)){var f=[],h=0;f.push(0);for(var c=1;c<e;c++)h+=B.Point.distance(a[c],a[c-1]),f.push(h);b=Math.min(b,.2*h);h=[];
h.push(a[0].x);h.push(a[0].y);var d=a[e-1].x,g=a[e-1].y,c=B.Point.sub(a[0],a[1]);c.normalize();a[0].x+=b*c.x;a[0].y+=b*c.y;c.assignSub(a[e-1],a[e-2]);c.normalize();a[e-1].x+=b*c.x;a[e-1].y+=b*c.y;for(c=1;c<e;c++)f[c]+=b;f[e-1]+=b;for(var l=.5*b,c=1;c<e-1;c++){for(var t=0,v=0,r=0,n=c-1;0<=n&&!(f[n+1]<f[c]-l);n--){var y=l+f[n+1]-f[c],p=f[n+1]-f[n],k=f[c]-f[n]<l?1:y/p;if(1E-6>Math.abs(k))break;var m=k*k,w=k*y-.5*m*p,z=k*p/b,x=a[n+1],u=a[n].x-x.x,C=a[n].y-x.y,t=t+z/w*(x.x*k*y+.5*m*(y*u-p*x.x)-m*k*p*u/
3),v=v+z/w*(x.y*k*y+.5*m*(y*C-p*x.y)-m*k*p*C/3),r=r+z}for(n=c+1;n<e&&!(f[n-1]>f[c]+l);n++){y=l-f[n-1]+f[c];p=f[n]-f[n-1];k=f[n]-f[c]<l?1:y/p;if(1E-6>Math.abs(k))break;m=k*k;w=k*y-.5*m*p;z=k*p/b;x=a[n-1];u=a[n].x-x.x;C=a[n].y-x.y;t+=z/w*(x.x*k*y+.5*m*(y*u-p*x.x)-m*k*p*u/3);v+=z/w*(x.y*k*y+.5*m*(y*C-p*x.y)-m*k*p*C/3);r+=z}h.push(t/r);h.push(v/r)}h.push(d);h.push(g);for(n=c=0;c<e;c++)a[c].x=h[n++],a[c].y=h[n++]}}};g._findCentroid=function(a){var b=a.length-1,e=0,f=0,g=0,c=a[0].x,d=a[0].y;4096<c&&(c=
4096);0>c&&(c=0);4096<d&&(d=4096);0>d&&(d=0);for(var q=1;q<b;q++){var l=a[q].x,t=a[q].y,v=a[q+1].x,r=a[q+1].y;4096<l&&(l=4096);0>l&&(l=0);4096<t&&(t=4096);0>t&&(t=0);4096<v&&(v=4096);0>v&&(v=0);4096<r&&(r=4096);0>r&&(r=0);var n=(l-c)*(r-d)-(v-c)*(t-d),e=e+n*(c+l+v),f=f+n*(d+t+r),g=g+n}e/=3*g;f/=3*g;return isNaN(e)||isNaN(f)?[]:[new F.Anchor(e,f)]};g._bidiEngine=new M.default;return g}(N)});