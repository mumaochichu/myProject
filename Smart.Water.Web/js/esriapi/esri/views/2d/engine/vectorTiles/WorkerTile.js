// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/maybe ../../../../core/promiseUtils ./BackgroundBucket ./CircleBucket ./FillBucket ./GeometryUtils ./IndexMemoryBuffer ./LineBucket ./Placement ./SymbolBucket ./TileParser ./VertexMemoryBuffer ../../tiling/enums".split(" "),function(L,M,r,x,w,E,F,G,y,m,H,I,J,K,g,q){return function(){function d(){this.rotation=0;this.status=q.TileStatus.INITIALIZED;this._symbolBuckets=[];this.placementEngine=new I.PlacementEngine;this.fillVertexBuffer=new g.FillVertexBuffer(!1);
this.fillDDVertexBuffer=new g.FillVertexBuffer(!0);this.fillIndexBuffer=new m.TriangleIndexBuffer;this.outlineVertexBuffer=new g.OutlineVertexBuffer(!1);this.outlineDDVertexBuffer=new g.OutlineVertexBuffer(!0);this.outlineIndexBuffer=new m.TriangleIndexBuffer;this.lineVertexBuffer=new g.LineVertexBuffer(!1);this.lineDDVertexBuffer=new g.LineVertexBuffer(!0);this.lineIndexBuffer=new m.TriangleIndexBuffer;this.iconVertexBuffer=new g.SymbolVertexBuffer(!1);this.iconDDVertexBuffer=new g.SymbolVertexBuffer(!0);
this.iconIndexBuffer=new m.TriangleIndexBuffer;this.textVertexBuffer=new g.SymbolVertexBuffer(!1);this.textDDVertexBuffer=new g.SymbolVertexBuffer(!0);this.textIndexBuffer=new m.TriangleIndexBuffer;this.circleVertexBuffer=new g.CircleVertexBuffer;this.circleIndexBuffer=new m.TriangleIndexBuffer}d.prototype.initialize=function(e,f,a,k){void 0===k&&(k=0);this.tileKey=e;this.refKeys=f;this._workerTileHandler=a;this.rotation=k;this.placementEngine.setAngle(y.C_DEG_TO_RAD*k)};d.prototype.release=function(){this.tileKey=
"";this.refKeys=null;this.status=q.TileStatus.INITIALIZED;this.rotation=0;this.resetData();this._workerTileHandler=null};d.prototype.resetData=function(){this.fillVertexBuffer.reset();this.fillDDVertexBuffer.reset();this.fillIndexBuffer.reset();this.outlineVertexBuffer.reset();this.outlineDDVertexBuffer.reset();this.outlineIndexBuffer.reset();this.lineVertexBuffer.reset();this.lineDDVertexBuffer.reset();this.lineIndexBuffer.reset();this.iconVertexBuffer.reset();this.iconDDVertexBuffer.reset();this.iconIndexBuffer.reset();
this.textVertexBuffer.reset();this.textDDVertexBuffer.reset();this.textIndexBuffer.reset();this.circleVertexBuffer.reset();this.circleIndexBuffer.reset();this.placementEngine.reset();this._symbolBuckets.length=0};d.prototype.reparse=function(e){this.resetData();return this.setDataAndParse(this._data,e)};d.prototype.setDataAndParse=function(e,f){var a=this,k=f&&f.signal;if(x.isSome(k)){var d=function(){k.removeEventListener("abort",d);a.status=q.TileStatus.INVALID};k.addEventListener("abort",d)}this._data=
e;return this._parse(e,f).then(function(e){a.status=q.TileStatus.READY;for(var f=new Uint32Array([1,a.fillVertexBuffer.sizeInBytes,2,a.fillDDVertexBuffer.sizeInBytes,3,a.fillIndexBuffer.sizeInBytes,4,a.outlineVertexBuffer.sizeInBytes,5,a.outlineDDVertexBuffer.sizeInBytes,6,a.outlineIndexBuffer.sizeInBytes,7,a.lineVertexBuffer.sizeInBytes,8,a.lineDDVertexBuffer.sizeInBytes,9,a.lineIndexBuffer.sizeInBytes,10,a.iconVertexBuffer.sizeInBytes,11,a.iconDDVertexBuffer.sizeInBytes,12,a.iconIndexBuffer.sizeInBytes,
13,a.textVertexBuffer.sizeInBytes,14,a.textDDVertexBuffer.sizeInBytes,15,a.textIndexBuffer.sizeInBytes,16,a.circleVertexBuffer.sizeInBytes,17,a.circleIndexBuffer.sizeInBytes]),c=[],k=e.length,d=0;d<k;d++){var b=e[d];if(b instanceof G)c.push(b.layerIndex),c.push(1),c.push(b.fillIndexStart),c.push(b.fillIndexCount),c.push(b.outlineIndexStart),c.push(b.outlineIndexCount);else if(b instanceof H)c.push(b.layerIndex),c.push(2),c.push(b.lineIndexStart),c.push(b.lineIndexCount);else if(b instanceof J){c.push(b.layerIndex);
c.push(3);c.push(b.sdfMarker?1:0);var n=b.markerPageMap;c.push(n.size);n.forEach(function(a,b){c.push(b);c.push(a[0]);c.push(a[1])});b=b.glyphsPageMap;c.push(b.size);b.forEach(function(a,b){c.push(b);c.push(a[0]);c.push(a[1])})}else b instanceof F?(c.push(b.layerIndex),c.push(4),c.push(b.circleIndexStart),c.push(b.circleIndexCount)):b instanceof E&&(c.push(b.layerIndex),c.push(0))}e=new Uint32Array(c);var k=a.fillVertexBuffer.toBuffer(),d=a.fillDDVertexBuffer.toBuffer(),b=a.fillIndexBuffer.toBuffer(),
n=a.outlineVertexBuffer.toBuffer(),g=a.outlineDDVertexBuffer.toBuffer(),l=a.outlineIndexBuffer.toBuffer(),m=a.lineVertexBuffer.toBuffer(),h=a.lineDDVertexBuffer.toBuffer(),B=a.lineIndexBuffer.toBuffer(),C=a.iconVertexBuffer.toBuffer(),w=a.iconDDVertexBuffer.toBuffer(),z=a.iconIndexBuffer.toBuffer(),r=a.textVertexBuffer.toBuffer(),x=a.textDDVertexBuffer.toBuffer(),y=a.textIndexBuffer.toBuffer(),A=a.circleVertexBuffer.toBuffer(),D=a.circleIndexBuffer.toBuffer();return{result:{bufferDataInfo:f.buffer,
bucketDataInfo:e.buffer,bufferData:[k,d,b,n,g,l,m,h,B,C,w,z,r,x,y,A,D]},transferList:[k,d,b,n,g,l,m,h,B,C,w,z,r,x,y,A,D,f.buffer,e.buffer]}})};d.prototype.addBucket=function(e){this._symbolBuckets.push(e)};d.prototype.updateSymbols=function(e,f){var a=this,d=this._symbolBuckets;if(!d||0===d.length)return w.resolve();var g=f&&f.signal;if(x.isSome(g)){var m=function(){g.removeEventListener("abort",m);a.status=q.TileStatus.INVALID};g.addEventListener("abort",m)}this.rotation=e;var p=this.placementEngine;
p.reset();p.setAngle(e/256*360*y.C_DEG_TO_RAD);var c=this.iconVertexBuffer;c.reset();var t=this.iconDDVertexBuffer;t.reset();var u=this.iconIndexBuffer;u.reset();var b=this.textVertexBuffer;b.reset();f=this.textDDVertexBuffer;f.reset();e=this.textIndexBuffer;e.reset();for(var n=[],v=0;v<d.length;v++){var l=d[v];if(l&&l.layer){var r=l.layer;if(l=l.copy(r.hasDataDrivenIcon?t:c,u,r.hasDataDrivenText?f:b,e,p))n.push(l),l.updateSymbols()}}if(this.status===q.TileStatus.INVALID||this.status===q.TileStatus.INITIALIZED||
0===c.sizeInBytes&&0===t.sizeInBytes&&0===u.sizeInBytes&&0===b.sizeInBytes&&0===f.sizeInBytes&&0===e.sizeInBytes)return w.reject();for(var d=new Uint32Array([10,c.sizeInBytes,11,t.sizeInBytes,12,u.sizeInBytes,13,b.sizeInBytes,14,f.sizeInBytes,15,e.sizeInBytes]),h=[],v=0;v<n.length;v++)p=n[v],h.push(p.layerIndex),h.push(3),h.push(p.sdfMarker?1:0),l=p.markerPageMap,h.push(l.size),l.forEach(function(a,b){h.push(b);h.push(a[0]);h.push(a[1])}),p=p.glyphsPageMap,h.push(p.size),p.forEach(function(a,b){h.push(b);
h.push(a[0]);h.push(a[1])});n=new Uint32Array(h);c=c.toBuffer();t=t.toBuffer();u=u.toBuffer();b=b.toBuffer();f=f.toBuffer();e=e.toBuffer();return w.resolve({result:{bufferDataInfo:d.buffer,bucketDataInfo:n.buffer,bufferData:[c,t,u,b,f,e]},transferList:[c,t,u,b,f,e,d.buffer,n.buffer]})};d.prototype.setObsolete=function(){this.status=q.TileStatus.INVALID};d.prototype.getLayers=function(){return this._workerTileHandler.getLayers()};d.prototype.getWorkerTileHandler=function(){return this._workerTileHandler};
d.prototype._parse=function(d,f){return r.__awaiter(this,void 0,void 0,function(){var a;return r.__generator(this,function(e){if(0===Object.keys(d).length)return[2,[]];this.status=q.TileStatus.MODIFIED;a=new K(d,this,f.client);return[2,a.parse(f)]})})};return d}()});