// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Color ../../../request ../../../symbols ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/Handles ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/urlUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../layers/support/ExportImageParameters ../../../layers/support/fieldUtils ../../../renderers/support/jsonUtils ../../../renderers/visualVariables/support/SizeVariableLegendOptions ../../../symbols/support/symbolUtils ../../../symbols/support/utils ../../../views/MapView ./clusterUtils ./colorRampUtils ./heatmapRampUtils ./relationshipRampUtils ./sizeRampUtils ./utils @dojo/framework/shim/Promise".split(" "),
function(N,Ba,e,O,ja,P,ka,la,ma,na,oa,Q,w,ca,q,m,pa,qa,ra,sa,C,ta,ua,va,B,wa,da,I,xa){function J(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function K(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function W(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function fa(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function D(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function E(e){return"esri.renderers.PointCloudStretchRenderer"===
e.declaredClass}function L(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function ga(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}var p=oa.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),F=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,M=new P.SimpleMarkerSymbol({size:6,outline:{color:[128,128,128,.5],width:.5}}),ya=new P.SimpleFillSymbol({style:"solid"}),za=new P.SimpleMarkerSymbol({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,
color:[85,85,85,1]}}),x={};return function(ea){function g(a){a=ea.call(this,a)||this;a._handles=new na;a._hasColorRamp=!1;a._hasOpacityRamp=!1;a._hasSizeRamp=!1;a._webStyleSymbolCache=new Map;a._dotDensityUrlCache=new Map;a._scaleDrivenSizeVariable=null;a._hasClusterSizeVariable=!1;a.children=new ma;a.layerView=null;a.layer=null;a.legendElements=[];a.parent=null;a.keepCacheOnDestroy=!1;a.respectLayerVisibility=!0;a.sublayerIds=[];a.title=null;a.view=null;return a}e.__extends(g,ea);g.prototype.initialize=
function(){var a=this,b=function(){return a.notifyChange("ready")};this._handles.add([q.on(this,"children","change",function(c){var d=c.removed,h=a._handles;c.added.map(function(a){var c="activeLayerInfo-ready-watcher-"+a.layer.uid;h.add(q.init(a,"ready",b),c)});d.forEach(function(a){return h.remove(a.layer.uid)});b()})]);this.keepCacheOnDestroy||(x={})};g.prototype.destroy=function(){this._handles.destroy();this._scaleDrivenSizeVariable=this._dotDensityUrlCache=this._webStyleSymbolCache=this._handles=
null;this.keepCacheOnDestroy||(x=null)};Object.defineProperty(g.prototype,"ready",{get:function(){return null===this.layer?!0:0<this.children.length?this._isGroupActive():0<this.legendElements.length},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"scale",{get:function(){return this.view&&this.view.scale},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"isScaleDriven",{get:function(){var a=this,b=this.layer;if(null===b)return!1;if("featureReduction"in b&&b.featureReduction&&
"cluster"===b.featureReduction.type)return!0;if("renderer"in b&&b.renderer){if("dot-density"===b.renderer.type)return!0;var c=b.get("renderer.valueExpression");if(F.test(c))return!0;if(b=b.get("renderer.visualVariables"))return b.some(function(b){return a._isScaleDrivenSizeVariable(b)})}return this._isLayerScaleDriven(this.layer)},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"version",{get:function(){return this._get("version")+1},enumerable:!0,configurable:!0});g.prototype.buildLegendElementsForFeatureCollections=
function(a){return e.__awaiter(this,void 0,void 0,function(){var b,c=this;return e.__generator(this,function(d){this.legendElements=[];b=a.map(function(a){if("esri.layers.FeatureLayer"===a.declaredClass)return c._buildRendererLegendElements(a.renderer,{title:a.title,mode:0});if(a.featureSet&&a.featureSet.features.length){var b=a.layerDefinition,b=(b=b&&b.drawingInfo)&&ra.fromJSON(b.renderer);return b?c._buildRendererLegendElements(b,{title:a.name,mode:0}):(p.warn("drawingInfo not available!"),null)}return null});
return[2,w.eachAlways(b).then(function(){})]})})};g.prototype.buildLegendElementsForRenderer=function(a){return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(b){return[2,this._buildRendererLegendElements(a)]})})};g.prototype.buildLegendElementsForTools=function(){return e.__awaiter(this,void 0,void 0,function(){var a,b=this;return e.__generator(this,function(c){switch(c.label){case 0:a=this.layer;if("esri.layers.WMTSLayer"!==a.declaredClass)return[3,1];this._constructLegendElementsForWMTSlayer();
return[3,6];case 1:if("esri.layers.WMSLayer"!==a.declaredClass)return[3,2];this._constructLegendElementsForWMSSublayers();return[3,6];case 2:return"esri.layers.MapImageLayer"!==a.declaredClass&&"esri.layers.TileLayer"!==a.declaredClass?[3,4]:[4,this._constructLegendElementsForSublayers()];case 3:return c.sent(),[3,6];case 4:return this._handles.remove("imageryLayers-watcher"),[4,this._getLegendLayers().then(function(c){b.legendElements=[];c.forEach(function(c){if("esri.layers.ImageryLayer"===a.declaredClass){var d=
a.watch("renderingRule, bandIds",function(){x["default"]=null;b.buildLegendElementsForTools()});b._handles.add(d,"imageryLayers-watcher")}(c=b._generateSymbolTableElementForLegendLayer(c))&&c.infos.length&&("esri.layers.ImageryLayer"===a.declaredClass&&(c.title=a.title),b.legendElements.push(c));b.notifyChange("ready")});b.notifyChange("ready")}).catch(function(a){p.warn("Request to server for legend has failed!",a)})];case 5:c.sent(),c.label=6;case 6:return[2]}})})};g.prototype._isGroupActive=function(){var a=
this.children;return a.length?a.some(function(a){return a.ready}):!1};g.prototype._isScaleDrivenSizeVariable=function(a){if(a&&"size"!==a.type)return!1;var b=a.minSize,c=a.maxSize;return"object"===typeof b&&b?this._isScaleDrivenSizeVariable(b):"object"===typeof c&&c?this._isScaleDrivenSizeVariable(c):!!a.expression||F.test(a.valueExpression)};g.prototype._isLayerScaleDriven=function(a){var b=this;if("minScale"in a&&0<a.minScale||"maxScale"in a&&0<a.maxScale)return!0;if("sublayers"in a&&a.sublayers)return a.sublayers.some(function(a){return b._isLayerScaleDriven(a)});
var c=a.parent;if(!1===a.loaded&&"esri.layers.MapImageLayer"===c.declaredClass&&"source"in a&&a.source&&"map-layer"===a.source.type)for(var d=0,c=c.sourceJSON.layers;d<c.length;d++){var h=c[d];if(h.id===a.source.mapLayerId&&(0<h.minScale||0<h.maxScale))return!0}return!1};g.prototype._buildRendererLegendElements=function(a,b){void 0===b&&(b={});return e.__awaiter(this,void 0,void 0,function(){var c,d;return e.__generator(this,function(h){switch(h.label){case 0:return h.trys.push([0,2,,3]),[4,this._getRendererLegendElements(a,
{title:b.title})];case 1:return c=h.sent(),0===b.mode?Array.prototype.push.apply(this.legendElements,c):this.legendElements=c,this.notifyChange("ready"),[3,3];case 2:return d=h.sent(),p.warn("error while building legend for layer!",d),[3,3];case 3:return[2]}})})};g.prototype._constructLegendElementsForWMTSlayer=function(){this.legendElements=[];this._handles.remove("wmts-activeLayer-watcher");var a=this.layer,b=a.activeLayer;this._handles.add(q.watch(this.layer,"activeLayer",this._constructLegendElementsForWMTSlayer.bind(this)),
"wmts-activeLayer-watcher");if(b.styleId&&b.styles){var c=null;b.styles.some(function(a){return b.styleId===a.id?(c=a.legendUrl,!0):!1});c&&(this.legendElements=[{type:"symbol-table",title:b.title,infos:[{src:c,opacity:a.opacity}]}])}this.notifyChange("ready")};g.prototype._constructLegendElementsForWMSSublayers=function(){this.legendElements=[];this._handles.remove("wms-sublayers-watcher");var a=this.layer,b=null;if(a.customParameters||a.customLayerParameters)b=e.__assign(e.__assign({},a.customParameters),
a.customLayerParameters);this._handles.add(q.watch(this.layer,"sublayers",this._constructLegendElementsForWMSSublayers.bind(this)),"wms-sublayers-watcher");this.legendElements=this._generateLegendElementsForWMSSublayers(a.sublayers,b);this.notifyChange("ready")};g.prototype._generateLegendElementsForWMSSublayers=function(a,b){var c=this,d=[];this._handles.add(a.on("change",this._constructLegendElementsForWMSSublayers.bind(this)),"wms-sublayers-watcher");a.forEach(function(a){var f=a.watch("title, visible, legendEnabled",
function(){return c._constructLegendElementsForWMSSublayers()});c._handles.add(f,"wms-sublayers-watcher");a.visible&&a.legendEnabled&&(a=c._generateSymbolTableElementForWMSSublayer(a,b))&&a.infos.length&&d.unshift(a)});return d};g.prototype._generateSymbolTableElementForWMSSublayer=function(a,b){return!a.legendUrl&&a.sublayers?(b=this._generateLegendElementsForWMSSublayers(a.sublayers,b).filter(function(a){return a}),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendUrl(a,
b)};g.prototype._generateSymbolTableElementForLegendUrl=function(a,b){var c=a.legendUrl;if(c){var d={type:"symbol-table",title:a.title||a.name||a.id&&a.id+"",infos:[]};b&&(c+="?"+ca.objectToQuery(b));d.infos.push({src:c,opacity:a.layer&&a.layer.opacity});return d}};g.prototype._getLegendLayers=function(a){var b=(a=a&&a.hasDynamicLayers?a.dynamicLayers:null)||"default",c=x&&x[b];return c?w.resolve(c):this._legendRequest(a).then(function(a){a=a.layers;return x[b]=a})};g.prototype._legendRequest=function(a){var b=
this.layer;a={f:"json",dynamicLayers:a};"esri.layers.ImageryLayer"===b.declaredClass&&(b.renderingRule&&(a.renderingRule=JSON.stringify(b.renderingRule.toJSON())),b.bandIds&&(a.bandIds=b.bandIds.join()),b.raster||b.viewId)&&(a=e.__assign({raster:b.raster,viewId:b.viewId},a));var c=b.url.replace(/(\/)+$/,"");"version"in b&&10.01<=b.version?(b=c.indexOf("?"),c=-1<b?c.substring(0,b)+"/legend"+c.substring(b):c+"/legend"):(b=c.toLowerCase().indexOf("/rest/"),c=c.substring(0,b)+c.substring(b+5,c.length),
c="https://utility.arcgis.com/sharing/tools/legend?soapUrl\x3d"+encodeURI(c)+"\x26returnbytes\x3dtrue");return ja(c,{query:a}).then(function(a){return a.data})};g.prototype._constructLegendElementsForSublayers=function(){return e.__awaiter(this,void 0,void 0,function(){var a,b,c;return e.__generator(this,function(d){switch(d.label){case 0:this.legendElements=[],this._handles.remove("sublayers-watcher"),a=this.layer,this._handles.add(q.watch(a,"sublayers",this._constructLegendElementsForSublayers.bind(this)),
"sublayers-watcher"),d.label=1;case 1:return d.trys.push([1,3,,4]),b=this,[4,this._generateLegendElementsForSublayers(a.sublayers,a.opacity)];case 2:return b.legendElements=d.sent(),this.notifyChange("ready"),[3,4];case 3:return c=d.sent(),p.warn("Request to server for legend has failed!",c),[3,4];case 4:return[2]}})})};g.prototype._generateLegendElementsForSublayers=function(a,b,c){return e.__awaiter(this,void 0,void 0,function(){var d,h,f,g,k,l,y,n,m,r,t,w=this;return e.__generator(this,function(e){switch(e.label){case 0:d=
[],this._handles.add(a.on("change",this._constructLegendElementsForSublayers.bind(this)),"sublayers-watcher"),h=a.toArray(),!c&&this.sublayerIds&&this.sublayerIds.length&&(f=this.layer,h=this.sublayerIds.map(function(a){return f.findSublayerById(a)}).filter(Boolean)),g=0,k=h,e.label=1;case 1:if(!(g<k.length))return[3,8];l=k[g];y=l.watch("renderer, opacity, title, visible, legendEnabled",function(){return w._constructLegendElementsForSublayers()});this._handles.add(y,"sublayers-watcher");if(!l.visible||
!l.legendEnabled)return[3,7];n=l&&null!=l.opacity?l.opacity:null;m=null!=n?n*b:b;return!l.renderer||l.sublayers?[3,5]:this.respectLayerVisibility&&!this._isSublayerInScale(l)?[3,4]:[4,l.load()];case 2:return e.sent(),[4,this._getRendererLegendElements(l.renderer,{title:l.title,opacity:m,sublayer:l})];case 3:r=e.sent(),Array.prototype.unshift.apply(d,r),e.label=4;case 4:return[3,7];case 5:return[4,this._generateSymbolTableElementForSublayer(l,m,c)];case 6:(t=e.sent())&&d.unshift(t),e.label=7;case 7:return g++,
[3,1];case 8:return[2,d.filter(function(a){return!!a&&("infos"in a?0<a.infos.length:!0)})]}})})};g.prototype._generateSymbolTableElementForSublayer=function(a,b,c){return e.__awaiter(this,void 0,void 0,function(){var d,h,f,g;return e.__generator(this,function(e){switch(e.label){case 0:if(c)return[3,4];c=new Map;d=new pa.ExportImageParameters({layer:this.layer});e.label=1;case 1:return e.trys.push([1,,3,4]),[4,this._getLegendLayers(d)];case 2:return h=e.sent(),h.forEach(function(a){return c.set(a.layerId,
a)}),[3,4];case 3:return d.destroy(),[7];case 4:return(f=c.get(a.id))||!a.sublayers?[3,6]:[4,this._generateLegendElementsForSublayers(a.sublayers,b,c)];case 5:return g=e.sent(),[2,{type:"symbol-table",title:a.title,infos:g}];case 6:return[2,this._generateSymbolTableElementForLegendLayer(f,a,b)]}})})};g.prototype._generateSymbolTableElementForLegendLayer=function(a,b,c){var d=this;if(!a||!a.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(a,b))return null;var h=b&&b.renderer,f=b&&b.title||
a.layerName;h&&(h=b&&b.title||this._getRendererTitle(h,b))&&(f&&(h.title=f),f=h);f={type:"symbol-table",title:f,infos:[]};a.legendType&&(f.legendType=a.legendType);b=b?this._sanitizeLegendForSublayer(a.legend.slice(),b):a.legend;f.infos=b.map(function(b){var f=b.url;if(b.imageData&&0<b.imageData.length)f="data:image/png;base64,"+b.imageData;else if(0!==f.indexOf("http"))f=ca.addTokenParameter(d.layer.url+"/"+a.layerId+"/images/"+f);else return null;return{label:b.label,src:f,opacity:null==c?d.layer.opacity:
c,width:b.width,height:b.height}}).filter(function(a){return!!a});return f.infos.length?f:null};g.prototype._isSublayerInScale=function(a){var b=a.minScale||0;a=a.maxScale||0;return 0<b&&b<this.scale||a>this.scale?!1:!0};g.prototype._isLegendLayerInScale=function(a,b){b=b||this.layer;var c=null,d=null,h=!0;!b.minScale&&0!==b.minScale||!b.maxScale&&0!==b.maxScale?(0===a.minScale&&b.tileInfo&&(c=b.tileInfo.lods[0].scale),0===a.maxScale&&b.tileInfo&&(d=b.tileInfo.lods[b.tileInfo.lods.length-1].scale)):
(c=Math.min(b.minScale,a.minScale)||b.minScale||a.minScale,d=Math.max(b.maxScale,a.maxScale));if(0<c&&c<this.scale||d>this.scale)h=!1;return h};g.prototype._sanitizeLegendForSublayer=function(a,b){if("version"in this.layer&&10.1>this.layer.version||0===a.length)return a;b=b.renderer;var c=null,d=null;a.some(function(a){return a.values})&&a.some(function(a,b){a.values||(c=b,d=a,d.label||(d.label="others"));return null!=d});b?"unique-value"===b.type?d&&(a.splice(c,1),a.push(d)):"class-breaks"===b.type&&
(d&&a.splice(c,1),a.reverse(),d&&a.push(d)):d&&(a.splice(c,1),a.push(d));return a};g.prototype._getRendererLegendElements=function(a,b){void 0===b&&(b={});return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(c){return J(a)||K(a)||W(a)||"raster-stretch"===a.type||"raster-colormap"===a.type||fa(a)||D(a)||E(a)||L(a)||ga(a)||"raster-shaded-relief"===a.type?D(a)||E(a)||L(a)||"esri.renderers.PointCloudRGBRenderer"===a.declaredClass?[2,this._constructPointCloudRendererLegendElements(a,
b)]:ga(a)?[2,this._constructDotDensityRendererLegendElements(a)]:[2,this._constructRendererLegendElements(a,b)]:(p.warn("Renderer not supported!"),[2,[]])})})};g.prototype._getPointCloudRendererTitle=function(a){return a.legendOptions&&a.legendOptions.title||a.field};g.prototype._constructPointCloudRendererLegendElements=function(a,b){var c=this;void 0===b&&(b={});b=b.title;var d=[],h=null,f=null;if(D(a))h={type:"symbol-table",title:b||this._getPointCloudRendererTitle(a),infos:[]},a.colorClassBreakInfos.forEach(function(a){h.infos.unshift({label:a.label||
a.minValue+" - "+a.maxValue,value:[a.minValue,a.maxValue],symbol:c._getAppliedCloneSymbol(M,a.color)})});else if(E(a)){var f=a.stops,e=null;if(f.length&&(1===f.length&&(e=f[0].color),!e)){var g=f[0].value,l=f[f.length-1].value;null!=g&&null!=l&&(e=B.getColorFromPointCloudStops(g+(l-g)/2,f))}h={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(M,e||M.color)}]};f=B.getRampStopsForPointCloud(a.stops);f={type:"color-ramp",title:b||this._getPointCloudRendererTitle(a),
infos:f,preview:C.renderColorRampPreviewHTML(f.map(function(a){return a.color}))}}else L(a)&&(h={type:"symbol-table",title:b||this._getPointCloudRendererTitle(a),infos:[]},a.colorUniqueValueInfos.forEach(function(a){h.infos.push({label:a.label||a.values.join(", "),value:a.values.join(", "),symbol:c._getAppliedCloneSymbol(M,a.color)})}));h&&h.infos.length&&d.push(h);f&&f.infos.length&&d.push(f);a=d.reduce(function(a,b){return a.concat(b.infos)},[]).filter(function(a){return!!a.symbol}).map(function(a){return c._getSymbolPreview(a,
c.layer.opacity)});return w.eachAlways(a).then(function(){return d})};g.prototype._getElementInfoForDotDensity=function(a,b){var c=a.outline,c=a.dotSize+"-"+b+"-"+a.backgroundColor+"-"+(c&&JSON.stringify(c.toJSON())),d=this._dotDensityUrlCache;a=d.has(c)?d.get(c):C.renderDotDensityPreviewHTML(a,b);d.set(c,a);return{opacity:1,src:a.src,preview:a,width:a.width,height:a.height}};g.prototype._constructDotDensityRendererLegendElements=function(a){var b=this,c=a.calculateDotValue(this.view.scale),d={type:"symbol-table",
title:{value:c&&Math.round(c),unit:a.legendOptions&&a.legendOptions.unit||""},infos:[]};a.attributes.forEach(function(c){var f=b._getElementInfoForDotDensity(a,c.color);f.label=c.label||c.valueExpressionTitle||c.field;d.infos.push(f)});return w.resolve([d])};g.prototype._constructRendererLegendElements=function(a,b){void 0===b&&(b={});return e.__awaiter(this,void 0,void 0,function(){var c,d,h,f,g,k,l,y,n,m,r,t,X,G,Y,Z,ha,p,T,aa,U,x,ba,Aa,ia,q,B,F,M,V,u,z,A,H,v,I,D,R,E,L,N,O,S=this;return e.__generator(this,
function(e){switch(e.label){case 0:return c=b.title,h=(d=b.sublayer)||this.layer,[4,this._loadRenderer(a)];case 1:return f=e.sent(),this._hasSizeRamp=this._hasOpacityRamp=this._hasColorRamp=!1,this._scaleDrivenSizeVariable=null,[4,this._getVisualVariableLegendElements(f,h)];case 2:g=e.sent()||[];k={type:"symbol-table",title:c||this._getRendererTitle(f,h),infos:[]};l=null;y=!1;n=new Set;if(!fa(f))return[3,3];m=wa.getHeatmapRampStops(f);g.push({type:"heatmap-ramp",title:c,infos:m,preview:C.renderColorRampPreviewHTML(m.map(function(a){return a.color}))});
return[3,12];case 3:if(!W(f))return[3,4];if(t=(r=f&&f.authoringInfo)&&"relationship"===r.type){if(X=r.focus,G=r.numClasses,Y=r.field1,Z=r.field2,G&&Y&&Z){ha=[Y,Z];p=da.getRotationAngleForFocus(X)||0;T=0;for(aa=ha;T<aa.length;T++)U=aa[T],x=U.field,ba=U.normalizationField,ia=(Aa=U.label)||{field:this._getFieldAlias(x,h),normField:ba&&this._getFieldAlias(ba,h)},q=za.clone(),q.angle=p,k.infos.push({label:ia,symbol:q}),n.add(q),p+=90;B=da.getRelationshipRampElement({focus:X,numClasses:G,infos:f.uniqueValueInfos});
g.unshift(B)}}else F=f.field,f.uniqueValueInfos.forEach(function(a){if(a.symbol){var b=a.symbol.clone();"esri.layers.ImageryLayer"===S.layer.declaredClass&&(b=P.SimpleMarkerSymbol.fromJSON({color:b.color,style:"square"}));k.infos.push({label:a.label||S._getDomainName(F,a.value,h)||a.value,value:a.value,symbol:b})}});f.defaultSymbol&&(k.infos.push({label:f.defaultLabel||"others",symbol:f.defaultSymbol}),y=!0);return[3,12];case 4:if(!K(f))return[3,5];l=this._isUnclassedRenderer(f);if(M=!l||!this._hasSizeRamp)f.classBreakInfos.forEach(function(a){if(a.symbol){var b=
a.symbol.clone();"esri.layers.ImageryLayer"===S.layer.declaredClass&&(b=P.SimpleMarkerSymbol.fromJSON({color:b.color,style:"square"}));k.infos.unshift({label:a.label||(l?null:a.minValue+" - "+a.maxValue),value:[a.minValue,a.maxValue],symbol:b})}}),l&&(k.title=null),this._updateInfosforClassedSizeRenderer(f,k.infos);f.defaultSymbol&&!l&&(k.infos.push({label:f.defaultLabel||"others",symbol:f.defaultSymbol}),y=!0);return[3,12];case 5:if("raster-stretch"!==f.type)return[3,11];if("esri.layers.ImageryTileLayer"!==
this.layer.declaredClass)return[3,6];V=this._constructTileImageryStretchRendererElements(f);"stretch-ramp"===V.type?g.push(V):k.infos=V;return[3,10];case 6:return u=this.layer,A=z=void 0,f.statistics&&f.statistics.length&&(z=f.statistics[0].min||f.statistics[0][0],A=f.statistics[0].max||f.statistics[0][1]),H=[],I=Q.unwrap,u.renderingRule?[4,u.generateRasterInfo(u.renderingRule)]:[3,8];case 7:return D=e.sent(),[3,9];case 8:D=u.serviceRasterInfo,e.label=9;case 9:v=I.apply(void 0,[D]),R=v.keyProperties.BandProperties,
1===v.bandCount?(z=z||v.statistics&&v.statistics[0].min,A=A||v.statistics&&v.statistics[0].max,z||A?g.push(this._getStretchLegendElements(f,{min:z,max:A})):this.buildLegendElementsForTools()):u.bandIds&&1===u.bandIds.length?(z=z||v.statistics&&v.statistics[u.bandIds[0]].min,A=A||v.statistics&&v.statistics[u.bandIds[0]].max,z||A?g.push(this._getStretchLegendElements(f,{min:z,max:A})):this.buildLegendElementsForTools()):3<=v.bandCount?R&&R.length>=v.bandCount?u.bandIds&&3===u.bandIds.length?(H=u.bandIds.map(function(a){return R[a].BandName}),
k.infos=this._createSymbolTableElementMultiBand(H)):"lerc"===u.format?(H=[0,1,2].map(function(a){return R[a].BandName}),k.infos=this._createSymbolTableElementMultiBand(H)):this.buildLegendElementsForTools():"lerc"===u.format?(H=["band0","band1","band2"],k.infos=this._createSymbolTableElementMultiBand(H)):this.buildLegendElementsForTools():this.buildLegendElementsForTools(),e.label=10;case 10:return[3,12];case 11:"raster-colormap"===f.type?f.colormapInfos.forEach(function(a){k.infos.push({label:a.label,
value:a.value,symbol:S._getAppliedCloneSymbol(ya,a.color)})}):J(f)?f.symbol&&!this._hasSizeRamp&&k.infos.push({label:f.label,symbol:f.symbol}):"raster-shaded-relief"===f.type&&g.push(this._getStretchLegendElements(f,{min:0,max:255})),e.label=12;case 12:return E=f.defaultSymbol,!E||y||J(f)||l&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||g.push({type:"symbol-table",infos:[{label:f.defaultLabel||"others",symbol:E}]}),k.infos.length&&g.unshift(k),L=null==b.opacity?h.opacity:b.opacity,
N=this._getSymbolConfig("visualVariables"in f&&f.visualVariables),O=g.reduce(function(a,b){return a.concat(b.infos)},[]).filter(function(a){return!(!a||!a.symbol)}).map(function(a){return S._getSymbolPreview(a,L,{applyScaleDrivenSize:!n.has(a.symbol),symbolConfig:N})}),f=null,[4,w.eachAlways(O)];case 13:return e.sent(),[2,g]}})})};g.prototype._constructTileImageryStretchRendererElements=function(a){function b(a){var b=(c.bandIds&&c.bandIds.length?c.bandIds:[0,1,2]).map(function(b){return a&&a[b]&&
a[b].BandName||"band"+b});3>b.length?b.push(b[1]):3<b.length&&b.splice(3);return b}var c=this.layer,d=c.rasterInfo,g=d.bandCount||a.statistics.length,f,e,k=[],k=d.keyProperties&&d.keyProperties.BandProperties;a.statistics&&a.statistics.length&&(f=void 0!==a.statistics[0].min?a.statistics[0].min:a.statistics[0][0],e=a.statistics[0].max||a.statistics[0][1]);if(1===d.bandCount)return this._getStretchLegendElements(a,{min:f,max:e});k=k&&k.length>=g?b(k):b();return this._createSymbolTableElementMultiBand(k)};
g.prototype._getStretchLegendElements=function(a,b){a=B.getStrectchRampStops(a.colorRamp,b);return{type:"stretch-ramp",title:"",infos:a,preview:C.renderColorRampPreviewHTML(a.map(function(a){return a.color}))}};g.prototype._createSymbolTableElementMultiBand=function(a){var b=[],c=["red","green","blue"];a.forEach(function(a,e){b.push({label:{colorName:c[e],bandName:a},src:xa.RGB_IMG_SOURCE[e],opacity:1})});return b};g.prototype._updateInfosforClassedSizeRenderer=function(a,b){var c=a.authoringInfo&&
"class-breaks-size"===a.authoringInfo.type,d=a.classBreakInfos.some(function(a){return ta.isVolumetricSymbol(a.symbol)});if(c&&d){var e=I.REAL_WORLD_MAX_SIZE;a=a.classBreakInfos.length;var f=(e-I.REAL_WORLD_MIN_SIZE)/(1<a?a-1:a);b.forEach(function(a,b){a.size=e-f*b})}};g.prototype._getSymbolConfig=function(a){var b=!1,c=!1;if(a)for(var d=0;d<a.length&&(!b||!c);d++){var e=a[d];"size"===e.type&&("height"===e.axis&&(b=!0),"width-and-depth"===e.axis&&(c=!0))}return b&&c?"tall":null};g.prototype._getSymbolPreview=
function(a,b,c){return e.__awaiter(this,void 0,void 0,function(){var d,g;return e.__generator(this,function(f){switch(f.label){case 0:return d=a.size,this._scaleDrivenSizeVariable&&(null===c||void 0===c?0:c.applyScaleDrivenSize)?[4,new Promise(function(a,b){N(["../../../renderers/visualVariables/support/visualVariableUtils"],a,b)})]:[3,2];case 1:g=f.sent().getSize,d=g(this._scaleDrivenSizeVariable,null,{view:this.view,scale:this.scale,shape:"simple-marker"===a.symbol.type?a.symbol.style:null}),f.label=
2;case 2:return[2,C.renderPreviewHTML(a.symbol,{size:d,opacity:b,symbolConfig:null===c||void 0===c?void 0:c.symbolConfig,rotation:a.symbol.angle}).then(function(b){a.preview=b;return a}).catch(function(){a.preview=null;return a})]}})})};g.prototype._loadRenderer=function(a){var b,c;return e.__awaiter(this,void 0,void 0,function(){var d,g,f,m,k,l,y,n,q,r,t,p,G=this;return e.__generator(this,function(e){switch(e.label){case 0:return d=[],g=this.layer,a=a.clone(),this._hasClusterSizeVariable=!1,f="visualVariables"in
a&&(null===(b=a.visualVariables)||void 0===b?void 0:b.some(function(a){return"size"===a.type&&"outline"!==a.target&&!F.test(a.valueExpression)})),a&&"visualVariables"in a&&!f&&"featureReduction"in g&&"cluster"===(null===(c=g.featureReduction)||void 0===c?void 0:c.type)&&(m=this.layerView._effectiveRenderer,k=Q.unwrap(va.getClusterSizeVariable(m,this.view)))&&(l=g.featureReduction,"clusterMinSize"in l&&"clusterMaxSize"in l&&(y=l.clusterMinSize,n=l.clusterMaxSize,k.legendOptions=new sa({showLegend:y!==
n})),q=a.visualVariables||[],a.visualVariables=q.concat([k]),this._hasClusterSizeVariable=!0),[4,this._getMedianColor(a)];case 1:r=e.sent();if(K(a)||W(a))t=a.classBreakInfos||a.uniqueValueInfos,p=t.map(function(a){return G._fetchSymbol(a.symbol,r).then(function(b){a.symbol=b}).catch(function(){a.symbol=null})}),Array.prototype.push.apply(d,p);d.push(this._fetchSymbol(a.symbol||a.defaultSymbol,a.defaultSymbol?null:r).then(function(b){G._applySymbolToRenderer(a,b,J(a))}).catch(function(){G._applySymbolToRenderer(a,
null,J(a))}));return[2,w.eachAlways(d).then(function(){return a})]}})})};g.prototype._applySymbolToRenderer=function(a,b,c){c?a.symbol=b:a.defaultSymbol=b};g.prototype._getMedianColor=function(a){return e.__awaiter(this,void 0,void 0,function(){var b,c,d,g,f;return e.__generator(this,function(e){switch(e.label){case 0:if(!("visualVariables"in a&&a.visualVariables))return[2,null];b=la.find(a.visualVariables,function(a){return"color"===a.type});if(!b)return[2,null];d=c=null;if(b.stops){if(1===b.stops.length)return[2,
b.stops[0].color];c=b.stops[0].value;d=b.stops[b.stops.length-1].value}g=c+(d-c)/2;return[4,new Promise(function(a,b){N(["../../../renderers/visualVariables/support/visualVariableUtils"],a,b)})];case 1:return f=e.sent().getColor,[2,f(b,g)]}})})};g.prototype._fetchSymbol=function(a,b){var c=this;if(!a)return w.reject();if("web-style"===a.type){var d=a.portal,d=a.name+"-"+a.styleName+"-"+a.styleUrl+"-"+(d&&d.url)+"-"+(d&&d.user&&d.user.username),e=this._webStyleSymbolCache;e.has(d)||(this.view instanceof
ua?e.set(d,a.fetchCIMSymbol()):e.set(d,a.fetchSymbol()));return e.get(d).then(function(a){return c._getAppliedCloneSymbol(a,b)}).catch(function(){p.warn("Fetching web-style failed!");return w.reject()})}return w.resolve(this._getAppliedCloneSymbol(a,b))};g.prototype._getAppliedCloneSymbol=function(a,b){if(!a)return a;a=a.clone();var c=-1<a.type.indexOf("3d");b=b&&b.toRgba();c?this._applyColorTo3dSymbol(a,b):a.color&&(a.color=new O(b||a.color));return a};g.prototype._applyColorTo3dSymbol=function(a,
b){b&&a.symbolLayers.forEach(function(a){a&&(a.material||(a.material={}),a.material.color=new O(b))})};g.prototype._getVisualVariableLegendElements=function(a,b){return e.__awaiter(this,void 0,void 0,function(){var c,d,g,f,m,k,l,q,n,p,r,t,x=this;return e.__generator(this,function(h){switch(h.label){case 0:if(!("visualVariables"in a&&a.visualVariables))return[2,null];c=a.visualVariables;d=[];g=[];f=[];m=0;for(k=c;m<k.length;m++)l=k[m],"color"===l.type?d.push(l):"size"===l.type?g.push(l):"opacity"===
l.type&&f.push(l);q=e.__spreadArrays(d,g,f);0===d.length&&K(a)&&a.classBreakInfos&&1===a.classBreakInfos.length&&(n=(r=a.classBreakInfos[0])&&r.symbol);0===d.length&&J(a)&&(n=a.symbol);n&&(-1<n.type.indexOf("3d")?(t=n.symbolLayers.getItemAt(0),"water"===t.type?Q.isSome(t.color)&&(p=t.color):Q.isSome(t.material)&&Q.isSome(t.material.color)&&(p=t.material.color)):n.url||(p=n.color));return[4,w.all(q.map(function(c){return e.__awaiter(x,void 0,void 0,function(){var d,f,g,h,k,l,m,n;return e.__generator(this,
function(e){switch(e.label){case 0:if(c.legendOptions&&!1===c.legendOptions.showLegend)return[3,10];d=this._getRampTitle(c,b);f=null;h=(g="getField"in b&&b.getField&&b.getField(c.field))&&qa.isDateField(g);return"color"!==c.type?[3,2]:[4,B.getRampStops(c,null,h)];case 1:return k=e.sent(),f={type:"color-ramp",title:d,infos:k,preview:C.renderColorRampPreviewHTML(k.map(function(a){return a.color}))},this._hasColorRamp||(this._hasColorRamp=!(null==f.infos||!f.infos.length)),[3,9];case 2:if("size"!==c.type||
"outline"===c.target)return[3,7];if(!F.test(c.valueExpression))return[3,3];this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=c);return[3,6];case 3:return l={type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(c):d},m=I.getRampStops,n=[a,c],[4,this._getMedianColor(a)];case 4:return[4,m.apply(void 0,n.concat([e.sent(),this.scale,this.view,h]))];case 5:f=(l.infos=e.sent(),l),this._hasSizeRamp||(this._hasSizeRamp=!(null==f.infos||!f.infos.length)),e.label=6;case 6:return[3,
9];case 7:return"opacity"!==c.type?[3,9]:[4,B.getRampStops(c,p,h)];case 8:k=e.sent(),f={type:"opacity-ramp",title:d,infos:k,preview:C.renderColorRampPreviewHTML(k.map(function(a){return a.color}))},this._hasOpacityRamp||(this._hasOpacityRamp=!(null==f.infos||!f.infos.length)),e.label=9;case 9:return[2,f&&f.infos?f:null];case 10:return[2,void 0]}})})}))];case 1:return[2,h.sent().filter(function(a){return!!a})]}})})};g.prototype._getDomainName=function(a,b,c){return a&&"function"!==typeof a?(c=(a="getField"in
c&&c.getField&&c.getField(a))&&"getFieldDomain"in c&&c.getFieldDomain?c.getFieldDomain(a.name):null)&&"coded-value"===c.type?c.getName(b):null:null};g.prototype._getClusterTitle=function(a){var b=this.layer;a=a.field;if("featureReduction"in b&&b.featureReduction&&"cluster"===b.featureReduction.type&&(b=b.featureReduction,b=(b="popupTemplate"in b&&b.popupTemplate)&&b.fieldInfos))for(var c=0;c<b.length;c++){var d=b[c];if(d.fieldName===a)return"cluster_count"===a?d.label||{showCount:!0}:d.label}return{showCount:!0}};
g.prototype._getRampTitle=function(a,b){var c=a.field,d=a.normalizationField,e=!1,f=!1,g=!1,k=null,c="function"===typeof c?null:c,d="function"===typeof d?null:d,k=a.legendOptions&&a.legendOptions.title;if(null==k)if(a.valueExpressionTitle)k=a.valueExpressionTitle;else{if("renderer"in b&&b.renderer&&"authoringInfo"in b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables)for(a=b.renderer.authoringInfo.visualVariables,k=0;k<a.length;k++){var l=a[k];if("color"===l.type){if("ratio"===
l.style){e=!0;break}if("percent"===l.style){f=!0;break}if("percent-of-total"===l.style){g=!0;break}}}k={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),ratio:e,ratioPercent:f,ratioPercentTotal:g}}return k};g.prototype._getRendererTitle=function(a,b){if(a.legendOptions&&a.legendOptions.title)return a.legendOptions.title;if(a.valueExpressionTitle)return a.valueExpressionTitle;var c=a.field,d=null,e=null;K(a)&&(d=a.normalizationField,e="percent-of-total"===a.normalizationType);
c="function"===typeof c?null:c;d="function"===typeof d?null:d;a=null;if(c||d)a={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),normByPct:e};return a};g.prototype._getFieldAlias=function(a,b){var c="popupTemplate"in b&&b.popupTemplate,c=c&&c.fieldInfos,d=null;c&&c.some(function(b){return a===b.fieldName?(d=b,!0):!1});c=null;"getField"in b&&b.getField?c=b.getField(a):"fieldsIndex"in b&&b.fieldsIndex&&(c=b.fieldsIndex.get(a));b=d||c;var e=null;b&&(e=d&&d.label||c&&c.alias||"name"in
b&&b.name||"fieldName"in b&&b.fieldName);return e};g.prototype._isUnclassedRenderer=function(a){var b=a.visualVariables,c=!1;K(a)&&a.classBreakInfos&&1===a.classBreakInfos.length&&b&&(c=a.field?b.some(function(b){return!(!b||a.field!==b.field||(a.normalizationField||b.normalizationField)&&a.normalizationField!==b.normalizationField)}):!!b.length);return c};e.__decorate([m.property()],g.prototype,"children",void 0);e.__decorate([m.property()],g.prototype,"layerView",void 0);e.__decorate([m.property()],
g.prototype,"layer",void 0);e.__decorate([m.property()],g.prototype,"legendElements",void 0);e.__decorate([m.property()],g.prototype,"parent",void 0);e.__decorate([m.property({readOnly:!0})],g.prototype,"ready",null);e.__decorate([m.property()],g.prototype,"keepCacheOnDestroy",void 0);e.__decorate([m.property()],g.prototype,"respectLayerVisibility",void 0);e.__decorate([m.property({dependsOn:["view.scale"],readOnly:!0})],g.prototype,"scale",null);e.__decorate([m.property()],g.prototype,"sublayerIds",
void 0);e.__decorate([m.property({dependsOn:["layer.renderer?.valueExpression?","layer.renderer?.visualVariables?","layer.featureReduction?","scale"],readOnly:!0})],g.prototype,"isScaleDriven",null);e.__decorate([m.property()],g.prototype,"title",void 0);e.__decorate([m.property({dependsOn:["ready"],readOnly:!0,value:0})],g.prototype,"version",null);e.__decorate([m.property()],g.prototype,"view",void 0);return g=e.__decorate([m.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],g)}(ka)});