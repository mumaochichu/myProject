// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../request ./featureSetCollection ./featureset/sources/FeatureLayerDynamic ./featureset/sources/FeatureLayerMemory ./featureset/sources/FeatureLayerRelated ./featureset/support/cache ./featureset/support/shared ../core/promiseUtils ../core/sql/WhereClause ../layers/FeatureLayer ../portal/Portal ../portal/PortalItem ./featureset/actions/OrderBy ./featureset/actions/Top ./featureset/actions/SpatialFilter ./featureset/actions/AttributeFilter ./featureset/actions/GroupBy".split(" "),
function(O,q,t,v,y,D,E,F,g,z,p,G,r,H,I){function w(d,b){if(g.applicationCache){var c=g.applicationCache.getLayerInfo(d);if(c)return c.then(function(a){return p.resolve(new r({url:d,outFields:b,sourceJSON:a}))});var e=new r({url:d,outFields:b}),c=p.create(function(a,c){e.load().then(function(){a(e.sourceJSON)},function(a){c(a)})});g.applicationCache&&(g.applicationCache.setLayerInfo(d,c),c=c.catch(function(a){g.applicationCache.clearLayerInfo(d);throw a;}));return c.then(function(){return p.resolve(e)})}return p.resolve(new r({url:d,
outFields:b}))}function x(d,b,c,e,a){return w(d,["*"]).then(function(d){return p.resolve(u(d,b,c,e,a))})}function u(d,b,c,e,a){void 0===b&&(b=null);void 0===c&&(c=null);void 0===e&&(e=!0);void 0===a&&(a=null);return!0===d._hasMemorySource()?new E({layer:d,spatialReference:b,outFields:c,includeGeometry:e,lrucache:a}):new D({layer:d,spatialReference:b,outFields:c,includeGeometry:e,lrucache:a})}function J(d){if(null!==g.applicationCache){var b=g.applicationCache.getLayerInfo(d);if(null!==b)return b}b=
v(d,{responseType:"json",query:{f:"json"}}).then(function(c){return c.data?p.resolve(c.data):p.resolve(null)});null!==g.applicationCache&&(g.applicationCache.setLayerInfo(d,b),b=b.catch(function(c){g.applicationCache.clearLayerInfo(d);throw c;}));return b}function K(d,b){var c="QUERYDATAELEMTS:"+b.toString()+":"+d;if(null!==g.applicationCache){var e=g.applicationCache.getLayerInfo(c);if(null!==e)return e}d=v(d+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([b.toString()]),
f:"json"}}).then(function(a){if(a.data&&(a=a.data,a.layerDataElements&&a.layerDataElements[0]))return a.layerDataElements[0];throw Error("Not Found");});null!==g.applicationCache&&(g.applicationCache.setLayerInfo(c,d),d=d.catch(function(a){g.applicationCache.clearLayerInfo(c);throw a;}));return d}function B(d){if(null!==g.applicationCache){var b=g.applicationCache.getLayerInfo(d);if(null!==b)return b}b=v(d,{responseType:"json",query:{f:"json"}}).then(function(c){return c.data?(c=c.data,c.layers||
(c.layers=[]),c.tables||(c.tables=[]),p.resolve(c)):p.resolve({layers:[],tables:[]})});null!==g.applicationCache&&(g.applicationCache.setLayerInfo(d,b),b=b.catch(function(c){g.applicationCache.clearLayerInfo(d);throw c;}));return b}Object.defineProperty(q,"__esModule",{value:!0});q.initialiseMetaDataCache=function(){null===g.applicationCache&&(g.applicationCache=new g)};q.constructFeatureSetFromUrl=x;q.constructFeatureSet=u;q.constructAssociationMetaDataFeatureSetFromUrl=function(d,b){var c=3,e=[],
a=null,n={},g=null;return B(d).then(function(f){if(f.controllerDatasetLayers&&void 0!==f.controllerDatasetLayers.utilityNetworkLayerId&&null!==f.controllerDatasetLayers.utilityNetworkLayerId){if(f.layers)for(var k=0,h=f.layers;k<h.length;k++){var l=h[k];n[l.id]=l.name}if(f.tables)for(k=0,h=f.tables;k<h.length;k++)l=h[k],n[l.id]=l.name;var A=f.controllerDatasetLayers.utilityNetworkLayerId;return K(d,A).then(function(h){if(h){(a=h)&&a.dataElement&&void 0!==a.dataElement.schemaGeneration&&(c=a.dataElement.schemaGeneration);
g={};a.dataElement.domainNetworks||(a.dataElement.domainNetworks=[]);h=0;for(var f=a.dataElement.domainNetworks;h<f.length;h++){for(var l=f[h],k=0,C=l.edgeSources?l.edgeSources:[];k<C.length;k++){var m=C[k],m={layerId:m.layerId,sourceId:m.sourceId,className:n[m.layerId]?n[m.layerId]:null};m.className&&(g[m.className]=m)}k=0;for(l=l.junctionSources?l.junctionSources:[];k<l.length;k++)m=l[k],m={layerId:m.layerId,sourceId:m.sourceId,className:n[m.layerId]?n[m.layerId]:null},m.className&&(g[m.className]=
m)}if(a.dataElement.terminalConfigurations)for(h=0,f=a.dataElement.terminalConfigurations;h<f.length;h++)for(l=0,m=f[h].terminals;l<m.length;l++)k=m[l],e.push({terminalId:k.terminalId,terminalName:k.terminalName});return J(d+"/"+A).then(function(a){if(a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&null!==a.systemLayers.associationsTableId){var h=[];4<=c&&(h.push("STATUS"),h.push("PERCENTALONG"));return x(d+"/"+a.systemLayers.associationsTableId.toString(),b,t.__spreadArrays("OBJECTID FROMNETWORKSOURCEID TONETWORKSOURCEID FROMGLOBALID TOGLOBALID TOTERMINALID FROMTERMINALID ASSOCIATIONTYPE ISCONTENTVISIBLE GLOBALID".split(" "),
h),!1,null).then(function(a){return a.load()}).then(function(a){return 4<=c?(a=a.filter(G.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",a.getFieldsIndex())),a.load()):a}).then(function(a){return{lkp:g,associations:a,unVersion:c,terminals:e}})}return{associations:null,unVersion:c,lkp:null,terminals:[]}})}return{associations:null,
unVersion:c,lkp:null,terminals:[]}})}return{associations:null,unVersion:c,lkp:null,terminals:[]}})};q.constructFeatureSetFromRelationship=function(d,b,c,e,a,n,g){void 0===e&&(e=null);void 0===a&&(a=null);void 0===n&&(n=!0);void 0===g&&(g=null);var f=d.serviceUrl();if(!f)return null;f="/"===f.charAt(f.length-1)?f+b.relatedTableId.toString():f+"/"+b.relatedTableId.toString();return x(f,e,a,n,g).then(function(f){return new F({layer:d,relatedLayer:f,relationship:b,objectId:c,spatialReference:e,outFields:a,
includeGeometry:n,lrucache:g})})};var M=function(d){function b(c,e,a){void 0===e&&(e=null);void 0===a&&(a=null);var b=d.call(this)||this;b._map=c;b._overridespref=e;b.lrucache=a;b._instantLayers=[];return b}t.__extends(b,d);b.prototype.makeAndAddFeatureSet=function(c,e,a){void 0===e&&(e=!0);void 0===a&&(a=null);var b=u(c,this._overridespref,null===a?["*"]:a,e,this.lrucache);this._instantLayers.push({featureset:b,opitem:c,includeGeometry:e,outFields:JSON.stringify(a)});return b};b.prototype.featureSetByName=
function(c,b,a){var e=this;void 0===b&&(b=!0);void 0===a&&(a=null);if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(function(){try{return e.featureSetByName(c,b,a)}catch(l){return p.reject(l)}});null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var d=JSON.stringify(a),f=0;f<this._instantLayers.length;f++){var k=this._instantLayers[f];if(k.opitem.title===c&&k.includeGeometry===b&&k.outFields===d)return this.resolvePromise(this._instantLayers[f].featureset)}if(d=
this._map.layers.find(function(a){return a instanceof r&&a.title===c?!0:!1}))return this.resolvePromise(this.makeAndAddFeatureSet(d,b,a));if(this._map.tables){var h=this._map.tables.find(function(a){return a.title&&a.title===c||a.title&&a.title===c?!0:!1});if(h)return h._materializedTable||(d=h.outFields?h:t.__assign(t.__assign({},h),{outFields:["*"]}),h._materializedTable=new r(d)),h._materializedTable.load().then(function(){return e.resolvePromise(e.makeAndAddFeatureSet(h._materializedTable,b,a))})}return this.resolvePromise(null)};
b.prototype.featureSetById=function(c,b,a){var d=this;void 0===b&&(b=!0);void 0===a&&(a=["*"]);if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(function(){try{return d.featureSetById(c,b,a)}catch(l){return p.reject(l)}});null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var e=JSON.stringify(a),f=0;f<this._instantLayers.length;f++){var k=this._instantLayers[f];if(k.opitem.id===c&&k.includeGeometry===b&&k.outFields===e)return this.resolvePromise(this._instantLayers[f].featureset)}if(e=
this._map.layers.find(function(a){return a instanceof r&&a.id===c?!0:!1}))return this.resolvePromise(this.makeAndAddFeatureSet(e,b,a));if(this._map.tables){var h=this._map.tables.find(function(a){return a.id===c?!0:!1});if(h)return h._materializedTable||(e=t.__assign(t.__assign({},h),{outFields:["*"]}),h._materializedTable=new r(e)),h._materializedTable.load().then(function(){return d.resolvePromise(d.makeAndAddFeatureSet(h._materializedTable,b,a))})}return this.resolvePromise(null)};return b}(y),
N=function(d){function b(c,b,a){void 0===b&&(b=null);void 0===a&&(a=null);var e=d.call(this)||this;e._url=c;e._overridespref=b;e.lrucache=a;e.metadata=null;e._instantLayers=[];return e}t.__extends(b,d);Object.defineProperty(b.prototype,"url",{get:function(){return this._url},enumerable:!0,configurable:!0});b.prototype.makeAndAddFeatureSet=function(c,b,a){void 0===b&&(b=!0);void 0===a&&(a=null);var d=u(c,this._overridespref,null===a?["*"]:a,b,this.lrucache);this._instantLayers.push({featureset:d,opitem:c,
includeGeometry:b,outFields:JSON.stringify(a)});return d};b.prototype._loadMetaData=function(){var b=this;return B(this._url).then(function(c){return b.metadata=c})};b.prototype.load=function(){return this._loadMetaData()};b.prototype.clone=function(){return new b(this._url,this._overridespref,this.lrucache)};b.prototype.featureSetByName=function(b,d,a){var c=this;void 0===d&&(d=!0);void 0===a&&(a=null);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var e=JSON.stringify(a),f=0;f<this._instantLayers.length;f++){var k=
this._instantLayers[f];if(k.opitem.title===b&&k.includeGeometry===d&&k.outFields===e)return this.resolvePromise(this._instantLayers[f].featureset)}return this._loadMetaData().then(function(e){for(var h=null,f=0,k=e.layers?e.layers:[];f<k.length;f++){var g=k[f];g.name===b&&(h=g)}if(!h)for(f=0,e=e.tables?e.tables:[];f<e.length;f++)g=e[f],g.name===b&&(h=g);return h?w(c._url+"/"+h.id,["*"]).then(function(b){return c.makeAndAddFeatureSet(b,d,a)}):c.resolvePromise(null)})};b.prototype.featureSetById=function(b,
d,a){var c=this;void 0===d&&(d=!0);void 0===a&&(a=["*"]);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();var e=JSON.stringify(a);b=null!==b&&void 0!==b?b.toString():"";for(var f=0;f<this._instantLayers.length;f++){var g=this._instantLayers[f];if(g.opitem.id===b&&g.includeGeometry===d&&g.outFields===e)return this.resolvePromise(this._instantLayers[f].featureset)}return this._loadMetaData().then(function(e){for(var f=null,g=0,h=e.layers?e.layers:[];g<h.length;g++){var k=h[g];null!==k.id&&void 0!==k.id&&
k.id.toString()===b&&(f=k)}if(!f)for(g=0,e=e.tables?e.tables:[];g<e.length;g++)k=e[g],null!==k.id&&void 0!==k.id&&k.id.toString()===b&&(f=k);return f?w(c._url+"/"+f.id,["*"]).then(function(b){return c.makeAndAddFeatureSet(b,d,a)}):c.resolvePromise(null)})};return b}(y);q.createFeatureSetCollectionFromMap=function(d,b,c){void 0===c&&(c=null);return new M(d,b,c)};q.createFeatureSetCollectionFromService=function(d,b,c){void 0===c&&(c=null);return new N(d,b,c)};q.getPortal=function(d,b){return null===
d?b:new H({url:d.field("url")})};q.constructFeatureSetFromPortalItem=function(d,b,c,e,a,n,q){if(g.applicationCache){var f=g.applicationCache.getLayerInfo(d+":"+n.url);if(f)return f.then(function(d){try{var f=new r({url:z.extractServiceUrl(d.url)+"/"+b,outFields:["*"]});return p.resolve(u(f,c,e,a,q))}catch(l){return p.reject(l)}},function(a){return p.reject(a)})}return p.create(function(f,h){var k=(new I({id:d,portal:n})).load();g.applicationCache&&g.applicationCache.setLayerInfo(d+":"+n.url,k);k.then(function(d){try{var g=
new r({url:z.extractServiceUrl(d.url)+"/"+b,outFields:["*"]});f(u(g,c,e,a,q))}catch(L){h(L)}},function(a){g.applicationCache&&g.applicationCache.clearLayerInfo(d+":"+n.url);h(a)})})}});