// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../core/arrayUtils ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../../../layers/support/arcgisLayerUrl ../../../layers/support/fieldUtils ../../statistics/support/predominanceUtils ../../statistics/support/utils ../utils ./LayerAdapter ./support/utils ../../../tasks/GenerateRendererTask ../../../tasks/support/GenerateRendererParameters ../../../tasks/support/QuantizationParameters ../../../tasks/support/StatisticDefinition ../../../tasks/support/UniqueValueDefinition".split(" "),
function(S,T,q,K,E,u,L,p,F,G,H,I,M,y,B,t,N,O,m,P,C,Q,D,R){return function(J){function e(a){return J.call(this,a)||this}q.__extends(e,J);e.prototype.destroy=function(){this._hasLocalSource=null};e.prototype._isStatsSupportedOnService=function(){var a=this.layer;return!a.get("capabilities.query.supportsStatistics")||"multipatch"===this.geometryType&&!M.isHostedAgolService(a.url)&&10.5>a.version?p.reject(new u("feature-layer-adapter:not-supported","Layer does not support statistics query")):p.resolve()};
e.prototype._fetchFeaturesFromMemory=function(a,c,b){return q.__awaiter(this,void 0,void 0,function(){var d,g,f,h;return q.__generator(this,function(k){switch(k.label){case 0:return d=this.layer,this._hasLocalSource?[4,d.queryFeatures(c)]:[3,2];case 1:return g=k.sent(),[2,g.features];case 2:if(!a)throw new u("feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView");return[4,a.whenLayerView(d)];case 3:return f=k.sent(),[4,F.whenFalseOnce(f,"updating")];case 4:return k.sent(),
[4,f.queryFeatures(c,{signal:b})];case 5:return h=k.sent(),[2,h.features]}})})};e.prototype._fetchFeaturesFromService=function(a,c){return this.layer.queryFeatures(a,{signal:c}).then(function(a){return a&&a.features})};e.prototype._fetchFeaturesForStats=function(a){var c=this;return N.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}).then(function(b){return c.getSampleFeatures({sampleSize:-1,view:a.view,returnGeometry:a.returnGeometry,requiredFields:b,
signal:a.signal})})};e.prototype._hasRequiredFieldsInView=function(a,c){return q.__awaiter(this,void 0,void 0,function(){var b,d,g=this;return q.__generator(this,function(f){switch(f.label){case 0:return[4,c.whenLayerView(this.layer)];case 1:return b=f.sent(),[4,F.whenFalseOnce(b,"updating")];case 2:return f.sent(),d=!0,a&&a.length&&(d=a.every(function(a){a=g.getField(a);return-1<b.availableFields.indexOf(a.name)})),[2,d]}})})};e.prototype._summaryStatsFromGenRend=function(a){var c=a.normalizationType,
b=a.normalizationField;return this.classBreaks({field:a.field,numClasses:5,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:c,normalizationField:"field"===c?b:void 0,minValue:a.minValue,maxValue:a.maxValue,signal:a.signal}).then(function(a){var b,c,d;a.classBreakInfos.some(function(a){a.hasAvg&&(b=a);return!!b});b&&(d=b.maxValue-b.minValue,c=b.minValue+d/2,d*=4);return m.processSummaryStatisticsResult({min:a.minValue,max:a.maxValue,avg:c,stddev:d})})};e.prototype._getSummaryStatsQuery=
function(a,c){var b=a.field,d=a.normalizationType,g=a.normalizationField,f=a.normalizationTotal;c=this.supportsSQLExpression&&c?m.msSinceUnixEpochSQL(this,b):a.sqlExpression;var f=m.getFieldExpr({field:b,normalizationType:d,normalizationField:g,normalizationTotal:f,layer:this}),h=c||f,f=h?t.getRangeExpr(h,a.minValue,a.maxValue):null,b=t.getSQLFilterForNormalization({field:b,normalizationField:g,normalizationType:d});a=t.mergeWhereClauses(a.sqlWhere,b);a=t.mergeWhereClauses(a,f);b=this.layer.createQuery();
b.where=t.mergeWhereClauses(b.where,a);b.sqlFormat=c?"standard":null;b.outStatistics=m.statisticTypes.map(function(a){var b=new D;b.statisticType="variance"===a?"var":a;b.onStatisticField=h;b.outStatisticFieldName=a+"_value";return b});return b};e.prototype._summaryStatsFromServiceQuery=function(a,c){return q.__awaiter(this,void 0,void 0,function(){var b,d,g,f;return q.__generator(this,function(h){switch(h.label){case 0:return[4,this._isStatsSupportedOnService()];case 1:h.sent();if("percent-of-total"!==
a.normalizationType)return[3,3];b=a;return[4,this._getNormalizationTotal(a.field,a.normalizationType)];case 2:b.normalizationTotal=h.sent(),h.label=3;case 3:return d=this._getSummaryStatsQuery(a,c),[4,this.layer.queryFeatures(d,{signal:a.signal})];case 4:return g=h.sent(),f=m.getSummaryStatisticsFromFeatureSet(g,c),[2,m.processSummaryStatisticsResult(f)]}})})};e.prototype._summaryStatsFromClientQuery=function(a,c){return q.__awaiter(this,void 0,void 0,function(){var b,d,g;return q.__generator(this,
function(f){switch(f.label){case 0:return b=this._getSummaryStatsQuery(a,c),[4,this.layer.queryFeatures(b,{signal:a.signal})];case 1:return d=f.sent(),g=m.getSummaryStatisticsFromFeatureSet(d,c),[2,m.processSummaryStatisticsResult(g)]}})})};e.prototype._summaryStatsFromMemory=function(a,c){return q.__awaiter(this,void 0,void 0,function(){var b,d,g,f,h,k,l,w,e,v,r;return q.__generator(this,function(n){switch(n.label){case 0:return b=a.field,d=a.valueExpression,g=a.view,f={field:b,valueExpression:d,
normalizationField:a.normalizationField,view:g,signal:a.signal},(k=a.features)?[3,2]:[4,this._fetchFeaturesForStats(f)];case 1:k=n.sent(),n.label=2;case 2:l=(h=k)&&h.length;if(!l)throw new u("feature-layer-adapter:insufficient-data","No features are available to calculate statistics");w=q.__assign({},a);return"percent-of-total"!==w.normalizationType?[3,4]:[4,m.calculateStatsFromMemory({field:b},h)];case 3:e=n.sent();v=e.sum;if(null==v)throw new u("feature-layer-adapter:invalid","invalid normalizationTotal");
w.normalizationTotal=v;n.label=4;case 4:return[4,m.calculateStatsFromMemory(w,h,c)];case 5:return r=n.sent(),[2,m.processSummaryStatisticsResult(r)]}})})};e.prototype._uvFromGenRenderer=function(a,c){var b=this,d=a.field,g=new R;g.attributeField=d;var f=new C;f.classificationDefinition=g;return this.generateRenderer(f,a.signal).then(function(a){var c={},g=b.getField(d);a.uniqueValues.forEach(function(a){var b=a.value;if(null==b||""===b||"string"===typeof b&&(""===b.trim()||"\x3cnull\x3e"===b.toLowerCase()))b=
null;null==c[b]?c[b]={count:a.count,data:y.isNumericField(g)&&b?Number(b):b}:c[b].count+=a.count});return{count:c}}).then(function(b){return m.createUVResult(b,c,a.returnAllCodedValues)})};e.prototype._getUVQuery=function(a){var c=a.field,b=a.sqlExpression,d="countOF"+(c||"Expr"),g=new D;g.statisticType="count";g.onStatisticField=b?"1":c;g.outStatisticFieldName=d;d=this.layer.createQuery();d.where=t.mergeWhereClauses(d.where,a.sqlWhere);d.sqlFormat=b?"standard":null;d.outStatistics=[g];d.groupByFieldsForStatistics=
[c||b];return d};e.prototype._uvFromServiceQuery=function(a,c){var b=this;return this._isStatsSupportedOnService().then(function(){return b.layer.queryFeatures(b._getUVQuery(a),{signal:a.signal})}).then(function(c){return m.getUniqueValuesFromFeatureSet(c,b,a.field,null,a.signal)}).then(function(b){return m.createUVResult(b,c,a.returnAllCodedValues)})};e.prototype._uvFromClientQuery=function(a,c){return q.__awaiter(this,void 0,void 0,function(){var b,d,g,f;return q.__generator(this,function(h){switch(h.label){case 0:return b=
a.signal,d=this._getUVQuery(a),[4,this.layer.queryFeatures(d,{signal:b})];case 1:return g=h.sent(),[4,m.getUniqueValuesFromFeatureSet(g,this,a.field,null,b)];case 2:return f=h.sent(),[2,m.createUVResult(f,c,a.returnAllCodedValues)]}})})};e.prototype._uvFromMemory=function(a,c){return q.__awaiter(this,void 0,void 0,function(){var b,d,g,f,h,k,l;return q.__generator(this,function(e){switch(e.label){case 0:b=a.field;d=a.valueExpression;g=a.view;f=a.signal;h={field:b,valueExpression:d,view:g,signal:f};
if(!a.features)return[3,1];l=a.features;return[3,3];case 1:return[4,this._fetchFeaturesForStats(h)];case 2:l=e.sent(),e.label=3;case 3:return k=l,[2,m.calculateUniqueValuesFromMemory(a,k,c)]}})})};e.prototype._calcBinsSQL=function(a,c){var b=[],d=c.length;c.forEach(function(c,f){c=t.mergeWhereClauses(a+" \x3e\x3d "+c[0],a+(f===d-1?" \x3c\x3d ":" \x3c ")+c[1]);b.push("WHEN ("+c+") THEN "+(f+1))});return["CASE",b.join(" "),"ELSE 0 END"].join(" ")};e.prototype._getNormalizationTotal=function(a,c,b){return a&&
"percent-of-total"===c?this.summaryStatistics({field:a,signal:b}).then(function(a){return a.sum}):p.resolve(null)};e.prototype._getQueryParamsForExpr=function(a,c){var b=a.signal;if(!a.valueExpression&&!a.sqlExpression){var d=a.field,g=d?this.getField(d):null,g=y.isDateField(g);c={field:d,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:c,layer:this};return{sqlExpression:g?m.msSinceUnixEpochSQL(this,d):m.getFieldExpr(c),sqlWhere:g?null:a.sqlWhere||t.getSQLFilterForNormalization(a),
signal:b}}return{valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,signal:b}};e.prototype._getDataRange=function(a,c,b){return null!=c&&null!=b?p.resolve({min:c,max:b}):this.summaryStatistics(a).then(function(a){return{min:a.min,max:a.max}})};e.prototype._histogramForExpr=function(a){var c=this;return this._getNormalizationTotal(a.field,a.normalizationType,a.signal).then(function(b){var d=c._getQueryParamsForExpr(a,b);return c._getDataRange(d,a.minValue,a.maxValue).then(function(g){var f=
g.min,h=g.max,k=a.numBins||10;g=m.getEqualIntervalBins(f,h,k);g=c._calcBinsSQL(d.sqlExpression,g);var l=new D({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"1"}),e=c.layer.createQuery();e.where=t.mergeWhereClauses(e.where,d.sqlWhere);e.sqlFormat="standard";e.outStatistics=[l];e.groupByFieldsForStatistics=[g];e.orderByFields=[g];return c._isStatsSupportedOnService().then(function(){return c.layer.queryFeatures(e,{signal:d.signal})}).then(function(a){return m.getHistogramFromFeatureSet(a,
f,h,k,b)})})})};e.prototype._histogramForField=function(a){var c=this,b=null,b=null!=a.minValue&&null!=a.maxValue?p.resolve({min:a.minValue,max:a.maxValue}):this.summaryStatistics(a).then(function(a){if(!a.count)throw new u("feature-layer-adapter:insufficient-data","Either the layer has no features or none of the features have data for the field");return{min:a.min,max:a.max}});return b.then(function(b){return c._getBins({min:b.min,max:b.max},a.field,a.numBins,a.signal)})};e.prototype._getBins=function(a,
c,b,d){void 0===b&&(b=10);var g=a.min,f=a.max,h=a.normTotal,k=a.excludeZerosExpr,e=a.intervals||m.getEqualIntervalBins(g,f,b);return this._queryBins(e,a.sqlExpr||c,k,d).then(function(a){return{bins:a.map(function(a,b){return{minValue:e[b][0],maxValue:e[b][1],count:a.value}}),minValue:g,maxValue:f,normalizationTotal:h}})};e.prototype._queryBins=function(a,c,b,d){for(var g=this,f=[],h=a.length,e=0;e<h;e++){var l=t.mergeWhereClauses(b,t.mergeWhereClauses(c+" \x3e\x3d "+a[e][0],null!==a[e][1]?c+(e===
h-1?" \x3c\x3d ":" \x3c ")+a[e][1]:""));f.push(l)}return p.eachAlways(f.map(function(a){return g.queryFeatureCount(a,d)}))};e.prototype._binParamsFromGenRend=function(a,c){var b=this,d=a.field,g=a.normalizationType,f=a.normalizationField,h=a.signal,e=t.getSQLFilterForNormalization({field:d,normalizationType:g,normalizationField:f});a=new C({classificationDefinition:m.createCBDefn({field:d,normalizationType:g,normalizationField:f,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,
breakCount:a.numBins||10}),where:t.mergeWhereClauses(e,c)});return this.generateRenderer(a,h).then(function(a){return m.generateBinParams({field:d,normalizationType:g,normalizationField:f,normalizationTotal:a.normalizationTotal,classBreaks:a.classBreaks,where:e,layer:b})})};e.prototype._histogramFromMemory=function(a){var c=this,b=a.field,d=a.normalizationType,g=a.valueExpression,f=a.classificationMethod,h=a.minValue,e=a.maxValue,l=a.view,w=a.signal,n={field:b,valueExpression:g,normalizationField:a.normalizationField,
view:l,signal:w};return(a.features?p.resolve(a.features):this._fetchFeaturesForStats(n)).then(function(k){if(!k||!k.length)throw new u("feature-layer-adapter:insufficient-data","No features are available to calculate histogram");var r=null!=h&&null!=e,n=null;f&&"equal-interval"!==f||d?(r=q.__assign({},a),r.features=k,n=c._getBinParamsFromMemory(r)):n=r?p.resolve({min:h,max:e,source:"parameters"}):c.summaryStatistics({field:b,valueExpression:g,features:k,view:l,signal:w}).then(function(a){return a.count?
{min:a.min,max:a.max}:p.reject(new u("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});return n.then(function(b){return m.calculateHistogramFromMemory(a,b,k)})})};e.prototype._getBinParamsFromMemory=function(a){return q.__awaiter(this,void 0,void 0,function(){var c,b,d,g,f,h,e,l,w,n,v,r=this;return q.__generator(this,function(k){c=a.field;b=a.valueExpression;d=a.classificationMethod;g=a.standardDeviationInterval;f=a.normalizationType;h=a.normalizationField;
e=a.minValue;l=a.maxValue;w=a.features;n=a.view;v=a.signal;return[2,this._classBreaksFromMemory({field:c,valueExpression:b,normalizationType:f,normalizationField:h,classificationMethod:d,standardDeviationInterval:g,minValue:e,maxValue:l,numClasses:a.numBins,features:w,view:n,signal:v}).then(function(a){var b=a.normalizationTotal;a=a.classBreakInfos;var d=t.getSQLFilterForNormalization({field:c,normalizationType:f,normalizationField:h});return m.generateBinParams({field:c,normalizationType:f,normalizationField:h,
normalizationTotal:b,classBreaks:a,where:d,layer:r})})]})})};e.prototype._classBreaksFromGenRend=function(a){var c=a.field,b=a.normalizationType,d=a.normalizationField,g=a.normalizationTotal,f=a.signal,h=t.getSQLFilterForNormalization({field:c,normalizationType:b,normalizationField:d}),g=m.getFieldExpr({field:c,normalizationType:b,normalizationField:d,normalizationTotal:g,layer:this}),g=t.getRangeExpr(g,a.minValue,a.maxValue),c=m.createCBDefn({field:c,normalizationType:b,normalizationField:d,classificationMethod:a.classificationMethod,
standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5}),b=new C;b.classificationDefinition=c;b.where=t.mergeWhereClauses(h,g);return this.generateRenderer(b,f).then(function(b){return m.resolveCBResult(a,b)})};e.prototype._classBreaksFromInterpolation=function(a){for(var c=a.minValue,b=a.maxValue,d=a.numClasses||5,g=[],f=(b-c)/d,h=0;h<d;h++){var e=c+h*f;g.push({minValue:e,maxValue:e+f})}g[d-1].maxValue=b;a=m.resolveCBResult(a,{classBreaks:g,normalizationTotal:a.normalizationTotal});
return p.resolve(a)};e.prototype._classBreaksFromMemory=function(a){return q.__awaiter(this,void 0,void 0,function(){var c,b,d,g,f,h,e,l,w,n,v,r;return q.__generator(this,function(k){switch(k.label){case 0:return c=a.field,b=a.normalizationField,d=a.valueExpression,g=a.view,f=a.signal,h={field:c,valueExpression:d,normalizationField:b,view:g,signal:f},(l=a.features)?[3,2]:[4,this._fetchFeaturesForStats(h)];case 1:l=k.sent(),k.label=2;case 2:w=(e=l)&&e.length;if(!w)throw new u("feature-layer-adapter:insufficient-data",
"No features are available to calculate statistics");n=q.__assign({},a);return"percent-of-total"!==n.normalizationType?[3,4]:[4,m.calculateStatsFromMemory({field:c},e)];case 3:v=k.sent();r=v.sum;if(null==r)throw new u("feature-layer-adapter:invalid","invalid normalizationTotal");n.normalizationTotal=r;k.label=4;case 4:return[2,m.calculateClassBreaksFromMemory(n,e)]}})})};e.prototype._heatmapStatsFromMemory=function(a,c){return q.__awaiter(this,void 0,void 0,function(){var b,d,g,f,e,k,l,w,n,v,r,p;
return q.__generator(this,function(h){switch(h.label){case 0:return b=a.blurRadius,d=a.field,g=a.view,f=a.signal,e=g.state,k=e.resolution,l=e.size,w=new Q.default({extent:g.extent,tolerance:k}),v=this._quantizeFeatures,(r=a.features)?[3,2]:[4,this._fetchFeaturesForStats({field:d,view:g,returnGeometry:!0,signal:f})];case 1:r=h.sent(),h.label=2;case 2:n=v.apply(this,[r,w,g]);if(!n||!n.length)return[2,{count:0,min:null,max:null,avg:null,stddev:null}];if(p=m.calculateHeatmapStats(n,b,c,d,l[0],l[1]))return[2,
{count:p.count,min:p.min,max:p.max,avg:p.mean,stddev:p.stdDev}];throw new u("feature-layer-adapter:invalid","unable to calculate heatmap statistics");}})})};e.prototype._quantizeFeatures=function(a,c,b){var d=this,g=H.toQuantizationTransform(c);c=b.spatialReference;var f=b.size,e=I.isWrappable(c);b=I.getInfo(c);var k=Math.round((b.valid[1]-b.valid[0])/g.scale[0]);return a.map(function(a){var b=new K.Point(L.unwrap(a.geometry));H.quantizePoint(g,b,b,b.hasZ,b.hasM);a.geometry=e?d._wrapPoint(b,k,f[0]):
b;return a})};e.prototype._wrapPoint=function(a,c,b){0>a.x?a.x+=c:a.x>b&&(a.x-=c);return a};e.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};e.prototype.getFieldUsageInfo=function(a){return this.getField(a)?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:null};e.prototype.getFieldDomain=function(a,c){return this.layer.getFieldDomain(a,c)};e.prototype.summaryStatistics=function(a){var c=this,b=a.field,
b=b?this.getField(b):null,d=y.isDateField(b),e=(b=a.valueExpression||a.sqlExpression)&&!a.sqlExpression,f=a.view,f=f&&"3d"===f.type;return this._hasLocalSource||a.features||e?e||a.features||f?this._summaryStatsFromMemory(a,d):this._summaryStatsFromClientQuery(a,d):this.supportsSQLExpression||!d&&!b?(a.normalizationType&&!this.supportsSQLExpression?this._summaryStatsFromGenRend(a):this._summaryStatsFromServiceQuery(a,d)).catch(function(){p.throwIfAborted(a.signal);return c._summaryStatsFromMemory(a,
d)}):p.reject(new u("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries"))};e.prototype.uniqueValues=function(a){var c=this,b=a.field,d=a.valueExpression,e=a.sqlExpression,f=a.signal,h=(b?this.getField(b):null)&&this.getFieldDomain(b),k=d&&(!e||!this.supportsSQLExpression),l=(b=a.view)&&"3d"===b.type;return this._hasLocalSource||a.features||k?k||a.features||l?this._uvFromMemory(a,h):this._uvFromClientQuery(a,h):this._uvFromServiceQuery(a,h).catch(function(b){p.throwIfAborted(f);
return a.field?c._uvFromGenRenderer(a,h):b}).catch(function(){p.throwIfAborted(f);return k||a.features||l?c._uvFromMemory(a,h):c._uvFromClientQuery(a,h)})};e.prototype.histogram=function(a){var c=this,b=a.field,d=a.normalizationType,e=a.normalizationField,f=a.classificationMethod,h=a.signal,k=b?this.getField(b):null,k=y.isDateField(k),l=a.valueExpression||a.sqlExpression,q=l&&!a.sqlExpression,n=this.supportsSQLExpression,v=!f||"equal-interval"===f,r=a.minValue,A=a.maxValue,x=null!=r&&null!=A,z=a.numBins||
10;return this._hasLocalSource||a.features||q?this._histogramFromMemory(a):(l||n)&&v?l&&!n?p.reject(new u("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries")):this._histogramForExpr(a):k&&v?p.reject(new u("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):d||!v?this._binParamsFromGenRend(a).then(function(f){if(!x)return c._getBins(f,b,z,h);if(r>
f.max||A<f.min)throw new u("histogram:insufficient-data","Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field");if(v)return c._getBins({min:r,max:A,sqlExpr:f.sqlExpr,excludeZerosExpr:f.excludeZerosExpr},b,z,h);f=m.getFieldExpr({field:b,normalizationType:d,normalizationField:e,normalizationTotal:f.normTotal,layer:c});f=t.getRangeExpr(f,r,A);return c._binParamsFromGenRend(a,f).then(function(a){return c._getBins(a,b,z,h)})}):this._histogramForField(a)};e.prototype.classBreaks=
function(a){var c=this,b=!1!==a.analyzeData,d=this._hasLocalSource||a.features||a.valueExpression;return b&&d?this._classBreaksFromMemory(a):(b?this._classBreaksFromGenRend(a):this._classBreaksFromInterpolation(a)).catch(function(){p.throwIfAborted(a.signal);return c._classBreaksFromMemory(a)})};e.prototype.queryFeatureCount=function(a,c){if(this._hasLocalSource)return p.reject(new u("feature-layer-adapter:not-supported","Layer does not support count query"));var b=this.layer,d=b.createQuery();d.where=
t.mergeWhereClauses(d.where,a);return b.queryFeatureCount(d,{signal:c})};e.prototype.generateRenderer=function(a,c){var b=this.layer;if(this._hasLocalSource||10.1>b.version)return p.reject(new u("feature-layer-adapter:not-supported","Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));var d=new P({url:b.parsedUrl.path,source:b.dynamicDataSource,gdbVersion:b.gdbVersion}),b=b.createQuery();a.where=t.mergeWhereClauses(a.where,b.where);return d.execute(a,{signal:c})};
e.prototype.heatmapStatistics=function(a){var c=this,b=a.field,d=a.fieldOffset,e=a.signal;return(b&&null==d?this.summaryStatistics({field:b,signal:e}):p.resolve(null)).then(function(b){var e=d||0;if(b){var f=b.min,g=b.max;b.count?f===g&&0===f?e=1:0>=g?e="abs":0>f&&(e=-1.01*f):e=1}return c._heatmapStatsFromMemory(a,e).then(function(a){return q.__assign(q.__assign({},a),{summaryStatistics:b,fieldOffset:e})})})};e.prototype.predominantCategories=function(a){return q.__awaiter(this,void 0,void 0,function(){var c,
b,d,e,f,h,k,l,m,n,p,r,t,x,z,y;return q.__generator(this,function(g){switch(g.label){case 0:if(!this._hasLocalSource&&!this.supportsSQLExpression)throw new u("feature-layer-adapter:not-supported","Layer does not support advanced SQL expressions and standardized queries");c=a.fields;b=a.view;d=a.signal;e=B.getArcadeForPredominantCategory(c);f=B.getSQLForPredominantCategoryName(c);return b&&this._hasLocalSource?[4,this._uvFromMemory({valueExpression:e,view:b,signal:d})]:[3,2];case 1:return k=g.sent(),
[3,4];case 2:return[4,this._uvFromServiceQuery({sqlExpression:f.expression,valueExpression:e,signal:d})];case 3:k=g.sent(),g.label=4;case 4:h=k;l=h.uniqueValueInfos;m=l.map(function(a){return a.value});n=c.filter(function(a){return-1===m.indexOf(a)});p=0;for(r=n;p<r.length;p++)t=r[p],l.push({value:t,count:0});l.sort(function(a,b){return c.indexOf(a.value)-c.indexOf(b.value)});x=0;for(z=l;x<z.length;x++)y=z[x],y.value===B.noDominantCategoryField&&(y.value=null);return[2,{predominantCategoryInfos:l}]}})})};
e.prototype.getSampleFeatures=function(a){return q.__awaiter(this,void 0,void 0,function(){var c,b,e,g,f,h,k,l,m,n,t,r,u,x;return q.__generator(this,function(d){switch(d.label){case 0:c=a.view,b=a.sampleSize,e=a.requiredFields,g=a.returnGeometry,f=a.signal,h=this.layer.createQuery(),k=1,h.outSpatialReference=a.spatialReference||c&&c.spatialReference,h.returnGeometry=!!g,h.outFields=e,l=[],m=!1,d.label=1;case 1:return d.trys.push([1,5,,6]),[4,this._hasRequiredFieldsInView(e,c)];case 2:return(m=d.sent())?
[4,this._fetchFeaturesFromMemory(c,h,f)]:[3,4];case 3:l=d.sent();if(l.length&&0<b&&b<=l.length)return[2,E.pickRandom(l,b,k)];d.label=4;case 4:return[3,6];case 5:return d.sent(),p.throwIfAborted(f),[3,6];case 6:return d.trys.push([6,10,,11]),this._hasLocalSource?[2,m?l:this._fetchFeaturesFromService(h,f)]:[4,this.queryFeatureCount(null,f)];case 7:n=d.sent();t=this.layer.capabilities.query.maxRecordCount;r=-1===b?n:b;r=t&&r>t?t:r;if(n<=l.length||l.length>=t)return[2,l];u=c.extent.width/c.width/c.scale*
4E5;h.maxAllowableOffset=a.resolution||u;return n<=r?[2,this._fetchFeaturesFromService(h,f)]:2E4>=n?[4,this.layer.queryObjectIds()]:[3,9];case 8:return x=d.sent(),h.objectIds=E.pickRandom(x,r,k),[2,this._fetchFeaturesFromService(h,f)];case 9:return this.layer.get("capabilities.query.supportsPagination")&&(h.num=Math.min(r,2E4)),[2,this._fetchFeaturesFromService(h,f)];case 10:return d.sent(),p.throwIfAborted(f),[2,l];case 11:return[2]}})})};e.prototype.load=function(a){var c=this;a=this.layer.load(a).then(function(a){c.geometryType=
a.geometryType;c.objectIdField=a.objectIdField;c.supportsSQLExpression=a.get("capabilities.query.supportsSqlExpression");c._hasLocalSource=!a.url&&!!a.source;c.hasQueryEngine=c._hasLocalSource;c.minScale=a.minScale;c.maxScale=a.maxScale;c.fullExtent=a.fullExtent});this.addResolvingPromise(a);return p.resolve(this)};q.__decorate([G.property({constructOnly:!0})],e.prototype,"layer",void 0);return e=q.__decorate([G.subclass("esri.smartMapping.support.adapters.FeatureLayerAdapter")],e)}(O)});