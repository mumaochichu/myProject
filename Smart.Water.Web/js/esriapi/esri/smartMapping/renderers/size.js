// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../renderers ../../core/Error ../../core/maybe ../../core/promiseUtils ../../core/screenUtils ../../intl/messages ../../intl/substitute ../../renderers/support/AuthoringInfo ../../renderers/support/AuthoringInfoVisualVariable ../../renderers/support/utils ../../renderers/visualVariables/SizeVariable ../heuristics/ageUnit ../heuristics/outline ../heuristics/sizeRange ./support/utils ../statistics/support/ageUtils ../support/utils ../symbology/size".split(" "),function(ka,
F,f,G,h,A,K,H,L,X,O,Y,Z,P,aa,Q,ba,n,I,k,C){function ca(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,l,q;return f.__generator(this,function(m){switch(m.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new h("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new h("size-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");
a=f.__assign({},b);g=[0,2,1,3];c=k.createLayerAdapter(a.layer,g);a.layer=c;if(!c)throw new h("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+k.getLayerTypeLabels(g).join(", "));"height"===a.axis&&(a.sizeOptimizationEnabled=!1);e=A.isSome(a.signal)?{signal:a.signal}:null;return[4,c.load(e)];case 1:m.sent();d=c.geometryType;if("mesh"===d)throw new h("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");
if(a.worldScale){if("polyline"===d||"polygon"===d)throw new h("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers");if(!a.view||"3d"!==a.view.type)throw new h("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true");}return[4,k.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})];case 2:l=m.sent();if(q=n.verifyBasicFieldValidity(c,
l,"size-visual-variable:invalid-parameters"))throw q;return[2,a]}})})}function da(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,l,q,m;return f.__generator(this,function(r){switch(r.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new h("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new h("size-continuous-renderer:missing-parameters",
"View is required when 'valueExpression' is specified");a=f.__assign({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;g=[0,2,1,3];c=k.createLayerAdapter(a.layer,g);a.layer=c;if(!c)throw new h("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+k.getLayerTypeLabels(g).join(", "));e=A.isSome(a.signal)?{signal:a.signal}:null;return[4,c.load(e)];case 1:r.sent();d=c.geometryType;l=-1<a.symbolType.indexOf("3d");
a.outlineOptimizationEnabled="polygon"===d?a.outlineOptimizationEnabled:!1;if("mesh"===d)throw new h("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(l&&("polyline"===d||"polygon"===d))throw new h("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new h("size-continuous-renderer:invalid-parameters",
"'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,k.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})];case 2:q=r.sent();if(m=n.verifyBasicFieldValidity(c,q,"size-continuous-renderer:invalid-parameters"))throw m;return[2,a]}})})}function ea(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,l,q,m,r;return f.__generator(this,function(p){switch(p.label){case 0:if(!b||
!b.layer||!b.field&&!b.valueExpression)throw new h("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(b.valueExpression&&!b.view)throw new h("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");a=f.__assign({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"equal-interval";
a.normalizationType=k.getNormalizationType(a);g=[0,2,1,3];c=k.createLayerAdapter(a.layer,g);a.layer=c;if(!c)throw new h("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+k.getLayerTypeLabels(g).join(", "));e=null!=a.minValue&&null!=a.maxValue;if(!e&&(null!=a.minValue||null!=a.maxValue))throw new h("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");d=A.isSome(a.signal)?{signal:a.signal}:
null;return[4,c.load(d)];case 1:p.sent();l=c.geometryType;q=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===l?a.outlineOptimizationEnabled:!1;if("mesh"===l)throw new h("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(q&&("polyline"===l||"polygon"===l))throw new h("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&
(!a.view||"3d"!==a.view.type))throw new h("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,k.getFieldsList({field:a.field,normalizationField:a.normalizationField})];case 2:m=p.sent();if(r=n.verifyBasicFieldValidity(c,m,"size-class-breaks-renderer:invalid-parameters"))throw r;return[2,a]}})})}function fa(b){b=f.__assign({},b);delete b.basemap;delete b.sizeScheme;delete b.legendOptions;
delete b.symbolType;delete b.defaultSymbolEnabled;b.analyzeData=!(null!=b.minValue&&null!=b.maxValue);return b}function R(b){b=f.__assign({},b);var a=-1<b.symbolType.indexOf("3d-volumetric");if(b.worldScale=a)b.axis="3d-volumetric-uniform"===b.symbolType?"all":"height";delete b.symbolType;delete b.defaultSymbolEnabled;return b}function ga(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,l,q;return f.__generator(this,function(m){switch(m.label){case 0:if(!(b&&b.layer&&b.view&&b.startTime&&
b.endTime))throw new h("size-age-renderer:missing-parameters","'layer', 'view', 'startTime', 'endTime' parameters are required");a=f.__assign({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;g=[0,2,1,3];c=k.createLayerAdapter(a.layer,g);a.layer=c;if(!c)throw new h("size-age-renderer:invalid-parameters","'layer' must be one of these types: "+k.getLayerTypeLabels(g).join(", "));e=A.isSome(a.signal)?{signal:a.signal}:null;return[4,c.load(e)];
case 1:m.sent();d=c.geometryType;l=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===d?a.outlineOptimizationEnabled:!1;if("mesh"===d)throw new h("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(l&&("polyline"===d||"polygon"===d))throw new h("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new h("size-age-renderer:invalid-parameters",
"'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");if(q=I.verifyDates(c,a.startTime,a.endTime,"size-age-renderer:invalid-parameters"))throw q;if(a.unit&&-1===I.supportedAgeUnits.indexOf(a.unit))throw new h("size-age-renderer:invalid-unit","Supported units are: "+I.supportedAgeUnits.join(", "));return[2,a]}})})}function S(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d;return f.__generator(this,function(l){switch(l.label){case 0:return a=
b.sizeScheme,c=g=null,[4,n.getBasemapInfo(b.basemap,b.view)];case 1:e=l.sent();g=A.isSome(e.basemapId)?e.basemapId:null;c=A.isSome(e.basemapTheme)?e.basemapTheme:null;if(a)return[2,{scheme:C.cloneScheme(a),basemapId:g,basemapTheme:c}];if(d=C.getSchemes({basemap:g,basemapTheme:c,geometryType:b.geometryType,worldScale:b.worldScale,view:b.view}))a=d.primaryScheme,g=d.basemapId,c=d.basemapTheme;return[2,{scheme:a,basemapId:g,basemapTheme:c}]}})})}function T(b,a){var g;switch(a){case "point":case "multipoint":g=
[b.minSize,b.maxSize];break;case "polyline":g=[b.minWidth,b.maxWidth];break;case "polygon":g=[b.marker.minSize,b.marker.maxSize]}return g}function ha(b,a,g,c){return f.__awaiter(this,void 0,void 0,function(){var e,d,l,q,m,r,p,J,E,w,u,t,x,y,v,z,k,B,D,U;return f.__generator(this,function(f){switch(f.label){case 0:return e=c.layer,d=c.field,l="function"===typeof d,m=(q=d&&!l?e.getField(d):null)&&"date"===q.type,r=e.geometryType,[4,S({basemap:c.basemap,geometryType:r,sizeScheme:c.sizeScheme,worldScale:c.worldScale,
view:c.view})];case 1:p=f.sent();J=p.scheme;if(!J)throw new h("size-visual-variable:insufficient-info","Unable to find size scheme");w=(E=a&&[a.minSize,a.maxSize])||T(J,r);t=(u=n.getDefaultDataRange(b,m,!1))||[b.min,b.max];x=[];v=(y="height"===c.axis)?c.axis:void 0;z=w[0];k=w[1];y&&"number"===typeof z&&"number"===typeof k&&(B=n.getSizeRangeForAxis({minSize:z,maxSize:k},v),x.push(new P({axis:"width-and-depth",minSize:B.minSize})),k=B.maxSize);x.unshift(new P({field:d,valueExpression:c.valueExpression,
valueExpressionTitle:c.valueExpressionTitle,valueUnit:"unknown",normalizationField:g,axis:v,minSize:z,maxSize:k,minDataValue:t[0],maxDataValue:t[1],legendOptions:c.legendOptions}));D=new Y({type:"size",minSliderValue:null!=c.minValue?c.minValue:b.min,maxSliderValue:null!=c.maxValue?c.maxValue:b.max});U=new O({visualVariables:[D]});return[2,{basemapId:p.basemapId,basemapTheme:p.basemapTheme,visualVariables:x,statistics:b,defaultValuesUsed:!!u,sizeScheme:C.cloneScheme(J),authoringInfo:U}]}})})}function V(b,
a,g,c,e){return f.__awaiter(this,void 0,void 0,function(){var d,l,q,m,r,p,h,k,w,u,t,x,y;return f.__generator(this,function(f){switch(f.label){case 0:return[4,L.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return d=f.sent(),l=e.layer,q=e.field,m=l.geometryType,r=e.defaultSymbolEnabled,p=C.cloneScheme(b.sizeScheme),k=(h="polygon"===m)?p.marker:p,w=h?p.background:null,u=h?"point":m,t=a&&a.opacity,x=b.visualVariables.map(function(a){return a.clone()}),a&&a.visualVariables&&a.visualVariables.length&&
x.push.apply(x,a.visualVariables.map(function(a){return a.clone()})),y=new G.ClassBreaksRenderer({backgroundFillSymbol:w&&n.createSymbol(m,{type:e.symbolType,color:w.color,outline:n.getSymbolOutlineFromScheme(w,m,t)}),classBreakInfos:[{minValue:-W,maxValue:W,symbol:n.createSymbol(u,{type:e.symbolType,color:k.color,size:n.getSymbolSizeFromScheme(k,u),outline:n.getSymbolOutlineFromScheme(k,u,t)})}],defaultLabel:r?d.other:null,defaultSymbol:r?n.createSymbol(u,{type:e.symbolType,color:k.noDataColor,size:n.getSymbolSizeFromScheme(k,
u,!0),outline:n.getSymbolOutlineFromScheme(k,u,t)}):null,field:q,normalizationField:c,normalizationType:g,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,visualVariables:x,authoringInfo:b.authoringInfo&&b.authoringInfo.clone()}),[2,{renderer:y,visualVariables:b.visualVariables.map(function(a){return a.clone()}),statistics:b.statistics,defaultValuesUsed:b.defaultValuesUsed,sizeScheme:C.cloneScheme(b.sizeScheme),basemapId:b.basemapId,basemapTheme:b.basemapTheme}]}})})}
function ia(b,a){var g=H.toPt(b.minSize);b=(H.toPt(b.maxSize)-g)/(4<=a?a-1:a);for(var c=[],e=0;e<a;e++)c.push(g+b*e);return c}function ja(b,a){return f.__awaiter(this,void 0,void 0,function(){var g,c,e,d,l,q,m,h,p,k,E,w,u,t,x,y,v,z,A,B,D;return f.__generator(this,function(f){switch(f.label){case 0:return[4,L.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return g=f.sent(),c=b.layer,e=b.defaultSymbolEnabled,d=c.geometryType,l="polygon"===d,q=-1<b.symbolType.indexOf("3d-volumetric"),
[4,S({basemap:b.basemap,geometryType:d,sizeScheme:b.sizeScheme,worldScale:q,view:b.view})];case 2:return m=f.sent(),h=m.scheme,p=a.result,k=a.outlineResult,E=p.classBreakInfos,w=b.classificationMethod,u=b.normalizationType,t=l?h.marker:h,x=l?h.background:null,y=l?"point":d,v=T(t,y),z=q&&n.getSizeRangeForAxis({minSize:v[0],maxSize:v[1]},"height"),A=ia({minSize:v[0],maxSize:q?z.maxSize:v[1]},E.length),B=k&&k.opacity,D=new G.ClassBreaksRenderer({backgroundFillSymbol:x&&n.createSymbol(d,{type:b.symbolType,
color:x.color,outline:n.getSymbolOutlineFromScheme(x,d,B)}),classBreakInfos:E.map(function(a,c){return{minValue:a.minValue,maxValue:a.maxValue,symbol:n.createSymbol(y,{type:b.symbolType,color:t.color,size:A[c],widthAndDepth:z&&z.minSize,outline:n.getSymbolOutlineFromScheme(t,y,B)}),label:a.label}}),defaultLabel:e?g.other:null,defaultSymbol:e?n.createSymbol(y,{type:b.symbolType,color:t.noDataColor,size:n.getSymbolSizeFromScheme(t,y,!0),widthAndDepth:z&&z.minSize,outline:n.getSymbolOutlineFromScheme(t,
y,B)}):null,field:b.field,valueExpression:b.valueExpression,valueExpressionTitle:b.valueExpressionTitle,normalizationType:u,normalizationField:b.normalizationField,normalizationTotal:"percent-of-total"===u?p.normalizationTotal:void 0,legendOptions:b.legendOptions,authoringInfo:new O({type:"class-breaks-size",classificationMethod:w,standardDeviationInterval:b.standardDeviationInterval})}),"standard-deviation"!==w&&Z.setLabelsForClassBreaks({classBreakInfos:D.classBreakInfos,classificationMethod:w,
normalizationType:u,round:!0}),k&&k.visualVariables&&k.visualVariables.length&&(D.visualVariables=k.visualVariables.map(function(a){return a.clone()})),[2,{renderer:D,sizeScheme:C.cloneScheme(h),classBreaksResult:p,defaultValuesUsed:a.defaultValuesUsed,basemapId:m.basemapId,basemapTheme:m.basemapTheme}]}})})}function N(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,l,h,m,k;return f.__generator(this,function(f){switch(f.label){case 0:return[4,ca(b)];case 1:return a=f.sent(),g=a.view,
c=a.layer,e=a.normalizationField,d=a.signal,l=e?"field":void 0,[4,K.all([a.statistics?a.statistics:n.getSummaryStatistics({layer:c,field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:l,normalizationField:e,minValue:a.minValue,maxValue:a.maxValue,view:g,signal:d}),a.sizeOptimizationEnabled?ba({view:g,layer:c,signal:d}):null])];case 2:return h=f.sent(),m=h[0],k=h[1],[2,ha(m,k,e,a)]}})})}Object.defineProperty(F,"__esModule",{value:!0});
var W=Math.pow(2,53)-1;F.createVisualVariables=N;F.createContinuousRenderer=function(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,h,k;return f.__generator(this,function(f){switch(f.label){case 0:return[4,da(b)];case 1:return a=f.sent(),g={layer:a.layer,view:a.view,signal:a.signal},[4,K.all([N(R(a)),a.outlineOptimizationEnabled?Q(g):null])];case 2:return c=f.sent(),e=c[0],d=c[1],k=(h=a.normalizationField)?"field":void 0,[2,V(e,d,k,h,a)]}})})};F.createClassBreaksRenderer=function(b){return f.__awaiter(this,
void 0,void 0,function(){var a,g;return f.__generator(this,function(c){switch(c.label){case 0:return[4,ea(b)];case 1:return a=c.sent(),[4,n.getClassBreaks(fa(a),a.outlineOptimizationEnabled)];case 2:return g=c.sent(),[2,ja(a,g)]}})})};F.createAgeRenderer=function(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,h,k,m,r,p,A,E,w,u,t,x,y,v,z,C,B,D,F,G,M,H;return f.__generator(this,function(l){switch(l.label){case 0:return[4,ga(b)];case 1:a=l.sent();g=a.defaultSymbolEnabled;c=a.view;
e=a.startTime;d=a.endTime;h=a.symbolType;k=a.minValue;m=a.maxValue;r=a.signal;p=a.layer;A={layer:a.layer,view:a.view,signal:r};x=(t=K).all;if(!a.unit)return[3,2];y={unit:a.unit,statistics:null,valueExpression:null};return[3,4];case 2:return[4,aa({view:c,layer:p,startTime:e,endTime:d,minValue:k,maxValue:m,signal:r})];case 3:y=l.sent(),l.label=4;case 4:return[4,x.apply(t,[[y,a.outlineOptimizationEnabled?Q(A):null]])];case 5:return E=l.sent(),w=E[0],u=E[1],v=w.unit,z=w.statistics,C=I.getAgeExpressions({layer:p,
startTime:e,endTime:d,unit:v}).valueExpression,[4,L.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 6:return B=l.sent(),D=X.substitute(B["ageInfo_"+v],{unit:v,startTime:n.formatDate(e,v,p),endTime:n.formatDate(d,v,p)}),[4,N(R({layer:p,basemap:a.basemap,valueExpression:C,symbolType:h,statistics:z,legendOptions:{title:D},sizeScheme:a.sizeScheme,sizeOptimizationEnabled:a.sizeOptimizationEnabled,view:a.view,minValue:k,maxValue:m,signal:r}))];case 7:return F=l.sent(),G={layer:p,valueExpression:C,
defaultSymbolEnabled:g,symbolType:h},[4,V(F,u,null,null,G)];case 8:return M=l.sent(),H=M.renderer.authoringInfo.visualVariables,H.forEach(function(a){return n.updateAgeRendererAuthoringInfoVV(a,e,d,v)}),[2,f.__assign(f.__assign({},M),{unit:v})]}})})}});