// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../kernel ../Error ../Logger ../promiseUtils ./utils ./workerFactory".split(" "),function(z,A,g,p,q,r,k,f,t){var u=r.getLogger("esri.core.workers"),n=f.MessageType.ABORT,v=f.MessageType.INVOKE,w=f.MessageType.OPEN,x=f.MessageType.OPENED,l=f.MessageType.RESPONSE;return function(){function e(a,b){this._outJobs=new Map;this._inJobs=new Map;this.worker=a;this.id=b;a.addEventListener("message",this._onMessage.bind(this));a.addEventListener("error",function(a){a.preventDefault();
u.error(a)})}e.create=function(a){return g.__awaiter(this,void 0,void 0,function(){var b;return g.__generator(this,function(c){switch(c.label){case 0:return[4,t.createWorker()];case 1:return b=c.sent(),[2,new e(b,a)]}})})};e.prototype.terminate=function(){this.worker.terminate()};e.prototype.open=function(a,b){void 0===b&&(b={});return g.__awaiter(this,void 0,void 0,function(){var c,d,e=this;return g.__generator(this,function(h){c=b.signal;d=f.newJobId();return[2,k.create(function(b,f){b={resolve:b,
reject:f};k.onAbortOrThrow(c,function(){e._outJobs.delete(d);e._post({type:n,jobId:d})});e._outJobs.set(d,b);e._post({type:w,jobId:d,modulePath:a})})]})})};e.prototype._onMessage=function(a){if(a=f.receiveMessage(a))switch(a.type){case x:this._onOpenedMessage(a);break;case l:this._onResponseMessage(a);break;case n:this._onAbortMessage(a);break;case v:this._onInvokeMessage(a)}};e.prototype._onAbortMessage=function(a){var b=this._inJobs;a=a.jobId;var c=b.get(a);c&&(c.controller&&c.controller.abort(),
b.delete(a))};e.prototype._onInvokeMessage=function(a){var b=this,c=a.methodName,d=a.jobId,e=a.data;a=a.abortable?k.createAbortController():null;var h=this._inJobs,g=p.workerMessages[c],m;try{if("function"!==typeof g)throw new TypeError(c+" is not a function");m=g.call(null,e,{signal:a?a.signal:null})}catch(y){this._post({type:l,jobId:d,error:f.toInvokeError(y)});return}k.isPromiseLike(m)?(h.set(d,{controller:a,promise:m}),m.then(function(a){h.has(d)&&(h.delete(d),b._post({type:l,jobId:d},a))},function(a){h.has(d)&&
(h.delete(d),a||(a={message:"Error encountered at method"+c}),k.isAbortError(a)||b._post({type:l,jobId:d,error:f.toInvokeError(a||{message:"Error encountered at method "+c})}))})):this._post({type:l,jobId:d},m)};e.prototype._onOpenedMessage=function(a){var b=a.jobId;a=a.data;var c=this._outJobs.get(b);c&&(this._outJobs.delete(b),c.resolve(a))};e.prototype._onResponseMessage=function(a){var b=a.jobId,c=a.error;a=a.data;var d=this._outJobs.get(b);d&&(this._outJobs.delete(b),c?d.reject(q.fromJSON(JSON.parse(c))):
d.resolve(a))};e.prototype._post=function(a,b,c){return f.postMessage(this.worker,a,b,c)};return e}()});