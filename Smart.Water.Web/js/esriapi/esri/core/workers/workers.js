// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../Error ../has ../Logger ../promiseUtils ./Connection ./RemoteClient ./WorkerOwner @dojo/framework/shim/Promise".split(" "),function(w,d,e,x,g,y,p,m,t,z){function q(a,b){return e.__awaiter(this,void 0,void 0,function(){var c;return e.__generator(this,function(e){switch(e.label){case 0:return c=new m,[4,c.open(a,b)];case 1:return e.sent(),[2,c]}})})}function u(){return e.__awaiter(this,void 0,void 0,function(){var a,b,c;return e.__generator(this,function(e){if(f)return[2,
f];n=p.createAbortController();a=[];b=function(b){var c=z.create(b).then(function(a){return h[b]=a});a.push(c)};for(c=0;c<k;c++)b(c);f=p.all(a);return[2,f]})})}Object.defineProperty(d,"__esModule",{value:!0});d.Connection=m;d.RemoteClient=t;var k=g("esri-workers-debug")?1:g("host-browser")?navigator.hardwareConcurrency-1:0;k||(k=g("safari")&&g("mac")||g("trident")?7:2);var v=0,h=[],A=y.getLogger("esri.core.workers");d.initialize=function(a){void 0===a&&(a={});if(a.maxNumWorkers&&0<a.maxNumWorkers){a=
Math.min(a.maxNumWorkers,k);if(f){a!==k&&A.warn("Web workers already initialized, can't set requested number of workers");return}k=a}u()};d.openWithPorts=function(a,b){return q(a,{client:b})};d.open=function(a,b){void 0===b&&(b={});return e.__awaiter(this,void 0,void 0,function(){var c,d,f,r,m,n;return e.__generator(this,function(l){switch(l.label){case 0:if("string"!==typeof a)throw new x("workers:undefined-module","modulePath is missing");c=b.strategy||"distributed";g("host-webworker")&&!g("esri-workers")&&
(c="local");return"local"!==c?[3,4]:[4,t.loadWorker(a)];case 1:return(d=l.sent())?[3,3]:[4,new Promise(function(b,c){w([a],b,c)})];case 2:d=l.sent(),l.label=3;case 3:return p.throwIfAborted(b.signal),f=b.client||d,r=t.connect(d),[2,q([r],e.__assign(e.__assign({},b),{client:f}))];case 4:return[4,u()];case 5:l.sent();p.throwIfAborted(b.signal);if("dedicated"!==c)return[3,7];m=v++;v%=k;return[4,h[m].open(a,b)];case 6:return r=l.sent(),[2,q([r],b)];case 7:return n=h.map(function(c){return c.open(a,b)}),
[2,q(n,b)]}})})};d.terminate=function(){f&&(n.abort(),f=null);for(var a=0;a<h.length;a++)h[a]&&h[a].terminate();h.length=0};var f=null,n});