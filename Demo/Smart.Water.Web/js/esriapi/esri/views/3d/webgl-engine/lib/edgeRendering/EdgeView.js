// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/arrayUtils ../../../../../core/mathUtils ../../../../../core/promiseUtils ../../../../../core/typedArrayUtil ../../../../../core/workers ../../../../../core/libs/gl-matrix-2/mat3 ../../../../../core/libs/gl-matrix-2/mat3f64 ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../support/buffer/utils ../../core/shaderLibrary/attributes/VertexPosition.glsl ../../core/util/TwoVectorPosition ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../Object3D ./bufferLayouts ./edgeBufferWriters ./EdgeProcessingWorker ./EdgeRenderer ./strokes ./util ../TextureBackedBuffer/BufferManager ../../../../webgl/BufferObject ../../../../webgl/VertexArrayObject".split(" "),
function(I,J,m,P,K,E,Q,R,F,L,S,M,B,G,T,U,V,W,X,Y,Z,x,N,aa,y,ba,u,ca,H,O){function da(d){for(var a=null,c=null,b=0;b<d.geometries.length;b++){var e=d.geometryRecords[b];if(e.material.supportsEdges){if(!a)a=e.transformation;else if(!P.equals(a,e.transformation))return!1;if(!c&&e.origin)c=e;else if(c&&e.origin&&c.origin.id!==e.origin.id)return!1}}return!0}Object.defineProperty(J,"__esModule",{value:!0});I=function(){function d(a,c,b){this.rctx=a;this.techniqueRepository=c;this.callbacks=b;this.profilingCallback=
null;this.perObjectData=new Map;this.renderers=new Map;this.localOrigins=new Y.LocalOriginManager(new W);this.gpuMemoryUsage=this.numberOfRenderedEdges=0;this.worker=new aa;this.workerThread=null;this.destroyed=!1;this.tmpModelPosition=G.vec3f64.create();this.tmpCameraPosition=G.vec3f64.create();this.componentColorManager=new ca.BufferManager(this.rctx,2)}d.prototype.initialize=function(){var a=this;R.open("EdgeProcessingWorker").then(function(b){a.destroyed?b.close():a.workerThread=b});for(var c=
x.VertexLayout.createBuffer(4),b=0;4>b;b++)c.sideness.set(b,0,0===b||3===b?0:1),c.sideness.set(b,1,0===b||1===b?0:1);this.verticesBufferObject=H.createVertex(this.rctx,35044,c.buffer)};d.prototype.destroy=function(){this.destroyed||(this.workerThread&&(this.workerThread.close(),this.workerThread=null),this.verticesBufferObject&&(this.verticesBufferObject.dispose(),this.verticesBufferObject=null),this.perObjectData.clear(),this.renderers.clear(),this.destroyed=!0)};d.prototype.getUsedMemory=function(){return this.gpuMemoryUsage};
Object.defineProperty(d.prototype,"numberOfRenderedPrimitives",{get:function(){return this.numberOfRenderedEdges},enumerable:!0,configurable:!0});d.prototype.shouldRender=function(){return 0<this.renderers.size};d.prototype.addComponentObject=function(a,c,b,e,k,h,t,d){return m.__awaiter(this,void 0,void 0,function(){var g,f;return m.__generator(this,function(l){switch(l.label){case 0:if(this.hasObject(a))return[2];f={loaded:E.create(function(a){return g=a}),renderables:[],center:b};this.perObjectData.set(a,
f);return[4,this.addComponentGeometry(c,f,e,k,h,t,d)];case 1:return l.sent(),this.callbacks.setNeedsRender(),g(),[2]}})})};d.prototype.addOrUpdateObject=function(a,c,b,e,k){return m.__awaiter(this,void 0,void 0,function(){var h,t,d,g,f,l,q,n,v=this;return m.__generator(this,function(p){switch(p.label){case 0:h=[];d={loaded:E.create(function(a){return t=a}),renderables:[]};g=this.perObjectData.get(a);this.perObjectData.set(a,d);if(k&&k.mergeGeometries&&1<a.geometries.length&&da(a))h.push(this.addObjectMergedGeometries(a,
d,c,b));else for(f=0;f<a.geometries.length;f++)l=a.geometries[f],q=a.geometryRecords[f],n=q.material,n.supportsEdges&&h.push(this.addGeometryData(a,d,l.data,q,c[0],b,e));return[4,E.all(h)];case 1:return p.sent(),g&&g.loaded.then(function(){g.renderables.forEach(function(a){return v.removeRenderable(a)});v.callbacks.setNeedsRender()}),this.callbacks.setNeedsRender(),t(),[2]}})})};d.prototype.hasObject=function(a){return this.perObjectData.has(a)};d.prototype.updateAllComponentOpacities=function(a,
c){return m.__awaiter(this,void 0,void 0,function(){var b,e,k=this;return m.__generator(this,function(h){switch(h.label){case 0:return b=c instanceof Array?function(a){return c[a]}:function(){return c},[4,this.getObjectEntry(a)];case 1:return e=h.sent(),e.renderables.forEach(function(a){for(var c=a.components.meta.length,e=0;e<c;e++){var f=b(e),h=a.components.meta[e],d=h.index;h.material.opacity=f;a.components.buffer.textureBuffer.setDataElement(d,1,3,255*f)}k.updateTransparency(a)}),this.callbacks.setNeedsRender(),
[2]}})})};d.prototype.updateAllComponentMaterials=function(a,c,b,e){return m.__awaiter(this,void 0,void 0,function(){var k,h,d,p,g,f=this;return m.__generator(this,function(l){switch(l.label){case 0:return k=a instanceof Z,h=!!b.slicePlaneEnabled,d=u.determineRendererType(c),p=y.EdgeRenderer.getKey(d,h,k),[4,this.getObjectEntry(a)];case 1:return g=l.sent(),g.renderables.forEach(function(a){if(p!==a.rendererKey){var b=f.renderers.get(a.rendererKey),g=f.acquireRenderer(d,h,k);b.removeRenderable(a);
b.refCount.decrement();a.rendererKey=p;g.addRenderable(a)}for(b=0;b<c.length;b++)a.components.meta[b].material=c[b];e&&f.updateComponentBuffer(a.components);f.updateTransparency(a)}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.updateObjectVisibility=function(a,c){return m.__awaiter(this,void 0,void 0,function(){var b;return m.__generator(this,function(e){switch(e.label){case 0:return[4,this.getObjectEntry(a)];case 1:return b=e.sent(),b.renderables.forEach(function(a){return a.visible=c}),
this.callbacks.setNeedsRender(),[2]}})})};d.prototype.removeObject=function(a){var c=this,b=this.perObjectData.get(a);b&&(this.perObjectData.delete(a),b.loaded.then(function(){b.renderables.forEach(function(a){return c.removeRenderable(a)});c.callbacks.setNeedsRender()}))};d.prototype.getObjectEntry=function(a){return m.__awaiter(this,void 0,void 0,function(){var c;return m.__generator(this,function(b){switch(b.label){case 0:c=this.perObjectData.get(a);if(!c)throw"no object";return[4,c.loaded];case 1:return b.sent(),
[2,c]}})})};d.prototype.removeAll=function(){var a=this;this.perObjectData.forEach(function(c,b){a.removeObject(b)})};d.prototype.render=function(a,c){var b=this;this.localOrigins.updateViewMatrices(a.view);var e=a.viewInvTransp,k=G.vec3f64.create(),h=new V.TwoVectorPosition,d=new U.VertexPosition.ViewProjectionTransform,p=L.mat3f64.create();B.vec3.set(k,e[3],e[7],e[11]);h.set(k);B.vec3.copy(d.worldFromView_TH,h.high);B.vec3.copy(d.worldFromView_TL,h.low);F.mat3.fromMat4(d.viewFromCameraRelative_RS,
a.view);S.mat4.copy(d.projFromView,a.proj);e=L.mat3f64.create();F.mat3.transpose(e,d.viewFromCameraRelative_RS);F.mat3.invert(p,e);this.renderers.forEach(function(a){0===a.refCount.value&&(b.renderers.delete(a.key),a.dispose())});this.componentColorManager.garbageCollect();this.componentColorManager.updateTextures();var g=0,f=0;this.renderers.forEach(function(a){return a.forEachRenderable(function(a){g+=a.statistics.averageEdgeLength;f++},c)});if(0!==f){var e=a.view,k=40*g/f,h=u.estimateLengthAtDistance(a.viewport[3],
a.fovY,1,3.5*a.pixelRatio),l={distanceFalloffFactor:k,minimumEdgeLength:h,transparency:c,viewProjectionTransform:d,transformNormal_ViewFromGlobal:p};this.updateObjectCameraDistances(a);this.numberOfRenderedEdges=0;this.renderers.forEach(function(c){b.renderRegularEdges(c,a,l);b.renderSilhouetteEdges(c,a,l)});a.view=e}};d.prototype.updateTransparency=function(a){var c=u.determineEdgeTransparency(a.components.meta),b=u.determineObjectTransparency(a.components.meta);if(c!==a.edgeTransparency||b!==a.objectTransparency)a.edgeTransparency=
c,a.objectTransparency=b,this.renderers.get(a.rendererKey).setRenderablesDirty()};d.prototype.computeModelTransformWithLocalOrigin=function(a,c,b){a.getCombinedStaticTransformation(c,b);c.origin?this.localOrigins.register(c.origin):(a=B.vec3.set(this.tmpModelPosition,b[12],b[13],b[14]),c.origin=this.localOrigins.acquire(a));X.applyToModelMatrix(c.origin.vec3,b);return b};d.prototype.updateComponentBuffer=function(a){var c=a.meta;a=a.buffer;for(var b=0;b<c.length;b++){var e=c[b].material,k=c[b].index,
d=K.clamp(Math.round(e.size*y.LINE_WIDTH_FRACTION_FACTOR),0,255),m=K.clamp(e.extensionLength,-y.EXTENSION_LENGTH_OFFSET,255-y.EXTENSION_LENGTH_OFFSET)+y.EXTENSION_LENGTH_OFFSET,p="solid"===e.type?0:1,g=255*e.opacity,e=e.color;a.textureBuffer.setData(k,0,255*e[0],255*e[1],255*e[2],255*e[3]);a.textureBuffer.setData(k,1,d,m,p,g)}};d.prototype.createComponentBuffers=function(a){for(var c=[],b=this.componentColorManager.getBuffer(a.length),e=0;e<a.length;e++){var k=a[e],d=b.acquireIndex();c.push({index:d,
material:k})}a={meta:c,buffer:b};this.updateComponentBuffer(a);return a};d.prototype.extractEdges=function(a,c,b,e,d){return this.worker.process({data:c,originalIndices:d,writerSettings:a,skipDeduplicate:b},e?null:this.workerThread)};d.prototype.createEdgeResources=function(a){var c={};if(0<a.regular.lodInfo.lengths.length){var b=new O(this.rctx,x.EdgeShaderAttributeLocations,{vertices:x.glVertexLayout,instances:N.RegularEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:H.createVertex(this.rctx,
35044,a.regular.instancesData.buffer)});c.regular={vao:b,lod:a.regular.lodInfo}}0<a.silhouette.lodInfo.lengths.length&&(b=new O(this.rctx,x.EdgeShaderAttributeLocations,{vertices:x.glVertexLayout,instances:N.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:H.createVertex(this.rctx,35044,a.silhouette.instancesData.buffer)}),c.silhouette={vao:b,lod:a.silhouette.lodInfo});return c};d.prototype.addGeometryData=function(a,c,b,e,d,h,t){return m.__awaiter(this,void 0,void 0,
function(){var k,g,f,l;return m.__generator(this,function(m){k=b.getAttribute("position");g=this.computeModelTransformWithLocalOrigin(a,e,M.mat4f64.create());f=e.origin;l={position:k,indices:b.getIndices("position"),modelTransform:g,origin:f};return[2,this.addPositionData(c,l,d,h,t)]})})};d.prototype.addPositionData=function(a,c,b,e,d){void 0===d&&(d=!1);return m.__awaiter(this,void 0,void 0,function(){var k,t,p,g,f,l,q,n,v,w,D,z,r,C,A;return m.__generator(this,function(h){switch(h.label){case 0:k=
this.acquireRenderer(b.type,e.slicePlaneEnabled||!1);t=c.modelTransform;p=c.origin;g=c.indices;f=c.position;l=f.data.length/f.strideIdx;q=x.EdgeInputBufferLayout.createBuffer(l);for(n=0;n<l;n++)q.position.set(n,0,f.data[f.offsetIdx+n*f.strideIdx+0]),q.position.set(n,1,f.data[f.offsetIdx+n*f.strideIdx+1]),q.position.set(n,2,f.data[f.offsetIdx+n*f.strideIdx+2]);v=this.createComponentBuffers([b]);u.fillComponenBufferIndices(v.meta,[0,q.componentIndex.count],q.componentIndex);return[4,this.extractEdges(k.writerSettings,
q,!1,d,g)];case 1:return w=h.sent(),D=this.createEdgeResources(w),z=D.regular,r=D.silhouette,C=(z?z.vao.size:0)+(r?r.vao.size:0),A={regular:z,silhouette:r,transform:{modelMatrix:t,origin:p},statistics:{gpuMemoryUsage:C,averageEdgeLength:w.averageEdgeLength},components:v,visible:!0,edgeTransparency:u.determineEdgeTransparency(v.meta),objectTransparency:u.determineObjectTransparency(v.meta),distanceToCamera:0,rendererKey:k.key},a.renderables.push(A),k.addRenderable(A),this.gpuMemoryUsage+=C,[2]}})})};
d.prototype.addComponentGeometry=function(a,c,b,e,d,h,t){return m.__awaiter(this,void 0,void 0,function(){var k,g,f,l,q,n,v,w,D,z,r;return m.__generator(this,function(m){switch(m.label){case 0:return k=u.determineRendererType(h),g=this.acquireRenderer(k,t.slicePlaneEnabled||!1,!1),f=x.EdgeInputBufferLayout.createBuffer(b.count),T.vec3.copy(f.position,b),l=this.createComponentBuffers(h),u.fillComponenBufferIndices(l.meta,d,f.componentIndex,e),q=g.writerSettings,[4,this.extractEdges(q,f,!0,!1,e)];case 1:return n=
m.sent(),v=this.createEdgeResources(n),w=v.regular,D=v.silhouette,z=(w?w.vao.size:0)+(D?D.vao.size:0),r={regular:w,silhouette:D,transform:a,statistics:{gpuMemoryUsage:z,averageEdgeLength:n.averageEdgeLength},components:l,visible:!0,edgeTransparency:u.determineEdgeTransparency(l.meta),objectTransparency:u.determineObjectTransparency(l.meta),distanceToCamera:0,rendererKey:g.key},c.renderables.push(r),g.addRenderable(r),this.gpuMemoryUsage+=z,[2]}})})};d.prototype.addObjectMergedGeometries=function(a,
c,b,e){return m.__awaiter(this,void 0,void 0,function(){var d,h,t,p,g,f,l,q,n,v,w,u,z,r,C,A,x,y,B,E,F;return m.__generator(this,function(k){switch(k.label){case 0:d=new Map;h=0;p=t=null;for(g=0;g<a.geometries.length;g++)if(f=a.geometries[g],l=a.geometryRecords[g],q=l.material,q.supportsEdges&&(!p&&l.origin&&(p=l),n=f.data.getIndices("position"),h+=n?n.length:0,n&&null==t||t===Uint16Array))t=Q.isUint16Array(n)?Uint16Array:Uint32Array;v=h?new t(h):null;w=[];for(g=u=0;g<a.geometries.length;g++)if(f=
a.geometries[g],z=a.geometryRecords[g],q=z.material,q.supportsEdges){r=f.data.getAttribute("position");n=f.data.getIndices("position");C=d.get(r.data);if(null==C){C=w.length/3;for(A=r.offsetIdx;A<r.data.length;A+=r.strideIdx)w.push(r.data[A+0]),w.push(r.data[A+1]),w.push(r.data[A+2]);d.set(r.data,C)}if(n)for(x=0;x<n.length;x++)v[u++]=C+n[x]}y=p||a.geometryRecords[0];B=this.computeModelTransformWithLocalOrigin(a,y,M.mat4f64.create());E=y.origin;for(g=0;g<a.geometryRecords.length;g++)a.geometryRecords[g].origin=
E;F={position:{data:w,offsetIdx:0,strideIdx:3},indices:v,modelTransform:B,origin:E};return[4,this.addPositionData(c,F,b[0],e)];case 1:return k.sent(),[2]}})})};d.prototype.acquireRenderer=function(a,c,b){void 0===b&&(b=!0);var e=y.EdgeRenderer.getKey(a,c,b),d=this.renderers.get(e);this.strokesTexture||(this.strokesTexture=ba.generateStrokesTexture(this.rctx));d||(d=new y.EdgeRenderer(this.rctx,this.techniqueRepository,{type:a,slicePlaneEnabled:c,strokesTexture:this.strokesTexture,legacy:b}),this.renderers.set(e,
d));d.refCount.increment();return d};d.prototype.removeRenderable=function(a){var c=this.renderers.get(a.rendererKey);if(c){c.removeRenderable(a);c.refCount.decrement();a.regular&&(a.regular.vao.vertexBuffers.instances.dispose(),a.regular.vao.dispose(!1),a.regular.vao=null);a.silhouette&&(a.silhouette.vao.vertexBuffers.instances.dispose(),a.silhouette.vao.dispose(!1),a.silhouette.vao=null);"origin"in a.transform&&this.localOrigins.release(a.transform.origin);this.gpuMemoryUsage-=a.statistics.gpuMemoryUsage;
for(var c=0,b=a.components.meta;c<b.length;c++)a.components.buffer.releaseIndex(b[c].index)}};d.prototype.updateObjectCameraDistances=function(a){var c=this;a=a.viewInvTransp;B.vec3.set(this.tmpCameraPosition,a[3],a[7],a[11]);this.perObjectData.forEach(function(a,d){d="getCenter"in d?d.getCenter():a.center;var b=B.vec3.distance(d,c.tmpCameraPosition);a.renderables.forEach(function(a){return a.distanceToCamera=b})})};d.prototype.renderRegularEdges=function(a,c,b){var d=this;a.bindRegularEdges(c,b);
a.forEachRenderable(function(e){if(e.visible&&e.regular){var k=u.computeEdgeCount(e.regular.lod.lengths,e.distanceToCamera,b);"origin"in e.transform&&(c.view=d.localOrigins.getViewMatrix(e.transform.origin));a.renderRegularEdges(e,c,k);d.numberOfRenderedEdges+=k}},b.transparency)};d.prototype.renderSilhouetteEdges=function(a,c,b){var d=this;a.bindSilhouetteEdges(c,b);a.forEachRenderable(function(e){if(e.visible&&e.silhouette){var h=u.computeEdgeCount(e.silhouette.lod.lengths,e.distanceToCamera,b);
"origin"in e.transform&&(c.view=d.localOrigins.getViewMatrix(e.transform.origin));a.renderSilhouetteEdges(e,c,h);d.numberOfRenderedEdges+=h}},b.transparency)};return d}();J.EdgeView=I});