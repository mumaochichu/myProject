// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../geometry/support/aaBoundingBox ../../lib/screenSizePerspectiveUtils ../../lib/Util ../renderers/utils".split(" "),function(da,c,N,J,z,C,K,Y,O,Z){function P(a,b,d,f,u,e){var h=Q(b,d,aa);K.setMin(H,a.getBBMin());K.setMax(H,a.getBBMax());J.isSome(u)&&u.applyToAABB(H);if(R(H,b,h,f)){var h=a.getPrimitiveIndices(),A=a.getIndices(),
w=a.getPosition(),g=h?h.length:A.length/3;if(g>ba&&(a=a.getChildren(),void 0!==a)){for(h=0;8>h;++h)void 0!==a[h]&&P(a[h],b,d,f,u,e);return}L(b,d,0,g,A,w,h,u,e)}}function L(a,b,d,f,u,e,h,A,w){var g,n,k;if(h){var q,l,c=e.data,D=e.offsetIdx;e=e.strideIdx;var z=a[0],G=a[1];a=a[2];var E=b[0]-z,F=b[1]-G;for(b=b[2]-a;d<f;++d){var y=h[d],r=3*y;l=D+e*u[r++];var p=c[l++],m=c[l++];g=c[l];l=D+e*u[r++];var v=c[l++];n=c[l++];q=c[l];l=D+e*u[r];r=c[l++];k=c[l++];l=c[l];J.isSome(A)&&(g=A.applyToVertex(p,m,g),p=g[0],
m=g[1],g=g[2],q=A.applyToVertex(v,n,q),v=q[0],n=q[1],q=q[2],l=A.applyToVertex(r,k,l),r=l[0],k=l[1],l=l[2]);v-=p;n-=m;q-=g;r-=p;k-=m;l-=g;var x=F*l-k*b,B=b*r-l*E,C=E*k-r*F,t=v*x+n*B+q*C;if(!(Math.abs(t)<=S)){p=z-p;m=G-m;g=a-g;x=p*x+m*B+g*C;if(0<t){if(0>x||x>t)continue}else if(0<x||x<t)continue;B=m*q-n*g;g=g*v-q*p;m=p*n-v*m;p=E*B+F*g+b*m;if(0<t){if(0>p||x+p>t)continue}else if(0<p||x+p<t)continue;m=(r*B+k*g+l*m)/t;0<=m&&(v=M(v,n,q,r,k,l,T),w(m,v,y))}}}else for(h=e.data,c=e.offsetIdx,D=e.strideIdx,e=
a[0],z=a[1],G=a[2],a=b[0]-e,E=b[1]-z,F=b[2]-G,b=d,d*=3;b<f;++b)if(k=c+D*u[d++],p=h[k++],m=h[k++],g=h[k],k=c+D*u[d++],y=h[k++],v=h[k++],n=h[k],k=c+D*u[d++],q=h[k++],r=h[k++],k=h[k],J.isSome(A)&&(g=A.applyToVertex(p,m,g),p=g[0],m=g[1],g=g[2],n=A.applyToVertex(y,v,n),y=n[0],v=n[1],n=n[2],k=A.applyToVertex(q,r,k),q=k[0],r=k[1],k=k[2]),y-=p,v-=m,n-=g,q-=p,r-=m,k-=g,t=E*k-r*F,x=F*q-k*a,B=a*r-q*E,l=y*t+v*x+n*B,!(Math.abs(l)<=S)){p=e-p;m=z-m;g=G-g;t=p*t+m*x+g*B;if(0<l){if(0>t||t>l)continue}else if(0<t||t<
l)continue;x=m*n-v*g;g=g*y-n*p;m=p*v-y*m;p=a*x+E*g+F*m;if(0<l){if(0>p||t+p>l)continue}else if(0<p||t+p<l)continue;m=(q*x+r*g+k*m)/l;0<=m&&(y=M(y,v,n,q,r,k,T),w(m,y,b))}}function M(a,b,d,f,u,e,h){z.vec3.set(U,a,b,d);z.vec3.set(V,f,u,e);z.vec3.cross(h,U,V);z.vec3.normalize(h,h);return h}function Q(a,b,d){return z.vec3.set(d,1/(b[0]-a[0]),1/(b[1]-a[1]),1/(b[2]-a[2]))}function R(a,b,d,f){return W(a,b,d,f,Infinity)}function W(a,b,d,f,u){var e=(a[0]-f-b[0])*d[0],h=(a[3]+f-b[0])*d[0],c=Math.min(e,h),e=Math.max(e,
h),h=(a[1]-f-b[1])*d[1],w=(a[4]+f-b[1])*d[1],e=Math.min(e,Math.max(h,w));if(0>e)return!1;c=Math.max(c,Math.min(h,w));if(c>e)return!1;h=(a[2]-f-b[2])*d[2];a=(a[5]+f-b[2])*d[2];e=Math.min(e,Math.max(h,a));if(0>e)return!1;c=Math.max(c,Math.min(h,a));return c>e?!1:c<u}function X(a,b){b=b?X(b):{};for(var d in a){var f=a[d];f&&f.forEach&&(f=ca(f));null==f&&d in b||(b[d]=f)}return b}function ca(a){var b=[];a.forEach(function(a){return b.push(a)});return b}Object.defineProperty(c,"__esModule",{value:!0});
var H=K.create(),I=O.VertexAttrConstants;c.intersectTriangleGeometry=function(a,b,d,f,c,e,h){b=Z.isInstanceHidden(b);d=d.tolerance;b||(a.boundingInfo?(O.assert("triangle"===a.data.primitiveType),P(a.boundingInfo,f,c,d,e,h)):(d=a.getIndices(I.POSITION),a=a.getAttribute(I.POSITION),L(f,c,0,d.length/3,d,a,void 0,e,h)))};var aa=C.vec3f64.create(),S=Math.pow(2,-52),T=C.vec3f64.create();c.intersectTriangles=L;var U=C.vec3f64.create(),V=C.vec3f64.create();c.computeNormal=M;c.computeInvDir=Q;c.intersectAabbInvDir=
R;c.intersectAabbInvDirBefore=W;c.verticalOffsetAtDistance=function(a,b,d,f,c){var e=(d.screenLength||0)*a.pixelRatio;c&&(e=Y.scale(e,f,b,c));return N.glClamp(e*Math.tan(.5*a.fovY)/(.5*a.fullHeight)*b,d.minWorldLength||0,null!=d.maxWorldLength?d.maxWorldLength:Infinity)};c.bindScreenSizePerspective=function(a,b,d){if(a){var f=a.parameters;b.setUniform4f(d,f.divisor,f.offset,f.minPixelSize,a.paddingPixelsOverride)}};c.copyParameters=X;c.updateParameters=function(a,b){var d=!1,f;for(f in b){var c=b[f];
void 0!==c&&(d=!0,Array.isArray(c)?a[f]=c.slice():a[f]=c)}return d};c.intersectDrapedRenderLineGeometry=function(a,b,d,c,u){if(b.options.selectionMode){b=a.getAttribute(I.POSITION).data;var e=a.getAttribute(I.SIZE),h=d[0];d=d[1];a=(((e&&e.data[0])+c)/2+4)*a.pixelRatio;c=Number.MAX_VALUE;for(e=0;e<b.length-5;e+=3){var f=b[e],w=b[e+1],g=h-f,n=d-w,f=b[e+3]-f,w=b[e+4]-w,k=N.clamp((f*g+w*n)/(f*f+w*w),0,1),g=f*k-g,n=w*k-n,n=g*g+n*n;n<c&&(c=n)}c<a*a&&u()}};c.colorMixModes={multiply:1,ignore:2,replace:3,
tint:4};var ba=1E3});