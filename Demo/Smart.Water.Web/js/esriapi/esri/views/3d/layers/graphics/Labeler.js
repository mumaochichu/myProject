// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Handles ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../layers/graphics/dehydratedFeatures ../../../../layers/support/labelFormatUtils ../../../../layers/support/layerUtils ../../../../symbols/callouts/calloutUtils ./Graphics3DCalloutSymbolLayerFactory ./graphicSymbolUtils ./labelPlacement ../../support/debugFlags ../../webgl-engine/lib/Layer ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextRenderer ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureAtlas ../../../support/Scheduler".split(" "),
function(t,y,f,C,z,D,E,F,u,l,n,G,H,w,I,J,K,L,M,N,A,O,P,Q,R){Object.defineProperty(y,"__esModule",{value:!0});var B=E.getLogger("esri.views.3d.layers.graphics.Labeler");t=function(r){function b(){var a=null!==r&&r.apply(this,arguments)||this;a.idHint="__labeler";a._dirty=!1;a.labels=new Map;a.labelsToAdd=new Map;a.labelsToRemove=new Map;a.labelingContexts=[];return a}f.__extends(b,r);b.prototype.setup=function(){var a=this;this.handles||(this.handles=new D,this.handles.add([this.view.watch("state.camera",
function(){return a.setDirty()}),this.view.watch("pixelRatio",function(){return a.resetAllLabels()})]));this.textTextureAtlas||(this.textTextureAtlas=new Q.default({idHint:this.idHint+"_atlas",view:this.view}),this.hudMaterialCollection=new A(this.view._stage),this.calloutMaterialCollection=new A(this.view._stage));this.handles.add(this.view.resourceController.scheduler.registerTask(R.Task.LABELER,function(d){return a.update(d)},function(){return a.needsUpdate()}))};b.prototype.dispose=function(){this.handles&&
(this.handles.destroy(),this.handles=null);this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null);this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null);this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null);this.labelingContexts=[];this.labels.clear();this.labelsToAdd.clear();this.labelsToRemove.clear()};b.prototype.isActiveLabelingContext=function(a){return a.active&&
w.areLabelsVisible(a.layer)};b.prototype.activateLabelingContext=function(a){var d=this;a.labels.forEach(function(a,e){d.labels.set(e,a);a.graphics3DGraphic.setVisibilityFlag(0,!0,1)});a.active=!0};b.prototype.deactivateLabelingContext=function(a){var d=this;a.labels.forEach(function(a,e){a.graphics3DGraphic.setVisibilityFlag(0,!1,1);d.setLabelGraphicVisibility(a.graphics3DGraphic,!1);d.labels.delete(e)});a.active=!1};b.prototype.addLabelTextureToAtlas=function(a){for(var d=0,c=a.graphics3DGraphic.labelGraphics;d<
c.length;d++){var e=c[d];if(e._labelClass){var b=a.textRenderers[e._labelIndex];b&&this.textTextureAtlas.addTextTexture(b,e.stageObject)}}a.rendered=!0};b.prototype.removeLabelTextureFromAtlas=function(a){for(var d=0,c=a.graphics3DGraphic.labelGraphics;d<c.length;d++){var e=c[d];if(e._labelClass){var b=a.textRenderers[e._labelIndex];b&&this.textTextureAtlas.removeTextTexture(b,e.stageObject)}}a.rendered=!1};b.prototype.needsUpdate=function(){return this.view.ready&&this.isDirty};b.prototype.update=
function(a){this._updateLabels(a);!this._dirty&&this.deconflictor.needsUpdate()&&this.deconflictor.update(a)};b.prototype._updateLabels=function(a){var d=this;if(this._dirty){this._dirty=!1;for(var c=function(c){if(!e.isActiveLabelingContext(c))return"continue";if(!e.hasValidLabelClassContext(c)){if(e.hasInvalidLabelClassContext(c))return e.deactivateLabelingContext(c),"continue";e.createLabelClassContext(c);if(e.hasPendingLabelClassContext(c))return e._dirty=!0,"continue";if(!e.hasValidLabelClassContext(c))return"continue"}F.someMap(c.labelsToInitialize,
function(e,b){d.ensureGraphics3DResources(e)&&(d.labels.set(b,e),d.deconflictor.setDirty(),a.madeProgress());if(e.visible&&e.hasTextTextureResources||!e.visible&&e.hasGraphics3DResources)c.labelsToInitialize.delete(b),a.madeProgress();return a.done})&&(e._dirty=!0)},e=this,b=0,k=this.labelingContexts;b<k.length;b++)c(k[b]);this.labelsToRemove.forEach(function(a){return d.removeLabelTextureFromAtlas(a)});this.labelsToRemove.clear();this.labelsToAdd.forEach(function(a){return d.addLabelTextureToAtlas(a)});
this.labelsToAdd.clear();this._dirty||this.notifyChange("updating")}};b.prototype.hasPendingLabelClassContext=function(a){return a.labelClassPromise&&!!a.labelClassAbortController};b.prototype.hasValidLabelClassContext=function(a){return a.labelClassContexts&&a.labelClassContexts.length};b.prototype.hasInvalidLabelClassContext=function(a){return null===a.labelClassContexts};b.prototype.createLabelClassContextAsync=function(a){return f.__awaiter(this,void 0,void 0,function(){var d,c,e,b,k,m,g=this;
return f.__generator(this,function(p){switch(p.label){case 0:return d=a.labelClassAbortController.signal,[4,a.layer.when()];case 1:p.sent();l.throwIfAborted(d);a.scaleVisibility&&a.scaleVisibility.updateScaleRangeActive();c=a.graphics3DCore;e=c.layer;b=e.labelingInfo&&e.labelingInfo.filter(function(a){return!!a.symbol});if(!b||0===b.length)return[2];k=Array(b.length);m=!1;return[4,z.forEach(b,function(e,b){return f.__awaiter(g,void 0,void 0,function(){var g,p,v,h;return f.__generator(this,function(f){switch(f.label){case 0:return g=
e.symbol,p=K.getGraphics3DSymbol(c.getOrCreateGraphics3DSymbol(g)),u.isNone(p)?(B.error("Failed to create Graphics3DSymbol for label"),[2]):[4,p.load()];case 1:f.sent();l.throwIfAborted(d);v=null;if(!I.isCalloutSupport(g)||!g.hasVisibleCallout())return[3,3];v=J.make(g,c.symbolCreationContext);return[4,v.load()];case 2:f.sent(),l.throwIfAborted(d),f.label=3;case 3:return[4,z.result(H.createLabelFunction(e,a.layer.fields.map(function(a){return a.toJSON()}),this.view.spatialReference))];case 4:return h=
f.sent(),l.throwIfAborted(d),!0===h.ok?k[b]={labelClass:e,labelFunction:h.value,graphics3DSymbol:p,graphics3DCalloutSymbolLayer:v,calloutSymbolLayerIndex:0,textRenderParameters:this.createTextRenderParameters(p.symbol)}:(B.error("Label expression failed to evaluate: "+h.error),m=!0),[2]}})})})];case 2:p.sent();l.throwIfAborted(d);if(m)return[2];a.labelClassContexts=k;return[2]}})})};b.prototype.createLabelClassContext=function(a){return f.__awaiter(this,void 0,void 0,function(){var d=this;return f.__generator(this,
function(c){a.labelClassPromise||(a.labelClassPromise=this.createLabelClassContextAsync(a).catch(function(d){if(l.isAbortError(d))throw d;a.labelClassContexts=null}).then(function(){a.labelClassAbortController=null;d.notifyChange("updating")}).catch(function(){}),this.notifyChange("updating"));return[2,a.labelClassPromise]})})};b.prototype.createTextRenderParameters=function(a){return(a=a.symbolLayers.getItemAt(0))&&"text"===a.type?P.default.fromSymbol(a,this.view.pixelRatio):null};b.prototype.destroyLabelClassContext=
function(a){for(var d=0,c=a.labelClassContexts;d<c.length;d++){var e=c[d];--e.graphics3DSymbol.referenced;e.graphics3DSymbol=null}d=a.labelClassAbortController;a.labelClassAbortController=l.createAbortController();d&&d.abort();a.labelClassContexts=[];a.labelClassPromise=null;this.notifyChange("updating")};b.prototype.createTextSymbolGraphic=function(a,d,c,e,b){a={text:a.text,centerOffset:c.centerOffset,translation:c.translation,elevationOffset:c.elevationOffset,screenOffset:c.screenOffset,anchor:c.anchor,
centerOffsetUnits:c.centerOffsetUnits,verticalOffset:c.verticalOffset,debugDrawBorder:M.LABELS_SHOW_BORDER,displayWidth:a.displayWidth,displayHeight:a.displayHeight};h.graphic=d;h.renderingInfo=null;h.layer=e;return b.createLabel(h,a,this.hudMaterialCollection,this.textTextureAtlas)};b.prototype.createLineCalloutGraphic=function(a,d,c,e,b){d={symbol:d,translation:e.translation,elevationOffset:e.elevationOffset,screenOffset:e.screenOffset,centerOffset:e.centerOffset,centerOffsetUnits:e.centerOffsetUnits,
materialCollection:this.calloutMaterialCollection};h.graphic=a;h.renderingInfo=d;h.layer=b;return c.createGraphics3DGraphic(h)};b.prototype.ensureGraphics3DResources=function(a){if(a.hasGraphics3DResources)return!1;var d=a.graphics3DGraphic;if(d.destroyed)return!1;this.ensureTextTextureResources(a);var c=a.labelingContext,e=c.labelClassContexts;if(!e||0===e.length||!c.emptySymbolLabelSupported&&0===d._graphics.length)return!1;for(var b=!1,k=d.graphic,m=c.layer,g=w.areLabelsVisible(c.layer),f=this.view._stage,
h=0;h<e.length;h++){var l=a.textRenderers[h];if(l){var n=e[h],q=n.graphics3DSymbol,r=null;q.symbol&&"label-3d"===q.symbol.type&&(r=q.symbol);var x=q.symbolLayers[0];if(x){var t=n.labelClass,q=L.get({graphics3DGraphic:d,labelSymbol:r,labelClass:t,disablePlacement:c.disablePlacement});if(!u.isNone(q)){x.setElevationInfoOverride(c.elevationInfoOverride);b=this.createTextSymbolGraphic(l,k,q,m,x);if(!b)return!1;b._labelClass=t;b._labelIndex=h;d.addLabelGraphic(b,f,c.stageLayer);d.setVisibilityFlag(0,g,
1);d.clearVisibilityFlag(1,1);d.setVisibilityFlag(3,!1,1);b=!0;(g=n.graphics3DCalloutSymbolLayer)&&q.hasLabelVerticalOffset&&(g.setElevationInfoOverride(c.elevationInfoOverride),k=this.createLineCalloutGraphic(k,r,g,q,m))&&(n.calloutSymbolLayerIndex=d.labelGraphics.length,d.addLabelGraphic(k,f,c.stageLayer));break}}}}c.scaleVisibility&&b&&c.scaleVisibility.updateGraphicLabelScaleVisibility(d);return a.hasGraphics3DResources=!0};b.prototype.destroyGraphics3DResources=function(a){for(var d=a.labelingContext.labelClassContexts,
c=0,e=a.graphics3DGraphic.labelGraphics;c<e.length;c++){var b=e[c];if(null!=b._labelClass){var k=d[b._labelIndex].graphics3DSymbol.symbolLayers[0];if(null!=k)k.onRemoveGraphic(b)}}a.graphics3DGraphic.clearLabelGraphics();a.hasGraphics3DResources=!1};b.prototype.ensureTextTextureResources=function(a){if(!a.hasTextTextureResources){var d=a.labelingContext,c=d.labelClassContexts;if(c&&0!==c.length){for(var e=a.graphics3DGraphic.graphic,b=0;b<c.length;b++){var k=c[b];a.textRenderers[b]=null;if(k.textRenderParameters){var f=
k.labelFunction,g=void 0;if("arcade"===f.type)try{var h=f.needsHydrationToEvaluate()?G.hydrateGraphic(e,d.layer):e,g=f.evaluate(h)}catch(S){g=null}else g=f.evaluate(e);u.isNone(g)||""===g||/^\s+$/.test(g)||(a.textRenderers[b]=new O.default(g,k.textRenderParameters))}}a.hasTextTextureResources=!0}}};b.prototype.destroyTextTextureResources=function(a){a.textRenderers=[];a.hasTextTextureResources=!1};b.prototype.addGraphic=function(a,d){var c={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,
rendered:!1,labelingContext:a,graphics3DGraphic:d,textRenderers:[]};d=d.graphic.uid;a.labels.set(d,c);a.labelsToInitialize.set(d,c);this.setDirty();this.deconflictor.setDirty()};b.prototype.removeGraphic=function(a,d){d=d.graphic.uid;var c=a.labels.get(d);c&&(this.destroyGraphic(c,d),a.labels.delete(d),a.labelsToInitialize.delete(d),this.setDirty(),this.deconflictor.setDirty())};b.prototype.destroyGraphic=function(a,d){this.labels.has(d)&&(this.labels.delete(d),this.labelsToAdd.delete(d),this.labelsToRemove.delete(d));
a.hasTextTextureResources&&(this.removeLabelTextureFromAtlas(a),this.destroyTextTextureResources(a));a.hasGraphics3DResources&&this.destroyGraphics3DResources(a)};b.prototype.labelingInfoChange=function(a,d){return f.__awaiter(this,void 0,void 0,function(){var c,b,h,k;return f.__generator(this,function(e){if(d){c=0;for(b=d;c<b.length;c++)if(h=b[c],k=a.labels.get(h))this.removeGraphic(a,k.graphics3DGraphic),this.addGraphic(a,k.graphics3DGraphic);return[2]}this.visibilityInfoChange(a);this.resetLabels(a);
return[2,this.createLabelClassContext(a)]})})};b.prototype.globalPropertyChanged=function(a,d){for(var c=function(c){var b=new Map;d.labels.forEach(function(a){a=a.graphics3DGraphic;b.set(a.graphic.uid,a)});u.unwrap(c.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(a,b,function(a){return a.labelGraphics[0]});c.graphics3DCalloutSymbolLayer&&c.graphics3DCalloutSymbolLayer.globalPropertyChanged(a,b,function(a){return a.labelGraphics[c.calloutSymbolLayerIndex]})},b=0,f=d.labelClassContexts;b<
f.length;b++)c(f[b])};b.prototype.visibilityInfoChange=function(a){var d=a.layer.labelsVisible;d&&!a.active&&this.activateLabelingContext(a);!d&&a.active&&this.deactivateLabelingContext(a);this.setDirty()};b.prototype.resetAllLabels=function(){for(var a=0,d=this.labelingContexts;a<d.length;a++)this.resetLabels(d[a])};b.prototype.resetLabels=function(a){var d=this;a.labels.forEach(function(c,b){d.destroyGraphic(c,b);c.visible=!1;c.rendered=!1;a.labelsToInitialize.set(b,c)});this.destroyLabelClassContext(a);
this.setDirty();this.deconflictor.setDirty()};b.prototype.findLabelingContext=function(a){for(var d=0,c=this.labelingContexts;d<c.length;d++){var b=c[d];if(b.graphics3DCore===a)return b}return null};b.prototype.addGraphicsOwner=function(a,d,c){var b=this,f=c&&c.emptySymbolLabelSupported||!1,h=c&&c.elevationInfoOverride||null;c=c&&c.disablePlacement||null;if(!this.findLabelingContext(a)){var m=a.layer,g={graphics3DCore:a,layer:m,scaleVisibility:d,emptySymbolLabelSupported:f,elevationInfoOverride:h,
disablePlacement:c,active:m.labelsVisible,labelClassPromise:null,labelClassAbortController:l.createAbortController(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new N(this.idHint+"_"+m.uid,{isPickable:!0},m.uid)};this.view._stage.add(0,g.stageLayer);this.view._stage.addToViewContent([g.stageLayer.id]);this.labelingContexts.push(g);this.setDirty();return{addGraphic:function(a){return b.addGraphic(g,a)},removeGraphic:function(a){return b.removeGraphic(g,a)},featureReductionChange:function(){},
layerLabelsEnabled:function(){return w.areLabelsVisible(g.layer)},labelingInfoChange:function(a){return b.labelingInfoChange(g,a)},elevationInfoChange:function(){return b.globalPropertyChanged("elevationInfo",g)},slicePlaneEnabledChange:function(){return b.globalPropertyChanged("slicePlaneEnabled",g)},visibilityInfoChange:function(){return b.visibilityInfoChange(g)},reset:function(){return b.resetLabels(g)},clear:function(){},processStageDirty:function(){return b.view._stage.processDirtyLayer(g.stageLayer.id)}}}};
b.prototype.removeGraphicsOwner=function(a){var b=this,c=this.findLabelingContext(a);c&&(a=this.labelingContexts.indexOf(c),this.labelingContexts.splice(a,1),c.labels.forEach(function(a){return b.removeGraphic(c,a.graphics3DGraphic)}),a=c.stageLayer.id,this.view._stage.removeFromViewContent([a]),this.view._stage.remove(0,a),c.stageLayer=null,this.setDirty())};b.prototype.setLabelGraphicVisibility=function(a,b){a=a.graphic.uid;var c=this.labels.get(a);c&&c.visible!==b&&(b&&!c.rendered?(this.labelsToAdd.set(a,
c),this.labelsToRemove.delete(a),c.hasTextTextureResources||c.labelingContext.labelsToInitialize.set(a,c)):!b&&c.rendered&&(this.labelsToRemove.set(a,c),this.labelsToAdd.delete(a)),c.visible=b,this.setDirty())};Object.defineProperty(b.prototype,"isDirty",{get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.isDirty||this.deconflictor.needsUpdate()},enumerable:!0,configurable:!0});b.prototype.setDirty=function(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))};
Object.defineProperty(b.prototype,"updating",{get:function(){var a=this;return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.deconflictor.updating||this.labelingContexts.some(function(b){return a.hasPendingLabelClassContext(b)})},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updatingProgress",{get:function(){var a=this;if(!this.updating||!this.textTextureAtlas)return 1;var b=0<this.labelingContexts.length?this.labelingContexts.reduce(function(b,d){return b+
(a.hasPendingLabelClassContext(d)?0:1)},0)/this.labelingContexts.length:1;return(this._dirty?0:.3)+(this.textTextureAtlas.updating?0:.1)+.1*b+.5*this.deconflictor.updatingProgress},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{textTextureAtlas:this.textTextureAtlas,resetAllLabels:function(){return a.resetAllLabels()}}},enumerable:!0,configurable:!0});f.__decorate([n.property({constructOnly:!0})],b.prototype,"view",void 0);f.__decorate([n.property({constructOnly:!0})],
b.prototype,"deconflictor",void 0);f.__decorate([n.property()],b.prototype,"textTextureAtlas",void 0);f.__decorate([n.property({type:Boolean,readOnly:!0,dependsOn:["textTextureAtlas.updating","deconflictor.updating"]})],b.prototype,"updating",null);return b=f.__decorate([n.subclass("esri.views.3d.layers.graphics.Labeler")],b)}(C);y.Labeler=t;var h={graphic:null,renderingInfo:null,layer:null}});