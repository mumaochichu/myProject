// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/devEnvironmentUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../glTF/DefaultLoadingContext ../../glTF/loader ../../glTF/internal/indexUtils ./wosrLoader ../../support/buffer/BufferView ../../support/buffer/math ../../support/buffer/utils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(da,A,l,U,c,N,V,W,X,m,Q,G,Y,Z,H,R,t,B,w,aa,ba,C,K){function S(c){var h=c.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return h?{fileType:"gltf",url:h[1],specifiedLodIndex:null!=h[4]?Number(h[4]):null}:c.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:c,specifiedLodIndex:null}:{fileType:"unknown",url:c,specifiedLodIndex:null}}function O(m,h,x,T){var y=m.model,k=V.mat3f64.create(),I=[],F=new Map,g=new Map;y.lods.forEach(function(m,L){if(void 0===T||L===T){var A=0,q={name:m.name,stageResources:{textures:[],
materials:[],geometries:[]},lodThreshold:c.isSome(m.lodThreshold)?m.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:G.empty()};I.push(q);m.parts.forEach(function(b){var n=b.material+(b.attributes.normal?"_normal":"")+(b.attributes.color?"_color":"")+(b.attributes.texCoord0?"_texCoord0":"")+(b.attributes.tangent?"_tangent":""),a=y.materials.get(b.material),u=c.isSome(b.attributes.texCoord0),p=c.isSome(b.attributes.normal);if(!F.has(n)){if(u){if(c.isSome(a.textureColor)&&!g.has(a.textureColor)){var d=
y.textures.get(a.textureColor),f=l.__assign(l.__assign({},d.parameters),{preMultiplyAlpha:!0});g.set(a.textureColor,new C(d.data,a.textureColor,f))}c.isSome(a.textureNormal)&&!g.has(a.textureNormal)&&(d=y.textures.get(a.textureNormal),f=l.__assign(l.__assign({},d.parameters),{preMultiplyAlpha:!0}),g.set(a.textureNormal,new C(d.data,a.textureNormal,f)));c.isSome(a.textureOcclusion)&&!g.has(a.textureOcclusion)&&(d=y.textures.get(a.textureOcclusion),f=l.__assign(l.__assign({},d.parameters),{preMultiplyAlpha:!0}),
g.set(a.textureOcclusion,new C(d.data,a.textureOcclusion,f)));c.isSome(a.textureEmissive)&&!g.has(a.textureEmissive)&&(d=y.textures.get(a.textureEmissive),f=l.__assign(l.__assign({},d.parameters),{preMultiplyAlpha:!0}),g.set(a.textureEmissive,new C(d.data,a.textureEmissive,f)));c.isSome(a.textureMetallicRoughness)&&!g.has(a.textureMetallicRoughness)&&(d=y.textures.get(a.textureMetallicRoughness),f=l.__assign(l.__assign({},d.parameters),{preMultiplyAlpha:!0}),g.set(a.textureMetallicRoughness,new C(d.data,
a.textureMetallicRoughness,f)))}var z=K.COLOR_GAMMA,d=Math.pow(a.color[0],1/z),f=Math.pow(a.color[1],1/z),v=Math.pow(a.color[2],1/z),e=Math.pow(a.emissiveFactor[0],1/z),D=Math.pow(a.emissiveFactor[1],1/z),z=Math.pow(a.emissiveFactor[2],1/z);F.set(n,new K(l.__assign(l.__assign(l.__assign({},h),{transparent:"BLEND"===a.alphaMode,textureAlphaMode:ca(a.alphaMode),textureAlphaCutoff:a.alphaCutoff,diffuse:[d,f,v],ambient:[d,f,v],opacity:a.opacity,doubleSided:a.doubleSided,doubleSidedType:"winding-order",
cullFace:a.doubleSided?0:2,vertexColors:!!b.attributes.color,vertexTangents:!!b.attributes.tangent,normals:p?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:c.isSome(a.textureColor)&&u?g.get(a.textureColor).id:void 0,colorMixMode:a.colorMixMode,normalTextureId:c.isSome(a.textureNormal)&&u?g.get(a.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:c.isSome(a.textureOcclusion)&&u?g.get(a.textureOcclusion).id:void 0,emissiveTextureId:c.isSome(a.textureEmissive)&&
u?g.get(a.textureEmissive).id:void 0,metallicRoughnessTextureId:c.isSome(a.textureMetallicRoughness)&&u?g.get(a.textureMetallicRoughness).id:void 0,emissiveFactor:[e,D,z],mrrFactors:[a.metallicFactor,a.roughnessFactor,h.mrrFactors[2]],isSchematic:!1}),x),n))}a:{p=b.indices||b.attributes.position.count;switch(b.primitiveType){case 4:d=H.trianglesToTriangles(p);break a;case 5:d=H.triangleStripToTriangles(p);break a;case 6:d=H.triangleFanToTriangles(p);break a}d=void 0}f={};v={};p=b.attributes.position.count;
e=w.createBuffer(t.BufferViewVec3f,p);B.vec3.transformMat4(e,b.attributes.position,b.transform);v.position={data:e.typedBuffer,size:e.elementCount};f.position=d;c.isSome(b.attributes.normal)&&(e=w.createBuffer(t.BufferViewVec3f,p),N.mat3.normalFromMat4(k,b.transform),B.vec3.transformMat3(e,b.attributes.normal,k),v.normal={data:e.typedBuffer,size:e.elementCount},f.normal=d);c.isSome(b.attributes.tangent)&&(e=w.createBuffer(t.BufferViewVec4f,p),N.mat3.normalFromMat4(k,b.transform),B.vec4.transformMat3(e,
b.attributes.tangent,k),v.tangent={data:e.typedBuffer,size:e.elementCount},f.tangent=d);c.isSome(b.attributes.texCoord0)&&(e=w.createBuffer(t.BufferViewVec2f,p),w.vec2.normalizeIntegerBuffer(e,b.attributes.texCoord0),v.uv0={data:e.typedBuffer,size:e.elementCount},f.uv0=d);c.isSome(b.attributes.color)&&(e=w.createBuffer(t.BufferViewVec4u8,p),4===b.attributes.color.elementCount?b.attributes.color instanceof t.BufferViewVec4f?B.vec4.scale(e,b.attributes.color,255):b.attributes.color instanceof t.BufferViewVec4u8?
w.vec4.copy(e,b.attributes.color):b.attributes.color instanceof t.BufferViewVec4u16&&B.vec4.scale(e,b.attributes.color,1/256):(w.vec4.fill(e,255,255,255,255),D=new t.BufferViewVec3u8(e.buffer,0,4),b.attributes.color instanceof t.BufferViewVec3f?B.vec3.scale(D,b.attributes.color,255):b.attributes.color instanceof t.BufferViewVec3u8?w.vec3.copy(D,b.attributes.color):b.attributes.color instanceof t.BufferViewVec3u16&&B.vec3.scale(D,b.attributes.color,1/256)),v.color={data:e.typedBuffer,size:e.elementCount},
f.color=d);b=new aa(new ba.GeometryData(v,f),"gltf_"+m.name+"_"+A++);q.stageResources.geometries.push(b);q.stageResources.materials.push(F.get(n));u&&(c.isSome(a.textureColor)&&q.stageResources.textures.push(g.get(a.textureColor)),c.isSome(a.textureNormal)&&q.stageResources.textures.push(g.get(a.textureNormal)),c.isSome(a.textureOcclusion)&&q.stageResources.textures.push(g.get(a.textureOcclusion)),c.isSome(a.textureEmissive)&&q.stageResources.textures.push(g.get(a.textureEmissive)),c.isSome(a.textureMetallicRoughness)&&
q.stageResources.textures.push(g.get(a.textureMetallicRoughness)));q.numberOfVertices+=p;n=b.boundingInfo;G.expand(q.boundingBox,n.getBBMin());G.expand(q.boundingBox,n.getBBMax())})}});return I}function ca(c){switch(c){case "BLEND":return 0;case "MASK":return 2;case "OPAQUE":return 1;default:return 0}}Object.defineProperty(A,"__esModule",{value:!0});A.fetch=function(B,h){return l.__awaiter(this,void 0,void 0,function(){var x,A,y,k,I,F,g,C,L,G,q,b;return l.__generator(this,function(n){switch(n.label){case 0:return x=
S(U.adjustStaticAGOUrl(B)),"wosr"!==x.fileType?[3,2]:[4,h.cache?h.cache.loadWOSR(x.url,h):R.load(x.url,h)];case 1:return A=n.sent(),y=R.processLoadResult(A,h),[2,{lods:[y],referenceBoundingBox:y.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:A.remove}];case 2:return[4,h.cache?h.cache.loadGLTF(x.url,h):Z.load(new Y.DefaultLoadingContext(h.streamDataRequester),x.url,h)];case 3:k=n.sent();I=c.get(k.model.meta,"ESRI_proxyEllipsoid");if(k.meta.isEsriSymbolResource&&c.isSome(I)&&-1!==k.meta.uri.indexOf("/RealisticTrees/"))a:{n=
k;for(var a=I,u=0;u<n.model.lods.length;++u){var p=n.model.lods[u];n.customMeta.esriTreeRendering=!0;for(var d=0,p=p.parts;d<p.length;d++){var f=p[d],z=f.attributes.normal;if(c.isNone(z))break a;for(var v=f.attributes.position,e=v.count,D=Q.vec3f64.create(),P=Q.vec3f64.create(),r=Q.vec3f64.create(),M=w.createBuffer(t.BufferViewVec4u8,e),H=w.createBuffer(t.BufferViewVec3f,e),N=W.mat4.invert(X.mat4f64.create(),f.transform),E=0;E<e;E++){v.getVec(E,P);z.getVec(E,D);m.vec3.transformMat4(P,P,f.transform);
m.vec3.subtract(r,P,a.center);m.vec3.divide(r,r,a.radius);var K=r[2],J=m.vec3.length(r),J=Math.min(.45+.55*J*J,1);m.vec3.divide(r,r,a.radius);m.vec3.transformMat4(r,r,N);m.vec3.normalize(r,r);u+1!==n.model.lods.length&&1<n.model.lods.length&&(-1<K?m.vec3.lerp(r,r,D,.2):m.vec3.lerp(r,r,D,Math.min(-4*K-3.8,1)));H.setVec(E,r);M.set(E,0,255*J);M.set(E,1,255*J);M.set(E,2,255*J);M.set(E,3,255)}f.attributes.normal=H;f.attributes.color=M}}}F=k.meta.isEsriSymbolResource?{usePBR:h.usePBR,isSchematic:!1,treeRendering:k.customMeta.esriTreeRendering,
mrrFactors:[0,1,.2]}:{usePBR:!0,isSchematic:!1,mrrFactors:[0,1,.5]};g=l.__assign(l.__assign({},h.materialParamsMixin),{treeRendering:k.customMeta.esriTreeRendering});if(null!=x.specifiedLodIndex)return C=O(k,F,g,x.specifiedLodIndex),L=C[0].boundingBox,0!==x.specifiedLodIndex&&(G=O(k,F,g,0),L=G[0].boundingBox),[2,{lods:C,referenceBoundingBox:L,isEsriSymbolResource:k.meta.isEsriSymbolResource,isWosr:!1,remove:k.remove}];q=O(k,F,g);b=q[0].boundingBox;return[2,{lods:q,referenceBoundingBox:b,isEsriSymbolResource:k.meta.isEsriSymbolResource,
isWosr:!1,remove:k.remove}]}})})};A.parseUrl=S;A.gltfToEngineResources=O});