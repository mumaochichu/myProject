// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../Color ../request ../core/Error ../core/lang ../core/Logger ../core/LRUCache ../core/maybe ../core/promiseUtils ../core/SetUtils ../core/string ../core/accessorSupport/decorators ../layers/support/fieldUtils ./Renderer ./mixins/VisualVariablesMixin ../support/arcadeOnDemand ../symbols/CIMSymbol".split(" "),function(W,X,c,L,D,M,f,N,O,p,E,P,Q,h,R,S,T,I,U){var V=N.getLogger("esri.renderers.DictionaryRenderer");return function(J){function b(a){a=J.call(this,a)||this;a._ongoingRequests=
new Map;a._symbolCache=new O(100);a.config=null;a.description=null;a.fieldMap=null;a.label=null;a.scaleExpression=null;a.url=null;a.type="dictionary";return a}c.__extends(b,J);n=b;b.prototype.clone=function(){return new n({config:f.clone(this.config),scaleExpression:f.clone(this.scaleExpression),description:f.clone(this.description),fieldMap:f.clone(this.fieldMap),label:f.clone(this.label),url:f.clone(this.url),visualVariables:f.clone(this.visualVariables)})};b.prototype.getSymbolAsync=function(a,
b){return c.__awaiter(this,void 0,void 0,function(){var z,d,l,g,k,e,m,f,q,t,h,A,r,x,u,y,v,B,K,F,w,C,p,n,G,H,D=this;return c.__generator(this,function(c){switch(c.label){case 0:this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(b)),c.label=1;case 1:return c.trys.push([1,3,,4]),[4,this._dictionaryPromise];case 2:return z=c.sent(),[3,4];case 3:return d=c.sent(),E.isAbortError(d)?(this._dictionaryPromise=null,[2,null]):[3,4];case 4:l={};g=0;for(k=this._symbolAttributes;g<k.length;g++)e=
k[g],(m=this.fieldMap[e])&&null!==a.attributes[m]&&void 0!==a.attributes[m]?(f=""+a.attributes[m],l[e]=f):l[e]="";q=z(l,b);if(!q||"string"!==typeof q)return[2,null];t=Q.numericHash(q).toString();if(h=this._symbolCache.get(t))return h.catch(function(){D._symbolCache.pop(t)}),[2,h];A=q.split(";");r=[];x=[];u=0;for(y=A;u<y.length;u++)if((v=y[u])&&0!==v.length)if(-1!==v.indexOf("po:"))B=v.substr(3).split("|"),3===B.length&&(K=B[0],F=B[1],w=B[2],"DashTemplate"===F?w=w.split(" ").map(function(a){return Number(a)}):
"Color"===F?(C=(new L(w)).toRgba(),w=[C[0],C[1],C[2],255*C[3]]):w=Number(w),x.push({primitiveName:K,propertyName:F,value:w}));else if(-1!==v.indexOf("|"))for(p=0,n=v.split("|");p<n.length;p++)G=n[p],this._itemNames.has(G)&&r.push(G);else this._itemNames.has(v)&&r.push(v);H=this._cimPartsToCIMSymbol(r,x,b);this._symbolCache.put(t,H,1);return[2,H]}})})};b.prototype.collectRequiredFields=function(a,b){return c.__awaiter(this,void 0,void 0,function(){var e,d;return c.__generator(this,function(c){switch(c.label){case 0:return[4,
this.collectVVRequiredFields(a,b)];case 1:return c.sent(),this.scaleExpression?[4,R.collectArcadeFieldNames(a,b,this.scaleExpression)]:[3,3];case 2:c.sent(),c.label=3;case 3:e=b.map(function(a){return a.name});for(d in this.fieldMap)0>e.indexOf(this.fieldMap[d])||a.add(this.fieldMap[d]);return[2]}})})};Object.defineProperty(b.prototype,"arcadeRequired",{get:function(){return!0},enumerable:!0,configurable:!0});b.prototype.fetchResources=function(a){return c.__awaiter(this,void 0,void 0,function(){var b,
z,d,l,g,k,h,m,f,q,t,n,A,r,x,u,y;return c.__generator(this,function(e){switch(e.label){case 0:if(!this.url)return V.error("no valid URL!"),[2,void 0];b=p.isSome(a)?a.abortOptions:null;z=D(this.url+"/resources/styles/dictionary-info.json",c.__assign({responseType:"json",query:{f:"json"}},b));return[4,E.all([z,I.loadArcade()])];case 1:d=e.sent()[0].data;if(!d)throw new M("esri.renderers.DictionaryRenderer","Bad dictionary data!");l=d.expression;g=d.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+
d.cimRefTemplateUrl;this._itemNames=P.SetFromValues(d.itemsNames);this._symbolAttributes=g.symbol;k={};if(this.config)for(m in h=this.config,h)k[m]=h[m];f=0;for(q=g.configuration;f<q.length;f++)m=q[f],k.hasOwnProperty(m.name)||(k[m.name]=m.value);t=[];if(p.isSome(a)&&a.fields)for(n=function(b){var d=A.fieldMap[b],e=a.fields.filter(function(a){return a.name===d});0<e.length&&t.push(c.__assign(c.__assign({},e[0]),{name:b}))},A=this,r=0,x=this._symbolAttributes;r<x.length;r++)m=x[r],n(m);return[4,I.createDictionaryExpression(l,
p.isSome(a)?a.spatialReference:null,t,k)];case 2:return u=e.sent(),y={scale:0},[2,function(a,b){a=u.repurposeFeature({geometry:null,attributes:a});y.scale=p.isSome(b)?b.scale:void 0;return u.evaluate({$feature:a,$view:y})}]}})})};b.prototype.getSymbol=function(){return null};b.prototype.getSymbols=function(){return[]};b.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(function(a,b){return a+b.getAttributeHash()},"")};b.prototype.getMeshHash=function(){return this.url+
"-"+JSON.stringify(this.fieldMap)};b.prototype._getSymbolPart=function(a,b){return c.__awaiter(this,void 0,void 0,function(){var e,d,l,g;return c.__generator(this,function(k){switch(k.label){case 0:if(this._ongoingRequests.has(a))return[2,this._ongoingRequests.get(a).then(function(a){return a.data})];e=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,a);d=D(e,c.__assign({responseType:"json",query:{f:"json"}},b));this._ongoingRequests.set(a,d);k.label=1;case 1:return k.trys.push([1,3,,4]),[4,d];
case 2:return l=k.sent(),[2,l.data];case 3:return g=k.sent(),this._ongoingRequests.delete(a),[2,E.reject(g)];case 4:return[2]}})})};b.prototype._combineSymbolParts=function(a,b){var e;if(!a||0===a.length)return null;if(1===a.length)return{type:"CIMSymbolReference",symbol:a[0],primitiveOverrides:b};var d=c.__assign({},a[0]);d.symbolLayers=[];for(var l=0;l<a.length;l++){var g=a[l];(e=d.symbolLayers).unshift.apply(e,g.symbolLayers)}return{type:"CIMSymbolReference",symbol:d,primitiveOverrides:b}};b.prototype._cimPartsToCIMSymbol=
function(a,b,f){return c.__awaiter(this,void 0,void 0,function(){var d,e,g;return c.__generator(this,function(c){switch(c.label){case 0:d=Array(a.length);for(e=0;e<a.length;e++)d[e]=this._getSymbolPart(a[e],f);return[4,E.all(d)];case 1:return g=c.sent(),[2,new U({data:this._combineSymbolParts(g,b)})]}})})};var n;c.__decorate([h.property({type:Object,json:{write:!0}})],b.prototype,"config",void 0);c.__decorate([h.property({type:String,json:{write:!0}})],b.prototype,"description",void 0);c.__decorate([h.property({type:Object,
json:{write:!0}})],b.prototype,"fieldMap",void 0);c.__decorate([h.property({type:String,json:{write:!0}})],b.prototype,"label",void 0);c.__decorate([h.property({type:String,json:{write:!0}})],b.prototype,"scaleExpression",void 0);c.__decorate([h.property({type:String,json:{write:!0}})],b.prototype,"url",void 0);return b=n=c.__decorate([h.subclass("esri.renderers.DictionaryRenderer")],b)}(T.VisualVariablesMixin(S))});