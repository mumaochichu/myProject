// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../request ../../core/Error ../../core/has ../../core/Logger ../../core/promiseUtils ../../core/urlUtils ../../core/accessorSupport/decorators ../../core/accessorSupport/originUtils ../../geometry/Extent ../../geometry/HeightModelInfo ../../geometry/SpatialReference ../support/arcgisLayerUrl ../support/commonProperties ../../portal/Portal ../../portal/PortalItem ../../webdoc/support/saveUtils @dojo/framework/shim/Promise".split(" "),function(B,l,b,r,m,G,g,n,t,e,w,
x,C,u,p,D,y,E,z){Object.defineProperty(l,"__esModule",{value:!0});var q=g.getLogger("esri.layers.mixins.SceneService");l.SceneService=function(g){return function(g){function c(){var a=null!==g&&g.apply(this,arguments)||this;a.spatialReference=null;a.fullExtent=null;a.heightModelInfo=null;a.minScale=0;a.maxScale=0;a.version={major:Number.NaN,minor:Number.NaN,versionString:""};a.copyright=null;a.sublayerTitleMode="item-title";a.title=null;a.layerId=null;return a}b.__extends(c,g);c.prototype.readSpatialReference=
function(a,d){return this._readSpatialReference(d)};c.prototype._readSpatialReference=function(a){if(null!=a.spatialReference)return u.fromJSON(a.spatialReference);a=a.store;a=(a=a.indexCRS||a.geographicCRS)&&parseInt(a.substring(a.lastIndexOf("/")+1,a.length),10);return null!=a?new u(a):null};c.prototype.readFullExtent=function(a,d){a=d.store;d=this._readSpatialReference(d);return null==d||null==a||null==a.extent||!Array.isArray(a.extent)||a.extent.some(function(a){return a<v})?null:new x({xmin:a.extent[0],
ymin:a.extent[1],xmax:a.extent[2],ymax:a.extent[3],spatialReference:d})};c.prototype.readVersion=function(a,d){a=d.store;d=null!=a.version?a.version.toString():"";a={major:Number.NaN,minor:Number.NaN,versionString:d};d=d.split(".");2<=d.length&&(a.major=parseInt(d[0],10),a.minor=parseInt(d[1],10));return a};c.prototype.readTitlePortalItem=function(a){return"item-title"!==this.sublayerTitleMode?void 0:a};c.prototype.readTitleService=function(a,d){a=this.portalItem&&this.portalItem.title;if("item-title"===
this.sublayerTitleMode)return p.titleFromUrlAndName(this.url,d.name);d=d.name||p.parse(this.url).title;"item-title-and-service-name"===this.sublayerTitleMode&&a&&(d=a+" - "+d);return p.cleanTitle(d)};Object.defineProperty(c.prototype,"url",{set:function(a){a=p.sanitizeUrlWithLayerId(this,a,q);this._set("url",a.url);null!=a.layerId&&this._set("layerId",a.layerId)},enumerable:!0,configurable:!0});c.prototype.writeUrl=function(a,d,b,c){p.writeUrlWithLayerId(this,a,"layers",d,c)};Object.defineProperty(c.prototype,
"parsedUrl",{get:function(){var a=this._get("url");if(!a)return null;a=t.urlToObject(a);null!=this.layerId&&p.isArcGISUrl(a.path)&&(a.path=a.path+"/layers/"+this.layerId);return a},enumerable:!0,configurable:!0});c.prototype._verifyRootNodeAndUpdateExtent=function(a,d){return b.__awaiter(this,void 0,void 0,function(){var c,f,h;return b.__generator(this,function(b){switch(b.label){case 0:if(!a)return[3,4];b.label=1;case 1:return b.trys.push([1,3,,4]),c=this._updateExtentFromRootPage,f=[a],[4,this._fetchRootPage(a,
d)];case 2:return[2,c.apply(this,f.concat([b.sent()]))];case 3:return b.sent(),[3,4];case 4:return h=this._updateExtentFromRootNode,[4,this._fetchRootNode(d)];case 5:return[2,h.apply(this,[b.sent()])]}})})};c.prototype._fetchRootPage=function(a,d){return b.__awaiter(this,void 0,void 0,function(){var c,f,h;return b.__generator(this,function(b){switch(b.label){case 0:if(!a)return[2,n.reject()];c=Math.floor(a.rootIndex/a.nodesPerPage);f=this.parsedUrl.path+"/nodepages/"+c;return[4,r(f,{responseType:"json",
signal:d})];case 1:return h=b.sent(),[2,h.data]}})})};c.prototype._updateExtentFromRootPage=function(a,d){if(null==d||null==d.nodes)throw new m("sceneservice:invalid-node-page","Inavlid node page.");d=d.nodes[a.rootIndex%a.nodesPerPage];if(null==d||null==d.obb||null==d.obb.center||null==d.obb.halfSize)throw new m("sceneservice:invalid-node-page","Inavlid node page.");d.obb.center[0]<v||(a=d.obb.halfSize,d=d.obb.center[2],a=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),this.fullExtent.zmin=d-a,this.fullExtent.zmax=
d+a)};c.prototype._updateExtentFromRootNode=function(a){if(null!=a&&null!=this.fullExtent&&!this.fullExtent.hasZ&&Array.isArray(a.mbs)&&4===a.mbs.length&&!(a.mbs[0]<v)){var d=a.mbs[2];a=a.mbs[3];this.fullExtent.zmin=d-a;this.fullExtent.zmax=d+a}};c.prototype._fetchRootNode=function(a){return b.__awaiter(this,void 0,void 0,function(){var d,c,f;return b.__generator(this,function(b){switch(b.label){case 0:if(!this.rootNode)return[2];d=t.join(this.parsedUrl.path,this.rootNode);b.label=1;case 1:return b.trys.push([1,
3,,4]),[4,r(d,{query:{f:"json"},responseType:"json",signal:a})];case 2:return c=b.sent(),[2,c.data];case 3:throw f=b.sent(),new m("sceneservice:root-node-missing","Root node missing.",{error:f,url:d});case 4:return[2]}})})};c.prototype._fetchService=function(a){return b.__awaiter(this,void 0,void 0,function(){var d;return b.__generator(this,function(b){switch(b.label){case 0:return null==this.layerId&&/SceneServer\/*$/i.test(this.url)?[4,this._fetchFirstLayerId(a)]:[3,2];case 1:d=b.sent(),null!=d&&
(this.layerId=d),b.label=2;case 2:return[2,this._fetchServiceLayer(a)]}})})};c.prototype._fetchFirstLayerId=function(a){return b.__awaiter(this,void 0,void 0,function(){var d;return b.__generator(this,function(b){switch(b.label){case 0:return[4,r(this.url,{query:{f:"json"},responseType:"json",signal:a})];case 1:return d=b.sent(),d.data&&Array.isArray(d.data.layers)&&0<d.data.layers.length?[2,d.data.layers[0].id]:[2,void 0]}})})};c.prototype._fetchServiceLayer=function(a){return b.__awaiter(this,void 0,
void 0,function(){var d,c;return b.__generator(this,function(b){switch(b.label){case 0:return[4,r(this.parsedUrl.path,{query:{f:"json"},responseType:"json",signal:a})];case 1:return d=b.sent(),d.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),c=d.data,this.read(c,{origin:"service",url:this.parsedUrl}),this.validateLayer(c),[2]}})})};c.prototype._ensureLoadBeforeSave=function(){return b.__awaiter(this,void 0,void 0,function(){return b.__generator(this,function(a){switch(a.label){case 0:return[4,
this.load()];case 1:return a.sent(),"beforeSave"in this&&"function"===typeof this.beforeSave?[4,this.beforeSave()]:[3,3];case 2:a.sent(),a.label=3;case 3:return[2]}})})};c.prototype.validateLayer=function(a){};c.prototype._updateTypeKeywords=function(a,d){a.typeKeywords||(a.typeKeywords=[]);var b=0;for(d=d.getTypeKeywords();b<d.length;b++)a.typeKeywords.push(d[b]);a.typeKeywords&&(a.typeKeywords=a.typeKeywords.filter(function(a,d,b){return b.indexOf(a)===d}))};c.prototype._saveAs=function(a,d){return b.__awaiter(this,
void 0,void 0,function(){var c,f,h,e,g;return b.__generator(this,function(k){switch(k.label){case 0:c=b.__assign(b.__assign({},A),d);if(f=E.from(a))return[3,2];q.error("_saveAs(): requires a portal item parameter");return[4,n.reject(new m("sceneservice:portal-item-required","_saveAs() requires a portal item to save to"))];case 1:k.sent(),k.label=2;case 2:return f.id&&(f=f.clone(),f.id=null),h=f.portal||y.getDefault(),[4,this._ensureLoadBeforeSave()];case 3:return k.sent(),f.type=l.SCENE_SERVICE_ITEM_TYPE,
f.portal=h,e={origin:"portal-item",url:null,messages:[],portal:h,portalItem:f,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},g={layers:[this.write(null,e)]},[4,n.all(e.resources.pendingOperations)];case 4:return k.sent(),[4,this._validateAgainstJSONSchema(g,e,c)];case 5:return k.sent(),f.url=this.url,f.title||(f.title=this.title),this._updateTypeKeywords(f,c),[4,h._signIn()];case 6:return k.sent(),[4,h.user.addItem({item:f,folder:c&&c.folder,
data:g})];case 7:return k.sent(),[4,z.saveResources(this.resourceReferences,e,null)];case 8:return k.sent(),this.portalItem=f,w.updateOrigins(e),e.portalItem=f,[2,f]}})})};c.prototype._save=function(a){return b.__awaiter(this,void 0,void 0,function(){var d,c,f;return b.__generator(this,function(e){switch(e.label){case 0:d=b.__assign(b.__assign({},A),a);if(this.portalItem)return[3,2];q.error("_save(): requires the .portalItem property to be set");return[4,n.reject(new m("sceneservice:portal-item-not-set",
"Portal item to save to has not been set on this SceneService"))];case 1:e.sent(),e.label=2;case 2:if(this.portalItem.type===l.SCENE_SERVICE_ITEM_TYPE)return[3,4];q.error("_save(): Non-matching portal item type. Got "+this.portalItem.type+", expected "+l.SCENE_SERVICE_ITEM_TYPE);return[4,n.reject(new m("sceneservice:portal-item-wrong-type",'Portal item needs to have type "'+l.SCENE_SERVICE_ITEM_TYPE+'"'))];case 3:e.sent(),e.label=4;case 4:return[4,this._ensureLoadBeforeSave()];case 5:return e.sent(),
c={origin:"portal-item",url:this.portalItem.itemUrl&&t.urlToObject(this.portalItem.itemUrl),messages:[],portal:this.portalItem.portal||y.getDefault(),portalItem:this.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},f={layers:[this.write(null,c)]},[4,n.all(c.resources.pendingOperations)];case 6:return e.sent(),[4,this._validateAgainstJSONSchema(f,c,d)];case 7:return e.sent(),this.portalItem.url=this.url,this.portalItem.title||(this.portalItem.title=
this.title),this._updateTypeKeywords(this.portalItem,d),[4,this.portalItem.update({data:f})];case 8:return e.sent(),[4,z.saveResources(this.resourceReferences,c,null)];case 9:return e.sent(),w.updateOrigins(c),[2,this.portalItem]}})})};c.prototype._validateAgainstJSONSchema=function(a,d,c){return b.__awaiter(this,void 0,void 0,function(){var e,h,g,k,l,n;return b.__generator(this,function(b){switch(b.label){case 0:return e=d.messages.filter(function(a){return"error"===a.type}).map(function(a){return new m(a.name,
a.message,a.details)}),c&&c.validationOptions.ignoreUnsupported&&(e=e.filter(function(a){return"layer:unsupported"!==a.name&&"symbol:unsupported"!==a.name&&"symbol-layer:unsupported"!==a.name&&"property:unsupported"!==a.name&&"url:unsupported"!==a.name&&"scenemodification:unsupported"!==a.name})),c.validationOptions.enabled||F?[4,new Promise(function(a,b){B(["../../portal/schemas/validator"],a,b)})]:[3,2];case 1:h=b.sent();g=h.validate(a,c.portalItemLayerType);if(0<g.length&&(k="Layer item did not validate:\n"+
g.join("\n"),q.error("_validateAgainstJSONSchema(): "+k),"throw"===c.validationOptions.failPolicy))throw l=g.map(function(a){return new m("sceneservice:schema-validation",a)}),n=l.concat(e),new m("sceneservice-validate:error","Failed to save layer item due to schema validation, see `details.errors`.",{combined:n});b.label=2;case 2:if(0<e.length)throw new m("sceneservice:save","Failed to save SceneService due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:e});
return[2]}})})};b.__decorate([e.property({json:{origins:{service:{read:!1},"portal-item":{read:!1}}}})],c.prototype,"id",void 0);b.__decorate([e.property({type:u})],c.prototype,"spatialReference",void 0);b.__decorate([e.reader("spatialReference",["spatialReference","store.indexCRS","store.geographicCRS"])],c.prototype,"readSpatialReference",null);b.__decorate([e.property({type:x})],c.prototype,"fullExtent",void 0);b.__decorate([e.reader("fullExtent",["store.extent","spatialReference","store.indexCRS",
"store.geographicCRS"])],c.prototype,"readFullExtent",null);b.__decorate([e.property({readOnly:!0,type:C})],c.prototype,"heightModelInfo",void 0);b.__decorate([e.property({type:Number,json:{read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"},origins:{service:{read:{source:"minScale"},write:!1}}}})],c.prototype,"minScale",void 0);b.__decorate([e.property({type:Number,json:{read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"},origins:{service:{read:{source:"maxScale"},
write:!1}}}})],c.prototype,"maxScale",void 0);b.__decorate([e.property({readOnly:!0})],c.prototype,"version",void 0);b.__decorate([e.reader("version",["store.version"])],c.prototype,"readVersion",null);b.__decorate([e.property({type:String,json:{read:{source:"copyrightText"}}})],c.prototype,"copyright",void 0);b.__decorate([e.property({type:String,json:{read:!1}})],c.prototype,"sublayerTitleMode",void 0);b.__decorate([e.property({type:String})],c.prototype,"title",void 0);b.__decorate([e.reader("portal-item",
"title")],c.prototype,"readTitlePortalItem",null);b.__decorate([e.reader("service","title",["name"])],c.prototype,"readTitleService",null);b.__decorate([e.property({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{write:{target:"id",isRequired:!0,ignoreOrigin:!0},read:!1}}}})],c.prototype,"layerId",void 0);b.__decorate([e.property(D.url)],c.prototype,"url",null);b.__decorate([e.writer("url")],c.prototype,"writeUrl",null);b.__decorate([e.property({dependsOn:["layerId"]})],c.prototype,
"parsedUrl",null);b.__decorate([e.property({readOnly:!0})],c.prototype,"store",void 0);b.__decorate([e.property({type:String,readOnly:!0,json:{read:{source:"store.rootNode"}}})],c.prototype,"rootNode",void 0);return c=b.__decorate([e.subclass("esri.layers.mixins.SceneService")],c)}(g)};var v=-1E38,F=0;l.SCENE_SERVICE_ITEM_TYPE="Scene Service";var A={getTypeKeywords:function(){return[]},portalItemLayerType:"unknown",validationOptions:{enabled:!0,ignoreUnsupported:!1,failPolicy:"throw"}}});