// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Graphic ../../intl ../../core/Error ../../core/Handles ../../core/lang ../../core/Logger ../../core/promiseUtils ../../core/string ../../core/throttle ../../core/watchUtils ../../core/accessorSupport/decorators ../../intl/date ../../intl/number ../../layers/support/fieldUtils ../../popup/FieldInfo ../../popup/content/TextContent ../../popup/content/support/ChartMediaInfoValueSeries ../../popup/support/FieldInfoFormat ../Attachments/AttachmentsViewModel ./FeatureContent/FeatureContentViewModel ./FeatureFields/FeatureFieldsViewModel ./support/featureUtils ./support/RelatedFeatures @dojo/framework/shim/Promise".split(" "),
function(H,Y,g,I,y,D,J,u,K,r,z,L,M,n,N,E,O,P,Q,R,S,T,F,U,t,V){function W(){return new Promise(function(g,d){H(["../../support/arcadeUtils"],g,d)})}function v(g){var d=/(\n)/gi;return"string"===typeof g?g.replace(d,'\x3cbr class\x3d"esri-text-new-line" /\x3e'):g}function A(g,d){return g&&"function"===typeof g.getField?g.getField(d):null}function B(g){return g.replace(/[\u00A0-\u9999<>\&]/gim,function(d){return"\x26#"+d.charCodeAt(0)+";"})}var X=["$datastore","$map","$layer"],w=K.getLogger("esri.widgets.FeatureViewModel"),
C=N.convertDateFormatToIntlOptions("short-date-short-time");return function(G){function d(a){var b=G.call(this,a)||this;b._handles=new J;b._featureAbortController=null;b._graphicChangedThrottled=L.throttle(b._graphicChanged,1,b);b._effectivePopupTemplate=null;b._graphic=null;b._fieldInfoMap=null;b.content=null;b.contentVMs=[];b.defaultPopupTemplateEnabled=!1;b.formattedAttributes=null;b.graphic=null;b.lastEditInfo=null;b.title="";b.view=null;b._handles.add(M.init(b,"graphic graphic.sourceLayer.popupTemplate.title graphic.sourceLayer.popupTemplate.content graphic.sourceLayer.popupTemplate.expressionInfos graphic.sourceLayer.popupTemplate.fieldInfos graphic.sourceLayer.popupTemplate.lastEditInfoEnabled graphic.sourceLayer.popupTemplate.outFields graphic.sourceLayer.popupTemplate.relatedRecordsInfo graphic.popupTemplate.title graphic.popupTemplate.content graphic.popupTemplate.expressionInfos graphic.popupTemplate.fieldInfos graphic.popupTemplate.lastEditInfoEnabled graphic.popupTemplate.outFields graphic.popupTemplate.relatedRecordsInfo".split(" "),
function(){return b._graphicChangedThrottled()}));return b}g.__extends(d,G);d.prototype.destroy=function(){this._clear();this._cancelFeatureQuery();this._handles.destroy();this._graphic=this.graphic=this._handles=null;this._destroyContentViewModels()};Object.defineProperty(d.prototype,"spatialReference",{get:function(){return this.get("view.spatialReference")||null},set:function(a){void 0===a?this._clearOverride("spatialReference"):this._override("spatialReference",a)},enumerable:!0,configurable:!0});
Object.defineProperty(d.prototype,"map",{get:function(){return this.get("view.map")||null},set:function(a){void 0===a?this._clearOverride("map"):this._override("map",a)},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"waitingForContent",{get:function(){return!!this._featureAbortController},enumerable:!0,configurable:!0});d.prototype._clear=function(){this._set("title","");this._set("content",null);this._set("formattedAttributes",null)};d.prototype._graphicChanged=function(){return g.__awaiter(this,
void 0,void 0,function(){var a,b,c,e;return g.__generator(this,function(f){switch(f.label){case 0:this._cancelFeatureQuery();this._clear();this._graphic=b=(a=this.graphic)?a.clone():null;if(!b)return[2];this._featureAbortController=c=r.createAbortController();f.label=1;case 1:return f.trys.push([1,3,,4]),[4,this._queryFeature({signal:c.signal})];case 2:return f.sent(),[3,4];case 3:return e=f.sent(),w.error("error","error loading template",e),[3,4];case 4:return this._featureAbortController=null,[2]}})})};
d.prototype._cancelFeatureQuery=function(){var a=this._featureAbortController;a&&a.abort();this._featureAbortController=null};d.prototype._compileContent=function(a){var b=this;this._destroyContentViewModels();if(this._graphic)return Array.isArray(a)?a.map(function(a,e){if("attachments"===a.type)return b._compileAttachments(a,e);if("custom"===a.type)return b._compileCustom(a,e);if("fields"===a.type)return b._compileFields(a,e);if("media"===a.type)return b._compileMedia(a);if("text"===a.type)return b._compileText(a,
e)}):"string"===typeof a?this._compileText(new Q({text:a}),0).text:a};d.prototype._destroyContentViewModels=function(){this.contentVMs.forEach(function(a){return a&&!a.destroyed&&a.destroy()});this._set("contentVMs",[])};d.prototype._compileAttachments=function(a,b){this.contentVMs[b]=new T({graphic:this.graphic});return a};d.prototype._compileCustom=function(a,b){this.contentVMs[b]=new F({graphic:this.graphic,creator:a.creator,destroyer:a.destroyer});return a};d.prototype._compileFields=function(a,
b){var c=this._effectivePopupTemplate,e=this.formattedAttributes,f=a.clone();a=(null===a||void 0===a?void 0:a.fieldInfos)||(null===c||void 0===c?void 0:c.fieldInfos);c=null===c||void 0===c?void 0:c.expressionInfos;e=g.__assign(g.__assign({},e.global),e.content[b]);e=new U({attributes:e,expressionInfos:c,fieldInfos:a});this.contentVMs[b]=e;f.fieldInfos=u.clone(e.formattedFieldInfos);return f};d.prototype._setImageValue=function(a){var b=a.value,c=a.formattedAttributes;a=a.layer;var e=b.linkURL,f=b.sourceURL;
f&&(f=this._fixTokens(f,a),b.sourceURL=this._substituteAttributes(c,f));e&&(a=this._fixTokens(e,a),b.linkURL=this._substituteAttributes(c,a))};d.prototype._compileMedia=function(a){var b=this,c=this._graphic;a=u.clone(a);var e=a.mediaInfos,f=c.attributes,d=t.getSourceLayer(c),h=this.formattedAttributes.global,k=g.__assign(g.__assign({},h),f);a.mediaInfos=e&&e.map(function(a){if(a=u.clone(a)){var c=a.title?b._processFieldsInLinks(a.title,k):"";a.title=c?b._substituteAttributes(h,c):"";c=a.caption?
b._processFieldsInLinks(a.caption,k):"";a.caption=c?b._substituteAttributes(h,c):"";c=a.altText?b._processFieldsInLinks(a.altText,k):"";a.altText=c?b._substituteAttributes(h,c):"";if("image"===a.type)return c=a.value,b._setImageValue({value:c,formattedAttributes:h,layer:d}),a.value.sourceURL?a:void 0;if("pie-chart"===a.type||"line-chart"===a.type||"column-chart"===a.type||"bar-chart"===a.type)return c=a.value,b._setChartValue({value:c,chartType:a.type,attributes:f,formattedAttributes:h,layer:d}),
a}}).filter(Boolean);return a};d.prototype._normalizeTemplateFields=function(a){var b=this._fieldInfoMap.get(a.toLowerCase());return"{"+(b&&b.fieldName||a)+"}"};d.prototype._substituteAttributes=function(a,b){var c=this;return(""+this._removeEmptyHref(z.replace(z.replace(b,function(a){return c._normalizeTemplateFields(a)}),a))).trim()};d.prototype._compileText=function(a,b){a=u.clone(a);var c=this._graphic;if(a&&a.text){var e=c.attributes,f=this.formattedAttributes.global,e=this._processFieldsInLinks(a.text,
g.__assign(g.__assign({},f),e));a.text=this._substituteAttributes(f,e)}this.contentVMs[b]=new F({graphic:c,creator:a.text});return a};d.prototype._formatEditInfo=function(a,b){var c=a.creatorField,e=a.creationDateField,f=a.editorField;if(b){a=b[a.editDateField];if("number"===typeof a)return b=b[f],c=y.formatDate(a,C),{type:"edit",date:c,user:b};e=b[e];if("number"===typeof e)return b=b[c],c=y.formatDate(e,C),{type:"create",date:c,user:b}}};d.prototype._compileLastEditInfo=function(){var a=this._effectivePopupTemplate,
b=this._graphic;if(a){var a=a.lastEditInfoEnabled,c=b.get("sourceLayer.editFieldsInfo");if(a&&c)return this._formatEditInfo(c,b.attributes)}};d.prototype._compileTitle=function(a){var b=this._graphic.attributes,c=this.formattedAttributes.global;return a?(a=this._processFieldsInLinks(a,g.__assign(g.__assign({},c),b)),this._substituteAttributes(c,a)):""};d.prototype._fixTokens=function(a,b){return a.replace(/(\{([^\{\r\n]+)\})/g,function(a,e,f){return(a=A(b,f))?"{"+a.name+"}":e})};d.prototype._encodeAttributes=
function(a){var b=a?u.clone(a):{};Object.keys(b).forEach(function(a){var c=b[a];"string"===typeof c&&(c=encodeURIComponent(c).replace(/\'/g,"\x26apos;"),b[a]=c)});return b};d.prototype._createfieldInfoMap=function(a,b){var c=this,e=new Map;a&&a.forEach(function(a){var f=c._getFixedFieldName(a.fieldName,b);a.fieldName=f;e.set(f.toLowerCase(),a)});return e};d.prototype._formatAttributeValue=function(a){var b=a.value,c=a.fieldName,e=a.fieldInfos,f=a.fieldInfoMap;a=a.layer;if(null==b)return"";var d=this._getDomainName(c,
b);return d||(d=this._getTypeName(c))?d:f.get(c.toLowerCase())?this._formatValueToFieldInfo(b,{fieldInfos:e,fieldName:c,layer:a}):(e=a&&a.fieldsIndex)&&e.isDateField(c)?y.formatDate(b,C):v(b)};d.prototype._formatAttributes=function(a){var b=this,c=this._graphic,e=t.getSourceLayer(c),f=u.clone(c.attributes);this.addRelatedFeatureAttributes(f);var d=this._createfieldInfoMap(a,e);this._fieldInfoMap=d;Object.keys(f).forEach(function(c){f[c]=b._formatAttributeValue({fieldName:c,fieldInfos:a,fieldInfoMap:d,
layer:e,value:f[c]})});return f};d.prototype._parseNumberFromString=function(a,b){return"string"!==typeof a||!b||null!=b.dateFormat||null==b.places&&null==b.digitSeparator||(b=Number(a),isNaN(b))?a:b};d.prototype._formatValueToFieldInfo=function(a,b){var c=b.fieldName,e=this._getFieldInfo(b.fieldInfos,c),f=u.clone(e),e=b.preventPlacesFormatting;(b=A(b.layer,c))&&"date"===b.type&&(b=f.format||new S,b.dateFormat=b.dateFormat||"short-date-short-time",f.format=b);f=f&&f.format;a=this._parseNumberFromString(a,
f);return"string"===typeof a||null==a||null==f?a:e?E.formatNumber(a,g.__assign(g.__assign({},E.convertNumberFormatToIntlOptions(f)),{minimumFractionDigits:0,maximumFractionDigits:20})):f.format(a)};d.prototype._getDomainName=function(a,b){if(this.isRelatedField(a))return null;var c=this._graphic,e=t.getSourceLayer(c);return e&&"function"===typeof e.getFieldDomain?(a=e.getFieldDomain(a,{feature:c}))&&"coded-value"===a.type?a.getName(b):null:null};d.prototype._getFieldInfo=function(a,b){if(a&&a.length&&
b){var c=b.toLowerCase(),e=void 0;a.some(function(a){return a.fieldName&&a.fieldName.toLowerCase()===c?(e=a,!0):!1});return e}};d.prototype._getTypeName=function(a){if(this.isRelatedField(a))return null;var b=this._graphic,c=t.getSourceLayer(b);if(!c||"function"!==typeof c.getFeatureType)return null;var e=c.typeIdField;return e&&a===e?(a=c.getFeatureType(b))?a.name:null:null};d.prototype._removeEmptyHref=function(a){return a.replace(/href=(""|'')/gi,"")};d.prototype._processFieldsInLinks=function(a,
b){var c=this.get("_graphic.layer");a=this._fixTokens(a,c);var e=this._encodeAttributes(b),c=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi;return a?a.replace(c,function(a,c,d){c=(""+(c||d)).trim();return z.replace(a,c&&"{"===c[0]?b:e)}):a};d.prototype._getTitle=function(){return g.__awaiter(this,void 0,void 0,function(){var a,b,c,e;return g.__generator(this,function(f){a=this;b=a._effectivePopupTemplate;c=a._graphic;e=b&&b.title;return[2,t.graphicCallback(e,{graphic:c})]})})};d.prototype._getContent=
function(){return g.__awaiter(this,void 0,void 0,function(){var a,b,c,e;return g.__generator(this,function(f){a=this;b=a._effectivePopupTemplate;c=a._graphic;e=b&&b.content;return[2,t.graphicCallback(e,{graphic:c})]})})};d.prototype._querySourceLayer=function(a,b){var c=a.layer,e=a.graphic,f=a.outFields;a=a.objectIds;var d=a[0];if("number"!==typeof d)return b="Could not query required fields for the specified feature. The feature's ID is invalid.",c={layer:c,graphic:e,objectId:d,requiredFields:f},
f=new D("layer-query-features-invalid-objectid",b,c),w.warn(b,c),r.reject(f);if("function"!==typeof c.queryFeatures)return b="The specified layer does not support the method 'queryFeatures'. The following fields will not be available.",c={layer:c,graphic:e,requiredFields:f},f=new D("layer-query-features-unsupported",b,c),w.warn(b,c),r.reject(f);e=c.createQuery();e.objectIds=a;e.outFields=f;e.returnGeometry=!0;return c.queryFeatures(e,b).then(function(a){return a.features[0]})};d.prototype._queryRequiredFieldsFeature=
function(a){var b=this,c=this._graphic,e=this._effectivePopupTemplate,f=c.sourceLayer;return f&&e?("function"===typeof f.load?f.load(a):r.resolve()).then(function(){var d=[c.attributes[f.objectIdField]];return e.getRequiredFields(f.fields).then(function(e){return O.featureHasFields(e,c)?null:b._querySourceLayer({layer:f,graphic:c,outFields:e,objectIds:d},a)})}):r.resolve(null)};d.prototype._queryFeature=function(a){var b=this,c=this._featureAbortController,e=this._graphic;this._effectivePopupTemplate=
e&&e.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled);return r.eachAlways({content:this._getContent(),title:this._getTitle()}).then(function(f){var d=f.content.value,h=f.title.value;if(c===b._featureAbortController&&e){f=b._checkForRelatedFeatures(d,a);var k=b._createFormattedExpressions().then(function(a){e.attributes=g.__assign(g.__assign({},e.attributes),a)}),m=b._queryRequiredFieldsFeature(a).then(function(a){a&&(e.geometry=a.geometry,e.attributes=g.__assign(g.__assign({},e.attributes),
a.attributes))});return r.eachAlways([f,k,m]).then(function(){if(c===b._featureAbortController&&e){b._set("formattedAttributes",b._createFormattedAttributes(d));b._set("title",b._compileTitle(h));var a=b._compileLastEditInfo();b._set("lastEditInfo",a||null);a=b._compileContent(d);b._set("content",a||null);return a}})}})};d.prototype._formatArcadeArray=function(a){return'\x3cul class\x3d"esri-widget__list"\x3e'+a.map(function(a){return"\x3cli\x3e"+("string"===typeof a?v(B(a)):a)+"\x3c/li\x3e"}).join("")+
"\x3c/ul\x3e"};d.prototype._formatArcadeDictionary=function(a){return'\x3ctable class\x3d"esri-widget__table"\x3e'+a.keys().map(function(b){var c=a.field(b),c="string"===typeof c?v(B(c)):c;return"\x3ctr\x3e\x3cth\x3e"+b+"\x3c/th\x3e\x3ctd\x3e"+c+"\x3c/td\x3e\x3c/tr\x3e"}).join("")+"\x3c/table\x3e"};d.prototype._createFormattedExpressions=function(){return g.__awaiter(this,void 0,void 0,function(){var a,b,c,e,d,x,h,k,m,l,p,q=this;return g.__generator(this,function(f){switch(f.label){case 0:return a=
this,b=a._effectivePopupTemplate,c=a._graphic,e=b&&b.expressionInfos,d=[],x={},e&&e.length?[4,W()]:[2,x];case 1:h=f.sent();k=function(a){var b="expression/"+a.name,e=h.createSyntaxTree(a.expression),f=X.filter(function(a){return h.hasVariable(e,a)});a=h.loadScriptDependencies(e,!0,f).then(function(){return g.__awaiter(q,void 0,void 0,function(){var a,d,k,q,m=this;return g.__generator(this,function(g){a=this.spatialReference;d=h.getViewInfo({spatialReference:a});k=h.createExecContext(c,d);k.useAsync=
!0;this._addVarsToContext(h,f,k,d);q=h.createFunction(e,k);return[2,h.executeAsyncFunction(q,k).then(function(a){x[b]="string"===typeof a?v(B(a)):Array.isArray(a)?m._formatArcadeArray(a):a&&"esri.arcade.Dictionary"===a.declaredClass?m._formatArcadeDictionary(a):a},function(a){return w.error("arcade-execution-error",a)})]})})});d.push(a)};m=0;for(l=e;m<l.length;m++)p=l[m],k(p);return[2,r.eachAlways(d).then(function(){return x})]}})})};d.prototype._addVarsToContext=function(a,b,c,e){var d=this.graphic,
g=this.map;b.forEach(function(b){b=b.toLowerCase();var f={map:g,spatialReference:e.sr};"$map"===b&&(c.vars[b]=a.convertMapToFeatureSetCollection(f));"$layer"===b&&(c.vars[b]=a.convertFeatureLayerToFeatureSet(d.sourceLayer,e.sr));"$datastore"===b&&(c.vars[b]=a.convertServiceUrlToWorkspace(d.sourceLayer.url,e.sr))})};d.prototype._createFormattedAttributes=function(a){var b=this,c=this._effectivePopupTemplate,e={global:this._formatAttributes(c&&c.fieldInfos),content:[]};Array.isArray(a)&&a.forEach(function(a,
c){"fields"===a.type&&a.fieldInfos&&(e.content[c]=b._formatAttributes(a.fieldInfos))});return e};d.prototype._getAllFieldInfos=function(a){var b=this._effectivePopupTemplate,c=[];(b=b&&b.fieldInfos)&&c.push.apply(c,b);if(!a||!Array.isArray(a))return c;a.forEach(function(a){"fields"===a.type&&c.push.apply(c,a&&a.fieldInfos)});return c};d.prototype._checkForRelatedFeatures=function(a,b){var c=this._graphic;a=this._getAllFieldInfos(a);return this.queryRelatedInfos(c,a,b)};d.prototype._getTooltip=function(a){var b=
a.label;return"pie-chart"===a.chartType?b:b+": "+a.value};d.prototype._getChartOption=function(a){var b,c=a.value,e=a.attributes,d=a.formattedAttributes,g=a.fieldName,h=a.relatedFieldName,k=a.fieldInfos,m=a.index;a=a.chartType;var l=t.getSourceLayer(this._graphic),p=c.normalizeField,c=c.tooltipField,p=p?this.isRelatedField(p)?e[this.getRelatedFieldInfo(p).fieldName]:e[p]:null,q=h&&void 0!==e[h]?e[h]:void 0!==e[g]?e[g]:d[g],q=void 0===q?null:q&&p?q/p:q,m=new R({x:m,y:q});if(this.isRelatedField(g))return b=
this.getRelatedFieldInfo(g),d=(d=this.getRelatedFieldInfo(c))?d.fieldName:null,k=this._formatValueToFieldInfo(q,{fieldInfos:k,fieldName:h,layer:l,preventPlacesFormatting:!!p}),h=b?b.label||b.fieldName:h,m.tooltip=this._getTooltip({label:d&&void 0!==e[d]?e[d]:h,value:k,chartType:a}),m;e=this._getFieldInfo(k,g);h=this._getFixedFieldName(g,l);e=c&&void 0!==d[c]?d[c]:t.getFieldInfoLabel(e||new P({fieldName:h}),null===(b=this._effectivePopupTemplate)||void 0===b?void 0:b.expressionInfos);m.tooltip=this._getTooltip({label:e,
value:d[h],chartType:a});return m};d.prototype._getFixedFieldName=function(a,b){return(b=A(b,a))?b.name:a};d.prototype._getFixedFieldNames=function(a,b){var c=this;return a&&a.map(function(a){return c._getFixedFieldName(a,b)})};d.prototype._setChartValue=function(a){var b=this,c=a.value,e=a.attributes,d=a.formattedAttributes,n=a.chartType;a=a.layer;var h=this._effectivePopupTemplate,k=this.relatedInfoCount,m=c.fields,l=c.normalizeField;c.fields=this._getFixedFieldNames(m,a);l&&(c.normalizeField=this._getFixedFieldName(l,
a));if(m.some(function(a){return!!(null!=d[a]||b.isRelatedField(a)&&k)})){var p=h&&h.fieldInfos;m.forEach(function(a,f){b.isRelatedField(a)?c.series=g.__spreadArrays(c.series,b._getRelatedChartInfos({fieldInfos:p,fieldName:a,formattedAttributes:d,chartType:n,value:c})):(a=b._getChartOption({value:c,index:f,attributes:e,chartType:n,formattedAttributes:d,fieldName:a,fieldInfos:p}),c.series.push(a))})}};d.prototype._getRelatedChartInfos=function(a){var b=this,c=a.fieldInfos,e=a.fieldName,d=a.formattedAttributes,
g=a.chartType,h=a.value,k=[];a=this.getRelatedFieldInfo(e);var m=a.fieldName,l=this.getRelatedInfo(a.layerId);if(!l)return k;a=l.relatedFeatures;l=l.relation;if(!l||!a)return k;l=l.cardinality;a.forEach(function(a,f){var l=a.attributes;l&&Object.keys(l).forEach(function(a){a===m&&k.push(b._getChartOption({value:h,index:f,attributes:l,formattedAttributes:d,fieldName:e,chartType:g,relatedFieldName:a,fieldInfos:c}))})});return"one-to-many"===l||"many-to-many"===l?k:[k[0]]};g.__decorate([n.property()],
d.prototype,"_featureAbortController",void 0);g.__decorate([n.property({readOnly:!0})],d.prototype,"content",void 0);g.__decorate([n.property({readOnly:!0})],d.prototype,"contentVMs",void 0);g.__decorate([n.property({type:Boolean})],d.prototype,"defaultPopupTemplateEnabled",void 0);g.__decorate([n.property({readOnly:!0})],d.prototype,"formattedAttributes",void 0);g.__decorate([n.property({type:I})],d.prototype,"graphic",void 0);g.__decorate([n.property({readOnly:!0})],d.prototype,"lastEditInfo",void 0);
g.__decorate([n.property({dependsOn:["view"]})],d.prototype,"spatialReference",null);g.__decorate([n.property({readOnly:!0})],d.prototype,"title",void 0);g.__decorate([n.property({dependsOn:["view"]})],d.prototype,"map",null);g.__decorate([n.property({readOnly:!0,dependsOn:["_featureAbortController"]})],d.prototype,"waitingForContent",null);g.__decorate([n.property()],d.prototype,"view",void 0);return d=g.__decorate([n.subclass("esri.widgets.FeatureViewModel")],d)}(V)});